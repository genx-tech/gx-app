"use strict";

require("source-map-support/register");

const {
  _,
  getValueByPath
} = require('rk-utils');

const spawn = require('child_process').spawn;

exports.withProps = (Base, Props) => class extends Base {
  constructor(...args) {
    super(...args);
    Object.assign(this, Props);
  }

};

exports.withArgFill = (Base, ArgIndex, ...Value) => class extends Base {
  constructor(...args) {
    super(args.splice(ArgIndex, 0, ...Value));
  }

};

exports.dependsOn = function (features, app, fromFeature) {
  let hasNotEnabled = _.find(_.castArray(features), feature => !app.enabled(feature));

  if (hasNotEnabled) {
    throw new Error(`"${fromFeature}" feature requires "${hasNotEnabled}" feature to be enabled.`);
  }
};

exports.tryRequire = function (packageName) {
  function tryRequireBy(packageName, mainModule, throwWhenNotFound) {
    try {
      return mainModule.require(packageName);
    } catch (error) {
      if (error.code === 'MODULE_NOT_FOUND') {
        if (throwWhenNotFound) {
          let pkgPaths = packageName.split('/');
          let npmPkgName = pkgPaths[0];

          if (pkgPaths[0].startsWith('@') && pkgPaths.length > 1) {
            npmPkgName += '/' + pkgPaths[1];
          }

          console.log(error.message);
          throw new Error(`Module "${packageName}" not found. Try run "npm install ${npmPkgName}" to install the dependency.`);
        }

        return undefined;
      }

      throw error;
    }
  }

  return tryRequireBy(packageName, module, require.main === module) || tryRequireBy(packageName, require.main, true);
};

exports.restart = function (envVariables) {
  let processOptions = {
    env: { ...process.env,
      ...envVariables
    },
    detached: true,
    stdio: 'ignore'
  };
  let cp = spawn(process.argv[0], process.argv.slice(1), processOptions);
  cp.unref();
  process.exit(0);
};

exports.requireConfig = function (app, config, keys, prefix) {
  const {
    InvalidConfiguration
  } = require('./Errors');

  keys.forEach(key => {
    let value = getValueByPath(config, key);

    if (_.isNil(value)) {
      throw new InvalidConfiguration(`Missing required config item "${key}".`, app, `${prefix}.${key}`);
    }
  });
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9IZWxwZXJzLmpzIl0sIm5hbWVzIjpbIl8iLCJnZXRWYWx1ZUJ5UGF0aCIsInJlcXVpcmUiLCJzcGF3biIsImV4cG9ydHMiLCJ3aXRoUHJvcHMiLCJCYXNlIiwiUHJvcHMiLCJjb25zdHJ1Y3RvciIsImFyZ3MiLCJPYmplY3QiLCJhc3NpZ24iLCJ3aXRoQXJnRmlsbCIsIkFyZ0luZGV4IiwiVmFsdWUiLCJzcGxpY2UiLCJkZXBlbmRzT24iLCJmZWF0dXJlcyIsImFwcCIsImZyb21GZWF0dXJlIiwiaGFzTm90RW5hYmxlZCIsImZpbmQiLCJjYXN0QXJyYXkiLCJmZWF0dXJlIiwiZW5hYmxlZCIsIkVycm9yIiwidHJ5UmVxdWlyZSIsInBhY2thZ2VOYW1lIiwidHJ5UmVxdWlyZUJ5IiwibWFpbk1vZHVsZSIsInRocm93V2hlbk5vdEZvdW5kIiwiZXJyb3IiLCJjb2RlIiwicGtnUGF0aHMiLCJzcGxpdCIsIm5wbVBrZ05hbWUiLCJzdGFydHNXaXRoIiwibGVuZ3RoIiwiY29uc29sZSIsImxvZyIsIm1lc3NhZ2UiLCJ1bmRlZmluZWQiLCJtb2R1bGUiLCJtYWluIiwicmVzdGFydCIsImVudlZhcmlhYmxlcyIsInByb2Nlc3NPcHRpb25zIiwiZW52IiwicHJvY2VzcyIsImRldGFjaGVkIiwic3RkaW8iLCJjcCIsImFyZ3YiLCJzbGljZSIsInVucmVmIiwiZXhpdCIsInJlcXVpcmVDb25maWciLCJjb25maWciLCJrZXlzIiwicHJlZml4IiwiSW52YWxpZENvbmZpZ3VyYXRpb24iLCJmb3JFYWNoIiwia2V5IiwidmFsdWUiLCJpc05pbCJdLCJtYXBwaW5ncyI6Ijs7OztBQUtDLE1BQU07QUFBRUEsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQXdCQyxPQUFPLENBQUMsVUFBRCxDQUFyQzs7QUFDQSxNQUFNQyxLQUFLLEdBQUdELE9BQU8sQ0FBQyxlQUFELENBQVAsQ0FBeUJDLEtBQXZDOztBQVFEQyxPQUFPLENBQUNDLFNBQVIs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Q0FBQzZDLE9BQU8sQ0FBQ0ksSUFBUixDQUFhLENBQWIsQ0FBRCxFQUFrQkosT0FBTyxDQUFDSSxJQUFSLENBQWFDLEtBQWIsQ0FBbUIsQ0FBbkIsQ0FBbEIsRUFBeUNQLGNBQXpDLENBQWQ7QUFDQUssRUFBQUEsRUFBRSxDQUFDRyxLQUFIO0FBQ0FOLEVBQUFBLE9BQU8sQ0FBQ08sSUFBUixDQUFhLENBQWI7QUFDSCxDQVZEOztBQVlBbkQsT0FBTyxDQUFDb0QsYUFBUixHQUF3QixVQUFVdEMsR0FBVixFQUFldUMsTUFBZixFQUF1QkMsSUFBdkIsRUFBNkJDLE1BQTdCLEVBQXFDO0FBQ3pELFFBQU07QUFBRUMsSUFBQUE7QUFBRixNQUEyQjFELE9BQU8sQ0FBQyxVQUFELENBQXhDOztBQUVBd0QsRUFBQUEsSUFBSSxDQUFDRyxPQUFMLENBQWFDLEdBQUcsSUFBSTtBQUNoQixRQUFJQyxLQUFLLEdBQUc5RCxjQUFjLENBQUN3RCxNQUFELEVBQVNLLEdBQVQsQ0FBMUI7O0FBQ0EsUUFBSTlELENBQUMsQ0FBQ2dFLEtBQUYsQ0FBUUQsS0FBUixDQUFKLEVBQW9CO0FBQ2hCLFlBQU0sSUFBSUgsb0JBQUosQ0FBMEIsaUNBQWdDRSxHQUFJLElBQTlELEVBQW1FNUMsR0FBbkUsRUFBeUUsR0FBRXlDLE1BQU8sSUFBR0csR0FBSSxFQUF6RixDQUFOO0FBQ0g7QUFDSixHQUxEO0FBTUgsQ0FURCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29tbW9uIGhlbHBlcnMgZm9yIHNlcnZpY2UgY29udGFpbmVyLlxuICogQG1vZHVsZSBIZWxwZXJzXG4gKi8gXG5cbiBjb25zdCB7IF8sIGdldFZhbHVlQnlQYXRoIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuIGNvbnN0IHNwYXduID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpLnNwYXduO1xuXG4vKipcbiAqIFJldHVybnMgYSBuZXcgY2xhc3MgbWl4aW5nIHdpdGggZ2l2ZW4gcHJvcGVydGllcyBhbmQgaW5pdGlhbCB2YWx1ZXMuXG4gKiBAbWl4aW5cbiAqIEBwYXJhbSB7Kn0gQmFzZSBcbiAqIEBwYXJhbSB7b2JqZWN0fSBQcm9wcyBcbiAqL1xuZXhwb3J0cy53aXRoUHJvcHMgPSAoQmFzZSwgUHJvcHMpID0+IGNsYXNzIGV4dGVuZHMgQmFzZSB7XG4gICAgY29uc3RydWN0b3IoLi4uYXJncykge1xuICAgICAgICBzdXBlciguLi5hcmdzKTtcblxuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMsIFByb3BzKTtcbiAgICB9XG59O1xuXG4vKipcbiAqIEZpbGwgYXJndW1lbnRzIGludG8gZ2l2ZW4gcG9zaXRpb25cbiAqIEBtaXhpblxuICogQHBhcmFtIHsqfSBCYXNlIFxuICogQHBhcmFtIHtpbnRlZ2VyfSBBcmdJbmRleCBcbiAqL1xuZXhwb3J0cy53aXRoQXJnRmlsbCA9IChCYXNlLCBBcmdJbmRleCwgLi4uVmFsdWUpID0+IGNsYXNzIGV4dGVuZHMgQmFzZSB7XG4gICAgY29uc3RydWN0b3IoLi4uYXJncykge1xuICAgICAgICBzdXBlcihhcmdzLnNwbGljZShBcmdJbmRleCwgMCwgLi4uVmFsdWUpKTtcbiAgICB9XG59O1xuXG4gLyoqXG4gICogQHBhcmFtIHtzdHJpbmd8YXJyYXkuPHN0cmluZz59IGZlYXR1cmVzIC0gRGVwZW5kZW5jaWVzIG9mIG90aGVyIGZlYXR1cmVzLlxuICAqIEBwYXJhbSB7U2VydmljZUNvbnRhaW5lcn0gYXBwIC0gT3JpZ2luIHNlcnZpY2UgY29udGFpbmVyIGFwcC5cbiAgKiBAcGFyYW0ge3N0cmluZ30gZnJvbUZlYXR1cmUgLSBEZXBlbmRlbnQgZmVhdHVyZS5cbiAgKi9cbmV4cG9ydHMuZGVwZW5kc09uID0gZnVuY3Rpb24gKGZlYXR1cmVzLCBhcHAsIGZyb21GZWF0dXJlKSB7XG4gICAgbGV0IGhhc05vdEVuYWJsZWQgPSBfLmZpbmQoXy5jYXN0QXJyYXkoZmVhdHVyZXMpLCBmZWF0dXJlID0+ICFhcHAuZW5hYmxlZChmZWF0dXJlKSk7XG5cbiAgICBpZiAoaGFzTm90RW5hYmxlZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFwiJHtmcm9tRmVhdHVyZX1cIiBmZWF0dXJlIHJlcXVpcmVzIFwiJHtoYXNOb3RFbmFibGVkfVwiIGZlYXR1cmUgdG8gYmUgZW5hYmxlZC5gKTtcbiAgICB9XG59O1xuXG4vKipcbiAqIFRyeSByZXF1aXJlIGEgcGFja2FnZSBtb2R1bGUgYW5kIHNob3cgaW5zdGFsbCB0aXBzIGlmIG5vdCBmb3VuZC5cbiAqIEBwYXJhbSB7c3RyaW5nfSBwYWNrYWdlTmFtZVxuICovXG5leHBvcnRzLnRyeVJlcXVpcmUgPSBmdW5jdGlvbiAocGFja2FnZU5hbWUpIHtcblxuICAgIGZ1bmN0aW9uIHRyeVJlcXVpcmVCeShwYWNrYWdlTmFtZSwgbWFpbk1vZHVsZSwgdGhyb3dXaGVuTm90Rm91bmQpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiBtYWluTW9kdWxlLnJlcXVpcmUocGFja2FnZU5hbWUpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgaWYgKGVycm9yLmNvZGUgPT09ICdNT0RVTEVfTk9UX0ZPVU5EJykge1xuICAgICAgICAgICAgICAgIGlmICh0aHJvd1doZW5Ob3RGb3VuZCkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgcGtnUGF0aHMgPSBwYWNrYWdlTmFtZS5zcGxpdCgnLycpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgbnBtUGtnTmFtZSA9IHBrZ1BhdGhzWzBdO1xuICAgICAgICAgICAgICAgICAgICBpZiAocGtnUGF0aHNbMF0uc3RhcnRzV2l0aCgnQCcpICYmIHBrZ1BhdGhzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5wbVBrZ05hbWUgKz0gJy8nICsgcGtnUGF0aHNbMV07XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvci5tZXNzYWdlKTtcblxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1vZHVsZSBcIiR7cGFja2FnZU5hbWV9XCIgbm90IGZvdW5kLiBUcnkgcnVuIFwibnBtIGluc3RhbGwgJHtucG1Qa2dOYW1lfVwiIHRvIGluc3RhbGwgdGhlIGRlcGVuZGVuY3kuYCk7XG4gICAgICAgICAgICAgICAgfSAgICAgICAgICAgICAgICBcblxuICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRyeVJlcXVpcmVCeShwYWNrYWdlTmFtZSwgbW9kdWxlLCByZXF1aXJlLm1haW4gPT09IG1vZHVsZSkgfHwgdHJ5UmVxdWlyZUJ5KHBhY2thZ2VOYW1lLCByZXF1aXJlLm1haW4sIHRydWUpO1xufTtcblxuXG4vKipcbiAqIFJlc3RhcnQgdGhlIGN1cnJlbnQgcHJvY2Vzcy5cbiAqIEBwYXJhbSB7b2JqZWN0fSBlbnZWYXJpYWJsZXMgLSBFbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAqL1xuZXhwb3J0cy5yZXN0YXJ0ID0gZnVuY3Rpb24gKGVudlZhcmlhYmxlcykge1xuICAgIGxldCBwcm9jZXNzT3B0aW9ucyA9IHsgICAgICAgIFxuICAgICAgICBlbnY6IHsgLi4ucHJvY2Vzcy5lbnYsIC4uLmVudlZhcmlhYmxlcyB9LFxuICAgICAgICBkZXRhY2hlZDogdHJ1ZSxcbiAgICAgICAgc3RkaW86ICdpZ25vcmUnXG4gICAgfTtcblxuICAgIGxldCBjcCA9IHNwYXduKHByb2Nlc3MuYXJndlswXSwgcHJvY2Vzcy5hcmd2LnNsaWNlKDEpLCBwcm9jZXNzT3B0aW9ucyk7XG4gICAgY3AudW5yZWYoKTtcbiAgICBwcm9jZXNzLmV4aXQoMCk7XG59O1xuXG5leHBvcnRzLnJlcXVpcmVDb25maWcgPSBmdW5jdGlvbiAoYXBwLCBjb25maWcsIGtleXMsIHByZWZpeCkge1xuICAgIGNvbnN0IHsgSW52YWxpZENvbmZpZ3VyYXRpb24gfSA9IHJlcXVpcmUoJy4vRXJyb3JzJyk7XG5cbiAgICBrZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgbGV0IHZhbHVlID0gZ2V0VmFsdWVCeVBhdGgoY29uZmlnLCBrZXkpO1xuICAgICAgICBpZiAoXy5pc05pbCh2YWx1ZSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQ29uZmlndXJhdGlvbihgTWlzc2luZyByZXF1aXJlZCBjb25maWcgaXRlbSBcIiR7a2V5fVwiLmAsIGFwcCwgYCR7cHJlZml4fS4ke2tleX1gKTtcbiAgICAgICAgfVxuICAgIH0pXG59OyJdfQ==