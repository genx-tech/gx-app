"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const ConfigLoader = require('rk-config');

const JsonConfigProvider = require('rk-config/lib/JsonConfigProvider');

const {
  _,
  fs,
  Promise
} = Util;

const path = require('path');

const EventEmitter = require('events');

const winston = require('winston');

const Feature = require('./enum/Feature');

const Literal = require('./enum/Literal');

class ServiceContainer extends EventEmitter {
  constructor(name, options) {
    super();

    this.logError = (error, message) => {
      return this.log('error', (message ? message + '\n' : '') + error.message, _.pick(error, ['name', 'status', 'code', 'info', 'stack', 'request']));
    };

    this.name = name;
    this.options = Object.assign({}, options);
    this.env = this.options.env || process.env.NODE_ENV || "development";
    this.workingPath = this.options.workingPath ? path.resolve(this.options.workingPath) : process.cwd();
    this.configPath = this.toAbsolutePath(this.options.configPath || Literal.DEFAULT_CONFIG_PATH);
    this.configName = this.options.configName || Literal.APP_CFG_NAME;
  }

  async start_() {
    this._featureRegistry = {
      '*': this._getFeatureFallbackPath()
    };
    this.features = {};
    this.services = {};

    if (this.options.loadConfigFromOptions) {
      this.config = this.options.config;
    } else {
      this.configLoader = this.options.disableEnvAwareConfig ? new ConfigLoader(new JsonConfigProvider(path.join(this.configPath, this.configName + '.json')), this) : ConfigLoader.createEnvAwareJsonLoader(this.configPath, this.configName, this.env, this);
      await this.loadConfig_();
    }

    this.emit('configLoaded');

    if (_.isEmpty(this.config)) {
      throw Error('Empty configuration. Nothing to do! Config path: ' + this.configPath);
    }

    await this._loadFeatures_();
    this.emit('ready');
    this.started = true;
    return this;
  }

  async stop_() {
    await this.emitAsync_('stopping');
    this.started = false;
    delete this.services;
    delete this.features;
    delete this._featureRegistry;
    delete this.config;
    delete this.configLoader;
    await this.emitAsync_('stopped');
  }

  async loadConfig_() {
    let configVariables = this._getConfigVariables();

    this.config = await this.configLoader.load_(configVariables);
    return this;
  }

  toAbsolutePath(...args) {
    if (args.length === 0) {
      return this.workingPath;
    }

    return path.resolve(this.workingPath, ...args);
  }

  registerService(name, serviceObject, override) {
    if (name in this.services && !override) {
      throw new Error('Service "' + name + '" already registered!');
    }

    this.services[name] = serviceObject;
    this.log('verbose', `Service "${name}" registered.`);
    return this;
  }

  hasService(name) {
    return name in this.services;
  }

  getService(name) {
    return this.services[name];
  }

  enabled(feature) {
    return this.features.hasOwnProperty(feature);
  }

  addFeatureRegistry(registry) {
    if (registry.hasOwnProperty('*')) {
      Util.putIntoBucket(this._featureRegistry, '*', registry['*']);
    }

    Object.assign(this._featureRegistry, _.omit(registry, ['*']));
  }

  log(level, message, ...rest) {
    this.logger && this.logger.log(level, message, ...rest);
    return this;
  }

  replaceLogger(logger) {
    if (logger) {
      if (!!this._loggerBackup) {
        throw new Error("Assertion failed: !this._loggerBackup");
      }

      this._loggerBackup = this.logger;
      this._externalLoggerBackup = this._externalLogger;
      this.logger = logger;
      this._externalLogger = true;
      this.log('verbose', 'A new app logger attached.');
    } else {
      this.logger = this._loggerBackup;
      this._externalLogger = this._externalLoggerBackup;
      delete this._loggerBackup;
      delete this._externalLoggerBackup;
      this.log('verbose', 'The current app logger is dettached.');
    }
  }

  _getConfigVariables() {
    return {
      'app': this,
      'log': winston,
      'env': this.env
    };
  }

  _getFeatureFallbackPath() {
    return [path.resolve(__dirname, Literal.FEATURES_PATH), this.toAbsolutePath(Literal.FEATURES_PATH)];
  }

  async emitAsync_(event) {
    let asyncHandlers = [];
    this.emit(event, asyncHandlers);

    if (asyncHandlers.length > 0) {
      await Promise.all(asyncHandlers);
    }
  }

  async _loadFeatures_() {
    let configStageFeatures = [];

    _.forOwn(this.config, (featureOptions, name) => {
      if (this.options.allowedFeatures && this.options.allowedFeatures.indexOf(name) === -1) {
        return;
      }

      let feature;

      try {
        feature = this._loadFeature(name);
      } catch (err) {
        console.error(err);
      }

      if (feature && feature.type === Feature.CONF) {
        configStageFeatures.push([name, feature.load_, featureOptions]);
        delete this.config[name];
      }
    });

    if (configStageFeatures.length > 0) {
      configStageFeatures.forEach(([name]) => {
        delete this.config[name];
      });
      await this._loadFeatureGroup_(configStageFeatures, Feature.CONF);
      return this._loadFeatures_();
    }

    let featureGroups = {
      [Feature.INIT]: [],
      [Feature.SERVICE]: [],
      [Feature.PLUGIN]: [],
      [Feature.READY]: []
    };

    _.forOwn(this.config, (featureOptions, name) => {
      if (this.options.allowedFeatures && this.options.allowedFeatures.indexOf(name) === -1) {
        return;
      }

      let feature = this._loadFeature(name);

      if (!(feature.type in featureGroups)) {
        throw new Error(`Invalid feature type. Feature: ${name}, type: ${feature.type}`);
      }

      featureGroups[feature.type].push([name, feature.load_, featureOptions]);
    });

    return Util.eachAsync_(featureGroups, (group, level) => this._loadFeatureGroup_(group, level));
  }

  async _loadFeatureGroup_(featureGroup, groupLevel) {
    await this.emitAsync_('before:' + groupLevel);
    this.log('verbose', `Loading "${groupLevel}" feature group ...`);
    await Util.eachAsync_(featureGroup, async ([name, load_, options]) => {
      await this.emitAsync_('before:load:' + name);
      this.log('verbose', `Loading feature "${name}" ...`);
      await load_(this, options);
      this.features[name].loaded = true;
      this.log('verbose', `Feature "${name}" loaded. [OK]`);
      await this.emitAsync_('after:load:' + name);
    });
    this.log('verbose', `Finished loading "${groupLevel}" feature group. [OK]`);
    await this.emitAsync_('after:' + groupLevel);
  }

  _loadFeature(feature) {
    let featureObject = this.features[feature];
    if (featureObject) return featureObject;
    let featurePath;

    if (this._featureRegistry.hasOwnProperty(feature)) {
      let loadOption = this._featureRegistry[feature];

      if (Array.isArray(loadOption)) {
        if (loadOption.length === 0) {
          throw new Error(`Invalid registry value for feature "${feature}".`);
        }

        featurePath = loadOption[0];
        featureObject = require(featurePath);

        if (loadOption.length > 1) {
          featureObject = Util.getValueByPath(featureObject, loadOption[1]);
        }
      } else {
        featurePath = loadOption;
        featureObject = require(featurePath);
      }
    } else {
      let searchingPath = this._featureRegistry['*'];

      let found = _.findLast(searchingPath, p => {
        featurePath = path.join(p, feature + '.js');
        return fs.existsSync(featurePath);
      });

      if (!found) {
        throw new Error(`Don't know where to load feature "${feature}".`);
      }

      featureObject = require(featurePath);
    }

    if (!Feature.validate(featureObject)) {
      throw new Error(`Invalid feature object loaded from "${featurePath}".`);
    }

    this.features[feature] = featureObject;
    return featureObject;
  }

}

module.exports = ServiceContainer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TZXJ2aWNlQ29udGFpbmVyLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiQ29uZmlnTG9hZGVyIiwiSnNvbkNvbmZpZ1Byb3ZpZGVyIiwiXyIsImZzIiwiUHJvbWlzZSIsInBhdGgiLCJFdmVudEVtaXR0ZXIiLCJ3aW5zdG9uIiwiRmVhdHVyZSIsIkxpdGVyYWwiLCJTZXJ2aWNlQ29udGFpbmVyIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsImxvZ0Vycm9yIiwiZXJyb3IiLCJtZXNzYWdlIiwibG9nIiwicGljayIsIk9iamVjdCIsImFzc2lnbiIsImVudiIsInByb2Nlc3MiLCJOT0RFX0VOViIsIndvcmtpbmdQYXRoIiwicmVzb2x2ZSIsImN3ZCIsImNvbmZpZ1BhdGgiLCJ0b0Fic29sdXRlUGF0aCIsIkRFRkFVTFRfQ09ORklHX1BBVEgiLCJjb25maWdOYW1lIiwiQVBQX0NGR19OQU1FIiwic3RhcnRfIiwiX2ZlYXR1cmVSZWdpc3RyeSIsIl9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoIiwiZmVhdHVyZXMiLCJzZXJ2aWNlcyIsImxvYWRDb25maWdGcm9tT3B0aW9ucyIsImNvbmZpZyIsImNvbmZpZ0xvYWRlciIsImRpc2FibGVFbnZBd2FyZUNvbmZpZyIsImpvaW4iLCJjcmVhdGVFbnZBd2FyZUpzb25Mb2FkZXIiLCJsb2FkQ29uZmlnXyIsImVtaXQiLCJpc0VtcHR5IiwiRXJyb3IiLCJfbG9hZEZlYXR1cmVzXyIsInN0YXJ0ZWQiLCJzdG9wXyIsImVtaXRBc3luY18iLCJjb25maWdWYXJpYWJsZXMiLCJfZ2V0Q29uZmlnVmFyaWFibGVzIiwibG9hZF8iLCJhcmdzIiwibGVuZ3RoIiwicmVnaXN0ZXJTZXJ2aWNlIiwic2VydmljZU9iamVjdCIsIm92ZXJyaWRlIiwiaGFzU2VydmljZSIsImdldFNlcnZpY2UiLCJlbmFibGVkIiwiZmVhdHVyZSIsImhhc093blByb3BlcnR5IiwiYWRkRmVhdHVyZVJlZ2lzdHJ5IiwicmVnaXN0cnkiLCJwdXRJbnRvQnVja2V0Iiwib21pdCIsImxldmVsIiwicmVzdCIsImxvZ2dlciIsInJlcGxhY2VMb2dnZXIiLCJfbG9nZ2VyQmFja3VwIiwiX2V4dGVybmFsTG9nZ2VyQmFja3VwIiwiX2V4dGVybmFsTG9nZ2VyIiwiX19kaXJuYW1lIiwiRkVBVFVSRVNfUEFUSCIsImV2ZW50IiwiYXN5bmNIYW5kbGVycyIsImFsbCIsImNvbmZpZ1N0YWdlRmVhdHVyZXMiLCJmb3JPd24iLCJmZWF0dXJlT3B0aW9ucyIsImFsbG93ZWRGZWF0dXJlcyIsImluZGV4T2YiLCJfbG9hZEZlYXR1cmUiLCJlcnIiLCJjb25zb2xlIiwidHlwZSIsIkNPTkYiLCJwdXNoIiwiZm9yRWFjaCIsIl9sb2FkRmVhdHVyZUdyb3VwXyIsImZlYXR1cmVHcm91cHMiLCJJTklUIiwiU0VSVklDRSIsIlBMVUdJTiIsIlJFQURZIiwiZWFjaEFzeW5jXyIsImdyb3VwIiwiZmVhdHVyZUdyb3VwIiwiZ3JvdXBMZXZlbCIsImxvYWRlZCIsImZlYXR1cmVPYmplY3QiLCJmZWF0dXJlUGF0aCIsImxvYWRPcHRpb24iLCJBcnJheSIsImlzQXJyYXkiLCJnZXRWYWx1ZUJ5UGF0aCIsInNlYXJjaGluZ1BhdGgiLCJmb3VuZCIsImZpbmRMYXN0IiwicCIsImV4aXN0c1N5bmMiLCJ2YWxpZGF0ZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNQyxZQUFZLEdBQUdELE9BQU8sQ0FBQyxXQUFELENBQTVCOztBQUNBLE1BQU1FLGtCQUFrQixHQUFHRixPQUFPLENBQUMsa0NBQUQsQ0FBbEM7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUE7QUFBVCxJQUFxQk4sSUFBM0I7O0FBQ0EsTUFBTU8sSUFBSSxHQUFHTixPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNTyxZ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LElBQXlCeUMsYUFBekI7QUFDQSxXQUFPQSxhQUFQO0FBQ0g7O0FBL2F1Qzs7QUFrYjVDWSxNQUFNLENBQUNDLE9BQVAsR0FBaUIxRyxnQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCBDb25maWdMb2FkZXIgPSByZXF1aXJlKCdyay1jb25maWcnKTtcbmNvbnN0IEpzb25Db25maWdQcm92aWRlciA9IHJlcXVpcmUoJ3JrLWNvbmZpZy9saWIvSnNvbkNvbmZpZ1Byb3ZpZGVyJyk7XG5jb25zdCB7IF8sIGZzLCBQcm9taXNlIH0gPSBVdGlsO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpO1xuY29uc3Qgd2luc3RvbiA9IHJlcXVpcmUoJ3dpbnN0b24nKTtcblxuY29uc3QgRmVhdHVyZSA9IHJlcXVpcmUoJy4vZW51bS9GZWF0dXJlJyk7XG5jb25zdCBMaXRlcmFsID0gcmVxdWlyZSgnLi9lbnVtL0xpdGVyYWwnKTtcblxuLyoqXG4gKiBTZXJ2aWNlIGNvbnRhaW5lciBjbGFzcy5cbiAqIEBjbGFzc1xuICogQGV4dGVuZHMgRXZlbnRFbWl0dGVyICAgICBcbiAqL1xuY2xhc3MgU2VydmljZUNvbnRhaW5lciBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gICAgbG9nRXJyb3IgPSAoZXJyb3IsIG1lc3NhZ2UpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9nKCdlcnJvcicsIChtZXNzYWdlID8gKG1lc3NhZ2UgKyAnXFxuJykgOiAnJykgKyBlcnJvci5tZXNzYWdlLCBfLnBpY2soZXJyb3IsIFsgJ25hbWUnLCAnc3RhdHVzJywgJ2NvZGUnLCAnaW5mbycsICdzdGFjaycsICdyZXF1ZXN0JyBdKSk7XG4gICAgfTtcblxuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgY29udGFpbmVyIGluc3RhbmNlLiAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIENvbnRhaW5lciBvcHRpb25zICAgICAgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5lbnZdIC0gRW52aXJvbm1lbnQsIGRlZmF1bHQgdG8gcHJvY2Vzcy5lbnYuTk9ERV9FTlZcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMud29ya2luZ1BhdGhdIC0gQXBwJ3Mgd29ya2luZyBwYXRoLCBkZWZhdWx0IHRvIHByb2Nlc3MuY3dkKClcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuY29uZmlnUGF0aF0gLSBBcHAncyBjb25maWcgcGF0aCwgZGVmYXVsdCB0byBcImNvbmZcIiB1bmRlciB3b3JraW5nUGF0aFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5jb25maWdOYW1lXSAtIEFwcCdzIGNvbmZpZyBiYXNlbmFtZSwgZGVmYXVsdCB0byBcImFwcFwiXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmRpc2FibGVFbnZBd2FyZUNvbmZpZz1mYWxzZV0gLSBEb24ndCB1c2UgZW52aXJvbm1lbnQtYXdhcmUgY29uZmlnXG4gICAgICogQHByb3BlcnR5IHthcnJheX0gW29wdGlvbnMuYWxsb3dlZEZlYXR1cmVzXSAtIEEgbGlzdCBvZiBlbmFibGVkIGZlYXR1cmUgbmFtZXNcbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLmxvYWRDb25maWdGcm9tT3B0aW9ucz1mYWxzZV0gLSBXaGV0aGVyIHRvIGxvYWQgY29uZmlnIGZyb20gcGFzc2VkLWluIG9wdGlvbnNcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW29wdGlvbnMuY29uZmlnXSAtIENvbmZpZyBpbiBvcHRpb25zLCB1c2VkIG9ubHkgd2hlbiBsb2FkQ29uZmlnRnJvbU9wdGlvbnNcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihuYW1lLCBvcHRpb25zKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE5hbWUgb2YgdGhlIGFwcFxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9ICAgICAgICAgXG4gICAgICAgICAqKi9cbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFwcCBvcHRpb25zXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH0gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe1xuICAgICAgICAgICAgLy8uLi4gZGVmYXVsdCBvcHRpb25zICAgICAgICAgICAgXG4gICAgICAgIH0sIG9wdGlvbnMpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBFbnZpcm9ubWVudCBmbGFnXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gICAgICAgIFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5lbnYgPSB0aGlzLm9wdGlvbnMuZW52IHx8IHByb2Nlc3MuZW52Lk5PREVfRU5WIHx8IFwiZGV2ZWxvcG1lbnRcIjtcblxuICAgICAgICAvKipcbiAgICAgICAgICogV29ya2luZyBkaXJlY3Rvcnkgb2YgdGhpcyBjbGkgYXBwXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMud29ya2luZ1BhdGggPSB0aGlzLm9wdGlvbnMud29ya2luZ1BhdGggPyBwYXRoLnJlc29sdmUodGhpcy5vcHRpb25zLndvcmtpbmdQYXRoKSA6IHByb2Nlc3MuY3dkKCk7ICAgICBcbiAgICAgICAgXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDb25maWcgcGF0aFxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9ICAgICAgICAgXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmNvbmZpZ1BhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5jb25maWdQYXRoIHx8IExpdGVyYWwuREVGQVVMVF9DT05GSUdfUEFUSCk7ICAgICAgXG4gICAgICAgIFxuICAgICAgICAvKipcbiAgICAgICAgICogQ29uZmlnIGJhc2VuYW1lXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuY29uZmlnTmFtZSA9IHRoaXMub3B0aW9ucy5jb25maWdOYW1lIHx8IExpdGVyYWwuQVBQX0NGR19OQU1FOyAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgdGhlIGNvbnRhaW5lci5cbiAgICAgKiBAZmlyZXMgU2VydmljZUNvbnRhaW5lciNjb25maWdMb2FkZWRcbiAgICAgKiBAZmlyZXMgU2VydmljZUNvbnRhaW5lciNyZWFkeVxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxTZXJ2aWNlQ29udGFpbmVyPn1cbiAgICAgKi9cbiAgICBhc3luYyBzdGFydF8oKSB7ICAgICAgICAgICAgXG4gICAgICAgIHRoaXMuX2ZlYXR1cmVSZWdpc3RyeSA9IHtcbiAgICAgICAgICAgIC8vZmlyc3RseSBsb29rIHVwIFwiZmVhdHVyZXNcIiB1bmRlciBjdXJyZW50IHdvcmtpbmcgcGF0aCwgYW5kIHRoZW4gdHJ5IHRoZSBidWlsdGluIGZlYXR1cmVzIHBhdGhcbiAgICAgICAgICAgICcqJzogdGhpcy5fZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCgpXG4gICAgICAgIH07XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBMb2FkZWQgZmVhdHVyZXMsIG5hbWUgPT4gZmVhdHVyZSBvYmplY3RcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fSAgICAgICAgIFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5mZWF0dXJlcyA9IHt9O1xuICAgICAgICAvKipcbiAgICAgICAgICogTG9hZGVkIHNlcnZpY2VzXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH0gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc2VydmljZXMgPSB7fTsgICAgICAgXG4gICAgICAgIFxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvYWRDb25maWdGcm9tT3B0aW9ucykge1xuICAgICAgICAgICAgdGhpcy5jb25maWcgPSB0aGlzLm9wdGlvbnMuY29uZmlnO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBDb25maWd1cmF0aW9uIGxvYWRlciBpbnN0YW5jZVxuICAgICAgICAgICAgICogQG1lbWJlciB7Q29uZmlnTG9hZGVyfSAgICAgICAgIFxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ0xvYWRlciA9IHRoaXMub3B0aW9ucy5kaXNhYmxlRW52QXdhcmVDb25maWcgPyBcbiAgICAgICAgICAgICAgICBuZXcgQ29uZmlnTG9hZGVyKG5ldyBKc29uQ29uZmlnUHJvdmlkZXIocGF0aC5qb2luKHRoaXMuY29uZmlnUGF0aCwgdGhpcy5jb25maWdOYW1lICsgJy5qc29uJykpLCB0aGlzKSA6IFxuICAgICAgICAgICAgICAgIENvbmZpZ0xvYWRlci5jcmVhdGVFbnZBd2FyZUpzb25Mb2FkZXIodGhpcy5jb25maWdQYXRoLCB0aGlzLmNvbmZpZ05hbWUsIHRoaXMuZW52LCB0aGlzKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgYXdhaXQgdGhpcy5sb2FkQ29uZmlnXygpOyAgICAgXG4gICAgICAgIH0gICBcblxuICAgICAgICAvKipcbiAgICAgICAgICogQ29uZmlnIGxvYWRlZCBldmVudC5cbiAgICAgICAgICogQGV2ZW50IFNlcnZpY2VDb250YWluZXIjY29uZmlnTG9hZGVkXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmVtaXQoJ2NvbmZpZ0xvYWRlZCcpO1xuXG4gICAgICAgIGlmIChfLmlzRW1wdHkodGhpcy5jb25maWcpKSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcignRW1wdHkgY29uZmlndXJhdGlvbi4gTm90aGluZyB0byBkbyEgQ29uZmlnIHBhdGg6ICcgKyB0aGlzLmNvbmZpZ1BhdGgpO1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fbG9hZEZlYXR1cmVzXygpOyBcblxuICAgICAgICAvKipcbiAgICAgICAgICogQXBwIHJlYWR5XG4gICAgICAgICAqIEBldmVudCBTZXJ2aWNlQ29udGFpbmVyI3JlYWR5XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmVtaXQoJ3JlYWR5Jyk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEZsYWcgc2hvd2luZyB0aGUgYXBwIGlzIHN0YXJ0ZWQgb3Igbm90LlxuICAgICAgICAgKiBAbWVtYmVyIHtib29sfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5zdGFydGVkID0gdHJ1ZTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0b3AgdGhlIGNvbnRhaW5lclxuICAgICAqIEBmaXJlcyBTZXJ2aWNlQ29udGFpbmVyI3N0b3BwaW5nXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPFNlcnZpY2VDb250YWluZXI+fVxuICAgICAqL1xuICAgIGFzeW5jIHN0b3BfKCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogQXBwIHN0b3BwaW5nXG4gICAgICAgICAqIEBldmVudCBTZXJ2aWNlQ29udGFpbmVyI3N0b3BwaW5nXG4gICAgICAgICAqL1xuICAgICAgICBhd2FpdCB0aGlzLmVtaXRBc3luY18oJ3N0b3BwaW5nJyk7XG5cbiAgICAgICAgdGhpcy5zdGFydGVkID0gZmFsc2U7XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuc2VydmljZXM7XG4gICAgICAgIGRlbGV0ZSB0aGlzLmZlYXR1cmVzO1xuICAgICAgICBkZWxldGUgdGhpcy5fZmVhdHVyZVJlZ2lzdHJ5O1xuXG4gICAgICAgIGRlbGV0ZSB0aGlzLmNvbmZpZztcbiAgICAgICAgZGVsZXRlIHRoaXMuY29uZmlnTG9hZGVyOyAgXG5cbiAgICAgICAgYXdhaXQgdGhpcy5lbWl0QXN5bmNfKCdzdG9wcGVkJyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHJldHVybnMge1NlcnZpY2VDb250YWluZXJ9XG4gICAgICovXG4gICAgYXN5bmMgbG9hZENvbmZpZ18oKSB7XG4gICAgICAgIGxldCBjb25maWdWYXJpYWJsZXMgPSB0aGlzLl9nZXRDb25maWdWYXJpYWJsZXMoKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQXBwIGNvbmZpZ3VyYXRpb25cbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fSAgICAgICAgIFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5jb25maWcgPSBhd2FpdCB0aGlzLmNvbmZpZ0xvYWRlci5sb2FkXyhjb25maWdWYXJpYWJsZXMpOyAgIFxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRyYW5zbGF0ZSBhIHJlbGF0aXZlIHBhdGggb2YgdGhpcyBhcHAgbW9kdWxlIHRvIGFuIGFic29sdXRlIHBhdGggICAgIFxuICAgICAqIEBwYXJhbSB7YXJyYXl9IGFyZ3MgLSBBcnJheSBvZiBwYXRoIHBhcnRzXG4gICAgICogQHJldHVybnMge3N0cmluZ31cbiAgICAgKi9cbiAgICB0b0Fic29sdXRlUGF0aCguLi5hcmdzKSB7XG4gICAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMud29ya2luZ1BhdGg7XG4gICAgICAgIH0gICAgICAgXG5cbiAgICAgICAgcmV0dXJuIHBhdGgucmVzb2x2ZSh0aGlzLndvcmtpbmdQYXRoLCAuLi5hcmdzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZWdpc3RlciBhIHNlcnZpY2UgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHNlcnZpY2VPYmplY3RcbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IG92ZXJyaWRlXG4gICAgICovXG4gICAgcmVnaXN0ZXJTZXJ2aWNlKG5hbWUsIHNlcnZpY2VPYmplY3QsIG92ZXJyaWRlKSB7XG4gICAgICAgIGlmIChuYW1lIGluIHRoaXMuc2VydmljZXMgJiYgIW92ZXJyaWRlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NlcnZpY2UgXCInKyBuYW1lICsnXCIgYWxyZWFkeSByZWdpc3RlcmVkIScpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXJ2aWNlc1tuYW1lXSA9IHNlcnZpY2VPYmplY3Q7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYFNlcnZpY2UgXCIke25hbWV9XCIgcmVnaXN0ZXJlZC5gKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciBhIHNlcnZpY2UgZXhpc3RzXG4gICAgICogQHBhcmFtIHsqfSBuYW1lIFxuICAgICAqIEByZXR1cm5zIHtib29sZWFufVxuICAgICAqL1xuICAgIGhhc1NlcnZpY2UobmFtZSkge1xuICAgICAgICByZXR1cm4gbmFtZSBpbiB0aGlzLnNlcnZpY2VzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBhIHNlcnZpY2UgZnJvbSBtb2R1bGUgaGllcmFyY2h5ICAgICBcbiAgICAgKiBAcGFyYW0gbmFtZVxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9XG4gICAgICovXG4gICAgZ2V0U2VydmljZShuYW1lKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNlcnZpY2VzW25hbWVdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIHdoZXRoZXIgYSBmZWF0dXJlIGlzIGVuYWJsZWQgaW4gdGhlIGFwcC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZmVhdHVyZSBcbiAgICAgKiBAcmV0dXJucyB7Ym9vbH1cbiAgICAgKi9cbiAgICBlbmFibGVkKGZlYXR1cmUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmVhdHVyZXMuaGFzT3duUHJvcGVydHkoZmVhdHVyZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIG1vcmUgb3Igb3ZlcmlkZSBjdXJyZW50IGZlYXR1cmUgcmVnaXN0cnlcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVnaXN0cnkgXG4gICAgICovXG4gICAgYWRkRmVhdHVyZVJlZ2lzdHJ5KHJlZ2lzdHJ5KSB7XG4gICAgICAgIC8vICogaXMgdXNlZCBhcyB0aGUgZmFsbGJhY2sgbG9jYXRpb24gdG8gZmluZCBhIGZlYXR1cmVcbiAgICAgICAgaWYgKHJlZ2lzdHJ5Lmhhc093blByb3BlcnR5KCcqJykpIHtcbiAgICAgICAgICAgIFV0aWwucHV0SW50b0J1Y2tldCh0aGlzLl9mZWF0dXJlUmVnaXN0cnksICcqJywgcmVnaXN0cnlbJyonXSk7XG4gICAgICAgIH1cblxuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMuX2ZlYXR1cmVSZWdpc3RyeSwgXy5vbWl0KHJlZ2lzdHJ5LCBbJyonXSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlZmF1bHQgbG9nIG1ldGhvZCwgbWF5IGJlIG92ZXJyaWRlIGJ5IGxvZ2dlcnMgZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSAtIExvZyBsZXZlbFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSAtIExvZyBtZXNzYWdlXG4gICAgICogQHBhcmFtIHsuLi5vYmplY3R9IC0gRXh0cmEgbWV0YSBkYXRhXG4gICAgICogQHJldHVybnMge1NlcnZpY2VDb250YWluZXJ9XG4gICAgICovXG4gICAgbG9nKGxldmVsLCBtZXNzYWdlLCAuLi5yZXN0KSB7XG4gICAgICAgIHRoaXMubG9nZ2VyICYmIHRoaXMubG9nZ2VyLmxvZyhsZXZlbCwgbWVzc2FnZSwgLi4ucmVzdCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgICAvKipcbiAgICAgKiBSZXBsYWNlIHRoZSBkZWZhdWx0IGxvZ2dlciBzZXQgb24gY3JlYXRpb24gb2YgdGhlIGFwcC5cbiAgICAgKiBAcGFyYW0ge0xvZ2dlcn0gbG9nZ2VyIFxuICAgICAqIEBtZW1iZXJvZiBTZXJ2aWNlQ29udGFpbmVyXG4gICAgICovXG4gICAgcmVwbGFjZUxvZ2dlcihsb2dnZXIpIHtcbiAgICAgICAgaWYgKGxvZ2dlcikge1xuICAgICAgICAgICAgYXNzZXJ0OiAhdGhpcy5fbG9nZ2VyQmFja3VwO1xuXG4gICAgICAgICAgICB0aGlzLl9sb2dnZXJCYWNrdXAgPSB0aGlzLmxvZ2dlcjtcbiAgICAgICAgICAgIHRoaXMuX2V4dGVybmFsTG9nZ2VyQmFja3VwID0gdGhpcy5fZXh0ZXJuYWxMb2dnZXI7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xuICAgICAgICAgICAgdGhpcy5fZXh0ZXJuYWxMb2dnZXIgPSB0cnVlO1xuXG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdBIG5ldyBhcHAgbG9nZ2VyIGF0dGFjaGVkLicpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIgPSB0aGlzLl9sb2dnZXJCYWNrdXA7XG4gICAgICAgICAgICB0aGlzLl9leHRlcm5hbExvZ2dlciA9IHRoaXMuX2V4dGVybmFsTG9nZ2VyQmFja3VwO1xuXG4gICAgICAgICAgICBkZWxldGUgdGhpcy5fbG9nZ2VyQmFja3VwO1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2V4dGVybmFsTG9nZ2VyQmFja3VwO1xuXG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdUaGUgY3VycmVudCBhcHAgbG9nZ2VyIGlzIGRldHRhY2hlZC4nKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9nZXRDb25maWdWYXJpYWJsZXMoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnYXBwJzogdGhpcywgICAgICAgICAgICBcbiAgICAgICAgICAgICdsb2cnOiB3aW5zdG9uLFxuICAgICAgICAgICAgJ2Vudic6IHRoaXMuZW52XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKSB7XG4gICAgICAgIHJldHVybiBbIHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIExpdGVyYWwuRkVBVFVSRVNfUEFUSCksIHRoaXMudG9BYnNvbHV0ZVBhdGgoTGl0ZXJhbC5GRUFUVVJFU19QQVRIKSBdO1xuICAgIH1cblxuICAgIGFzeW5jIGVtaXRBc3luY18oZXZlbnQpIHtcbiAgICAgICAgbGV0IGFzeW5jSGFuZGxlcnMgPSBbXTtcbiAgICAgICAgdGhpcy5lbWl0KGV2ZW50LCBhc3luY0hhbmRsZXJzKTtcbiAgICAgICAgaWYgKGFzeW5jSGFuZGxlcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoYXN5bmNIYW5kbGVycyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogTG9hZCBmZWF0dXJlc1xuICAgICAqIEBwcml2YXRlICAgICBcbiAgICAgKiBAcmV0dXJucyB7Ym9vbH1cbiAgICAgKi9cbiAgICBhc3luYyBfbG9hZEZlYXR1cmVzXygpIHsgICAgICAgXG4gICAgICAgIC8vIHJ1biBjb25maWcgc3RhZ2Ugc2VwYXJhdGVseSBmaXJzdFxuICAgICAgICBsZXQgY29uZmlnU3RhZ2VGZWF0dXJlcyA9IFtdOyAgICAgICAgXG5cbiAgICAgICAgLy8gbG9hZCBmZWF0dXJlc1xuICAgICAgICBfLmZvck93bih0aGlzLmNvbmZpZywgKGZlYXR1cmVPcHRpb25zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmFsbG93ZWRGZWF0dXJlcyAmJlxuICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5hbGxvd2VkRmVhdHVyZXMuaW5kZXhPZihuYW1lKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAvL3NraXAgZGlzYWJsZWQgZmVhdHVyZXNcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBmZWF0dXJlO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBmZWF0dXJlID0gdGhpcy5fbG9hZEZlYXR1cmUobmFtZSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgeyAgICAgXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpOyAgICAgICAgICAgXG4gICAgICAgICAgICB9ICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChmZWF0dXJlICYmIGZlYXR1cmUudHlwZSA9PT0gRmVhdHVyZS5DT05GKSB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNvbmZpZ1N0YWdlRmVhdHVyZXMucHVzaChbIG5hbWUsIGZlYXR1cmUubG9hZF8sIGZlYXR1cmVPcHRpb25zIF0pO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNvbmZpZ1tuYW1lXTtcbiAgICAgICAgICAgIH0gICAgXG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBpZiAoY29uZmlnU3RhZ2VGZWF0dXJlcy5sZW5ndGggPiAwKSB7ICAgICAgXG4gICAgICAgICAgICAvL2NvbmZpZ3VyYXRpb24gZmVhdHVyZXMgd2lsbCBiZSBvdmVycmlkZWQgYnkgbmV3bHkgbG9hZGVkIGNvbmZpZ1xuICAgICAgICAgICAgY29uZmlnU3RhZ2VGZWF0dXJlcy5mb3JFYWNoKChbIG5hbWUgXSkgPT4geyBkZWxldGUgdGhpcy5jb25maWdbbmFtZV07IH0pO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9sb2FkRmVhdHVyZUdyb3VwXyhjb25maWdTdGFnZUZlYXR1cmVzLCBGZWF0dXJlLkNPTkYpO1xuXG4gICAgICAgICAgICAvL3JlbG9hZCBhbGwgZmVhdHVyZXMgaWYgYW55IHR5cGUgb2YgY29uZmlndXJhdGlvbiBmZWF0dXJlIGV4aXN0cyAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xvYWRGZWF0dXJlc18oKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBmZWF0dXJlR3JvdXBzID0geyAgICAgICAgICAgIFxuICAgICAgICAgICAgW0ZlYXR1cmUuSU5JVF06IFtdLCAgICAgICAgICAgIFxuICAgICAgICAgICAgW0ZlYXR1cmUuU0VSVklDRV06IFtdLCAgICAgICAgICAgIFxuICAgICAgICAgICAgW0ZlYXR1cmUuUExVR0lOXTogW10sXG4gICAgICAgICAgICBbRmVhdHVyZS5SRUFEWV06IFtdXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gbG9hZCBmZWF0dXJlc1xuICAgICAgICBfLmZvck93bih0aGlzLmNvbmZpZywgKGZlYXR1cmVPcHRpb25zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmFsbG93ZWRGZWF0dXJlcyAmJlxuICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5hbGxvd2VkRmVhdHVyZXMuaW5kZXhPZihuYW1lKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAvL3NraXAgZGlzYWJsZWQgZmVhdHVyZXNcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBmZWF0dXJlID0gdGhpcy5fbG9hZEZlYXR1cmUobmFtZSk7XG5cbiAgICAgICAgICAgIGlmICghKGZlYXR1cmUudHlwZSBpbiBmZWF0dXJlR3JvdXBzKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBmZWF0dXJlIHR5cGUuIEZlYXR1cmU6ICR7bmFtZX0sIHR5cGU6ICR7ZmVhdHVyZS50eXBlfWApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmZWF0dXJlR3JvdXBzW2ZlYXR1cmUudHlwZV0ucHVzaChbIG5hbWUsIGZlYXR1cmUubG9hZF8sIGZlYXR1cmVPcHRpb25zIF0pO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gVXRpbC5lYWNoQXN5bmNfKGZlYXR1cmVHcm91cHMsIChncm91cCwgbGV2ZWwpID0+IHRoaXMuX2xvYWRGZWF0dXJlR3JvdXBfKGdyb3VwLCBsZXZlbCkpO1xuICAgIH1cblxuICAgIGFzeW5jIF9sb2FkRmVhdHVyZUdyb3VwXyhmZWF0dXJlR3JvdXAsIGdyb3VwTGV2ZWwpIHsgICAgICAgIFxuICAgICAgICBhd2FpdCB0aGlzLmVtaXRBc3luY18oJ2JlZm9yZTonICsgZ3JvdXBMZXZlbCk7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYExvYWRpbmcgXCIke2dyb3VwTGV2ZWx9XCIgZmVhdHVyZSBncm91cCAuLi5gKTtcblxuICAgICAgICBhd2FpdCBVdGlsLmVhY2hBc3luY18oZmVhdHVyZUdyb3VwLCBhc3luYyAoWyBuYW1lLCBsb2FkXywgb3B0aW9ucyBdKSA9PiB7ICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgYXdhaXQgdGhpcy5lbWl0QXN5bmNfKCdiZWZvcmU6bG9hZDonICsgbmFtZSk7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBMb2FkaW5nIGZlYXR1cmUgXCIke25hbWV9XCIgLi4uYCk7XG5cbiAgICAgICAgICAgIGF3YWl0IGxvYWRfKHRoaXMsIG9wdGlvbnMpOyAgIFxuICAgICAgICAgICAgdGhpcy5mZWF0dXJlc1tuYW1lXS5sb2FkZWQgPSB0cnVlOyAgICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgRmVhdHVyZSBcIiR7bmFtZX1cIiBsb2FkZWQuIFtPS11gKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgYXdhaXQgdGhpcy5lbWl0QXN5bmNfKCdhZnRlcjpsb2FkOicgKyBuYW1lKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYEZpbmlzaGVkIGxvYWRpbmcgXCIke2dyb3VwTGV2ZWx9XCIgZmVhdHVyZSBncm91cC4gW09LXWApO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuZW1pdEFzeW5jXygnYWZ0ZXI6JyArIGdyb3VwTGV2ZWwpO1xuICAgIH0gICAgXG5cbiAgICAvKipcbiAgICAgKiBMb2FkIGEgZmVhdHVyZSBvYmplY3QgYnkgbmFtZS5cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmZWF0dXJlIFxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9ICAgICBcbiAgICAgKi9cbiAgICBfbG9hZEZlYXR1cmUoZmVhdHVyZSkge1xuICAgICAgICBsZXQgZmVhdHVyZU9iamVjdCA9IHRoaXMuZmVhdHVyZXNbZmVhdHVyZV07XG4gICAgICAgIGlmIChmZWF0dXJlT2JqZWN0KSByZXR1cm4gZmVhdHVyZU9iamVjdDtcblxuICAgICAgICBsZXQgZmVhdHVyZVBhdGg7XG5cbiAgICAgICAgaWYgKHRoaXMuX2ZlYXR1cmVSZWdpc3RyeS5oYXNPd25Qcm9wZXJ0eShmZWF0dXJlKSkgeyAgICAgICAgICBcbiAgICAgICAgICAgIC8vbG9hZCBieSByZWdpc3RyeSBlbnRyeVxuICAgICAgICAgICAgbGV0IGxvYWRPcHRpb24gPSB0aGlzLl9mZWF0dXJlUmVnaXN0cnlbZmVhdHVyZV07ICAgICAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGxvYWRPcHRpb24pKSB7XG4gICAgICAgICAgICAgICAgaWYgKGxvYWRPcHRpb24ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCByZWdpc3RyeSB2YWx1ZSBmb3IgZmVhdHVyZSBcIiR7ZmVhdHVyZX1cIi5gKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBmZWF0dXJlUGF0aCA9IGxvYWRPcHRpb25bMF07XG4gICAgICAgICAgICAgICAgZmVhdHVyZU9iamVjdCA9IHJlcXVpcmUoZmVhdHVyZVBhdGgpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGxvYWRPcHRpb24ubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAvL29uZSBtb2R1bGUgbWF5IGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgZmVhdHVyZVxuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlT2JqZWN0ID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChmZWF0dXJlT2JqZWN0LCBsb2FkT3B0aW9uWzFdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZlYXR1cmVQYXRoID0gbG9hZE9wdGlvbjtcbiAgICAgICAgICAgICAgICBmZWF0dXJlT2JqZWN0ID0gcmVxdWlyZShmZWF0dXJlUGF0aCk7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vbG9hZCBieSBmYWxsYmFjayBwYXRoc1xuICAgICAgICAgICAgbGV0IHNlYXJjaGluZ1BhdGggPSB0aGlzLl9mZWF0dXJlUmVnaXN0cnlbJyonXTtcbiAgICBcbiAgICAgICAgICAgIC8vcmV2ZXJzZSBmYWxsYmFjayBzdGFja1xuICAgICAgICAgICAgbGV0IGZvdW5kID0gXy5maW5kTGFzdChzZWFyY2hpbmdQYXRoLCBwID0+IHtcbiAgICAgICAgICAgICAgICBmZWF0dXJlUGF0aCA9IHBhdGguam9pbihwLCBmZWF0dXJlICsgJy5qcycpO1xuICAgICAgICAgICAgICAgIHJldHVybiBmcy5leGlzdHNTeW5jKGZlYXR1cmVQYXRoKTtcbiAgICAgICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgICAgIGlmICghZm91bmQpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYERvbid0IGtub3cgd2hlcmUgdG8gbG9hZCBmZWF0dXJlIFwiJHtmZWF0dXJlfVwiLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmZWF0dXJlT2JqZWN0ID0gcmVxdWlyZShmZWF0dXJlUGF0aCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmICghRmVhdHVyZS52YWxpZGF0ZShmZWF0dXJlT2JqZWN0KSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGZlYXR1cmUgb2JqZWN0IGxvYWRlZCBmcm9tIFwiJHtmZWF0dXJlUGF0aH1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZmVhdHVyZXNbZmVhdHVyZV0gPSBmZWF0dXJlT2JqZWN0O1xuICAgICAgICByZXR1cm4gZmVhdHVyZU9iamVjdDtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gU2VydmljZUNvbnRhaW5lcjsiXX0=