"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const ConfigLoader = require('rk-config');

const JsonConfigProvider = require('rk-config/lib/JsonConfigProvider');

const {
  _,
  fs
} = Util;

const path = require('path');

const EventEmitter = require('events');

const winston = require('winston');

const Feature = require('./enum/Feature');

const Literal = require('./enum/Literal');

class ServiceContainer extends EventEmitter {
  constructor(name, options) {
    super();

    this.logError = (error, message) => {
      return this.logException('error', error, message);
    };

    this.logErrorAsWarning = (error, message) => {
      return this.logException('warn', error, message);
    };

    this.name = name;
    this.options = Object.assign({}, options);
    this.env = this.options.env || process.env.NODE_ENV || "development";
    this.workingPath = this.options.workingPath ? path.resolve(this.options.workingPath) : process.cwd();
    this.configPath = this.toAbsolutePath(this.options.configPath || Literal.DEFAULT_CONFIG_PATH);
    this.configName = this.options.configName || Literal.APP_CFG_NAME;
  }

  async start_() {
    this.log('verbose', `Starting app [${this.name}] ...`);
    this._featureRegistry = {
      '*': this._getFeatureFallbackPath()
    };
    this.features = {};
    this.services = {};

    if (this.options.loadConfigFromOptions) {
      this.config = this.options.config;
    } else {
      this.configLoader = this.options.disableEnvAwareConfig ? new ConfigLoader(new JsonConfigProvider(path.join(this.configPath, this.configName + '.json')), this) : ConfigLoader.createEnvAwareJsonLoader(this.configPath, this.configName, this.env, this);
      await this.loadConfig_();
    }

    this.emit('configLoaded');

    if (_.isEmpty(this.config)) {
      throw Error('Empty configuration. Nothing to do! Config path: ' + this.configPath);
    }

    await this._loadFeatures_();
    this.emit('ready');
    this.started = true;
    return this;
  }

  async stop_() {
    await this.emitAsync_('stopping');
    this.log('verbose', `Stopping app [${this.name}] ...`);
    this.started = false;
    delete this.services;
    delete this.features;
    delete this._featureRegistry;
    delete this.config;
    delete this.configLoader;
    await this.emitAsync_('stopped');
  }

  async loadConfig_() {
    let configVariables = this._getConfigVariables();

    this.config = await this.configLoader.load_(configVariables);
    return this;
  }

  toAbsolutePath(...args) {
    if (args.length === 0) {
      return this.workingPath;
    }

    return path.resolve(this.workingPath, ...args);
  }

  registerService(name, serviceObject, override) {
    if (name in this.services && !override) {
      throw new Error('Service "' + name + '" already registered!');
    }

    this.services[name] = serviceObject;
    this.log('verbose', `Service "${name}" registered.`);
    return this;
  }

  hasService(name) {
    return name in this.services;
  }

  getService(name) {
    return this.services[name];
  }

  enabled(feature) {
    return this.features.hasOwnProperty(feature);
  }

  addFeatureRegistry(registry) {
    if (registry.hasOwnProperty('*')) {
      Util.putIntoBucket(this._featureRegistry, '*', registry['*']);
    }

    Object.assign(this._featureRegistry, _.omit(registry, ['*']));
  }

  log(level, message, ...rest) {
    this.logger && this.logger.log(level, message, ...rest);
    return this;
  }

  logException(level, error, summary) {
    this.log(level, (summary ? summary + '\n' : '') + error.message, _.pick(error, ['name', 'status', 'code', 'info', 'stack', 'request']));
    return this;
  }

  replaceLogger(logger) {
    if (logger) {
      if (!!this._loggerBackup) {
        throw new Error("Assertion failed: !this._loggerBackup");
      }

      this._loggerBackup = this.logger;
      this._externalLoggerBackup = this._externalLogger;
      this.logger = logger;
      this._externalLogger = true;
      this.log('verbose', 'A new app logger attached.');
    } else {
      this.logger = this._loggerBackup;
      this._externalLogger = this._externalLoggerBackup;
      delete this._loggerBackup;
      delete this._externalLoggerBackup;
      this.log('verbose', 'The current app logger is dettached.');
    }
  }

  _getConfigVariables() {
    return {
      'app': this,
      'log': winston,
      'env': this.env
    };
  }

  _getFeatureFallbackPath() {
    return [path.resolve(__dirname, Literal.FEATURES_PATH), this.toAbsolutePath(Literal.FEATURES_PATH)];
  }

  async emitAsync_(event) {
    let asyncHandlers = [];
    this.emit(event, asyncHandlers);

    if (asyncHandlers.length > 0) {
      await Promise.all(asyncHandlers);
    }
  }

  async _loadFeatures_() {
    let configStageFeatures = [];

    _.forOwn(this.config, (featureOptions, name) => {
      if (this.options.allowedFeatures && this.options.allowedFeatures.indexOf(name) === -1) {
        return;
      }

      let feature;

      try {
        feature = this._loadFeature(name);
      } catch (err) {
        console.error(err);
      }

      if (feature && feature.type === Feature.CONF) {
        configStageFeatures.push([name, feature.load_, featureOptions]);
        delete this.config[name];
      }
    });

    if (configStageFeatures.length > 0) {
      configStageFeatures.forEach(([name]) => {
        delete this.config[name];
      });
      await this._loadFeatureGroup_(configStageFeatures, Feature.CONF);
      return this._loadFeatures_();
    }

    let featureGroups = {
      [Feature.INIT]: [],
      [Feature.SERVICE]: [],
      [Feature.PLUGIN]: [],
      [Feature.READY]: []
    };

    _.forOwn(this.config, (featureOptions, name) => {
      if (this.options.allowedFeatures && this.options.allowedFeatures.indexOf(name) === -1) {
        return;
      }

      let feature = this._loadFeature(name);

      if (!(feature.type in featureGroups)) {
        throw new Error(`Invalid feature type. Feature: ${name}, type: ${feature.type}`);
      }

      featureGroups[feature.type].push([name, feature.load_, featureOptions]);
    });

    return Util.eachAsync_(featureGroups, (group, level) => this._loadFeatureGroup_(group, level));
  }

  async _loadFeatureGroup_(featureGroup, groupLevel) {
    await this.emitAsync_('before:' + groupLevel);
    this.log('verbose', `Loading "${groupLevel}" feature group ...`);
    await Util.eachAsync_(featureGroup, async ([name, load_, options]) => {
      await this.emitAsync_('before:load:' + name);
      this.log('verbose', `Loading feature "${name}" ...`);
      await load_(this, options);
      this.features[name].loaded = true;
      this.log('verbose', `Feature "${name}" loaded. [OK]`);
      await this.emitAsync_('after:load:' + name);
    });
    this.log('verbose', `Finished loading "${groupLevel}" feature group. [OK]`);
    await this.emitAsync_('after:' + groupLevel);
  }

  _loadFeature(feature) {
    let featureObject = this.features[feature];
    if (featureObject) return featureObject;
    let featurePath;

    if (this._featureRegistry.hasOwnProperty(feature)) {
      let loadOption = this._featureRegistry[feature];

      if (Array.isArray(loadOption)) {
        if (loadOption.length === 0) {
          throw new Error(`Invalid registry value for feature "${feature}".`);
        }

        featurePath = loadOption[0];
        featureObject = require(featurePath);

        if (loadOption.length > 1) {
          featureObject = Util.getValueByPath(featureObject, loadOption[1]);
        }
      } else {
        featurePath = loadOption;
        featureObject = require(featurePath);
      }
    } else {
      let searchingPath = this._featureRegistry['*'];

      let found = _.findLast(searchingPath, p => {
        featurePath = path.join(p, feature + '.js');
        return fs.existsSync(featurePath);
      });

      if (!found) {
        throw new Error(`Don't know where to load feature "${feature}".`);
      }

      featureObject = require(featurePath);
    }

    if (!Feature.validate(featureObject)) {
      throw new Error(`Invalid feature object loaded from "${featurePath}".`);
    }

    this.features[feature] = featureObject;
    return featureObject;
  }

}

module.exports = ServiceContainer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TZXJ2aWNlQ29udGFpbmVyLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiQ29uZmlnTG9hZGVyIiwiSnNvbkNvbmZpZ1Byb3ZpZGVyIiwiXyIsImZzIiwicGF0aCIsIkV2ZW50RW1pdHRlciIsIndpbnN0b24iLCJGZWF0dXJlIiwiTGl0ZXJhbCIsIlNlcnZpY2VDb250YWluZXIiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJvcHRpb25zIiwibG9nRXJyb3IiLCJlcnJvciIsIm1lc3NhZ2UiLCJsb2dFeGNlcHRpb24iLCJsb2dFcnJvckFzV2FybmluZyIsIk9iamVjdCIsImFzc2lnbiIsImVudiIsInByb2Nlc3MiLCJOT0RFX0VOViIsIndvcmtpbmdQYXRoIiwicmVzb2x2ZSIsImN3ZCIsImNvbmZpZ1BhdGgiLCJ0b0Fic29sdXRlUGF0aCIsIkRFRkFVTFRfQ09ORklHX1BBVEgiLCJjb25maWdOYW1lIiwiQVBQX0NGR19OQU1FIiwic3RhcnRfIiwibG9nIiwiX2ZlYXR1cmVSZWdpc3RyeSIsIl9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoIiwiZmVhdHVyZXMiLCJzZXJ2aWNlcyIsImxvYWRDb25maWdGcm9tT3B0aW9ucyIsImNvbmZpZyIsImNvbmZpZ0xvYWRlciIsImRpc2FibGVFbnZBd2FyZUNvbmZpZyIsImpvaW4iLCJjcmVhdGVFbnZBd2FyZUpzb25Mb2FkZXIiLCJsb2FkQ29uZmlnXyIsImVtaXQiLCJpc0VtcHR5IiwiRXJyb3IiLCJfbG9hZEZlYXR1cmVzXyIsInN0YXJ0ZWQiLCJzdG9wXyIsImVtaXRBc3luY18iLCJjb25maWdWYXJpYWJsZXMiLCJfZ2V0Q29uZmlnVmFyaWFibGVzIiwibG9hZF8iLCJhcmdzIiwibGVuZ3RoIiwicmVnaXN0ZXJTZXJ2aWNlIiwic2VydmljZU9iamVjdCIsIm92ZXJyaWRlIiwiaGFzU2VydmljZSIsImdldFNlcnZpY2UiLCJlbmFibGVkIiwiZmVhdHVyZSIsImhhc093blByb3BlcnR5IiwiYWRkRmVhdHVyZVJlZ2lzdHJ5IiwicmVnaXN0cnkiLCJwdXRJbnRvQnVja2V0Iiwib21pdCIsImxldmVsIiwicmVzdCIsImxvZ2dlciIsInN1bW1hcnkiLCJwaWNrIiwicmVwbGFjZUxvZ2dlciIsIl9sb2dnZXJCYWNrdXAiLCJfZXh0ZXJuYWxMb2dnZXJCYWNrdXAiLCJfZXh0ZXJuYWxMb2dnZXIiLCJfX2Rpcm5hbWUiLCJGRUFUVVJFU19QQVRIIiwiZXZlbnQiLCJhc3luY0hhbmRsZXJzIiwiUHJvbWlzZSIsImFsbCIsImNvbmZpZ1N0YWdlRmVhdHVyZXMiLCJmb3JPd24iLCJmZWF0dXJlT3B0aW9ucyIsImFsbG93ZWRGZWF0dXJlcyIsImluZGV4T2YiLCJfbG9hZEZlYXR1cmUiLCJlcnIiLCJjb25zb2xlIiwidHlwZSIsIkNPTkYiLCJwdXNoIiwiZm9yRWFjaCIsIl9sb2FkRmVhdHVyZUdyb3VwXyIsImZlYXR1cmVHcm91cHMiLCJJTklUIiwiU0VSVklDRSIsIlBMVUdJTiIsIlJFQURZIiwiZWFjaEFzeW5jXyIsImdyb3VwIiwiZmVhdHVyZUdyb3VwIiwiZ3JvdXBMZXZlbCIsImxvYWRlZCIsImZlYXR1cmVPYmplY3QiLCJmZWF0dXJlUGF0aCIsImxvYWRPcHRpb24iLCJBcnJheSIsImlzQXJyYXkiLCJnZXRWYWx1ZUJ5UGF0aCIsInNlYXJjaGluZ1BhdGgiLCJmb3VuZCIsImZpbmRMYXN0IiwicCIsImV4aXN0c1N5bmMiLCJ2YWxpZGF0ZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNQyxZQUFZLEdBQUdELE9BQU8sQ0FBQyxXQUFELENBQTVCOztBQUNBLE1BQU1FLGtCQUFrQixHQUFHRixPQUFPLENBQUMsa0NBQUQsQ0FBbEM7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsSUFBWUwsSUFBbEI7O0FBQ0EsTUFBTU0sSUFBSSxHQUFHTCxPQUFPLENB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Q3ZDUixRQUFBQSxXQUFXLEdBQUd2RyxJQUFJLENBQUNxQyxJQUFMLENBQVUwRSxDQUFWLEVBQWFyRCxPQUFPLEdBQUcsS0FBdkIsQ0FBZDtBQUNBLGVBQU8zRCxFQUFFLENBQUNpSCxVQUFILENBQWNULFdBQWQsQ0FBUDtBQUNILE9BSFcsQ0FBWjs7QUFLQSxVQUFJLENBQUNNLEtBQUwsRUFBWTtBQUNSLGNBQU0sSUFBSW5FLEtBQUosQ0FBVyxxQ0FBb0NnQixPQUFRLElBQXZELENBQU47QUFDSDs7QUFFRDRDLE1BQUFBLGFBQWEsR0FBRzNHLE9BQU8sQ0FBQzRHLFdBQUQsQ0FBdkI7QUFDSDs7QUFFRCxRQUFJLENBQUNwRyxPQUFPLENBQUM4RyxRQUFSLENBQWlCWCxhQUFqQixDQUFMLEVBQXNDO0FBQ2xDLFlBQU0sSUFBSTVELEtBQUosQ0FBVyx1Q0FBc0M2RCxXQUFZLElBQTdELENBQU47QUFDSDs7QUFFRCxTQUFLeEUsUUFBTCxDQUFjMkIsT0FBZCxJQUF5QjRDLGFBQXpCO0FBQ0EsV0FBT0EsYUFBUDtBQUNIOztBQTVidUM7O0FBK2I1Q1ksTUFBTSxDQUFDQyxPQUFQLEdBQWlCOUcsZ0JBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IFV0aWwgPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgQ29uZmlnTG9hZGVyID0gcmVxdWlyZSgncmstY29uZmlnJyk7XG5jb25zdCBKc29uQ29uZmlnUHJvdmlkZXIgPSByZXF1aXJlKCdyay1jb25maWcvbGliL0pzb25Db25maWdQcm92aWRlcicpO1xuY29uc3QgeyBfLCBmcyB9ID0gVXRpbDtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKTtcbmNvbnN0IHdpbnN0b24gPSByZXF1aXJlKCd3aW5zdG9uJyk7XG5cbmNvbnN0IEZlYXR1cmUgPSByZXF1aXJlKCcuL2VudW0vRmVhdHVyZScpO1xuY29uc3QgTGl0ZXJhbCA9IHJlcXVpcmUoJy4vZW51bS9MaXRlcmFsJyk7XG5cbi8qKlxuICogU2VydmljZSBjb250YWluZXIgY2xhc3MuXG4gKiBAY2xhc3NcbiAqIEBleHRlbmRzIEV2ZW50RW1pdHRlciAgICAgXG4gKi9cbmNsYXNzIFNlcnZpY2VDb250YWluZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIGxvZ0Vycm9yID0gKGVycm9yLCBtZXNzYWdlKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvZ0V4Y2VwdGlvbignZXJyb3InLCBlcnJvciwgbWVzc2FnZSk7XG4gICAgfTtcblxuICAgIGxvZ0Vycm9yQXNXYXJuaW5nID0gKGVycm9yLCBtZXNzYWdlKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvZ0V4Y2VwdGlvbignd2FybicsIGVycm9yLCBtZXNzYWdlKTtcbiAgICB9OyAgICBcblxuICAgIC8qKiAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgY29udGFpbmVyIGluc3RhbmNlLiAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIENvbnRhaW5lciBvcHRpb25zICAgICAgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5lbnZdIC0gRW52aXJvbm1lbnQsIGRlZmF1bHQgdG8gcHJvY2Vzcy5lbnYuTk9ERV9FTlZcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMud29ya2luZ1BhdGhdIC0gQXBwJ3Mgd29ya2luZyBwYXRoLCBkZWZhdWx0IHRvIHByb2Nlc3MuY3dkKClcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuY29uZmlnUGF0aF0gLSBBcHAncyBjb25maWcgcGF0aCwgZGVmYXVsdCB0byBcImNvbmZcIiB1bmRlciB3b3JraW5nUGF0aFxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5jb25maWdOYW1lXSAtIEFwcCdzIGNvbmZpZyBiYXNlbmFtZSwgZGVmYXVsdCB0byBcImFwcFwiXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmRpc2FibGVFbnZBd2FyZUNvbmZpZz1mYWxzZV0gLSBEb24ndCB1c2UgZW52aXJvbm1lbnQtYXdhcmUgY29uZmlnXG4gICAgICogQHByb3BlcnR5IHthcnJheX0gW29wdGlvbnMuYWxsb3dlZEZlYXR1cmVzXSAtIEEgbGlzdCBvZiBlbmFibGVkIGZlYXR1cmUgbmFtZXNcbiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtvcHRpb25zLmxvYWRDb25maWdGcm9tT3B0aW9ucz1mYWxzZV0gLSBXaGV0aGVyIHRvIGxvYWQgY29uZmlnIGZyb20gcGFzc2VkLWluIG9wdGlvbnNcbiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gW29wdGlvbnMuY29uZmlnXSAtIENvbmZpZyBpbiBvcHRpb25zLCB1c2VkIG9ubHkgd2hlbiBsb2FkQ29uZmlnRnJvbU9wdGlvbnNcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihuYW1lLCBvcHRpb25zKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIE5hbWUgb2YgdGhlIGFwcFxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9ICAgICAgICAgXG4gICAgICAgICAqKi9cbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsgICAgICAgICAgICAgICAgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFwcCBvcHRpb25zXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH0gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe1xuICAgICAgICAgICAgLy8uLi4gZGVmYXVsdCBvcHRpb25zICAgICAgICAgICAgXG4gICAgICAgIH0sIG9wdGlvbnMpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBFbnZpcm9ubWVudCBmbGFnXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gICAgICAgIFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5lbnYgPSB0aGlzLm9wdGlvbnMuZW52IHx8IHByb2Nlc3MuZW52Lk5PREVfRU5WIHx8IFwiZGV2ZWxvcG1lbnRcIjtcblxuICAgICAgICAvKipcbiAgICAgICAgICogV29ya2luZyBkaXJlY3Rvcnkgb2YgdGhpcyBjbGkgYXBwXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMud29ya2luZ1BhdGggPSB0aGlzLm9wdGlvbnMud29ya2luZ1BhdGggPyBwYXRoLnJlc29sdmUodGhpcy5vcHRpb25zLndvcmtpbmdQYXRoKSA6IHByb2Nlc3MuY3dkKCk7ICAgICBcbiAgICAgICAgXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDb25maWcgcGF0aFxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9ICAgICAgICAgXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmNvbmZpZ1BhdGggPSB0aGlzLnRvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5jb25maWdQYXRoIHx8IExpdGVyYWwuREVGQVVMVF9DT05GSUdfUEFUSCk7ICAgICAgXG4gICAgICAgIFxuICAgICAgICAvKipcbiAgICAgICAgICogQ29uZmlnIGJhc2VuYW1lXG4gICAgICAgICAqIEBtZW1iZXIge3N0cmluZ30gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuY29uZmlnTmFtZSA9IHRoaXMub3B0aW9ucy5jb25maWdOYW1lIHx8IExpdGVyYWwuQVBQX0NGR19OQU1FOyAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgdGhlIGNvbnRhaW5lci5cbiAgICAgKiBAZmlyZXMgU2VydmljZUNvbnRhaW5lciNjb25maWdMb2FkZWRcbiAgICAgKiBAZmlyZXMgU2VydmljZUNvbnRhaW5lciNyZWFkeVxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxTZXJ2aWNlQ29udGFpbmVyPn1cbiAgICAgKi9cbiAgICBhc3luYyBzdGFydF8oKSB7ICAgXG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYFN0YXJ0aW5nIGFwcCBbJHt0aGlzLm5hbWV9XSAuLi5gKTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMuX2ZlYXR1cmVSZWdpc3RyeSA9IHtcbiAgICAgICAgICAgIC8vZmlyc3RseSBsb29rIHVwIFwiZmVhdHVyZXNcIiB1bmRlciBjdXJyZW50IHdvcmtpbmcgcGF0aCwgYW5kIHRoZW4gdHJ5IHRoZSBidWlsdGluIGZlYXR1cmVzIHBhdGhcbiAgICAgICAgICAgICcqJzogdGhpcy5fZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCgpXG4gICAgICAgIH07XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBMb2FkZWQgZmVhdHVyZXMsIG5hbWUgPT4gZmVhdHVyZSBvYmplY3RcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fSAgICAgICAgIFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5mZWF0dXJlcyA9IHt9O1xuICAgICAgICAvKipcbiAgICAgICAgICogTG9hZGVkIHNlcnZpY2VzXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH0gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc2VydmljZXMgPSB7fTsgICAgICAgXG4gICAgICAgIFxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvYWRDb25maWdGcm9tT3B0aW9ucykge1xuICAgICAgICAgICAgdGhpcy5jb25maWcgPSB0aGlzLm9wdGlvbnMuY29uZmlnO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBDb25maWd1cmF0aW9uIGxvYWRlciBpbnN0YW5jZVxuICAgICAgICAgICAgICogQG1lbWJlciB7Q29uZmlnTG9hZGVyfSAgICAgICAgIFxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ0xvYWRlciA9IHRoaXMub3B0aW9ucy5kaXNhYmxlRW52QXdhcmVDb25maWcgPyBcbiAgICAgICAgICAgICAgICBuZXcgQ29uZmlnTG9hZGVyKG5ldyBKc29uQ29uZmlnUHJvdmlkZXIocGF0aC5qb2luKHRoaXMuY29uZmlnUGF0aCwgdGhpcy5jb25maWdOYW1lICsgJy5qc29uJykpLCB0aGlzKSA6IFxuICAgICAgICAgICAgICAgIENvbmZpZ0xvYWRlci5jcmVhdGVFbnZBd2FyZUpzb25Mb2FkZXIodGhpcy5jb25maWdQYXRoLCB0aGlzLmNvbmZpZ05hbWUsIHRoaXMuZW52LCB0aGlzKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgYXdhaXQgdGhpcy5sb2FkQ29uZmlnXygpOyAgICAgXG4gICAgICAgIH0gICBcblxuICAgICAgICAvKipcbiAgICAgICAgICogQ29uZmlnIGxvYWRlZCBldmVudC5cbiAgICAgICAgICogQGV2ZW50IFNlcnZpY2VDb250YWluZXIjY29uZmlnTG9hZGVkXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmVtaXQoJ2NvbmZpZ0xvYWRlZCcpO1xuXG4gICAgICAgIGlmIChfLmlzRW1wdHkodGhpcy5jb25maWcpKSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcignRW1wdHkgY29uZmlndXJhdGlvbi4gTm90aGluZyB0byBkbyEgQ29uZmlnIHBhdGg6ICcgKyB0aGlzLmNvbmZpZ1BhdGgpO1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fbG9hZEZlYXR1cmVzXygpOyBcblxuICAgICAgICAvKipcbiAgICAgICAgICogQXBwIHJlYWR5XG4gICAgICAgICAqIEBldmVudCBTZXJ2aWNlQ29udGFpbmVyI3JlYWR5XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmVtaXQoJ3JlYWR5Jyk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEZsYWcgc2hvd2luZyB0aGUgYXBwIGlzIHN0YXJ0ZWQgb3Igbm90LlxuICAgICAgICAgKiBAbWVtYmVyIHtib29sfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5zdGFydGVkID0gdHJ1ZTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0b3AgdGhlIGNvbnRhaW5lclxuICAgICAqIEBmaXJlcyBTZXJ2aWNlQ29udGFpbmVyI3N0b3BwaW5nXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPFNlcnZpY2VDb250YWluZXI+fVxuICAgICAqL1xuICAgIGFzeW5jIHN0b3BfKCkge1xuICAgICAgICAvKipcbiAgICAgICAgICogQXBwIHN0b3BwaW5nXG4gICAgICAgICAqIEBldmVudCBTZXJ2aWNlQ29udGFpbmVyI3N0b3BwaW5nXG4gICAgICAgICAqL1xuICAgICAgICBhd2FpdCB0aGlzLmVtaXRBc3luY18oJ3N0b3BwaW5nJyk7XG5cbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgU3RvcHBpbmcgYXBwIFske3RoaXMubmFtZX1dIC4uLmApO1xuXG4gICAgICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlO1xuXG4gICAgICAgIGRlbGV0ZSB0aGlzLnNlcnZpY2VzO1xuICAgICAgICBkZWxldGUgdGhpcy5mZWF0dXJlcztcbiAgICAgICAgZGVsZXRlIHRoaXMuX2ZlYXR1cmVSZWdpc3RyeTtcblxuICAgICAgICBkZWxldGUgdGhpcy5jb25maWc7XG4gICAgICAgIGRlbGV0ZSB0aGlzLmNvbmZpZ0xvYWRlcjsgIFxuXG4gICAgICAgIGF3YWl0IHRoaXMuZW1pdEFzeW5jXygnc3RvcHBlZCcpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEByZXR1cm5zIHtTZXJ2aWNlQ29udGFpbmVyfVxuICAgICAqL1xuICAgIGFzeW5jIGxvYWRDb25maWdfKCkge1xuICAgICAgICBsZXQgY29uZmlnVmFyaWFibGVzID0gdGhpcy5fZ2V0Q29uZmlnVmFyaWFibGVzKCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFwcCBjb25maWd1cmF0aW9uXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH0gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuY29uZmlnID0gYXdhaXQgdGhpcy5jb25maWdMb2FkZXIubG9hZF8oY29uZmlnVmFyaWFibGVzKTsgICBcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUcmFuc2xhdGUgYSByZWxhdGl2ZSBwYXRoIG9mIHRoaXMgYXBwIG1vZHVsZSB0byBhbiBhYnNvbHV0ZSBwYXRoICAgICBcbiAgICAgKiBAcGFyYW0ge2FycmF5fSBhcmdzIC0gQXJyYXkgb2YgcGF0aCBwYXJ0c1xuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAgICovXG4gICAgdG9BYnNvbHV0ZVBhdGgoLi4uYXJncykge1xuICAgICAgICBpZiAoYXJncy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLndvcmtpbmdQYXRoO1xuICAgICAgICB9ICAgICAgIFxuXG4gICAgICAgIHJldHVybiBwYXRoLnJlc29sdmUodGhpcy53b3JraW5nUGF0aCwgLi4uYXJncyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVnaXN0ZXIgYSBzZXJ2aWNlICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzZXJ2aWNlT2JqZWN0XG4gICAgICogQHBhcmFtIHtib29sZWFufSBvdmVycmlkZVxuICAgICAqL1xuICAgIHJlZ2lzdGVyU2VydmljZShuYW1lLCBzZXJ2aWNlT2JqZWN0LCBvdmVycmlkZSkge1xuICAgICAgICBpZiAobmFtZSBpbiB0aGlzLnNlcnZpY2VzICYmICFvdmVycmlkZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTZXJ2aWNlIFwiJysgbmFtZSArJ1wiIGFscmVhZHkgcmVnaXN0ZXJlZCEnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc2VydmljZXNbbmFtZV0gPSBzZXJ2aWNlT2JqZWN0O1xuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBTZXJ2aWNlIFwiJHtuYW1lfVwiIHJlZ2lzdGVyZWQuYCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIHdoZXRoZXIgYSBzZXJ2aWNlIGV4aXN0c1xuICAgICAqIEBwYXJhbSB7Kn0gbmFtZSBcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBoYXNTZXJ2aWNlKG5hbWUpIHtcbiAgICAgICAgcmV0dXJuIG5hbWUgaW4gdGhpcy5zZXJ2aWNlcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgYSBzZXJ2aWNlIGZyb20gbW9kdWxlIGhpZXJhcmNoeSAgICAgXG4gICAgICogQHBhcmFtIG5hbWVcbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fVxuICAgICAqL1xuICAgIGdldFNlcnZpY2UobmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5zZXJ2aWNlc1tuYW1lXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayB3aGV0aGVyIGEgZmVhdHVyZSBpcyBlbmFibGVkIGluIHRoZSBhcHAuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGZlYXR1cmUgXG4gICAgICogQHJldHVybnMge2Jvb2x9XG4gICAgICovXG4gICAgZW5hYmxlZChmZWF0dXJlKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmZlYXR1cmVzLmhhc093blByb3BlcnR5KGZlYXR1cmUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBtb3JlIG9yIG92ZXJpZGUgY3VycmVudCBmZWF0dXJlIHJlZ2lzdHJ5XG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJlZ2lzdHJ5IFxuICAgICAqL1xuICAgIGFkZEZlYXR1cmVSZWdpc3RyeShyZWdpc3RyeSkge1xuICAgICAgICAvLyAqIGlzIHVzZWQgYXMgdGhlIGZhbGxiYWNrIGxvY2F0aW9uIHRvIGZpbmQgYSBmZWF0dXJlXG4gICAgICAgIGlmIChyZWdpc3RyeS5oYXNPd25Qcm9wZXJ0eSgnKicpKSB7XG4gICAgICAgICAgICBVdGlsLnB1dEludG9CdWNrZXQodGhpcy5fZmVhdHVyZVJlZ2lzdHJ5LCAnKicsIHJlZ2lzdHJ5WycqJ10pO1xuICAgICAgICB9XG5cbiAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLl9mZWF0dXJlUmVnaXN0cnksIF8ub21pdChyZWdpc3RyeSwgWycqJ10pKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZWZhdWx0IGxvZyBtZXRob2QsIG1heSBiZSBvdmVycmlkZSBieSBsb2dnZXJzIGZlYXR1cmVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gLSBMb2cgbGV2ZWxcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gLSBMb2cgbWVzc2FnZVxuICAgICAqIEBwYXJhbSB7Li4ub2JqZWN0fSAtIEV4dHJhIG1ldGEgZGF0YVxuICAgICAqIEByZXR1cm5zIHtTZXJ2aWNlQ29udGFpbmVyfVxuICAgICAqL1xuICAgIGxvZyhsZXZlbCwgbWVzc2FnZSwgLi4ucmVzdCkge1xuICAgICAgICB0aGlzLmxvZ2dlciAmJiB0aGlzLmxvZ2dlci5sb2cobGV2ZWwsIG1lc3NhZ2UsIC4uLnJlc3QpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBsb2dFeGNlcHRpb24obGV2ZWwsIGVycm9yLCBzdW1tYXJ5KSB7XG4gICAgICAgIHRoaXMubG9nKGxldmVsLCAoc3VtbWFyeSA/IChzdW1tYXJ5ICsgJ1xcbicpIDogJycpICsgZXJyb3IubWVzc2FnZSwgXy5waWNrKGVycm9yLCBbICduYW1lJywgJ3N0YXR1cycsICdjb2RlJywgJ2luZm8nLCAnc3RhY2snLCAncmVxdWVzdCcgXSkpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9O1xuXG4gICAgIC8qKlxuICAgICAqIFJlcGxhY2UgdGhlIGRlZmF1bHQgbG9nZ2VyIHNldCBvbiBjcmVhdGlvbiBvZiB0aGUgYXBwLlxuICAgICAqIEBwYXJhbSB7TG9nZ2VyfSBsb2dnZXIgXG4gICAgICogQG1lbWJlcm9mIFNlcnZpY2VDb250YWluZXJcbiAgICAgKi9cbiAgICByZXBsYWNlTG9nZ2VyKGxvZ2dlcikge1xuICAgICAgICBpZiAobG9nZ2VyKSB7XG4gICAgICAgICAgICBhc3NlcnQ6ICF0aGlzLl9sb2dnZXJCYWNrdXA7XG5cbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlckJhY2t1cCA9IHRoaXMubG9nZ2VyO1xuICAgICAgICAgICAgdGhpcy5fZXh0ZXJuYWxMb2dnZXJCYWNrdXAgPSB0aGlzLl9leHRlcm5hbExvZ2dlcjtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5sb2dnZXIgPSBsb2dnZXI7XG4gICAgICAgICAgICB0aGlzLl9leHRlcm5hbExvZ2dlciA9IHRydWU7XG5cbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ0EgbmV3IGFwcCBsb2dnZXIgYXR0YWNoZWQuJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlciA9IHRoaXMuX2xvZ2dlckJhY2t1cDtcbiAgICAgICAgICAgIHRoaXMuX2V4dGVybmFsTG9nZ2VyID0gdGhpcy5fZXh0ZXJuYWxMb2dnZXJCYWNrdXA7XG5cbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9sb2dnZXJCYWNrdXA7XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5fZXh0ZXJuYWxMb2dnZXJCYWNrdXA7XG5cbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ1RoZSBjdXJyZW50IGFwcCBsb2dnZXIgaXMgZGV0dGFjaGVkLicpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX2dldENvbmZpZ1ZhcmlhYmxlcygpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdhcHAnOiB0aGlzLCAgICAgICAgICAgIFxuICAgICAgICAgICAgJ2xvZyc6IHdpbnN0b24sXG4gICAgICAgICAgICAnZW52JzogdGhpcy5lbnZcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBfZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCgpIHtcbiAgICAgICAgcmV0dXJuIFsgcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgTGl0ZXJhbC5GRUFUVVJFU19QQVRIKSwgdGhpcy50b0Fic29sdXRlUGF0aChMaXRlcmFsLkZFQVRVUkVTX1BBVEgpIF07XG4gICAgfVxuXG4gICAgYXN5bmMgZW1pdEFzeW5jXyhldmVudCkge1xuICAgICAgICBsZXQgYXN5bmNIYW5kbGVycyA9IFtdO1xuICAgICAgICB0aGlzLmVtaXQoZXZlbnQsIGFzeW5jSGFuZGxlcnMpO1xuICAgICAgICBpZiAoYXN5bmNIYW5kbGVycy5sZW5ndGggPiAwKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChhc3luY0hhbmRsZXJzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBMb2FkIGZlYXR1cmVzXG4gICAgICogQHByaXZhdGUgICAgIFxuICAgICAqIEByZXR1cm5zIHtib29sfVxuICAgICAqL1xuICAgIGFzeW5jIF9sb2FkRmVhdHVyZXNfKCkgeyAgICAgICBcbiAgICAgICAgLy8gcnVuIGNvbmZpZyBzdGFnZSBzZXBhcmF0ZWx5IGZpcnN0XG4gICAgICAgIGxldCBjb25maWdTdGFnZUZlYXR1cmVzID0gW107ICAgICAgICBcblxuICAgICAgICAvLyBsb2FkIGZlYXR1cmVzXG4gICAgICAgIF8uZm9yT3duKHRoaXMuY29uZmlnLCAoZmVhdHVyZU9wdGlvbnMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuYWxsb3dlZEZlYXR1cmVzICYmXG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmFsbG93ZWRGZWF0dXJlcy5pbmRleE9mKG5hbWUpID09PSAtMSkge1xuICAgICAgICAgICAgICAgIC8vc2tpcCBkaXNhYmxlZCBmZWF0dXJlc1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGZlYXR1cmU7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGZlYXR1cmUgPSB0aGlzLl9sb2FkRmVhdHVyZShuYW1lKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7ICAgICBcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7ICAgICAgICAgICBcbiAgICAgICAgICAgIH0gICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGZlYXR1cmUgJiYgZmVhdHVyZS50eXBlID09PSBGZWF0dXJlLkNPTkYpIHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uZmlnU3RhZ2VGZWF0dXJlcy5wdXNoKFsgbmFtZSwgZmVhdHVyZS5sb2FkXywgZmVhdHVyZU9wdGlvbnMgXSk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY29uZmlnW25hbWVdO1xuICAgICAgICAgICAgfSAgICBcbiAgICAgICAgfSk7ICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGlmIChjb25maWdTdGFnZUZlYXR1cmVzLmxlbmd0aCA+IDApIHsgICAgICBcbiAgICAgICAgICAgIC8vY29uZmlndXJhdGlvbiBmZWF0dXJlcyB3aWxsIGJlIG92ZXJyaWRlZCBieSBuZXdseSBsb2FkZWQgY29uZmlnXG4gICAgICAgICAgICBjb25maWdTdGFnZUZlYXR1cmVzLmZvckVhY2goKFsgbmFtZSBdKSA9PiB7IGRlbGV0ZSB0aGlzLmNvbmZpZ1tuYW1lXTsgfSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2xvYWRGZWF0dXJlR3JvdXBfKGNvbmZpZ1N0YWdlRmVhdHVyZXMsIEZlYXR1cmUuQ09ORik7XG5cbiAgICAgICAgICAgIC8vcmVsb2FkIGFsbCBmZWF0dXJlcyBpZiBhbnkgdHlwZSBvZiBjb25maWd1cmF0aW9uIGZlYXR1cmUgZXhpc3RzICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fbG9hZEZlYXR1cmVzXygpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGZlYXR1cmVHcm91cHMgPSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBbRmVhdHVyZS5JTklUXTogW10sICAgICAgICAgICAgXG4gICAgICAgICAgICBbRmVhdHVyZS5TRVJWSUNFXTogW10sICAgICAgICAgICAgXG4gICAgICAgICAgICBbRmVhdHVyZS5QTFVHSU5dOiBbXSxcbiAgICAgICAgICAgIFtGZWF0dXJlLlJFQURZXTogW11cbiAgICAgICAgfTtcblxuICAgICAgICAvLyBsb2FkIGZlYXR1cmVzXG4gICAgICAgIF8uZm9yT3duKHRoaXMuY29uZmlnLCAoZmVhdHVyZU9wdGlvbnMsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuYWxsb3dlZEZlYXR1cmVzICYmXG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLmFsbG93ZWRGZWF0dXJlcy5pbmRleE9mKG5hbWUpID09PSAtMSkge1xuICAgICAgICAgICAgICAgIC8vc2tpcCBkaXNhYmxlZCBmZWF0dXJlc1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGZlYXR1cmUgPSB0aGlzLl9sb2FkRmVhdHVyZShuYW1lKTtcblxuICAgICAgICAgICAgaWYgKCEoZmVhdHVyZS50eXBlIGluIGZlYXR1cmVHcm91cHMpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGZlYXR1cmUgdHlwZS4gRmVhdHVyZTogJHtuYW1lfSwgdHlwZTogJHtmZWF0dXJlLnR5cGV9YCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZlYXR1cmVHcm91cHNbZmVhdHVyZS50eXBlXS5wdXNoKFsgbmFtZSwgZmVhdHVyZS5sb2FkXywgZmVhdHVyZU9wdGlvbnMgXSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBVdGlsLmVhY2hBc3luY18oZmVhdHVyZUdyb3VwcywgKGdyb3VwLCBsZXZlbCkgPT4gdGhpcy5fbG9hZEZlYXR1cmVHcm91cF8oZ3JvdXAsIGxldmVsKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2xvYWRGZWF0dXJlR3JvdXBfKGZlYXR1cmVHcm91cCwgZ3JvdXBMZXZlbCkgeyAgICAgICAgXG4gICAgICAgIGF3YWl0IHRoaXMuZW1pdEFzeW5jXygnYmVmb3JlOicgKyBncm91cExldmVsKTtcbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgTG9hZGluZyBcIiR7Z3JvdXBMZXZlbH1cIiBmZWF0dXJlIGdyb3VwIC4uLmApO1xuXG4gICAgICAgIGF3YWl0IFV0aWwuZWFjaEFzeW5jXyhmZWF0dXJlR3JvdXAsIGFzeW5jIChbIG5hbWUsIGxvYWRfLCBvcHRpb25zIF0pID0+IHsgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmVtaXRBc3luY18oJ2JlZm9yZTpsb2FkOicgKyBuYW1lKTtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYExvYWRpbmcgZmVhdHVyZSBcIiR7bmFtZX1cIiAuLi5gKTtcblxuICAgICAgICAgICAgYXdhaXQgbG9hZF8odGhpcywgb3B0aW9ucyk7ICAgXG4gICAgICAgICAgICB0aGlzLmZlYXR1cmVzW25hbWVdLmxvYWRlZCA9IHRydWU7ICAgICAgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBGZWF0dXJlIFwiJHtuYW1lfVwiIGxvYWRlZC4gW09LXWApO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmVtaXRBc3luY18oJ2FmdGVyOmxvYWQ6JyArIG5hbWUpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgRmluaXNoZWQgbG9hZGluZyBcIiR7Z3JvdXBMZXZlbH1cIiBmZWF0dXJlIGdyb3VwLiBbT0tdYCk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5lbWl0QXN5bmNfKCdhZnRlcjonICsgZ3JvdXBMZXZlbCk7XG4gICAgfSAgICBcblxuICAgIC8qKlxuICAgICAqIExvYWQgYSBmZWF0dXJlIG9iamVjdCBieSBuYW1lLlxuICAgICAqIEBwcml2YXRlXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGZlYXR1cmUgXG4gICAgICogQHJldHVybnMge29iamVjdH0gICAgIFxuICAgICAqL1xuICAgIF9sb2FkRmVhdHVyZShmZWF0dXJlKSB7XG4gICAgICAgIGxldCBmZWF0dXJlT2JqZWN0ID0gdGhpcy5mZWF0dXJlc1tmZWF0dXJlXTtcbiAgICAgICAgaWYgKGZlYXR1cmVPYmplY3QpIHJldHVybiBmZWF0dXJlT2JqZWN0O1xuXG4gICAgICAgIGxldCBmZWF0dXJlUGF0aDtcblxuICAgICAgICBpZiAodGhpcy5fZmVhdHVyZVJlZ2lzdHJ5Lmhhc093blByb3BlcnR5KGZlYXR1cmUpKSB7ICAgICAgICAgIFxuICAgICAgICAgICAgLy9sb2FkIGJ5IHJlZ2lzdHJ5IGVudHJ5XG4gICAgICAgICAgICBsZXQgbG9hZE9wdGlvbiA9IHRoaXMuX2ZlYXR1cmVSZWdpc3RyeVtmZWF0dXJlXTsgICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobG9hZE9wdGlvbikpIHtcbiAgICAgICAgICAgICAgICBpZiAobG9hZE9wdGlvbi5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHJlZ2lzdHJ5IHZhbHVlIGZvciBmZWF0dXJlIFwiJHtmZWF0dXJlfVwiLmApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGZlYXR1cmVQYXRoID0gbG9hZE9wdGlvblswXTtcbiAgICAgICAgICAgICAgICBmZWF0dXJlT2JqZWN0ID0gcmVxdWlyZShmZWF0dXJlUGF0aCk7XG5cbiAgICAgICAgICAgICAgICBpZiAobG9hZE9wdGlvbi5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vb25lIG1vZHVsZSBtYXkgY29udGFpbnMgbW9yZSB0aGFuIG9uZSBmZWF0dXJlXG4gICAgICAgICAgICAgICAgICAgIGZlYXR1cmVPYmplY3QgPSBVdGlsLmdldFZhbHVlQnlQYXRoKGZlYXR1cmVPYmplY3QsIGxvYWRPcHRpb25bMV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZmVhdHVyZVBhdGggPSBsb2FkT3B0aW9uO1xuICAgICAgICAgICAgICAgIGZlYXR1cmVPYmplY3QgPSByZXF1aXJlKGZlYXR1cmVQYXRoKTtcbiAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy9sb2FkIGJ5IGZhbGxiYWNrIHBhdGhzXG4gICAgICAgICAgICBsZXQgc2VhcmNoaW5nUGF0aCA9IHRoaXMuX2ZlYXR1cmVSZWdpc3RyeVsnKiddO1xuICAgIFxuICAgICAgICAgICAgLy9yZXZlcnNlIGZhbGxiYWNrIHN0YWNrXG4gICAgICAgICAgICBsZXQgZm91bmQgPSBfLmZpbmRMYXN0KHNlYXJjaGluZ1BhdGgsIHAgPT4ge1xuICAgICAgICAgICAgICAgIGZlYXR1cmVQYXRoID0gcGF0aC5qb2luKHAsIGZlYXR1cmUgKyAnLmpzJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZzLmV4aXN0c1N5bmMoZmVhdHVyZVBhdGgpO1xuICAgICAgICAgICAgfSk7ICAgICAgICBcblxuICAgICAgICAgICAgaWYgKCFmb3VuZCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRG9uJ3Qga25vdyB3aGVyZSB0byBsb2FkIGZlYXR1cmUgXCIke2ZlYXR1cmV9XCIuYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZlYXR1cmVPYmplY3QgPSByZXF1aXJlKGZlYXR1cmVQYXRoKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKCFGZWF0dXJlLnZhbGlkYXRlKGZlYXR1cmVPYmplY3QpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgZmVhdHVyZSBvYmplY3QgbG9hZGVkIGZyb20gXCIke2ZlYXR1cmVQYXRofVwiLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5mZWF0dXJlc1tmZWF0dXJlXSA9IGZlYXR1cmVPYmplY3Q7XG4gICAgICAgIHJldHVybiBmZWF0dXJlT2JqZWN0O1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTZXJ2aWNlQ29udGFpbmVyOyJdfQ==