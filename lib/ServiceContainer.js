"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const ConfigLoader = require('rk-config');

const JsonConfigProvider = require('rk-config/lib/JsonConfigProvider');

const {
  _,
  fs,
  Promise
} = Util;

const path = require('path');

const EventEmitter = require('events');

const winston = require('winston');

const Feature = require('./enum/Feature');

const Literal = require('./enum/Literal');

class ServiceContainer extends EventEmitter {
  constructor(name, options) {
    super();

    this.logError = (error, message) => {
      return this.logException('error', error, message);
    };

    this.logErrorAsWarning = (error, message) => {
      return this.logException('warn', error, message);
    };

    this.name = name;
    this.options = Object.assign({}, options);
    this.env = this.options.env || process.env.NODE_ENV || "development";
    this.workingPath = this.options.workingPath ? path.resolve(this.options.workingPath) : process.cwd();
    this.configPath = this.toAbsolutePath(this.options.configPath || Literal.DEFAULT_CONFIG_PATH);
    this.configName = this.options.configName || Literal.APP_CFG_NAME;
  }

  async start_() {
    this.log('verbose', `Starting app [${this.name}] ...`);
    this._featureRegistry = {
      '*': this._getFeatureFallbackPath()
    };
    this.features = {};
    this.services = {};

    if (this.options.loadConfigFromOptions) {
      this.config = this.options.config;
    } else {
      this.configLoader = this.options.disableEnvAwareConfig ? new ConfigLoader(new JsonConfigProvider(path.join(this.configPath, this.configName + '.json')), this) : ConfigLoader.createEnvAwareJsonLoader(this.configPath, this.configName, this.env, this);
      await this.loadConfig_();
    }

    this.emit('configLoaded');

    if (_.isEmpty(this.config)) {
      throw Error('Empty configuration. Nothing to do! Config path: ' + this.configPath);
    }

    await this._loadFeatures_();
    this.emit('ready');
    this.started = true;
    return this;
  }

  async stop_() {
    await this.emitAsync_('stopping');
    this.log('verbose', `Stopping app [${this.name}] ...`);
    this.started = false;
    delete this.services;
    delete this.features;
    delete this._featureRegistry;
    delete this.config;
    delete this.configLoader;
    await this.emitAsync_('stopped');
  }

  async loadConfig_() {
    let configVariables = this._getConfigVariables();

    this.config = await this.configLoader.load_(configVariables);
    return this;
  }

  toAbsolutePath(...args) {
    if (args.length === 0) {
      return this.workingPath;
    }

    return path.resolve(this.workingPath, ...args);
  }

  registerService(name, serviceObject, override) {
    if (name in this.services && !override) {
      throw new Error('Service "' + name + '" already registered!');
    }

    this.services[name] = serviceObject;
    this.log('verbose', `Service "${name}" registered.`);
    return this;
  }

  hasService(name) {
    return name in this.services;
  }

  getService(name) {
    return this.services[name];
  }

  enabled(feature) {
    return this.features.hasOwnProperty(feature);
  }

  addFeatureRegistry(registry) {
    if (registry.hasOwnProperty('*')) {
      Util.putIntoBucket(this._featureRegistry, '*', registry['*']);
    }

    Object.assign(this._featureRegistry, _.omit(registry, ['*']));
  }

  log(level, message, ...rest) {
    this.logger && this.logger.log(level, message, ...rest);
    return this;
  }

  logException(level, error, summary) {
    this.log(level, (summary ? summary + '\n' : '') + error.message, _.pick(error, ['name', 'status', 'code', 'info', 'stack', 'request']));
    return this;
  }

  replaceLogger(logger) {
    if (logger) {
      if (!!this._loggerBackup) {
        throw new Error("Assertion failed: !this._loggerBackup");
      }

      this._loggerBackup = this.logger;
      this._externalLoggerBackup = this._externalLogger;
      this.logger = logger;
      this._externalLogger = true;
      this.log('verbose', 'A new app logger attached.');
    } else {
      this.logger = this._loggerBackup;
      this._externalLogger = this._externalLoggerBackup;
      delete this._loggerBackup;
      delete this._externalLoggerBackup;
      this.log('verbose', 'The current app logger is dettached.');
    }
  }

  _getConfigVariables() {
    return {
      'app': this,
      'log': winston,
      'env': this.env
    };
  }

  _getFeatureFallbackPath() {
    return [path.resolve(__dirname, Literal.FEATURES_PATH), this.toAbsolutePath(Literal.FEATURES_PATH)];
  }

  async emitAsync_(event) {
    let asyncHandlers = [];
    this.emit(event, asyncHandlers);

    if (asyncHandlers.length > 0) {
      await Promise.all(asyncHandlers);
    }
  }

  async _loadFeatures_() {
    let configStageFeatures = [];

    _.forOwn(this.config, (featureOptions, name) => {
      if (this.options.allowedFeatures && this.options.allowedFeatures.indexOf(name) === -1) {
        return;
      }

      let feature;

      try {
        feature = this._loadFeature(name);
      } catch (err) {
        console.error(err);
      }

      if (feature && feature.type === Feature.CONF) {
        configStageFeatures.push([name, feature.load_, featureOptions]);
        delete this.config[name];
      }
    });

    if (configStageFeatures.length > 0) {
      configStageFeatures.forEach(([name]) => {
        delete this.config[name];
      });
      await this._loadFeatureGroup_(configStageFeatures, Feature.CONF);
      return this._loadFeatures_();
    }

    let featureGroups = {
      [Feature.INIT]: [],
      [Feature.SERVICE]: [],
      [Feature.PLUGIN]: [],
      [Feature.READY]: []
    };

    _.forOwn(this.config, (featureOptions, name) => {
      if (this.options.allowedFeatures && this.options.allowedFeatures.indexOf(name) === -1) {
        return;
      }

      let feature = this._loadFeature(name);

      if (!(feature.type in featureGroups)) {
        throw new Error(`Invalid feature type. Feature: ${name}, type: ${feature.type}`);
      }

      featureGroups[feature.type].push([name, feature.load_, featureOptions]);
    });

    return Util.eachAsync_(featureGroups, (group, level) => this._loadFeatureGroup_(group, level));
  }

  async _loadFeatureGroup_(featureGroup, groupLevel) {
    await this.emitAsync_('before:' + groupLevel);
    this.log('verbose', `Loading "${groupLevel}" feature group ...`);
    await Util.eachAsync_(featureGroup, async ([name, load_, options]) => {
      await this.emitAsync_('before:load:' + name);
      this.log('verbose', `Loading feature "${name}" ...`);
      await load_(this, options);
      this.features[name].loaded = true;
      this.log('verbose', `Feature "${name}" loaded. [OK]`);
      await this.emitAsync_('after:load:' + name);
    });
    this.log('verbose', `Finished loading "${groupLevel}" feature group. [OK]`);
    await this.emitAsync_('after:' + groupLevel);
  }

  _loadFeature(feature) {
    let featureObject = this.features[feature];
    if (featureObject) return featureObject;
    let featurePath;

    if (this._featureRegistry.hasOwnProperty(feature)) {
      let loadOption = this._featureRegistry[feature];

      if (Array.isArray(loadOption)) {
        if (loadOption.length === 0) {
          throw new Error(`Invalid registry value for feature "${feature}".`);
        }

        featurePath = loadOption[0];
        featureObject = require(featurePath);

        if (loadOption.length > 1) {
          featureObject = Util.getValueByPath(featureObject, loadOption[1]);
        }
      } else {
        featurePath = loadOption;
        featureObject = require(featurePath);
      }
    } else {
      let searchingPath = this._featureRegistry['*'];

      let found = _.findLast(searchingPath, p => {
        featurePath = path.join(p, feature + '.js');
        return fs.existsSync(featurePath);
      });

      if (!found) {
        throw new Error(`Don't know where to load feature "${feature}".`);
      }

      featureObject = require(featurePath);
    }

    if (!Feature.validate(featureObject)) {
      throw new Error(`Invalid feature object loaded from "${featurePath}".`);
    }

    this.features[feature] = featureObject;
    return featureObject;
  }

}

module.exports = ServiceContainer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TZXJ2aWNlQ29udGFpbmVyLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiQ29uZmlnTG9hZGVyIiwiSnNvbkNvbmZpZ1Byb3ZpZGVyIiwiXyIsImZzIiwiUHJvbWlzZSIsInBhdGgiLCJFdmVudEVtaXR0ZXIiLCJ3aW5zdG9uIiwiRmVhdHVyZSIsIkxpdGVyYWwiLCJTZXJ2aWNlQ29udGFpbmVyIiwiY29uc3RydWN0b3IiLCJuYW1lIiwib3B0aW9ucyIsImxvZ0Vycm9yIiwiZXJyb3IiLCJtZXNzYWdlIiwibG9nRXhjZXB0aW9uIiwibG9nRXJyb3JBc1dhcm5pbmciLCJPYmplY3QiLCJhc3NpZ24iLCJlbnYiLCJwcm9jZXNzIiwiTk9ERV9FTlYiLCJ3b3JraW5nUGF0aCIsInJlc29sdmUiLCJjd2QiLCJjb25maWdQYXRoIiwidG9BYnNvbHV0ZVBhdGgiLCJERUZBVUxUX0NPTkZJR19QQVRIIiwiY29uZmlnTmFtZSIsIkFQUF9DRkdfTkFNRSIsInN0YXJ0XyIsImxvZyIsIl9mZWF0dXJlUmVnaXN0cnkiLCJfZ2V0RmVhdHVyZUZhbGxiYWNrUGF0aCIsImZlYXR1cmVzIiwic2VydmljZXMiLCJsb2FkQ29uZmlnRnJvbU9wdGlvbnMiLCJjb25maWciLCJjb25maWdMb2FkZXIiLCJkaXNhYmxlRW52QXdhcmVDb25maWciLCJqb2luIiwiY3JlYXRlRW52QXdhcmVKc29uTG9hZGVyIiwibG9hZENvbmZpZ18iLCJlbWl0IiwiaXNFbXB0eSIsIkVycm9yIiwiX2xvYWRGZWF0dXJlc18iLCJzdGFydGVkIiwic3RvcF8iLCJlbWl0QXN5bmNfIiwiY29uZmlnVmFyaWFibGVzIiwiX2dldENvbmZpZ1ZhcmlhYmxlcyIsImxvYWRfIiwiYXJncyIsImxlbmd0aCIsInJlZ2lzdGVyU2VydmljZSIsInNlcnZpY2VPYmplY3QiLCJvdmVycmlkZSIsImhhc1NlcnZpY2UiLCJnZXRTZXJ2aWNlIiwiZW5hYmxlZCIsImZlYXR1cmUiLCJoYXNPd25Qcm9wZXJ0eSIsImFkZEZlYXR1cmVSZWdpc3RyeSIsInJlZ2lzdHJ5IiwicHV0SW50b0J1Y2tldCIsIm9taXQiLCJsZXZlbCIsInJlc3QiLCJsb2dnZXIiLCJzdW1tYXJ5IiwicGljayIsInJlcGxhY2VMb2dnZXIiLCJfbG9nZ2VyQmFja3VwIiwiX2V4dGVybmFsTG9nZ2VyQmFja3VwIiwiX2V4dGVybmFsTG9nZ2VyIiwiX19kaXJuYW1lIiwiRkVBVFVSRVNfUEFUSCIsImV2ZW50IiwiYXN5bmNIYW5kbGVycyIsImFsbCIsImNvbmZpZ1N0YWdlRmVhdHVyZXMiLCJmb3JPd24iLCJmZWF0dXJlT3B0aW9ucyIsImFsbG93ZWRGZWF0dXJlcyIsImluZGV4T2YiLCJfbG9hZEZlYXR1cmUiLCJlcnIiLCJjb25zb2xlIiwidHlwZSIsIkNPTkYiLCJwdXNoIiwiZm9yRWFjaCIsIl9sb2FkRmVhdHVyZUdyb3VwXyIsImZlYXR1cmVHcm91cHMiLCJJTklUIiwiU0VSVklDRSIsIlBMVUdJTiIsIlJFQURZIiwiZWFjaEFzeW5jXyIsImdyb3VwIiwiZmVhdHVyZUdyb3VwIiwiZ3JvdXBMZXZlbCIsImxvYWRlZCIsImZlYXR1cmVPYmplY3QiLCJmZWF0dXJlUGF0aCIsImxvYWRPcHRpb24iLCJBcnJheSIsImlzQXJyYXkiLCJnZXRWYWx1ZUJ5UGF0aCIsInNlYXJjaGluZ1BhdGgiLCJmb3VuZCIsImZpbmRMYXN0IiwicCIsImV4aXN0c1N5bmMiLCJ2YWxpZGF0ZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNQyxZQUFZLEdBQUdELE9BQU8sQ0FBQyxXQUFELENBQTVCOztBQUNBLE1BQU1FLGtCQUFrQixHQUFHRixPQUFPLENBQUMsa0NBQUQsQ0FBbEM7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLEVBQUw7QUFBU0MsRUFBQUE7QUFBVCxJQUFxQk4sSUFBM0I7O0FBQ0EsTUFBTU8s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RUFBMEJHLENBQUMsSUFBSTtBQUN2Q1IsUUFBQUEsV0FBVyxHQUFHdEcsSUFBSSxDQUFDcUMsSUFBTCxDQUFVeUUsQ0FBVixFQUFhcEQsT0FBTyxHQUFHLEtBQXZCLENBQWQ7QUFDQSxlQUFPNUQsRUFBRSxDQUFDaUgsVUFBSCxDQUFjVCxXQUFkLENBQVA7QUFDSCxPQUhXLENBQVo7O0FBS0EsVUFBSSxDQUFDTSxLQUFMLEVBQVk7QUFDUixjQUFNLElBQUlsRSxLQUFKLENBQVcscUNBQW9DZ0IsT0FBUSxJQUF2RCxDQUFOO0FBQ0g7O0FBRUQyQyxNQUFBQSxhQUFhLEdBQUczRyxPQUFPLENBQUM0RyxXQUFELENBQXZCO0FBQ0g7O0FBRUQsUUFBSSxDQUFDbkcsT0FBTyxDQUFDNkcsUUFBUixDQUFpQlgsYUFBakIsQ0FBTCxFQUFzQztBQUNsQyxZQUFNLElBQUkzRCxLQUFKLENBQVcsdUNBQXNDNEQsV0FBWSxJQUE3RCxDQUFOO0FBQ0g7O0FBRUQsU0FBS3ZFLFFBQUwsQ0FBYzJCLE9BQWQsSUFBeUIyQyxhQUF6QjtBQUNBLFdBQU9BLGFBQVA7QUFDSDs7QUE1YnVDOztBQStiNUNZLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjdHLGdCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBVdGlsID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IENvbmZpZ0xvYWRlciA9IHJlcXVpcmUoJ3JrLWNvbmZpZycpO1xuY29uc3QgSnNvbkNvbmZpZ1Byb3ZpZGVyID0gcmVxdWlyZSgncmstY29uZmlnL2xpYi9Kc29uQ29uZmlnUHJvdmlkZXInKTtcbmNvbnN0IHsgXywgZnMsIFByb21pc2UgfSA9IFV0aWw7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJyk7XG5jb25zdCB3aW5zdG9uID0gcmVxdWlyZSgnd2luc3RvbicpO1xuXG5jb25zdCBGZWF0dXJlID0gcmVxdWlyZSgnLi9lbnVtL0ZlYXR1cmUnKTtcbmNvbnN0IExpdGVyYWwgPSByZXF1aXJlKCcuL2VudW0vTGl0ZXJhbCcpO1xuXG4vKipcbiAqIFNlcnZpY2UgY29udGFpbmVyIGNsYXNzLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBFdmVudEVtaXR0ZXIgICAgIFxuICovXG5jbGFzcyBTZXJ2aWNlQ29udGFpbmVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBsb2dFcnJvciA9IChlcnJvciwgbWVzc2FnZSkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2dFeGNlcHRpb24oJ2Vycm9yJywgZXJyb3IsIG1lc3NhZ2UpO1xuICAgIH07XG5cbiAgICBsb2dFcnJvckFzV2FybmluZyA9IChlcnJvciwgbWVzc2FnZSkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2dFeGNlcHRpb24oJ3dhcm4nLCBlcnJvciwgbWVzc2FnZSk7XG4gICAgfTsgICAgXG5cbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGNvbnRhaW5lciBpbnN0YW5jZS4gICAgIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBDb250YWluZXIgb3B0aW9ucyAgICAgICAgICBcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuZW52XSAtIEVudmlyb25tZW50LCBkZWZhdWx0IHRvIHByb2Nlc3MuZW52Lk5PREVfRU5WXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLndvcmtpbmdQYXRoXSAtIEFwcCdzIHdvcmtpbmcgcGF0aCwgZGVmYXVsdCB0byBwcm9jZXNzLmN3ZCgpXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmNvbmZpZ1BhdGhdIC0gQXBwJ3MgY29uZmlnIHBhdGgsIGRlZmF1bHQgdG8gXCJjb25mXCIgdW5kZXIgd29ya2luZ1BhdGhcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuY29uZmlnTmFtZV0gLSBBcHAncyBjb25maWcgYmFzZW5hbWUsIGRlZmF1bHQgdG8gXCJhcHBcIlxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5kaXNhYmxlRW52QXdhcmVDb25maWc9ZmFsc2VdIC0gRG9uJ3QgdXNlIGVudmlyb25tZW50LWF3YXJlIGNvbmZpZ1xuICAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IFtvcHRpb25zLmFsbG93ZWRGZWF0dXJlc10gLSBBIGxpc3Qgb2YgZW5hYmxlZCBmZWF0dXJlIG5hbWVzXG4gICAgICogQHByb3BlcnR5IHtib29sZWFufSBbb3B0aW9ucy5sb2FkQ29uZmlnRnJvbU9wdGlvbnM9ZmFsc2VdIC0gV2hldGhlciB0byBsb2FkIGNvbmZpZyBmcm9tIHBhc3NlZC1pbiBvcHRpb25zXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLmNvbmZpZ10gLSBDb25maWcgaW4gb3B0aW9ucywgdXNlZCBvbmx5IHdoZW4gbG9hZENvbmZpZ0Zyb21PcHRpb25zXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobmFtZSwgb3B0aW9ucykge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBOYW1lIG9mIHRoZSBhcHBcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fSAgICAgICAgIFxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7ICAgICAgICAgICAgICAgIFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBcHAgb3B0aW9uc1xuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9ICAgICAgICAgXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHtcbiAgICAgICAgICAgIC8vLi4uIGRlZmF1bHQgb3B0aW9ucyAgICAgICAgICAgIFxuICAgICAgICB9LCBvcHRpb25zKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogRW52aXJvbm1lbnQgZmxhZ1xuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9ICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZW52ID0gdGhpcy5vcHRpb25zLmVudiB8fCBwcm9jZXNzLmVudi5OT0RFX0VOViB8fCBcImRldmVsb3BtZW50XCI7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFdvcmtpbmcgZGlyZWN0b3J5IG9mIHRoaXMgY2xpIGFwcFxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9ICAgICAgICAgXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLndvcmtpbmdQYXRoID0gdGhpcy5vcHRpb25zLndvcmtpbmdQYXRoID8gcGF0aC5yZXNvbHZlKHRoaXMub3B0aW9ucy53b3JraW5nUGF0aCkgOiBwcm9jZXNzLmN3ZCgpOyAgICAgXG4gICAgICAgIFxuICAgICAgICAvKipcbiAgICAgICAgICogQ29uZmlnIHBhdGhcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSAgICAgICAgIFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5jb25maWdQYXRoID0gdGhpcy50b0Fic29sdXRlUGF0aCh0aGlzLm9wdGlvbnMuY29uZmlnUGF0aCB8fCBMaXRlcmFsLkRFRkFVTFRfQ09ORklHX1BBVEgpOyAgICAgIFxuICAgICAgICBcbiAgICAgICAgLyoqXG4gICAgICAgICAqIENvbmZpZyBiYXNlbmFtZVxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9ICAgICAgICAgXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmNvbmZpZ05hbWUgPSB0aGlzLm9wdGlvbnMuY29uZmlnTmFtZSB8fCBMaXRlcmFsLkFQUF9DRkdfTkFNRTsgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IHRoZSBjb250YWluZXIuXG4gICAgICogQGZpcmVzIFNlcnZpY2VDb250YWluZXIjY29uZmlnTG9hZGVkXG4gICAgICogQGZpcmVzIFNlcnZpY2VDb250YWluZXIjcmVhZHlcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48U2VydmljZUNvbnRhaW5lcj59XG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRfKCkgeyAgIFxuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBTdGFydGluZyBhcHAgWyR7dGhpcy5uYW1lfV0gLi4uYCk7XG4gICAgICAgIFxuICAgICAgICB0aGlzLl9mZWF0dXJlUmVnaXN0cnkgPSB7XG4gICAgICAgICAgICAvL2ZpcnN0bHkgbG9vayB1cCBcImZlYXR1cmVzXCIgdW5kZXIgY3VycmVudCB3b3JraW5nIHBhdGgsIGFuZCB0aGVuIHRyeSB0aGUgYnVpbHRpbiBmZWF0dXJlcyBwYXRoXG4gICAgICAgICAgICAnKic6IHRoaXMuX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKVxuICAgICAgICB9O1xuICAgICAgICAvKipcbiAgICAgICAgICogTG9hZGVkIGZlYXR1cmVzLCBuYW1lID0+IGZlYXR1cmUgb2JqZWN0XG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH0gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZmVhdHVyZXMgPSB7fTtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIExvYWRlZCBzZXJ2aWNlc1xuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9ICAgICAgICAgXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnNlcnZpY2VzID0ge307ICAgICAgIFxuICAgICAgICBcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2FkQ29uZmlnRnJvbU9wdGlvbnMpIHtcbiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gdGhpcy5vcHRpb25zLmNvbmZpZztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogQ29uZmlndXJhdGlvbiBsb2FkZXIgaW5zdGFuY2VcbiAgICAgICAgICAgICAqIEBtZW1iZXIge0NvbmZpZ0xvYWRlcn0gICAgICAgICBcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgdGhpcy5jb25maWdMb2FkZXIgPSB0aGlzLm9wdGlvbnMuZGlzYWJsZUVudkF3YXJlQ29uZmlnID8gXG4gICAgICAgICAgICAgICAgbmV3IENvbmZpZ0xvYWRlcihuZXcgSnNvbkNvbmZpZ1Byb3ZpZGVyKHBhdGguam9pbih0aGlzLmNvbmZpZ1BhdGgsIHRoaXMuY29uZmlnTmFtZSArICcuanNvbicpKSwgdGhpcykgOiBcbiAgICAgICAgICAgICAgICBDb25maWdMb2FkZXIuY3JlYXRlRW52QXdhcmVKc29uTG9hZGVyKHRoaXMuY29uZmlnUGF0aCwgdGhpcy5jb25maWdOYW1lLCB0aGlzLmVudiwgdGhpcyk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGF3YWl0IHRoaXMubG9hZENvbmZpZ18oKTsgICAgIFxuICAgICAgICB9ICAgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIENvbmZpZyBsb2FkZWQgZXZlbnQuXG4gICAgICAgICAqIEBldmVudCBTZXJ2aWNlQ29udGFpbmVyI2NvbmZpZ0xvYWRlZFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5lbWl0KCdjb25maWdMb2FkZWQnKTtcblxuICAgICAgICBpZiAoXy5pc0VtcHR5KHRoaXMuY29uZmlnKSkge1xuICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0VtcHR5IGNvbmZpZ3VyYXRpb24uIE5vdGhpbmcgdG8gZG8hIENvbmZpZyBwYXRoOiAnICsgdGhpcy5jb25maWdQYXRoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHRoaXMuX2xvYWRGZWF0dXJlc18oKTsgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFwcCByZWFkeVxuICAgICAgICAgKiBAZXZlbnQgU2VydmljZUNvbnRhaW5lciNyZWFkeVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5lbWl0KCdyZWFkeScpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBGbGFnIHNob3dpbmcgdGhlIGFwcCBpcyBzdGFydGVkIG9yIG5vdC5cbiAgICAgICAgICogQG1lbWJlciB7Ym9vbH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc3RhcnRlZCA9IHRydWU7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdG9wIHRoZSBjb250YWluZXJcbiAgICAgKiBAZmlyZXMgU2VydmljZUNvbnRhaW5lciNzdG9wcGluZ1xuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxTZXJ2aWNlQ29udGFpbmVyPn1cbiAgICAgKi9cbiAgICBhc3luYyBzdG9wXygpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFwcCBzdG9wcGluZ1xuICAgICAgICAgKiBAZXZlbnQgU2VydmljZUNvbnRhaW5lciNzdG9wcGluZ1xuICAgICAgICAgKi9cbiAgICAgICAgYXdhaXQgdGhpcy5lbWl0QXN5bmNfKCdzdG9wcGluZycpO1xuXG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYFN0b3BwaW5nIGFwcCBbJHt0aGlzLm5hbWV9XSAuLi5gKTtcblxuICAgICAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTtcblxuICAgICAgICBkZWxldGUgdGhpcy5zZXJ2aWNlcztcbiAgICAgICAgZGVsZXRlIHRoaXMuZmVhdHVyZXM7XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9mZWF0dXJlUmVnaXN0cnk7XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuY29uZmlnO1xuICAgICAgICBkZWxldGUgdGhpcy5jb25maWdMb2FkZXI7ICBcblxuICAgICAgICBhd2FpdCB0aGlzLmVtaXRBc3luY18oJ3N0b3BwZWQnKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcmV0dXJucyB7U2VydmljZUNvbnRhaW5lcn1cbiAgICAgKi9cbiAgICBhc3luYyBsb2FkQ29uZmlnXygpIHtcbiAgICAgICAgbGV0IGNvbmZpZ1ZhcmlhYmxlcyA9IHRoaXMuX2dldENvbmZpZ1ZhcmlhYmxlcygpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBcHAgY29uZmlndXJhdGlvblxuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9ICAgICAgICAgXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGF3YWl0IHRoaXMuY29uZmlnTG9hZGVyLmxvYWRfKGNvbmZpZ1ZhcmlhYmxlcyk7ICAgXG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVHJhbnNsYXRlIGEgcmVsYXRpdmUgcGF0aCBvZiB0aGlzIGFwcCBtb2R1bGUgdG8gYW4gYWJzb2x1dGUgcGF0aCAgICAgXG4gICAgICogQHBhcmFtIHthcnJheX0gYXJncyAtIEFycmF5IG9mIHBhdGggcGFydHNcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgICAqL1xuICAgIHRvQWJzb2x1dGVQYXRoKC4uLmFyZ3MpIHtcbiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy53b3JraW5nUGF0aDtcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICByZXR1cm4gcGF0aC5yZXNvbHZlKHRoaXMud29ya2luZ1BhdGgsIC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlZ2lzdGVyIGEgc2VydmljZSAgICAgXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gc2VydmljZU9iamVjdFxuICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gb3ZlcnJpZGVcbiAgICAgKi9cbiAgICByZWdpc3RlclNlcnZpY2UobmFtZSwgc2VydmljZU9iamVjdCwgb3ZlcnJpZGUpIHtcbiAgICAgICAgaWYgKG5hbWUgaW4gdGhpcy5zZXJ2aWNlcyAmJiAhb3ZlcnJpZGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignU2VydmljZSBcIicrIG5hbWUgKydcIiBhbHJlYWR5IHJlZ2lzdGVyZWQhJyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNlcnZpY2VzW25hbWVdID0gc2VydmljZU9iamVjdDtcbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgU2VydmljZSBcIiR7bmFtZX1cIiByZWdpc3RlcmVkLmApO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayB3aGV0aGVyIGEgc2VydmljZSBleGlzdHNcbiAgICAgKiBAcGFyYW0geyp9IG5hbWUgXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAgICovXG4gICAgaGFzU2VydmljZShuYW1lKSB7XG4gICAgICAgIHJldHVybiBuYW1lIGluIHRoaXMuc2VydmljZXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGEgc2VydmljZSBmcm9tIG1vZHVsZSBoaWVyYXJjaHkgICAgIFxuICAgICAqIEBwYXJhbSBuYW1lXG4gICAgICogQHJldHVybnMge29iamVjdH1cbiAgICAgKi9cbiAgICBnZXRTZXJ2aWNlKG5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VydmljZXNbbmFtZV07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgd2hldGhlciBhIGZlYXR1cmUgaXMgZW5hYmxlZCBpbiB0aGUgYXBwLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmZWF0dXJlIFxuICAgICAqIEByZXR1cm5zIHtib29sfVxuICAgICAqL1xuICAgIGVuYWJsZWQoZmVhdHVyZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5mZWF0dXJlcy5oYXNPd25Qcm9wZXJ0eShmZWF0dXJlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgbW9yZSBvciBvdmVyaWRlIGN1cnJlbnQgZmVhdHVyZSByZWdpc3RyeVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZWdpc3RyeSBcbiAgICAgKi9cbiAgICBhZGRGZWF0dXJlUmVnaXN0cnkocmVnaXN0cnkpIHtcbiAgICAgICAgLy8gKiBpcyB1c2VkIGFzIHRoZSBmYWxsYmFjayBsb2NhdGlvbiB0byBmaW5kIGEgZmVhdHVyZVxuICAgICAgICBpZiAocmVnaXN0cnkuaGFzT3duUHJvcGVydHkoJyonKSkge1xuICAgICAgICAgICAgVXRpbC5wdXRJbnRvQnVja2V0KHRoaXMuX2ZlYXR1cmVSZWdpc3RyeSwgJyonLCByZWdpc3RyeVsnKiddKTtcbiAgICAgICAgfVxuXG4gICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5fZmVhdHVyZVJlZ2lzdHJ5LCBfLm9taXQocmVnaXN0cnksIFsnKiddKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVmYXVsdCBsb2cgbWV0aG9kLCBtYXkgYmUgb3ZlcnJpZGUgYnkgbG9nZ2VycyBmZWF0dXJlXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IC0gTG9nIGxldmVsXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IC0gTG9nIG1lc3NhZ2VcbiAgICAgKiBAcGFyYW0gey4uLm9iamVjdH0gLSBFeHRyYSBtZXRhIGRhdGFcbiAgICAgKiBAcmV0dXJucyB7U2VydmljZUNvbnRhaW5lcn1cbiAgICAgKi9cbiAgICBsb2cobGV2ZWwsIG1lc3NhZ2UsIC4uLnJlc3QpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIgJiYgdGhpcy5sb2dnZXIubG9nKGxldmVsLCBtZXNzYWdlLCAuLi5yZXN0KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgbG9nRXhjZXB0aW9uKGxldmVsLCBlcnJvciwgc3VtbWFyeSkge1xuICAgICAgICB0aGlzLmxvZyhsZXZlbCwgKHN1bW1hcnkgPyAoc3VtbWFyeSArICdcXG4nKSA6ICcnKSArIGVycm9yLm1lc3NhZ2UsIF8ucGljayhlcnJvciwgWyAnbmFtZScsICdzdGF0dXMnLCAnY29kZScsICdpbmZvJywgJ3N0YWNrJywgJ3JlcXVlc3QnIF0pKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfTtcblxuICAgICAvKipcbiAgICAgKiBSZXBsYWNlIHRoZSBkZWZhdWx0IGxvZ2dlciBzZXQgb24gY3JlYXRpb24gb2YgdGhlIGFwcC5cbiAgICAgKiBAcGFyYW0ge0xvZ2dlcn0gbG9nZ2VyIFxuICAgICAqIEBtZW1iZXJvZiBTZXJ2aWNlQ29udGFpbmVyXG4gICAgICovXG4gICAgcmVwbGFjZUxvZ2dlcihsb2dnZXIpIHtcbiAgICAgICAgaWYgKGxvZ2dlcikge1xuICAgICAgICAgICAgYXNzZXJ0OiAhdGhpcy5fbG9nZ2VyQmFja3VwO1xuXG4gICAgICAgICAgICB0aGlzLl9sb2dnZXJCYWNrdXAgPSB0aGlzLmxvZ2dlcjtcbiAgICAgICAgICAgIHRoaXMuX2V4dGVybmFsTG9nZ2VyQmFja3VwID0gdGhpcy5fZXh0ZXJuYWxMb2dnZXI7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xuICAgICAgICAgICAgdGhpcy5fZXh0ZXJuYWxMb2dnZXIgPSB0cnVlO1xuXG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdBIG5ldyBhcHAgbG9nZ2VyIGF0dGFjaGVkLicpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIgPSB0aGlzLl9sb2dnZXJCYWNrdXA7XG4gICAgICAgICAgICB0aGlzLl9leHRlcm5hbExvZ2dlciA9IHRoaXMuX2V4dGVybmFsTG9nZ2VyQmFja3VwO1xuXG4gICAgICAgICAgICBkZWxldGUgdGhpcy5fbG9nZ2VyQmFja3VwO1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2V4dGVybmFsTG9nZ2VyQmFja3VwO1xuXG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdUaGUgY3VycmVudCBhcHAgbG9nZ2VyIGlzIGRldHRhY2hlZC4nKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9nZXRDb25maWdWYXJpYWJsZXMoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAnYXBwJzogdGhpcywgICAgICAgICAgICBcbiAgICAgICAgICAgICdsb2cnOiB3aW5zdG9uLFxuICAgICAgICAgICAgJ2Vudic6IHRoaXMuZW52XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKSB7XG4gICAgICAgIHJldHVybiBbIHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIExpdGVyYWwuRkVBVFVSRVNfUEFUSCksIHRoaXMudG9BYnNvbHV0ZVBhdGgoTGl0ZXJhbC5GRUFUVVJFU19QQVRIKSBdO1xuICAgIH1cblxuICAgIGFzeW5jIGVtaXRBc3luY18oZXZlbnQpIHtcbiAgICAgICAgbGV0IGFzeW5jSGFuZGxlcnMgPSBbXTtcbiAgICAgICAgdGhpcy5lbWl0KGV2ZW50LCBhc3luY0hhbmRsZXJzKTtcbiAgICAgICAgaWYgKGFzeW5jSGFuZGxlcnMubGVuZ3RoID4gMCkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoYXN5bmNIYW5kbGVycyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogTG9hZCBmZWF0dXJlc1xuICAgICAqIEBwcml2YXRlICAgICBcbiAgICAgKiBAcmV0dXJucyB7Ym9vbH1cbiAgICAgKi9cbiAgICBhc3luYyBfbG9hZEZlYXR1cmVzXygpIHsgICAgICAgXG4gICAgICAgIC8vIHJ1biBjb25maWcgc3RhZ2Ugc2VwYXJhdGVseSBmaXJzdFxuICAgICAgICBsZXQgY29uZmlnU3RhZ2VGZWF0dXJlcyA9IFtdOyAgICAgICAgXG5cbiAgICAgICAgLy8gbG9hZCBmZWF0dXJlc1xuICAgICAgICBfLmZvck93bih0aGlzLmNvbmZpZywgKGZlYXR1cmVPcHRpb25zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmFsbG93ZWRGZWF0dXJlcyAmJlxuICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5hbGxvd2VkRmVhdHVyZXMuaW5kZXhPZihuYW1lKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAvL3NraXAgZGlzYWJsZWQgZmVhdHVyZXNcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBmZWF0dXJlO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBmZWF0dXJlID0gdGhpcy5fbG9hZEZlYXR1cmUobmFtZSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgeyAgICAgXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpOyAgICAgICAgICAgXG4gICAgICAgICAgICB9ICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChmZWF0dXJlICYmIGZlYXR1cmUudHlwZSA9PT0gRmVhdHVyZS5DT05GKSB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNvbmZpZ1N0YWdlRmVhdHVyZXMucHVzaChbIG5hbWUsIGZlYXR1cmUubG9hZF8sIGZlYXR1cmVPcHRpb25zIF0pO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNvbmZpZ1tuYW1lXTtcbiAgICAgICAgICAgIH0gICAgXG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBpZiAoY29uZmlnU3RhZ2VGZWF0dXJlcy5sZW5ndGggPiAwKSB7ICAgICAgXG4gICAgICAgICAgICAvL2NvbmZpZ3VyYXRpb24gZmVhdHVyZXMgd2lsbCBiZSBvdmVycmlkZWQgYnkgbmV3bHkgbG9hZGVkIGNvbmZpZ1xuICAgICAgICAgICAgY29uZmlnU3RhZ2VGZWF0dXJlcy5mb3JFYWNoKChbIG5hbWUgXSkgPT4geyBkZWxldGUgdGhpcy5jb25maWdbbmFtZV07IH0pO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9sb2FkRmVhdHVyZUdyb3VwXyhjb25maWdTdGFnZUZlYXR1cmVzLCBGZWF0dXJlLkNPTkYpO1xuXG4gICAgICAgICAgICAvL3JlbG9hZCBhbGwgZmVhdHVyZXMgaWYgYW55IHR5cGUgb2YgY29uZmlndXJhdGlvbiBmZWF0dXJlIGV4aXN0cyAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xvYWRGZWF0dXJlc18oKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBmZWF0dXJlR3JvdXBzID0geyAgICAgICAgICAgIFxuICAgICAgICAgICAgW0ZlYXR1cmUuSU5JVF06IFtdLCAgICAgICAgICAgIFxuICAgICAgICAgICAgW0ZlYXR1cmUuU0VSVklDRV06IFtdLCAgICAgICAgICAgIFxuICAgICAgICAgICAgW0ZlYXR1cmUuUExVR0lOXTogW10sXG4gICAgICAgICAgICBbRmVhdHVyZS5SRUFEWV06IFtdXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gbG9hZCBmZWF0dXJlc1xuICAgICAgICBfLmZvck93bih0aGlzLmNvbmZpZywgKGZlYXR1cmVPcHRpb25zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmFsbG93ZWRGZWF0dXJlcyAmJlxuICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5hbGxvd2VkRmVhdHVyZXMuaW5kZXhPZihuYW1lKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAvL3NraXAgZGlzYWJsZWQgZmVhdHVyZXNcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBmZWF0dXJlID0gdGhpcy5fbG9hZEZlYXR1cmUobmFtZSk7XG5cbiAgICAgICAgICAgIGlmICghKGZlYXR1cmUudHlwZSBpbiBmZWF0dXJlR3JvdXBzKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBmZWF0dXJlIHR5cGUuIEZlYXR1cmU6ICR7bmFtZX0sIHR5cGU6ICR7ZmVhdHVyZS50eXBlfWApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmZWF0dXJlR3JvdXBzW2ZlYXR1cmUudHlwZV0ucHVzaChbIG5hbWUsIGZlYXR1cmUubG9hZF8sIGZlYXR1cmVPcHRpb25zIF0pO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gVXRpbC5lYWNoQXN5bmNfKGZlYXR1cmVHcm91cHMsIChncm91cCwgbGV2ZWwpID0+IHRoaXMuX2xvYWRGZWF0dXJlR3JvdXBfKGdyb3VwLCBsZXZlbCkpO1xuICAgIH1cblxuICAgIGFzeW5jIF9sb2FkRmVhdHVyZUdyb3VwXyhmZWF0dXJlR3JvdXAsIGdyb3VwTGV2ZWwpIHsgICAgICAgIFxuICAgICAgICBhd2FpdCB0aGlzLmVtaXRBc3luY18oJ2JlZm9yZTonICsgZ3JvdXBMZXZlbCk7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYExvYWRpbmcgXCIke2dyb3VwTGV2ZWx9XCIgZmVhdHVyZSBncm91cCAuLi5gKTtcblxuICAgICAgICBhd2FpdCBVdGlsLmVhY2hBc3luY18oZmVhdHVyZUdyb3VwLCBhc3luYyAoWyBuYW1lLCBsb2FkXywgb3B0aW9ucyBdKSA9PiB7ICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgYXdhaXQgdGhpcy5lbWl0QXN5bmNfKCdiZWZvcmU6bG9hZDonICsgbmFtZSk7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBMb2FkaW5nIGZlYXR1cmUgXCIke25hbWV9XCIgLi4uYCk7XG5cbiAgICAgICAgICAgIGF3YWl0IGxvYWRfKHRoaXMsIG9wdGlvbnMpOyAgIFxuICAgICAgICAgICAgdGhpcy5mZWF0dXJlc1tuYW1lXS5sb2FkZWQgPSB0cnVlOyAgICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgRmVhdHVyZSBcIiR7bmFtZX1cIiBsb2FkZWQuIFtPS11gKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgYXdhaXQgdGhpcy5lbWl0QXN5bmNfKCdhZnRlcjpsb2FkOicgKyBuYW1lKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYEZpbmlzaGVkIGxvYWRpbmcgXCIke2dyb3VwTGV2ZWx9XCIgZmVhdHVyZSBncm91cC4gW09LXWApO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuZW1pdEFzeW5jXygnYWZ0ZXI6JyArIGdyb3VwTGV2ZWwpO1xuICAgIH0gICAgXG5cbiAgICAvKipcbiAgICAgKiBMb2FkIGEgZmVhdHVyZSBvYmplY3QgYnkgbmFtZS5cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmZWF0dXJlIFxuICAgICAqIEByZXR1cm5zIHtvYmplY3R9ICAgICBcbiAgICAgKi9cbiAgICBfbG9hZEZlYXR1cmUoZmVhdHVyZSkge1xuICAgICAgICBsZXQgZmVhdHVyZU9iamVjdCA9IHRoaXMuZmVhdHVyZXNbZmVhdHVyZV07XG4gICAgICAgIGlmIChmZWF0dXJlT2JqZWN0KSByZXR1cm4gZmVhdHVyZU9iamVjdDtcblxuICAgICAgICBsZXQgZmVhdHVyZVBhdGg7XG5cbiAgICAgICAgaWYgKHRoaXMuX2ZlYXR1cmVSZWdpc3RyeS5oYXNPd25Qcm9wZXJ0eShmZWF0dXJlKSkgeyAgICAgICAgICBcbiAgICAgICAgICAgIC8vbG9hZCBieSByZWdpc3RyeSBlbnRyeVxuICAgICAgICAgICAgbGV0IGxvYWRPcHRpb24gPSB0aGlzLl9mZWF0dXJlUmVnaXN0cnlbZmVhdHVyZV07ICAgICAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGxvYWRPcHRpb24pKSB7XG4gICAgICAgICAgICAgICAgaWYgKGxvYWRPcHRpb24ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCByZWdpc3RyeSB2YWx1ZSBmb3IgZmVhdHVyZSBcIiR7ZmVhdHVyZX1cIi5gKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBmZWF0dXJlUGF0aCA9IGxvYWRPcHRpb25bMF07XG4gICAgICAgICAgICAgICAgZmVhdHVyZU9iamVjdCA9IHJlcXVpcmUoZmVhdHVyZVBhdGgpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGxvYWRPcHRpb24ubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAvL29uZSBtb2R1bGUgbWF5IGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgZmVhdHVyZVxuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlT2JqZWN0ID0gVXRpbC5nZXRWYWx1ZUJ5UGF0aChmZWF0dXJlT2JqZWN0LCBsb2FkT3B0aW9uWzFdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZlYXR1cmVQYXRoID0gbG9hZE9wdGlvbjtcbiAgICAgICAgICAgICAgICBmZWF0dXJlT2JqZWN0ID0gcmVxdWlyZShmZWF0dXJlUGF0aCk7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vbG9hZCBieSBmYWxsYmFjayBwYXRoc1xuICAgICAgICAgICAgbGV0IHNlYXJjaGluZ1BhdGggPSB0aGlzLl9mZWF0dXJlUmVnaXN0cnlbJyonXTtcbiAgICBcbiAgICAgICAgICAgIC8vcmV2ZXJzZSBmYWxsYmFjayBzdGFja1xuICAgICAgICAgICAgbGV0IGZvdW5kID0gXy5maW5kTGFzdChzZWFyY2hpbmdQYXRoLCBwID0+IHtcbiAgICAgICAgICAgICAgICBmZWF0dXJlUGF0aCA9IHBhdGguam9pbihwLCBmZWF0dXJlICsgJy5qcycpO1xuICAgICAgICAgICAgICAgIHJldHVybiBmcy5leGlzdHNTeW5jKGZlYXR1cmVQYXRoKTtcbiAgICAgICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgICAgIGlmICghZm91bmQpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYERvbid0IGtub3cgd2hlcmUgdG8gbG9hZCBmZWF0dXJlIFwiJHtmZWF0dXJlfVwiLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmZWF0dXJlT2JqZWN0ID0gcmVxdWlyZShmZWF0dXJlUGF0aCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmICghRmVhdHVyZS52YWxpZGF0ZShmZWF0dXJlT2JqZWN0KSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGZlYXR1cmUgb2JqZWN0IGxvYWRlZCBmcm9tIFwiJHtmZWF0dXJlUGF0aH1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZmVhdHVyZXNbZmVhdHVyZV0gPSBmZWF0dXJlT2JqZWN0O1xuICAgICAgICByZXR1cm4gZmVhdHVyZU9iamVjdDtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gU2VydmljZUNvbnRhaW5lcjsiXX0=