"use strict";

require("source-map-support/register");

const ConfigLoader = require('@genx/config');

const JsonConfigProvider = require('@genx/config/lib/JsonConfigProvider');

const {
  _,
  pushIntoBucket,
  eachAsync_
} = require('@genx/july');

const {
  fs,
  tryRequire: _tryRequire
} = require('@genx/sys');

const path = require('path');

const EventEmitter = require('events');

const winston = require('winston');

const Feature = require('./enum/Feature');

const Literal = require('./enum/Literal');

class ServiceContainer extends EventEmitter {
  constructor(name, options) {
    super();

    this.logError = (error, message) => {
      return this.logException('error', error, message);
    };

    this.logErrorAsWarning = (error, message) => {
      return this.logException('warn', error, message);
    };

    this.name = name;
    this.options = Object.assign({}, options);
    this.env = this.options.env || process.env.NODE_ENV || "development";
    this.workingPath = this.options.workingPath ? path.resolve(this.options.workingPath) : process.cwd();
    this.configPath = this.toAbsolutePath(this.options.configPath || Literal.DEFAULT_CONFIG_PATH);
    this.configName = this.options.configName || Literal.APP_CFG_NAME;
  }

  async start_() {
    this.log('verbose', `Starting app [${this.name}] ...`);
    this._featureRegistry = {
      '*': this._getFeatureFallbackPath()
    };
    this.features = {};
    this.services = {};

    if (this.options.loadConfigFromOptions) {
      this.config = this.options.config;
    } else {
      this.configLoader = this.options.disableEnvAwareConfig ? new ConfigLoader(new JsonConfigProvider(path.join(this.configPath, this.configName + '.json')), this) : ConfigLoader.createEnvAwareJsonLoader(this.configPath, this.configName, this.env, this);
      await this.loadConfig_();
    }

    this.emit('configLoaded');

    if (_.isEmpty(this.config)) {
      throw Error('Empty configuration. Nothing to do! Config path: ' + this.configPath);
    }

    await this._loadFeatures_();
    this.emit('ready');
    this.started = true;
    return this;
  }

  async stop_() {
    await this.emitAsync_('stopping');
    this.log('verbose', `Stopping app [${this.name}] ...`);
    this.started = false;
    delete this.services;
    delete this.features;
    delete this._featureRegistry;
    delete this.config;
    delete this.configLoader;
    await this.emitAsync_('stopped');
    this.removeAllListeners();
  }

  async loadConfig_() {
    let configVariables = this._getConfigVariables();

    this.config = await this.configLoader.load_(configVariables);
    return this;
  }

  toAbsolutePath(...args) {
    if (args.length === 0 || args[0] == null) {
      return this.workingPath;
    }

    return path.resolve(this.workingPath, ...args);
  }

  tryRequire(pkgName) {
    return _tryRequire(pkgName, this.workingPath);
  }

  registerService(name, serviceObject, override) {
    if (name in this.services && !override) {
      throw new Error('Service "' + name + '" already registered!');
    }

    this.services[name] = serviceObject;
    this.log('verbose', `Service "${name}" registered.`);
    return this;
  }

  hasService(name) {
    return name in this.services;
  }

  getService(name) {
    return this.services[name];
  }

  enabled(feature) {
    return this.features.hasOwnProperty(feature);
  }

  addFeatureRegistry(registry) {
    if (registry.hasOwnProperty('*')) {
      pushIntoBucket(this._featureRegistry, '*', registry['*']);
    }

    Object.assign(this._featureRegistry, _.omit(registry, ['*']));
  }

  log(level, message, ...rest) {
    this.logger && this.logger.log(level, message, ...rest);
    return this;
  }

  logException(level, error, summary) {
    this.log(level, (summary ? summary + '\n' : '') + error.message, _.pick(error, ['name', 'status', 'code', 'info', 'stack', 'request']));
    return this;
  }

  replaceLogger(logger) {
    if (logger) {
      if (!!this._loggerBackup) {
        throw new Error("Assertion failed: !this._loggerBackup");
      }

      this._loggerBackup = this.logger;
      this._externalLoggerBackup = this._externalLogger;
      this.logger = logger;
      this._externalLogger = true;
      this.log('verbose', 'A new app logger attached.');
    } else {
      this.logger = this._loggerBackup;
      this._externalLogger = this._externalLoggerBackup;
      delete this._loggerBackup;
      delete this._externalLoggerBackup;
      this.log('verbose', 'The current app logger is dettached.');
    }
  }

  _getConfigVariables() {
    return {
      'app': this,
      'log': winston,
      'env': this.env
    };
  }

  _getFeatureFallbackPath() {
    return [path.resolve(__dirname, Literal.FEATURES_PATH), this.options.featuresPath ? this.toAbsolutePath(this.options.featuresPath) : this.toAbsolutePath(Literal.FEATURES_PATH)];
  }

  async emitAsync_(event) {
    let asyncHandlers = [];
    this.emit(event, asyncHandlers);

    if (asyncHandlers.length > 0) {
      await Promise.all(asyncHandlers);
    }
  }

  async _loadFeatures_() {
    let configStageFeatures = [];

    _.forOwn(this.config, (featureOptions, name) => {
      if (this.options.allowedFeatures && this.options.allowedFeatures.indexOf(name) === -1) {
        return;
      }

      let feature;

      try {
        feature = this._loadFeature(name);
      } catch (err) {
        console.error(err);
      }

      if (feature && feature.type === Feature.CONF) {
        configStageFeatures.push([name, feature.load_, featureOptions]);
        delete this.config[name];
      }
    });

    if (configStageFeatures.length > 0) {
      configStageFeatures.forEach(([name]) => {
        delete this.config[name];
      });
      await this._loadFeatureGroup_(configStageFeatures, Feature.CONF);
      return this._loadFeatures_();
    }

    let featureGroups = {
      [Feature.INIT]: [],
      [Feature.SERVICE]: [],
      [Feature.PLUGIN]: [],
      [Feature.READY]: []
    };

    _.forOwn(this.config, (featureOptions, name) => {
      if (this.options.allowedFeatures && this.options.allowedFeatures.indexOf(name) === -1) {
        return;
      }

      let feature = this._loadFeature(name);

      if (!(feature.type in featureGroups)) {
        throw new Error(`Invalid feature type. Feature: ${name}, type: ${feature.type}`);
      }

      featureGroups[feature.type].push([name, feature.load_, featureOptions]);
    });

    return eachAsync_(featureGroups, (group, level) => this._loadFeatureGroup_(group, level));
  }

  async _loadFeatureGroup_(featureGroup, groupLevel) {
    await this.emitAsync_('before:' + groupLevel);
    this.log('verbose', `Loading "${groupLevel}" feature group ...`);
    await eachAsync_(featureGroup, async ([name, load_, options]) => {
      await this.emitAsync_('before:load:' + name);
      this.log('verbose', `Loading feature "${name}" ...`);
      await load_(this, options, name);
      this.features[name].loaded = true;
      this.log('verbose', `Feature "${name}" loaded. [OK]`);
      await this.emitAsync_('after:load:' + name);
    });
    this.log('verbose', `Finished loading "${groupLevel}" feature group. [OK]`);
    await this.emitAsync_('after:' + groupLevel);
  }

  _loadFeature(feature) {
    let featureObject = this.features[feature];
    if (featureObject) return featureObject;
    let featurePath;

    if (this._featureRegistry.hasOwnProperty(feature)) {
      let loadOption = this._featureRegistry[feature];

      if (Array.isArray(loadOption)) {
        if (loadOption.length === 0) {
          throw new Error(`Invalid registry value for feature "${feature}".`);
        }

        featurePath = loadOption[0];
        featureObject = require(featurePath);

        if (loadOption.length > 1) {
          featureObject = _.get(featureObject, loadOption[1]);
        }
      } else {
        featurePath = loadOption;
        featureObject = require(featurePath);
      }
    } else {
      let searchingPath = this._featureRegistry['*'];

      let found = _.findLast(searchingPath, p => {
        featurePath = path.join(p, feature + '.js');
        return fs.existsSync(featurePath);
      });

      if (!found) {
        throw new Error(`Don't know where to load feature "${feature}".`);
      }

      featureObject = require(featurePath);
    }

    if (!Feature.validate(featureObject)) {
      throw new Error(`Invalid feature object loaded from "${featurePath}".`);
    }

    this.features[feature] = featureObject;
    return featureObject;
  }

}

module.exports = ServiceContainer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TZXJ2aWNlQ29udGFpbmVyLmpzIl0sIm5hbWVzIjpbIkNvbmZpZ0xvYWRlciIsInJlcXVpcmUiLCJKc29uQ29uZmlnUHJvdmlkZXIiLCJfIiwicHVzaEludG9CdWNrZXQiLCJlYWNoQXN5bmNfIiwiZnMiLCJ0cnlSZXF1aXJlIiwiX3RyeVJlcXVpcmUiLCJwYXRoIiwiRXZlbnRFbWl0dGVyIiwid2luc3RvbiIsIkZlYXR1cmUiLCJMaXRlcmFsIiwiU2VydmljZUNvbnRhaW5lciIsImNvbnN0cnVjdG9yIiwibmFtZSIsIm9wdGlvbnMiLCJsb2dFcnJvciIsImVycm9yIiwibWVzc2FnZSIsImxvZ0V4Y2VwdGlvbiIsImxvZ0Vycm9yQXNXYXJuaW5nIiwiT2JqZWN0IiwiYXNzaWduIiwiZW52IiwicHJvY2VzcyIsIk5PREVfRU5WIiwid29ya2luZ1BhdGgiLCJyZXNvbHZlIiwiY3dkIiwiY29uZmlnUGF0aCIsInRvQWJzb2x1dGVQYXRoIiwiREVGQVVMVF9DT05GSUdfUEFUSCIsImNvbmZpZ05hbWUiLCJBUFBfQ0ZHX05BTUUiLCJzdGFydF8iLCJsb2ciLCJfZmVhdHVyZVJlZ2lzdHJ5IiwiX2dldEZlYXR1cmVGYWxsYmFja1BhdGgiLCJmZWF0dXJlcyIsInNlcnZpY2VzIiwibG9hZENvbmZpZ0Zyb21PcHRpb25zIiwiY29uZmlnIiwiY29uZmlnTG9hZGVyIiwiZGlzYWJsZUVudkF3YXJlQ29uZmlnIiwiam9pbiIsImNyZWF0ZUVudkF3YXJlSnNvbkxvYWRlciIsImxvYWRDb25maWdfIiwiZW1pdCIsImlzRW1wdHkiLCJFcnJvciIsIl9sb2FkRmVhdHVyZXNfIiwic3RhcnRlZCIsInN0b3BfIiwiZW1pdEFzeW5jXyIsInJlbW92ZUFsbExpc3RlbmVycyIsImNvbmZpZ1ZhcmlhYmxlcyIsIl9nZXRDb25maWdWYXJpYWJsZXMiLCJsb2FkXyIsImFyZ3MiLCJsZW5ndGgiLCJwa2dOYW1lIiwicmVnaXN0ZXJTZXJ2aWNlIiwic2VydmljZU9iamVjdCIsIm92ZXJyaWRlIiwiaGFzU2VydmljZSIsImdldFNlcnZpY2UiLCJlbmFibGVkIiwiZmVhdHVyZSIsImhhc093blByb3BlcnR5IiwiYWRkRmVhdHVyZVJlZ2lzdHJ5IiwicmVnaXN0cnkiLCJvbWl0IiwibGV2ZWwiLCJyZXN0IiwibG9nZ2VyIiwic3VtbWFyeSIsInBpY2siLCJyZXBsYWNlTG9nZ2VyIiwiX2xvZ2dlckJhY2t1cCIsIl9leHRlcm5hbExvZ2dlckJhY2t1cCIsIl9leHRlcm5hbExvZ2dlciIsIl9fZGlybmFtZSIsIkZFQVRVUkVTX1BBVEgiLCJmZWF0dXJlc1BhdGgiLCJldmVudCIsImFzeW5jSGFuZGxlcnMiLCJQcm9taXNlIiwiYWxsIiwiY29uZmlnU3RhZ2VGZWF0dXJlcyIsImZvck93biIsImZlYXR1cmVPcHRpb25zIiwiYWxsb3dlZEZlYXR1cmVzIiwiaW5kZXhPZiIsIl9sb2FkRmVhdHVyZSIsImVyciIsImNvbnNvbGUiLCJ0eXBlIiwiQ09ORiIsInB1c2giLCJmb3JFYWNoIiwiX2xvYWRGZWF0dXJlR3JvdXBfIiwiZmVhdHVyZUdyb3VwcyIsIklOSVQiLCJTRVJWSUNFIiwiUExVR0lOIiwiUkVBRFkiLCJncm91cCIsImZlYXR1cmVHcm91cCIsImdyb3VwTGV2ZWwiLCJsb2FkZWQiLCJmZWF0dXJlT2JqZWN0IiwiZmVhdHVyZVBhdGgiLCJsb2FkT3B0aW9uIiwiQXJyYXkiLCJpc0FycmF5IiwiZ2V0Iiwic2VhcmNoaW5nUGF0aCIsImZvdW5kIiwiZmluZExhc3QiLCJwIiwiZXhpc3RzU3luYyIsInZhbGlkYXRlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNQSxZQUFZLEdBQUdDLE9BQU8sQ0FBQyxjQUFELENBQTVCOztBQUNBLE1BQU1DLGtCQUFrQixHQUFHRCxPQUFPLENBQUMscUNBQUQsQ0FBbEM7O0FBQ0EsTUFBTTtBQUFFRSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBLGNBQUw7QUFBcUJDLEVBQUFBO0FBQXJCLElBQW9DSixPQUFP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aWdMb2FkZXIgPSByZXF1aXJlKCdAZ2VueC9jb25maWcnKTtcbmNvbnN0IEpzb25Db25maWdQcm92aWRlciA9IHJlcXVpcmUoJ0BnZW54L2NvbmZpZy9saWIvSnNvbkNvbmZpZ1Byb3ZpZGVyJyk7XG5jb25zdCB7IF8sIHB1c2hJbnRvQnVja2V0LCBlYWNoQXN5bmNfIH0gPSByZXF1aXJlKCdAZ2VueC9qdWx5Jyk7XG5jb25zdCB7IGZzLCB0cnlSZXF1aXJlOiBfdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnQGdlbngvc3lzJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJyk7XG5jb25zdCB3aW5zdG9uID0gcmVxdWlyZSgnd2luc3RvbicpO1xuXG5jb25zdCBGZWF0dXJlID0gcmVxdWlyZSgnLi9lbnVtL0ZlYXR1cmUnKTtcbmNvbnN0IExpdGVyYWwgPSByZXF1aXJlKCcuL2VudW0vTGl0ZXJhbCcpO1xuXG4vKipcbiAqIFNlcnZpY2UgY29udGFpbmVyIGNsYXNzLlxuICogQGNsYXNzXG4gKiBAZXh0ZW5kcyBFdmVudEVtaXR0ZXIgICAgIFxuICovXG5jbGFzcyBTZXJ2aWNlQ29udGFpbmVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBsb2dFcnJvciA9IChlcnJvciwgbWVzc2FnZSkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2dFeGNlcHRpb24oJ2Vycm9yJywgZXJyb3IsIG1lc3NhZ2UpO1xuICAgIH07XG5cbiAgICBsb2dFcnJvckFzV2FybmluZyA9IChlcnJvciwgbWVzc2FnZSkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2dFeGNlcHRpb24oJ3dhcm4nLCBlcnJvciwgbWVzc2FnZSk7XG4gICAgfTsgICAgXG5cbiAgICAvKiogICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGNvbnRhaW5lciBpbnN0YW5jZS4gICAgIFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBDb250YWluZXIgb3B0aW9ucyAgICAgICAgICBcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuZW52XSAtIEVudmlyb25tZW50LCBkZWZhdWx0IHRvIHByb2Nlc3MuZW52Lk5PREVfRU5WXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLndvcmtpbmdQYXRoXSAtIEFwcCdzIHdvcmtpbmcgcGF0aCwgZGVmYXVsdCB0byBwcm9jZXNzLmN3ZCgpXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtvcHRpb25zLmNvbmZpZ1BhdGhdIC0gQXBwJ3MgY29uZmlnIHBhdGgsIGRlZmF1bHQgdG8gXCJjb25mXCIgdW5kZXIgd29ya2luZ1BhdGhcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gW29wdGlvbnMuY29uZmlnTmFtZV0gLSBBcHAncyBjb25maWcgYmFzZW5hbWUsIGRlZmF1bHQgdG8gXCJhcHBcIlxuICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbb3B0aW9ucy5kaXNhYmxlRW52QXdhcmVDb25maWc9ZmFsc2VdIC0gRG9uJ3QgdXNlIGVudmlyb25tZW50LWF3YXJlIGNvbmZpZ1xuICAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IFtvcHRpb25zLmFsbG93ZWRGZWF0dXJlc10gLSBBIGxpc3Qgb2YgZW5hYmxlZCBmZWF0dXJlIG5hbWVzXG4gICAgICogQHByb3BlcnR5IHtib29sZWFufSBbb3B0aW9ucy5sb2FkQ29uZmlnRnJvbU9wdGlvbnM9ZmFsc2VdIC0gV2hldGhlciB0byBsb2FkIGNvbmZpZyBmcm9tIHBhc3NlZC1pbiBvcHRpb25zXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLmNvbmZpZ10gLSBDb25maWcgaW4gb3B0aW9ucywgdXNlZCBvbmx5IHdoZW4gbG9hZENvbmZpZ0Zyb21PcHRpb25zXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobmFtZSwgb3B0aW9ucykge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBOYW1lIG9mIHRoZSBhcHBcbiAgICAgICAgICogQG1lbWJlciB7b2JqZWN0fSAgICAgICAgIFxuICAgICAgICAgKiovXG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7ICAgICAgICAgICAgICAgIFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBcHAgb3B0aW9uc1xuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9ICAgICAgICAgXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHtcbiAgICAgICAgICAgIC8vLi4uIGRlZmF1bHQgb3B0aW9ucyAgICAgICAgICAgIFxuICAgICAgICB9LCBvcHRpb25zKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogRW52aXJvbm1lbnQgZmxhZ1xuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9ICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZW52ID0gdGhpcy5vcHRpb25zLmVudiB8fCBwcm9jZXNzLmVudi5OT0RFX0VOViB8fCBcImRldmVsb3BtZW50XCI7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFdvcmtpbmcgZGlyZWN0b3J5IG9mIHRoaXMgY2xpIGFwcFxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9ICAgICAgICAgXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLndvcmtpbmdQYXRoID0gdGhpcy5vcHRpb25zLndvcmtpbmdQYXRoID8gcGF0aC5yZXNvbHZlKHRoaXMub3B0aW9ucy53b3JraW5nUGF0aCkgOiBwcm9jZXNzLmN3ZCgpOyAgICAgXG4gICAgICAgIFxuICAgICAgICAvKipcbiAgICAgICAgICogQ29uZmlnIHBhdGhcbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfSAgICAgICAgIFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5jb25maWdQYXRoID0gdGhpcy50b0Fic29sdXRlUGF0aCh0aGlzLm9wdGlvbnMuY29uZmlnUGF0aCB8fCBMaXRlcmFsLkRFRkFVTFRfQ09ORklHX1BBVEgpOyAgICAgIFxuICAgICAgICBcbiAgICAgICAgLyoqXG4gICAgICAgICAqIENvbmZpZyBiYXNlbmFtZVxuICAgICAgICAgKiBAbWVtYmVyIHtzdHJpbmd9ICAgICAgICAgXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmNvbmZpZ05hbWUgPSB0aGlzLm9wdGlvbnMuY29uZmlnTmFtZSB8fCBMaXRlcmFsLkFQUF9DRkdfTkFNRTsgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IHRoZSBjb250YWluZXIuXG4gICAgICogQGZpcmVzIFNlcnZpY2VDb250YWluZXIjY29uZmlnTG9hZGVkXG4gICAgICogQGZpcmVzIFNlcnZpY2VDb250YWluZXIjcmVhZHlcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48U2VydmljZUNvbnRhaW5lcj59XG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRfKCkgeyAgIFxuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBTdGFydGluZyBhcHAgWyR7dGhpcy5uYW1lfV0gLi4uYCk7XG4gICAgICAgIFxuICAgICAgICB0aGlzLl9mZWF0dXJlUmVnaXN0cnkgPSB7XG4gICAgICAgICAgICAvL2ZpcnN0bHkgbG9vayB1cCBcImZlYXR1cmVzXCIgdW5kZXIgY3VycmVudCB3b3JraW5nIHBhdGgsIGFuZCB0aGVuIHRyeSB0aGUgYnVpbHRpbiBmZWF0dXJlcyBwYXRoXG4gICAgICAgICAgICAnKic6IHRoaXMuX2dldEZlYXR1cmVGYWxsYmFja1BhdGgoKVxuICAgICAgICB9O1xuICAgICAgICAvKipcbiAgICAgICAgICogTG9hZGVkIGZlYXR1cmVzLCBuYW1lID0+IGZlYXR1cmUgb2JqZWN0XG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH0gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZmVhdHVyZXMgPSB7fTtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIExvYWRlZCBzZXJ2aWNlc1xuICAgICAgICAgKiBAbWVtYmVyIHtvYmplY3R9ICAgICAgICAgXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnNlcnZpY2VzID0ge307ICAgICAgIFxuICAgICAgICBcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2FkQ29uZmlnRnJvbU9wdGlvbnMpIHtcbiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gdGhpcy5vcHRpb25zLmNvbmZpZztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogQ29uZmlndXJhdGlvbiBsb2FkZXIgaW5zdGFuY2VcbiAgICAgICAgICAgICAqIEBtZW1iZXIge0NvbmZpZ0xvYWRlcn0gICAgICAgICBcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgdGhpcy5jb25maWdMb2FkZXIgPSB0aGlzLm9wdGlvbnMuZGlzYWJsZUVudkF3YXJlQ29uZmlnID8gXG4gICAgICAgICAgICAgICAgbmV3IENvbmZpZ0xvYWRlcihuZXcgSnNvbkNvbmZpZ1Byb3ZpZGVyKHBhdGguam9pbih0aGlzLmNvbmZpZ1BhdGgsIHRoaXMuY29uZmlnTmFtZSArICcuanNvbicpKSwgdGhpcykgOiBcbiAgICAgICAgICAgICAgICBDb25maWdMb2FkZXIuY3JlYXRlRW52QXdhcmVKc29uTG9hZGVyKHRoaXMuY29uZmlnUGF0aCwgdGhpcy5jb25maWdOYW1lLCB0aGlzLmVudiwgdGhpcyk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGF3YWl0IHRoaXMubG9hZENvbmZpZ18oKTsgICAgIFxuICAgICAgICB9ICAgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIENvbmZpZyBsb2FkZWQgZXZlbnQuXG4gICAgICAgICAqIEBldmVudCBTZXJ2aWNlQ29udGFpbmVyI2NvbmZpZ0xvYWRlZFxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5lbWl0KCdjb25maWdMb2FkZWQnKTtcblxuICAgICAgICBpZiAoXy5pc0VtcHR5KHRoaXMuY29uZmlnKSkge1xuICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ0VtcHR5IGNvbmZpZ3VyYXRpb24uIE5vdGhpbmcgdG8gZG8hIENvbmZpZyBwYXRoOiAnICsgdGhpcy5jb25maWdQYXRoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHRoaXMuX2xvYWRGZWF0dXJlc18oKTsgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFwcCByZWFkeVxuICAgICAgICAgKiBAZXZlbnQgU2VydmljZUNvbnRhaW5lciNyZWFkeVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5lbWl0KCdyZWFkeScpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBGbGFnIHNob3dpbmcgdGhlIGFwcCBpcyBzdGFydGVkIG9yIG5vdC5cbiAgICAgICAgICogQG1lbWJlciB7Ym9vbH1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc3RhcnRlZCA9IHRydWU7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdG9wIHRoZSBjb250YWluZXJcbiAgICAgKiBAZmlyZXMgU2VydmljZUNvbnRhaW5lciNzdG9wcGluZ1xuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxTZXJ2aWNlQ29udGFpbmVyPn1cbiAgICAgKi9cbiAgICBhc3luYyBzdG9wXygpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFwcCBzdG9wcGluZ1xuICAgICAgICAgKiBAZXZlbnQgU2VydmljZUNvbnRhaW5lciNzdG9wcGluZ1xuICAgICAgICAgKi9cbiAgICAgICAgYXdhaXQgdGhpcy5lbWl0QXN5bmNfKCdzdG9wcGluZycpO1xuXG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYFN0b3BwaW5nIGFwcCBbJHt0aGlzLm5hbWV9XSAuLi5gKTtcblxuICAgICAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTtcblxuICAgICAgICBkZWxldGUgdGhpcy5zZXJ2aWNlcztcbiAgICAgICAgZGVsZXRlIHRoaXMuZmVhdHVyZXM7XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9mZWF0dXJlUmVnaXN0cnk7XG5cbiAgICAgICAgZGVsZXRlIHRoaXMuY29uZmlnO1xuICAgICAgICBkZWxldGUgdGhpcy5jb25maWdMb2FkZXI7ICBcblxuICAgICAgICBhd2FpdCB0aGlzLmVtaXRBc3luY18oJ3N0b3BwZWQnKTtcblxuICAgICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEByZXR1cm5zIHtTZXJ2aWNlQ29udGFpbmVyfVxuICAgICAqL1xuICAgIGFzeW5jIGxvYWRDb25maWdfKCkge1xuICAgICAgICBsZXQgY29uZmlnVmFyaWFibGVzID0gdGhpcy5fZ2V0Q29uZmlnVmFyaWFibGVzKCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFwcCBjb25maWd1cmF0aW9uXG4gICAgICAgICAqIEBtZW1iZXIge29iamVjdH0gICAgICAgICBcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuY29uZmlnID0gYXdhaXQgdGhpcy5jb25maWdMb2FkZXIubG9hZF8oY29uZmlnVmFyaWFibGVzKTsgICBcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUcmFuc2xhdGUgYSByZWxhdGl2ZSBwYXRoIG9mIHRoaXMgYXBwIG1vZHVsZSB0byBhbiBhYnNvbHV0ZSBwYXRoICAgICBcbiAgICAgKiBAcGFyYW0ge2FycmF5fSBhcmdzIC0gQXJyYXkgb2YgcGF0aCBwYXJ0c1xuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAgICovXG4gICAgdG9BYnNvbHV0ZVBhdGgoLi4uYXJncykge1xuICAgICAgICBpZiAoYXJncy5sZW5ndGggPT09IDAgfHwgYXJnc1swXSA9PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy53b3JraW5nUGF0aDtcbiAgICAgICAgfSAgICAgICBcblxuICAgICAgICByZXR1cm4gcGF0aC5yZXNvbHZlKHRoaXMud29ya2luZ1BhdGgsIC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIHRyeVJlcXVpcmUocGtnTmFtZSkge1xuICAgICAgICByZXR1cm4gX3RyeVJlcXVpcmUocGtnTmFtZSwgdGhpcy53b3JraW5nUGF0aCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVnaXN0ZXIgYSBzZXJ2aWNlICAgICBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzZXJ2aWNlT2JqZWN0XG4gICAgICogQHBhcmFtIHtib29sZWFufSBvdmVycmlkZVxuICAgICAqL1xuICAgIHJlZ2lzdGVyU2VydmljZShuYW1lLCBzZXJ2aWNlT2JqZWN0LCBvdmVycmlkZSkge1xuICAgICAgICBpZiAobmFtZSBpbiB0aGlzLnNlcnZpY2VzICYmICFvdmVycmlkZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTZXJ2aWNlIFwiJysgbmFtZSArJ1wiIGFscmVhZHkgcmVnaXN0ZXJlZCEnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc2VydmljZXNbbmFtZV0gPSBzZXJ2aWNlT2JqZWN0O1xuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBTZXJ2aWNlIFwiJHtuYW1lfVwiIHJlZ2lzdGVyZWQuYCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIHdoZXRoZXIgYSBzZXJ2aWNlIGV4aXN0c1xuICAgICAqIEBwYXJhbSB7Kn0gbmFtZSBcbiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBoYXNTZXJ2aWNlKG5hbWUpIHtcbiAgICAgICAgcmV0dXJuIG5hbWUgaW4gdGhpcy5zZXJ2aWNlcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgYSBzZXJ2aWNlIGZyb20gbW9kdWxlIGhpZXJhcmNoeSAgICAgXG4gICAgICogQHBhcmFtIG5hbWVcbiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fVxuICAgICAqL1xuICAgIGdldFNlcnZpY2UobmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5zZXJ2aWNlc1tuYW1lXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayB3aGV0aGVyIGEgZmVhdHVyZSBpcyBlbmFibGVkIGluIHRoZSBhcHAuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGZlYXR1cmUgXG4gICAgICogQHJldHVybnMge2Jvb2x9XG4gICAgICovXG4gICAgZW5hYmxlZChmZWF0dXJlKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmZlYXR1cmVzLmhhc093blByb3BlcnR5KGZlYXR1cmUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBtb3JlIG9yIG92ZXJpZGUgY3VycmVudCBmZWF0dXJlIHJlZ2lzdHJ5XG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJlZ2lzdHJ5IFxuICAgICAqL1xuICAgIGFkZEZlYXR1cmVSZWdpc3RyeShyZWdpc3RyeSkge1xuICAgICAgICAvLyAqIGlzIHVzZWQgYXMgdGhlIGZhbGxiYWNrIGxvY2F0aW9uIHRvIGZpbmQgYSBmZWF0dXJlXG4gICAgICAgIGlmIChyZWdpc3RyeS5oYXNPd25Qcm9wZXJ0eSgnKicpKSB7XG4gICAgICAgICAgICBwdXNoSW50b0J1Y2tldCh0aGlzLl9mZWF0dXJlUmVnaXN0cnksICcqJywgcmVnaXN0cnlbJyonXSk7XG4gICAgICAgIH1cblxuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMuX2ZlYXR1cmVSZWdpc3RyeSwgXy5vbWl0KHJlZ2lzdHJ5LCBbJyonXSkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERlZmF1bHQgbG9nIG1ldGhvZCwgbWF5IGJlIG92ZXJyaWRlIGJ5IGxvZ2dlcnMgZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSAtIExvZyBsZXZlbFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSAtIExvZyBtZXNzYWdlXG4gICAgICogQHBhcmFtIHsuLi5vYmplY3R9IC0gRXh0cmEgbWV0YSBkYXRhXG4gICAgICogQHJldHVybnMge1NlcnZpY2VDb250YWluZXJ9XG4gICAgICovXG4gICAgbG9nKGxldmVsLCBtZXNzYWdlLCAuLi5yZXN0KSB7XG4gICAgICAgIHRoaXMubG9nZ2VyICYmIHRoaXMubG9nZ2VyLmxvZyhsZXZlbCwgbWVzc2FnZSwgLi4ucmVzdCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGxvZ0V4Y2VwdGlvbihsZXZlbCwgZXJyb3IsIHN1bW1hcnkpIHtcbiAgICAgICAgdGhpcy5sb2cobGV2ZWwsIChzdW1tYXJ5ID8gKHN1bW1hcnkgKyAnXFxuJykgOiAnJykgKyBlcnJvci5tZXNzYWdlLCBfLnBpY2soZXJyb3IsIFsgJ25hbWUnLCAnc3RhdHVzJywgJ2NvZGUnLCAnaW5mbycsICdzdGFjaycsICdyZXF1ZXN0JyBdKSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH07XG5cbiAgICAgLyoqXG4gICAgICogUmVwbGFjZSB0aGUgZGVmYXVsdCBsb2dnZXIgc2V0IG9uIGNyZWF0aW9uIG9mIHRoZSBhcHAuXG4gICAgICogQHBhcmFtIHtMb2dnZXJ9IGxvZ2dlciBcbiAgICAgKiBAbWVtYmVyb2YgU2VydmljZUNvbnRhaW5lclxuICAgICAqL1xuICAgIHJlcGxhY2VMb2dnZXIobG9nZ2VyKSB7XG4gICAgICAgIGlmIChsb2dnZXIpIHtcbiAgICAgICAgICAgIGFzc2VydDogIXRoaXMuX2xvZ2dlckJhY2t1cDtcblxuICAgICAgICAgICAgdGhpcy5fbG9nZ2VyQmFja3VwID0gdGhpcy5sb2dnZXI7XG4gICAgICAgICAgICB0aGlzLl9leHRlcm5hbExvZ2dlckJhY2t1cCA9IHRoaXMuX2V4dGVybmFsTG9nZ2VyO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcbiAgICAgICAgICAgIHRoaXMuX2V4dGVybmFsTG9nZ2VyID0gdHJ1ZTtcblxuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnQSBuZXcgYXBwIGxvZ2dlciBhdHRhY2hlZC4nKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyID0gdGhpcy5fbG9nZ2VyQmFja3VwO1xuICAgICAgICAgICAgdGhpcy5fZXh0ZXJuYWxMb2dnZXIgPSB0aGlzLl9leHRlcm5hbExvZ2dlckJhY2t1cDtcblxuICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2xvZ2dlckJhY2t1cDtcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9leHRlcm5hbExvZ2dlckJhY2t1cDtcblxuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnVGhlIGN1cnJlbnQgYXBwIGxvZ2dlciBpcyBkZXR0YWNoZWQuJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfZ2V0Q29uZmlnVmFyaWFibGVzKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgJ2FwcCc6IHRoaXMsICAgICAgICAgICAgXG4gICAgICAgICAgICAnbG9nJzogd2luc3RvbixcbiAgICAgICAgICAgICdlbnYnOiB0aGlzLmVudlxuICAgICAgICB9O1xuICAgIH1cblxuICAgIF9nZXRGZWF0dXJlRmFsbGJhY2tQYXRoKCkge1xuICAgICAgICByZXR1cm4gWyBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBMaXRlcmFsLkZFQVRVUkVTX1BBVEgpLCB0aGlzLm9wdGlvbnMuZmVhdHVyZXNQYXRoID8gdGhpcy50b0Fic29sdXRlUGF0aCh0aGlzLm9wdGlvbnMuZmVhdHVyZXNQYXRoKSA6IHRoaXMudG9BYnNvbHV0ZVBhdGgoTGl0ZXJhbC5GRUFUVVJFU19QQVRIKSBdO1xuICAgIH1cblxuICAgIGFzeW5jIGVtaXRBc3luY18oZXZlbnQpIHtcbiAgICAgICAgbGV0IGFzeW5jSGFuZGxlcnMgPSBbXTtcbiAgICAgICAgdGhpcy5lbWl0KGV2ZW50LCBhc3luY0hhbmRsZXJzKTtcbiAgICAgICAgaWYgKGFzeW5jSGFuZGxlcnMubGVuZ3RoID4gMCkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoYXN5bmNIYW5kbGVycyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogTG9hZCBmZWF0dXJlc1xuICAgICAqIEBwcml2YXRlICAgICBcbiAgICAgKiBAcmV0dXJucyB7Ym9vbH1cbiAgICAgKi9cbiAgICBhc3luYyBfbG9hZEZlYXR1cmVzXygpIHsgICAgICAgXG4gICAgICAgIC8vIHJ1biBjb25maWcgc3RhZ2Ugc2VwYXJhdGVseSBmaXJzdFxuICAgICAgICBsZXQgY29uZmlnU3RhZ2VGZWF0dXJlcyA9IFtdOyAgICAgICAgXG5cbiAgICAgICAgLy8gbG9hZCBmZWF0dXJlc1xuICAgICAgICBfLmZvck93bih0aGlzLmNvbmZpZywgKGZlYXR1cmVPcHRpb25zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmFsbG93ZWRGZWF0dXJlcyAmJlxuICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5hbGxvd2VkRmVhdHVyZXMuaW5kZXhPZihuYW1lKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAvL3NraXAgZGlzYWJsZWQgZmVhdHVyZXNcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBmZWF0dXJlO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBmZWF0dXJlID0gdGhpcy5fbG9hZEZlYXR1cmUobmFtZSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgeyAgICAgXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpOyAgICAgICAgICAgXG4gICAgICAgICAgICB9ICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChmZWF0dXJlICYmIGZlYXR1cmUudHlwZSA9PT0gRmVhdHVyZS5DT05GKSB7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNvbmZpZ1N0YWdlRmVhdHVyZXMucHVzaChbIG5hbWUsIGZlYXR1cmUubG9hZF8sIGZlYXR1cmVPcHRpb25zIF0pO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNvbmZpZ1tuYW1lXTtcbiAgICAgICAgICAgIH0gICAgXG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBpZiAoY29uZmlnU3RhZ2VGZWF0dXJlcy5sZW5ndGggPiAwKSB7ICAgICAgXG4gICAgICAgICAgICAvL2NvbmZpZ3VyYXRpb24gZmVhdHVyZXMgd2lsbCBiZSBvdmVycmlkZWQgYnkgbmV3bHkgbG9hZGVkIGNvbmZpZ1xuICAgICAgICAgICAgY29uZmlnU3RhZ2VGZWF0dXJlcy5mb3JFYWNoKChbIG5hbWUgXSkgPT4geyBkZWxldGUgdGhpcy5jb25maWdbbmFtZV07IH0pO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9sb2FkRmVhdHVyZUdyb3VwXyhjb25maWdTdGFnZUZlYXR1cmVzLCBGZWF0dXJlLkNPTkYpO1xuXG4gICAgICAgICAgICAvL3JlbG9hZCBhbGwgZmVhdHVyZXMgaWYgYW55IHR5cGUgb2YgY29uZmlndXJhdGlvbiBmZWF0dXJlIGV4aXN0cyAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xvYWRGZWF0dXJlc18oKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBmZWF0dXJlR3JvdXBzID0geyAgICAgICAgICAgIFxuICAgICAgICAgICAgW0ZlYXR1cmUuSU5JVF06IFtdLCAgICAgICAgICAgIFxuICAgICAgICAgICAgW0ZlYXR1cmUuU0VSVklDRV06IFtdLCAgICAgICAgICAgIFxuICAgICAgICAgICAgW0ZlYXR1cmUuUExVR0lOXTogW10sXG4gICAgICAgICAgICBbRmVhdHVyZS5SRUFEWV06IFtdXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gbG9hZCBmZWF0dXJlc1xuICAgICAgICBfLmZvck93bih0aGlzLmNvbmZpZywgKGZlYXR1cmVPcHRpb25zLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmFsbG93ZWRGZWF0dXJlcyAmJlxuICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5hbGxvd2VkRmVhdHVyZXMuaW5kZXhPZihuYW1lKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAvL3NraXAgZGlzYWJsZWQgZmVhdHVyZXNcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBmZWF0dXJlID0gdGhpcy5fbG9hZEZlYXR1cmUobmFtZSk7XG5cbiAgICAgICAgICAgIGlmICghKGZlYXR1cmUudHlwZSBpbiBmZWF0dXJlR3JvdXBzKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBmZWF0dXJlIHR5cGUuIEZlYXR1cmU6ICR7bmFtZX0sIHR5cGU6ICR7ZmVhdHVyZS50eXBlfWApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmZWF0dXJlR3JvdXBzW2ZlYXR1cmUudHlwZV0ucHVzaChbIG5hbWUsIGZlYXR1cmUubG9hZF8sIGZlYXR1cmVPcHRpb25zIF0pO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gZWFjaEFzeW5jXyhmZWF0dXJlR3JvdXBzLCAoZ3JvdXAsIGxldmVsKSA9PiB0aGlzLl9sb2FkRmVhdHVyZUdyb3VwXyhncm91cCwgbGV2ZWwpKTtcbiAgICB9XG5cbiAgICBhc3luYyBfbG9hZEZlYXR1cmVHcm91cF8oZmVhdHVyZUdyb3VwLCBncm91cExldmVsKSB7ICAgICAgICBcbiAgICAgICAgYXdhaXQgdGhpcy5lbWl0QXN5bmNfKCdiZWZvcmU6JyArIGdyb3VwTGV2ZWwpO1xuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBMb2FkaW5nIFwiJHtncm91cExldmVsfVwiIGZlYXR1cmUgZ3JvdXAgLi4uYCk7XG5cbiAgICAgICAgYXdhaXQgZWFjaEFzeW5jXyhmZWF0dXJlR3JvdXAsIGFzeW5jIChbIG5hbWUsIGxvYWRfLCBvcHRpb25zIF0pID0+IHsgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmVtaXRBc3luY18oJ2JlZm9yZTpsb2FkOicgKyBuYW1lKTtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgYExvYWRpbmcgZmVhdHVyZSBcIiR7bmFtZX1cIiAuLi5gKTtcblxuICAgICAgICAgICAgYXdhaXQgbG9hZF8odGhpcywgb3B0aW9ucywgbmFtZSk7ICAgXG4gICAgICAgICAgICB0aGlzLmZlYXR1cmVzW25hbWVdLmxvYWRlZCA9IHRydWU7ICAgICAgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsIGBGZWF0dXJlIFwiJHtuYW1lfVwiIGxvYWRlZC4gW09LXWApO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmVtaXRBc3luY18oJ2FmdGVyOmxvYWQ6JyArIG5hbWUpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCBgRmluaXNoZWQgbG9hZGluZyBcIiR7Z3JvdXBMZXZlbH1cIiBmZWF0dXJlIGdyb3VwLiBbT0tdYCk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5lbWl0QXN5bmNfKCdhZnRlcjonICsgZ3JvdXBMZXZlbCk7XG4gICAgfSAgICBcblxuICAgIC8qKlxuICAgICAqIExvYWQgYSBmZWF0dXJlIG9iamVjdCBieSBuYW1lLlxuICAgICAqIEBwcml2YXRlXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGZlYXR1cmUgXG4gICAgICogQHJldHVybnMge29iamVjdH0gICAgIFxuICAgICAqL1xuICAgIF9sb2FkRmVhdHVyZShmZWF0dXJlKSB7XG4gICAgICAgIGxldCBmZWF0dXJlT2JqZWN0ID0gdGhpcy5mZWF0dXJlc1tmZWF0dXJlXTtcbiAgICAgICAgaWYgKGZlYXR1cmVPYmplY3QpIHJldHVybiBmZWF0dXJlT2JqZWN0O1xuXG4gICAgICAgIGxldCBmZWF0dXJlUGF0aDtcblxuICAgICAgICBpZiAodGhpcy5fZmVhdHVyZVJlZ2lzdHJ5Lmhhc093blByb3BlcnR5KGZlYXR1cmUpKSB7ICAgICAgICAgIFxuICAgICAgICAgICAgLy9sb2FkIGJ5IHJlZ2lzdHJ5IGVudHJ5XG4gICAgICAgICAgICBsZXQgbG9hZE9wdGlvbiA9IHRoaXMuX2ZlYXR1cmVSZWdpc3RyeVtmZWF0dXJlXTsgICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobG9hZE9wdGlvbikpIHtcbiAgICAgICAgICAgICAgICBpZiAobG9hZE9wdGlvbi5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHJlZ2lzdHJ5IHZhbHVlIGZvciBmZWF0dXJlIFwiJHtmZWF0dXJlfVwiLmApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGZlYXR1cmVQYXRoID0gbG9hZE9wdGlvblswXTtcbiAgICAgICAgICAgICAgICBmZWF0dXJlT2JqZWN0ID0gcmVxdWlyZShmZWF0dXJlUGF0aCk7XG5cbiAgICAgICAgICAgICAgICBpZiAobG9hZE9wdGlvbi5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vb25lIG1vZHVsZSBtYXkgY29udGFpbnMgbW9yZSB0aGFuIG9uZSBmZWF0dXJlXG4gICAgICAgICAgICAgICAgICAgIGZlYXR1cmVPYmplY3QgPSBfLmdldChmZWF0dXJlT2JqZWN0LCBsb2FkT3B0aW9uWzFdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZlYXR1cmVQYXRoID0gbG9hZE9wdGlvbjtcbiAgICAgICAgICAgICAgICBmZWF0dXJlT2JqZWN0ID0gcmVxdWlyZShmZWF0dXJlUGF0aCk7XG4gICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vbG9hZCBieSBmYWxsYmFjayBwYXRoc1xuICAgICAgICAgICAgbGV0IHNlYXJjaGluZ1BhdGggPSB0aGlzLl9mZWF0dXJlUmVnaXN0cnlbJyonXTtcbiAgICBcbiAgICAgICAgICAgIC8vcmV2ZXJzZSBmYWxsYmFjayBzdGFja1xuICAgICAgICAgICAgbGV0IGZvdW5kID0gXy5maW5kTGFzdChzZWFyY2hpbmdQYXRoLCBwID0+IHtcbiAgICAgICAgICAgICAgICBmZWF0dXJlUGF0aCA9IHBhdGguam9pbihwLCBmZWF0dXJlICsgJy5qcycpO1xuICAgICAgICAgICAgICAgIHJldHVybiBmcy5leGlzdHNTeW5jKGZlYXR1cmVQYXRoKTtcbiAgICAgICAgICAgIH0pOyAgICAgICAgXG5cbiAgICAgICAgICAgIGlmICghZm91bmQpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYERvbid0IGtub3cgd2hlcmUgdG8gbG9hZCBmZWF0dXJlIFwiJHtmZWF0dXJlfVwiLmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmZWF0dXJlT2JqZWN0ID0gcmVxdWlyZShmZWF0dXJlUGF0aCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmICghRmVhdHVyZS52YWxpZGF0ZShmZWF0dXJlT2JqZWN0KSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGZlYXR1cmUgb2JqZWN0IGxvYWRlZCBmcm9tIFwiJHtmZWF0dXJlUGF0aH1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZmVhdHVyZXNbZmVhdHVyZV0gPSBmZWF0dXJlT2JqZWN0O1xuICAgICAgICByZXR1cm4gZmVhdHVyZU9iamVjdDtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gU2VydmljZUNvbnRhaW5lcjsiXX0=