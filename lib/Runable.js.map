{"version":3,"sources":["../src/Runable.js"],"names":["_","sleep_","eachAsync_","require","winston","winstonFlight","Logger","Runable","T","constructor","name","options","logger","format","combine","colorize","simple","exitOnUncaught","omit","exitOnError","err","waitForLogging","setTimeout","process","exit","log","clearTimeout","logError","warning","message","code","started","stop_","catch","start_","_initialize","on","_onExit","libModules","lib","removeListener","_uninitialize","getLib","libName","Error","libModule","requireFromLib","relativePath","registerLib","_pwd","cwd","workingPath","chdir","_injectLogger","_injectErrorHandlers","detach","_externalLogger","close","loggerOpt","cloneDeep","transports","createLogger","_onWarning","_onUncaughtException","ignoreUncaught","_getOnUncaughtException","module","exports"],"mappings":"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","sourcesContent":["\"use strict\";\n\nconst { _, sleep_, eachAsync_ } = require('@genx/july');\n\nconst winston = require('winston');\nconst winstonFlight = require('winstonflight');\nconst Logger = require('winston/lib/winston/logger');\n\n/**\n * Runable app mixin. \n * @param {object} T - Base class.     \n * @returns {Runable} A runable app class.\n * @constructs Runable(T)\n */\nconst Runable = T => class extends T {\n    _getOnUncaughtException = exitOnError => err => {\n        if (exitOnError) {\n            //wait 1 second for flushing the last log\n            let waitForLogging = setTimeout(() => {\n                process.exit(1);\n            }, 1000);\n\n            this.log('error', err, () => {\n                clearTimeout(waitForLogging);\n                process.exit(1);\n            });\n        } else {\n            this.logError(err);\n        }\n    };        \n\n    _onWarning = warning => {\n        this.log('warn', warning.message);   \n    };\n\n    _onExit = code => {\n        if (this.started) {\n            this.stop_().catch(this.logError);\n        }           \n    };\n\n    /**                 \n     * @param {string} name - The name of the application.     \n     * @param {object} [options] - Application options     \n     * @property {object} [options.logger] - Logger options    \n     * @property {object} [options.ignoreUncaught=false] - Whether to skip the handling of uncaught exception\n     * @property {object} [options.exitOnUncaught=true] - Whether to exit process on uncaught exception thrown\n     * @constructs Runable\n     */\n    constructor(name, options) {\n        super(name, {\n            logger: {\n                \"useMetaKey\": \"metadata\",\n                \"level\": \"info\",\n                \"transports\": [\n                    {\n                        \"type\": \"console\",\n                        \"options\": {                            \n                            \"format\": winston.format.combine(winston.format.colorize(), winston.format.simple())\n                        }\n                    }\n                ],\n                ...(options && options.logger)\n            },\n            exitOnUncaught: true,\n            ..._.omit(options, ['logger'])\n        });        \n    }\n\n    /**\n     * Start the app     \n     * @returns {Promise}\n     * @memberof Runable\n     */\n    async start_() {        \n        this._initialize();\n\n        process.on('exit', this._onExit);\n        \n        return super.start_();\n    }\n\n    /**\n     * Stop the app\n     * @returns {Promise}\n     * @memberof Runable\n     */\n    async stop_() {\n        if (this.started) {            \n            if (this.libModules) {\n                await eachAsync_(this.libModules, lib => lib.stop_());\n                delete this.libModules;\n            }\n        }\n\n        process.removeListener('exit', this._onExit);\n\n        await super.stop_();\n\n        await sleep_(0);\n\n        this._uninitialize();\n    }\n\n    /**\n     * Get the lib module\n     * @param {string} libName \n     */\n    getLib(libName) {\n        if (!this.libModules) {\n            throw new Error('\"libModules\" feature is required to access lib among modules.');\n        }\n\n        let libModule = this.libModules[libName];\n        \n        if (!libModule) {\n            throw new Error(`Lib module [${libName}] not found.`);\n        }\n\n        return libModule;\n    }\n\n    /**\n     * Require a module from the source path of a library module\n     * @param {*} relativePath \n     */\n    requireFromLib(libName, relativePath) {\n        let libModule = this.getLib(libName);\n        return libModule.require(relativePath);\n    }\n\n    /**\n     * Register a loaded lib module\n     * @param {LibModule} lib \n     */\n    registerLib(lib) {\n        if (!this.libModules) {\n            this.libModules = {};\n        }\n\n        this.libModules[lib.name] = lib;\n    }\n\n    _initialize() {\n        this._pwd = process.cwd();\n        if (this.workingPath !== this._pwd) {                   \n            process.chdir(this.workingPath);\n        }      \n\n        this._injectLogger();\n        this._injectErrorHandlers(); \n    }\n\n    _uninitialize() {\n        const detach = true;\n        this._injectErrorHandlers(detach);       \n        this._injectLogger(detach);         \n\n        process.chdir(this._pwd);\n        delete this._pwd;\n    }\n\n    _injectLogger(detach) {\n        if (detach) {\n            this.log('verbose', 'Logger is detaching ...');\n\n            if (!this._externalLogger) {\n                this.logger.close();\n            }\n\n            delete this._externalLogger;\n            delete this.logger;\n            return;\n        }\n\n        if (this.options.logger instanceof Logger) {\n            this.logger = this.options.logger;\n            this._externalLogger = true;\n        } else {        \n            const loggerOpt = _.cloneDeep(this.options.logger)\n\n            if (loggerOpt.transports) {                \n                loggerOpt.transports = winstonFlight(winston, loggerOpt.transports);\n            }\n\n            this.logger = winston.createLogger(loggerOpt);   \n        }\n        \n        this.log('verbose', 'Logger injected.');            \n    }\n\n    _injectErrorHandlers(detach) {\n        if (detach) {            \n            process.removeListener('warning', this._onWarning);\n            if (this._onUncaughtException) {\n                process.removeListener('uncaughtException', this._onUncaughtException);\n                delete this._onUncaughtException;\n            }\n            this.log('verbose', 'Process-wide error handlers detached.');\n            return;\n        }\n\n        if (!this.options.ignoreUncaught) {\n            this._onUncaughtException = this._getOnUncaughtException(this.options.exitOnUncaught);\n            process.on('uncaughtException', this._onUncaughtException);     \n        }\n        \n        process.on('warning', this._onWarning);\n        this.log('verbose', 'Process-wide error handlers injected.');            \n    }\n};\n\nmodule.exports = Runable;"],"file":"Runable.js"}