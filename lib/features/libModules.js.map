{"version":3,"sources":["../../src/features/libModules.js"],"names":["path","require","_","eachAsync_","fs","Feature","InvalidConfiguration","module","exports","type","PLUGIN","load_","app","entries","LibModule","tryRequire","config","name","options","Object","assign","env","logWithAppName","appPath","npmModule","toAbsolutePath","appModulesPath","join","exists","pathExists","stat","isDirectory","lib","on","isEmpty","settings","log","relativePath","relative","workingPath","start_","registerLib"],"mappings":"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","sourcesContent":["\"use strict\";\n\n/**\n * Load lib modules\n * @module Feature_LibModules\n *\n * @example\n *\n *  'libModules': {\n *      '<name>': {\n *          npmModule: false, // whether is a npm module\n *          options: { // module options\n *          },\n *          settings: { // can override module defined settings\n *          }\n *      }\n *  }\n */\n\nconst path = require(\"path\");\nconst { _, eachAsync_ } = require(\"@genx/july\");\nconst { fs } = require(\"@genx/sys\");\nconst Feature = require(\"../enum/Feature\");\nconst { InvalidConfiguration } = require(\"@genx/error\");\n\nmodule.exports = {\n    /**\n     * This feature is loaded at plugin stage.\n     * @member {string}\n     */\n    type: Feature.PLUGIN,\n\n    /**\n     * Load the feature.\n     * @param {App} app - The app module object.\n     * @param {object} entries - Lib module entries.\n     * @returns {Promise.<*>}\n     */\n    load_: async (app, entries) => {\n        const { LibModule } = app.tryRequire('@genx/server');\n\n        return eachAsync_(entries, async (config, name) => {\n            let options = Object.assign(\n                {\n                    env: app.env,\n                    logWithAppName: app.options.logWithAppName,\n                },\n                config.options\n            );\n\n            let appPath;\n\n            if (config.npmModule) {\n                appPath = app.toAbsolutePath(\"node_modules\", name);\n            } else {\n                const appModulesPath = app.appModulesPath || app.toAbsolutePath(app.options.appModulesPath);                \n                appPath = path.join(appModulesPath, name);\n            }\n\n            let exists = (await fs.pathExists(appPath)) && (await fs.stat(appPath)).isDirectory();\n            if (!exists) {\n                throw new InvalidConfiguration(`Lib [${name}] not exists.`, app, `libModules.${name}`);\n            }\n\n            let lib = new LibModule(app, name, appPath, options);\n\n            lib.on(\"configLoaded\", () => {\n                if (!_.isEmpty(config.settings)) {\n                    lib.config.settings = Object.assign({}, lib.config.settings, config.settings);\n                    app.log(\"verbose\", `Lib settings of [${lib.name}] is overrided.`);\n                }\n            });\n\n            let relativePath = path.relative(app.workingPath, appPath);\n            app.log(\"verbose\", `Loading lib [${lib.name}] from \"${relativePath}\" ...`);\n\n            await lib.start_();\n\n            app.registerLib(lib);\n\n            app.log(\"verbose\", `Lib [${lib.name}] is loaded.`);\n        });\n    },\n};\n"],"file":"libModules.js"}