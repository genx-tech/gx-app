{"version":3,"file":"libModules.js","names":["require","path","_","eachAsync_","fs","Feature","InvalidConfiguration","module","exports","type","PLUGIN","load_","app","entries","LibModule","tryRequire","config","name","options","Object","assign","env","logWithAppName","appPath","npmModule","toAbsolutePath","appModulesPath","join","exists","pathExists","stat","isDirectory","lib","on","isEmpty","settings","log","relativePath","relative","workingPath","start_","registerLib"],"sources":["../../src/features/libModules.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Load lib modules\n * @module Feature_LibModules\n *\n * @example\n *\n *  'libModules': {\n *      '<name>': {\n *          npmModule: false, // whether is a npm module\n *          options: { // module options\n *          },\n *          settings: { // can override module defined settings\n *          }\n *      }\n *  }\n */\n\nconst path = require(\"path\");\nconst { _, eachAsync_ } = require(\"@genx/july\");\nconst { fs } = require(\"@genx/sys\");\nconst Feature = require(\"../enum/Feature\");\nconst { InvalidConfiguration } = require(\"@genx/error\");\n\nmodule.exports = {\n    /**\n     * This feature is loaded at plugin stage.\n     * @member {string}\n     */\n    type: Feature.PLUGIN,\n\n    /**\n     * Load the feature.\n     * @param {App} app - The app module object.\n     * @param {object} entries - Lib module entries.\n     * @returns {Promise.<*>}\n     */\n    load_: async (app, entries) => {\n        const { LibModule } = app.tryRequire('@genx/server');\n\n        return eachAsync_(entries, async (config, name) => {\n            let options = Object.assign(\n                {\n                    env: app.env,\n                    logWithAppName: app.options.logWithAppName,\n                },\n                config.options\n            );\n\n            let appPath;\n\n            if (config.npmModule) {\n                appPath = app.toAbsolutePath(\"node_modules\", name);\n            } else {\n                const appModulesPath = app.appModulesPath || app.toAbsolutePath(app.options.appModulesPath);                \n                appPath = path.join(appModulesPath, name);\n            }\n\n            let exists = (await fs.pathExists(appPath)) && (await fs.stat(appPath)).isDirectory();\n            if (!exists) {\n                throw new InvalidConfiguration(`Lib [${name}] not exists.`, app, `libModules.${name}`);\n            }\n\n            let lib = new LibModule(app, name, appPath, options);\n\n            lib.on(\"configLoaded\", () => {\n                if (!_.isEmpty(config.settings)) {\n                    lib.config.settings = Object.assign({}, lib.config.settings, config.settings);\n                    app.log(\"verbose\", `Lib settings of [${lib.name}] is overrided.`);\n                }\n            });\n\n            let relativePath = path.relative(app.workingPath, appPath);\n            app.log(\"verbose\", `Loading lib [${lib.name}] from \"${relativePath}\" ...`);\n\n            await lib.start_();\n\n            app.registerLib(lib);\n\n            app.log(\"verbose\", `Lib [${lib.name}] is loaded.`);\n        });\n    },\n};\n"],"mappings":"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"}