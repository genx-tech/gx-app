{"version":3,"sources":["../../src/features/superTest.js"],"names":["_","require","URL","RestClient","Feature","ensureFeatureName","RestTestClient","constructor","app","endpoint","onSend","onError","onSent","agent","tryRequire","initReq","httpMethod","url","urlObj","testUrl","path","hash","server","Error","module","exports","type","SERVICE","groupable","load_","settings","name","client","registerService"],"mappings":"AAAA,MAAM;AAAEA,EAAAA;AAAF,IAAQC,OAAO,CAAC,YAAD,CAArB;;AACA,MAAMC,GAAG,GAAGD,OAAO,CAAC,KAAD,CAAnB;;AAEA,MAAM;AAAEE,EAAAA;AAAF,IAAiBF,OAAO,CAAC,cAAD,CAA9B;;AACA,MAAMG,OAAO,GAAGH,OAAO,CAAC,iBAAD,CAAvB;;AACA,MAAM;AAAEI,EAAAA;AAAF,IAAwBJ,OAAO,CAAC,kBAAD,CAArC;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;;AACA,MAAMK,cAAN,SAA6BH,UAA7B,CAAwC;AACpC;AACJ;AACA;AACA;AACA;AACA;AACII,EAAAA,WAAW,CAACC,GAAD,EAAMC,QAAN,EAAgBC,MAAhB,EAAwBC,OAAxB,EAAiCC,MAAjC,EAAyC;AAChD,UAAMJ,GAAN,EAAWC,QAAX,EAAqBC,MAArB,EAA6BC,OAA7B,EAAsCC,MAAtC;AACA,SAAKC,KAAL,GAAaL,GAAG,CAACM,UAAJ,CAAe,WAAf,CAAb;AACH;AAED;AACJ;AACA;AACA;AACA;;;AACIC,EAAAA,OAAO,CAACC,UAAD,EAAaC,GAAb,EAAkB;AACrB,UAAMC,MAAM,GAAG,IAAIhB,GAAJ,CAAQe,GAAR,CAAf;AAEA,UAAME,OAAO,GAAGD,MAAM,CAACE,IAAvB;;AACA,QAAIF,MAAM,CAACG,IAAX,EAAiB;AACbF,MAAAA,OAAO,IAAI,MAAMD,MAAM,CAACG,IAAxB;AACH;;AAED,QAAI,CAAC,KAAKC,MAAV,EAAkB;AACd,YAAM,IAAIC,KAAJ,CAAU,mDAAV,CAAN;AACH;;AAED,WAAO,KAAKV,KAAL,CAAW,KAAKS,MAAhB,EAAwBN,UAAxB,EAAoCG,OAApC,CAAP;AACH;;AA9BmC;;AAiCxCK,MAAM,CAACC,OAAP,GAAiB;AACb;AACJ;AACA;AACA;AACIC,EAAAA,IAAI,EAAEtB,OAAO,CAACuB,OALD;;AAOb;AACJ;AACA;AACA;AACIC,EAAAA,SAAS,EAAE,IAXE;;AAab;AACJ;AACA;AACA;AACA;AACA;AACIC,EAAAA,KAAK,EAAE,gBAAgBrB,GAAhB,EAAqBsB,QAArB,EAA+BC,IAA/B,EAAqC;AACxC1B,IAAAA,iBAAiB,CAAC0B,IAAD,CAAjB;AAEA,QAAIC,MAAM,GAAG,IAAI1B,cAAJ,CAAmBE,GAAnB,EAAwBsB,QAAxB,CAAb;AAEAtB,IAAAA,GAAG,CAACyB,eAAJ,CAAoBF,IAApB,EAA0BC,MAA1B;AACH;AAzBY,CAAjB","sourcesContent":["const { _ } = require(\"@genx/july\");\nconst URL = require('url');\n\nconst { RestClient } = require('./restClient');\nconst Feature = require(\"../enum/Feature\");\nconst { ensureFeatureName } = require(\"../utils/Helpers\");\n\n/**\n * Enable a named super rest client, for code coverage test only.\n * @module Feature_SuperTest\n */\n\n/**\n * RESTful test client.\n * @class\n */\nclass RestTestClient extends RestClient {\n    /**     \n     * @param {*} endpoint \n     * @param {*} onSend \n     * @param {*} onError \n     * @param {*} onSent \n     */\n    constructor(app, endpoint, onSend, onError, onSent) {\n        super(app, endpoint, onSend, onError, onSent);   \n        this.agent = app.tryRequire(\"supertest\");     \n    }\n\n    /**\n     * Override the default initReq method of RestClient.\n     * @param {*} httpMethod \n     * @param {*} url \n     */\n    initReq(httpMethod, url) {\n        const urlObj = new URL(url);\n\n        const testUrl = urlObj.path;\n        if (urlObj.hash) {\n            testUrl += \"#\" + urlObj.hash;\n        }\n\n        if (!this.server) {\n            throw new Error('\"server\" is required before sending test request.');\n        }\n\n        return this.agent(this.server)[httpMethod](testUrl);\n    }\n}\n\nmodule.exports = {\n    /**\n     * This feature is loaded at init stage\n     * @member {string}\n     */\n    type: Feature.SERVICE,\n\n    /**\n     * This feature can be grouped by serviceGroup\n     * @member {boolean}\n     */\n    groupable: true,\n\n    /**\n     * Load the feature\n     * @param {App} app - The cli app module object\n     * @param {object} settings - Settings of rest clients\n     * @returns {Promise.<*>}\n     */\n    load_: async function (app, settings, name) {\n        ensureFeatureName(name);\n        \n        let client = new RestTestClient(app, settings);\n\n        app.registerService(name, client);\n    },\n};\n"],"file":"superTest.js"}