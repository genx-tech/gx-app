"use strict";

require("source-map-support/register");

const Feature = require('../enum/Feature');

const {
  InvalidConfiguration
} = require('@genx/error');

const {
  _
} = require('@genx/july');

const KEY_ENV = 'env:';
const KEY_STAGE = 'stage:';
const Stage = process.env.STAGE_ENV;
module.exports = {
  type: Feature.INIT,
  load_: function (app, settings) {
    let result = {};
    let envSettings;
    let stageSettings;

    _.forOwn(settings, (value, key) => {
      if (key.startsWith(KEY_ENV)) {
        let envKey = key.substr(KEY_ENV.length);

        if (envKey === app.env) {
          envSettings = value;

          if (!_.isPlainObject(value)) {
            throw new InvalidConfiguration('Invalid env settings', app, `settings.${key}`);
          }
        }
      } else if (Stage && key.startsWith(KEY_STAGE)) {
        let stageKey = key.substr(KEY_ENV.length);

        if (stageKey === Stage) {
          stageSettings = value;

          if (!_.isPlainObject(value)) {
            throw new InvalidConfiguration('Invalid stage settings', app, `settings.${key}`);
          }
        }
      } else {
        result[key] = value;
      }
    });

    app.settings = Object.assign(result, envSettings, stageSettings);
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9zZXR0aW5ncy5qcyJdLCJuYW1lcyI6WyJGZWF0dXJlIiwicmVxdWlyZSIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiXyIsIktFWV9FTlYiLCJLRVlfU1RBR0UiLCJTdGFnZSIsInByb2Nlc3MiLCJlbnYiLCJTVEFHRV9FTlYiLCJtb2R1bGUiLCJleHBvcnRzIiwidHlwZSIsIklOSVQiLCJsb2FkXyIsImFwcCIsInNldHRpbmdzIiwicmVzdWx0IiwiZW52U2V0dGluZ3MiLCJzdGFnZVNldHRpbmdzIiwiZm9yT3duIiwidmFsdWUiLCJrZXkiLCJzdGFydHNXaXRoIiwiZW52S2V5Iiwic3Vic3RyIiwibGVuZ3RoIiwiaXNQbGFpbk9iamVjdCIsInN0YWdlS2V5IiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQU9BLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLGlCQUFELENBQXZCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUEyQkQsT0FBTyxDQUFDLGFBQUQsQ0FBeEM7O0FBQ0EsTUFBTTtBQUFFRSxFQUFBQTtBQUFGLElBQVFGLE9BQU8sQ0FBQyxZQUFELENBQXJCOztBQUVBLE1BQU1HLE9BQU8sR0FBRyxNQUFoQjtBQUNBLE1BQU1DLFNBQVMsR0FBRyxRQUFsQjtBQUNBLE1BQU1DLEtBQUssR0FBR0MsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFNBQTFCO0FBRUFDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQU1iQyxFQUFBQSxJQUFJLEVBQUVaLE9BQU8sQ0FBQ2EsSUFORDtBQWNiQyxFQUFBQSxLQUFLLEVBQUUsVUFBVUMsR0FBVixFQUFlQyxRQUFmLEVBQXlCO0FBQzVCLFFBQUlDLE1BQU0sR0FBRyxFQUFiO0FBQ0EsUUFBSUMsV0FBSjtBQUNBLFFBQUlDLGFBQUo7O0FBRUFoQixJQUFBQSxDQUFDLENBQUNpQixNQUFGLENBQVNKLFFBQVQsRUFBbUIsQ0FBQ0ssS0FBRCxFQUFRQyxHQUFSLEtBQWdCO0FBQy9CLFVBQUlBLEdBQUcsQ0FBQ0MsVUFBSixDQUFlbkIsT0FBZixDQUFKLEVBQTZCO0FBQ3pCLFlBQUlvQixNQUFNLEdBQUdGLEdBQUcsQ0FBQ0csTUFBSixDQUFXckIsT0FBTyxDQUFDc0IsTUFBbkIsQ0FBYjs7QUFDQSxZQUFJRixNQUFNLEtBQUtULEdBQUcsQ0FBQ1AsR0FBbkIsRUFBd0I7QUFDcEJVLFVBQUFBLFdBQVcsR0FBR0csS0FBZDs7QUFDQSxjQUFJLENBQUNsQixDQUFDLENBQUN3QixhQUFGLENBQWdCTixLQUFoQixDQUFMLEVBQTZCO0FBQ3pCLGtCQUFNLElBQUluQixvQkFBSixDQUNGLHNCQURFLEVBRUZhLEdBRkUsRUFHRCxZQUFXTyxHQUFJLEVBSGQsQ0FBTjtBQUtIO0FBQ0o7QUFDSixPQVpELE1BWU8sSUFBSWhCLEtBQUssSUFBSWdCLEdBQUcsQ0FBQ0MsVUFBSixDQUFlbEIsU0FBZixDQUFiLEVBQXdDO0FBQzNDLFlBQUl1QixRQUFRLEdBQUdOLEdBQUcsQ0FBQ0csTUFBSixDQUFXckIsT0FBTyxDQUFDc0IsTUFBbkIsQ0FBZjs7QUFDQSxZQUFJRSxRQUFRLEtBQUt0QixLQUFqQixFQUF3QjtBQUNwQmEsVUFBQUEsYUFBYSxHQUFHRSxLQUFoQjs7QUFDQSxjQUFJLENBQUNsQixDQUFDLENBQUN3QixhQUFGLENBQWdCTixLQUFoQixDQUFMLEVBQTZCO0FBQ3pCLGtCQUFNLElBQUluQixvQkFBSixDQUNGLHdCQURFLEVBRUZhLEdBRkUsRUFHRCxZQUFXTyxHQUFJLEVBSGQsQ0FBTjtBQUtIO0FBQ0o7QUFDSixPQVpNLE1BWUE7QUFDSEwsUUFBQUEsTUFBTSxDQUFDSyxHQUFELENBQU4sR0FBY0QsS0FBZDtBQUNIO0FBQ0osS0E1QkQ7O0FBOEJBTixJQUFBQSxHQUFHLENBQUNDLFFBQUosR0FBZWEsTUFBTSxDQUFDQyxNQUFQLENBQWNiLE1BQWQsRUFBc0JDLFdBQXRCLEVBQW1DQyxhQUFuQyxDQUFmO0FBQ0g7QUFsRFksQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuLyoqXG4gKiBFbmFibGUgY3VzdG9taXplZCBzZXR0aW5nc1xuICogQG1vZHVsZSBGZWF0dXJlX1NldHRpbmdzXG4gKi9cblxuY29uc3QgRmVhdHVyZSA9IHJlcXVpcmUoJy4uL2VudW0vRmVhdHVyZScpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiB9ID0gcmVxdWlyZSgnQGdlbngvZXJyb3InKTtcbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgnQGdlbngvanVseScpO1xuXG5jb25zdCBLRVlfRU5WID0gJ2VudjonO1xuY29uc3QgS0VZX1NUQUdFID0gJ3N0YWdlOic7XG5jb25zdCBTdGFnZSA9IHByb2Nlc3MuZW52LlNUQUdFX0VOVjtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IGluaXQgc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5JTklULFxuXG4gICAgLyoqXG4gICAgICogTG9hZCB0aGUgZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgY2xpIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IHNldHRpbmdzIC0gQ3VzdG9taXplZCBzZXR0aW5nc1xuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBsb2FkXzogZnVuY3Rpb24gKGFwcCwgc2V0dGluZ3MpIHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IHt9XG4gICAgICAgIGxldCBlbnZTZXR0aW5ncztcbiAgICAgICAgbGV0IHN0YWdlU2V0dGluZ3M7XG4gICAgICAgIFxuICAgICAgICBfLmZvck93bihzZXR0aW5ncywgKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aChLRVlfRU5WKSkge1xuICAgICAgICAgICAgICAgIGxldCBlbnZLZXkgPSBrZXkuc3Vic3RyKEtFWV9FTlYubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICBpZiAoZW52S2V5ID09PSBhcHAuZW52KSB7XG4gICAgICAgICAgICAgICAgICAgIGVudlNldHRpbmdzID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KHZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdJbnZhbGlkIGVudiBzZXR0aW5ncycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBzZXR0aW5ncy4ke2tleX1gXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChTdGFnZSAmJiBrZXkuc3RhcnRzV2l0aChLRVlfU1RBR0UpKSB7XG4gICAgICAgICAgICAgICAgbGV0IHN0YWdlS2V5ID0ga2V5LnN1YnN0cihLRVlfRU5WLmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgaWYgKHN0YWdlS2V5ID09PSBTdGFnZSkge1xuICAgICAgICAgICAgICAgICAgICBzdGFnZVNldHRpbmdzID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KHZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdJbnZhbGlkIHN0YWdlIHNldHRpbmdzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYHNldHRpbmdzLiR7a2V5fWBcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGFwcC5zZXR0aW5ncyA9IE9iamVjdC5hc3NpZ24ocmVzdWx0LCBlbnZTZXR0aW5ncywgc3RhZ2VTZXR0aW5ncyk7XG4gICAgfVxufTsiXX0=