"use strict";

require("source-map-support/register");

const Feature = require('../enum/Feature');

const {
  InvalidConfiguration
} = require('../utils/Errors');

const {
  _
} = require('rk-utils');

const KEY_ENV = 'env:';
const KEY_STAGE = 'stage:';
const Stage = process.env.STAGE_ENV;
module.exports = {
  type: Feature.INIT,
  load_: function (app, settings) {
    let result = {};
    let envSettings;
    let stageSettings;

    _.forOwn(settings, (value, key) => {
      if (key.startsWith(KEY_ENV)) {
        let envKey = key.substr(KEY_ENV.length);

        if (envKey === app.env) {
          envSettings = value;

          if (!_.isPlainObject(value)) {
            throw new InvalidConfiguration('Invalid env settings', app, `settings.${key}`);
          }
        }
      } else if (Stage && key.startsWith(KEY_STAGE)) {
        let stageKey = key.substr(KEY_ENV.length);

        if (stageKey === Stage) {
          stageSettings = value;

          if (!_.isPlainObject(value)) {
            throw new InvalidConfiguration('Invalid stage settings', app, `settings.${key}`);
          }
        }
      } else {
        result[key] = value;
      }
    });

    app.settings = Object.assign(result, envSettings, stageSettings);
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9zZXR0aW5ncy5qcyJdLCJuYW1lcyI6WyJGZWF0dXJlIiwicmVxdWlyZSIsIkludmFsaWRDb25maWd1cmF0aW9uIiwiXyIsIktFWV9FTlYiLCJLRVlfU1RBR0UiLCJTdGFnZSIsInByb2Nlc3MiLCJlbnYiLCJTVEFHRV9FTlYiLCJtb2R1bGUiLCJleHBvcnRzIiwidHlwZSIsIklOSVQiLCJsb2FkXyIsImFwcCIsInNldHRpbmdzIiwicmVzdWx0IiwiZW52U2V0dGluZ3MiLCJzdGFnZVNldHRpbmdzIiwiZm9yT3duIiwidmFsdWUiLCJrZXkiLCJzdGFydHNXaXRoIiwiZW52S2V5Iiwic3Vic3RyIiwibGVuZ3RoIiwiaXNQbGFpbk9iamVjdCIsInN0YWdlS2V5IiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQU9BLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLGlCQUFELENBQXZCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUEyQkQsT0FBTyxDQUFDLGlCQUFELENBQXhDOztBQUNBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUFRRixPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFFQSxNQUFNRyxPQUFPLEdBQUcsTUFBaEI7QUFDQSxNQUFNQyxTQUFTLEdBQUcsUUFBbEI7QUFDQSxNQUFNQyxLQUFLLEdBQUdDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxTQUExQjtBQUVBQyxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFNYkMsRUFBQUEsSUFBSSxFQUFFWixPQUFPLENBQUNhLElBTkQ7QUFjYkMsRUFBQUEsS0FBSyxFQUFFLFVBQVVDLEdBQVYsRUFBZUMsUUFBZixFQUF5QjtBQUM1QixRQUFJQyxNQUFNLEdBQUcsRUFBYjtBQUNBLFFBQUlDLFdBQUo7QUFDQSxRQUFJQyxhQUFKOztBQUVBaEIsSUFBQUEsQ0FBQyxDQUFDaUIsTUFBRixDQUFTSixRQUFULEVBQW1CLENBQUNLLEtBQUQsRUFBUUMsR0FBUixLQUFnQjtBQUMvQixVQUFJQSxHQUFHLENBQUNDLFVBQUosQ0FBZW5CLE9BQWYsQ0FBSixFQUE2QjtBQUN6QixZQUFJb0IsTUFBTSxHQUFHRixHQUFHLENBQUNHLE1BQUosQ0FBV3JCLE9BQU8sQ0FBQ3NCLE1BQW5CLENBQWI7O0FBQ0EsWUFBSUYsTUFBTSxLQUFLVCxHQUFHLENBQUNQLEdBQW5CLEVBQXdCO0FBQ3BCVSxVQUFBQSxXQUFXLEdBQUdHLEtBQWQ7O0FBQ0EsY0FBSSxDQUFDbEIsQ0FBQyxDQUFDd0IsYUFBRixDQUFnQk4sS0FBaEIsQ0FBTCxFQUE2QjtBQUN6QixrQkFBTSxJQUFJbkIsb0JBQUosQ0FDRixzQkFERSxFQUVGYSxHQUZFLEVBR0QsWUFBV08sR0FBSSxFQUhkLENBQU47QUFLSDtBQUNKO0FBQ0osT0FaRCxNQVlPLElBQUloQixLQUFLLElBQUlnQixHQUFHLENBQUNDLFVBQUosQ0FBZWxCLFNBQWYsQ0FBYixFQUF3QztBQUMzQyxZQUFJdUIsUUFBUSxHQUFHTixHQUFHLENBQUNHLE1BQUosQ0FBV3JCLE9BQU8sQ0FBQ3NCLE1BQW5CLENBQWY7O0FBQ0EsWUFBSUUsUUFBUSxLQUFLdEIsS0FBakIsRUFBd0I7QUFDcEJhLFVBQUFBLGFBQWEsR0FBR0UsS0FBaEI7O0FBQ0EsY0FBSSxDQUFDbEIsQ0FBQyxDQUFDd0IsYUFBRixDQUFnQk4sS0FBaEIsQ0FBTCxFQUE2QjtBQUN6QixrQkFBTSxJQUFJbkIsb0JBQUosQ0FDRix3QkFERSxFQUVGYSxHQUZFLEVBR0QsWUFBV08sR0FBSSxFQUhkLENBQU47QUFLSDtBQUNKO0FBQ0osT0FaTSxNQVlBO0FBQ0hMLFFBQUFBLE1BQU0sQ0FBQ0ssR0FBRCxDQUFOLEdBQWNELEtBQWQ7QUFDSDtBQUNKLEtBNUJEOztBQThCQU4sSUFBQUEsR0FBRyxDQUFDQyxRQUFKLEdBQWVhLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjYixNQUFkLEVBQXNCQyxXQUF0QixFQUFtQ0MsYUFBbkMsQ0FBZjtBQUNIO0FBbERZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbi8qKlxuICogRW5hYmxlIGN1c3RvbWl6ZWQgc2V0dGluZ3NcbiAqIEBtb2R1bGUgRmVhdHVyZV9TZXR0aW5nc1xuICovXG5cbmNvbnN0IEZlYXR1cmUgPSByZXF1aXJlKCcuLi9lbnVtL0ZlYXR1cmUnKTtcbmNvbnN0IHsgSW52YWxpZENvbmZpZ3VyYXRpb24gfSA9IHJlcXVpcmUoJy4uL3V0aWxzL0Vycm9ycycpO1xuY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuXG5jb25zdCBLRVlfRU5WID0gJ2VudjonO1xuY29uc3QgS0VZX1NUQUdFID0gJ3N0YWdlOic7XG5jb25zdCBTdGFnZSA9IHByb2Nlc3MuZW52LlNUQUdFX0VOVjtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IGluaXQgc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5JTklULFxuXG4gICAgLyoqXG4gICAgICogTG9hZCB0aGUgZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgY2xpIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IHNldHRpbmdzIC0gQ3VzdG9taXplZCBzZXR0aW5nc1xuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBsb2FkXzogZnVuY3Rpb24gKGFwcCwgc2V0dGluZ3MpIHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IHt9XG4gICAgICAgIGxldCBlbnZTZXR0aW5ncztcbiAgICAgICAgbGV0IHN0YWdlU2V0dGluZ3M7XG4gICAgICAgIFxuICAgICAgICBfLmZvck93bihzZXR0aW5ncywgKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aChLRVlfRU5WKSkge1xuICAgICAgICAgICAgICAgIGxldCBlbnZLZXkgPSBrZXkuc3Vic3RyKEtFWV9FTlYubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICBpZiAoZW52S2V5ID09PSBhcHAuZW52KSB7XG4gICAgICAgICAgICAgICAgICAgIGVudlNldHRpbmdzID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KHZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdJbnZhbGlkIGVudiBzZXR0aW5ncycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBzZXR0aW5ncy4ke2tleX1gXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChTdGFnZSAmJiBrZXkuc3RhcnRzV2l0aChLRVlfU1RBR0UpKSB7XG4gICAgICAgICAgICAgICAgbGV0IHN0YWdlS2V5ID0ga2V5LnN1YnN0cihLRVlfRU5WLmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgaWYgKHN0YWdlS2V5ID09PSBTdGFnZSkge1xuICAgICAgICAgICAgICAgICAgICBzdGFnZVNldHRpbmdzID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KHZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdJbnZhbGlkIHN0YWdlIHNldHRpbmdzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYHNldHRpbmdzLiR7a2V5fWBcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGFwcC5zZXR0aW5ncyA9IE9iamVjdC5hc3NpZ24ocmVzdWx0LCBlbnZTZXR0aW5ncywgc3RhZ2VTZXR0aW5ncyk7XG4gICAgfVxufTsiXX0=