"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const Feature = require('../enum/Feature');

const {
  tryRequire
} = require('../utils/Helpers');

const AllowedMethods = {
  'get': 'get',
  'post': 'post',
  'put': 'put',
  'del': 'del',
  'delete': 'del',
  'upload': 'post',
  'download': 'get'
};

class RestClient {
  constructor(endpoint, onSendHandler) {
    this.agent = tryRequire('superagent');
    this.endpoint = endpoint.endsWith('/') ? endpoint : endpoint + '/';
    this.onSendHandler = onSendHandler;
  }

  async _sendRequest_(req, streamMode) {
    if (this.onSendHandler) {
      this.onSendHandler(req);
    }

    if (streamMode) return req;

    try {
      let res = await req;
      return res.type === 'text/plain' ? res.text : res.body || res.text;
    } catch (error) {
      if (this.onErrorHandler) {
        let stopProcess = await this.onErrorHandler(error);

        if (stopProcess) {
          return undefined;
        }
      }

      if (error.response) {
        let {
          status,
          body,
          text
        } = error.response;
        let message = body && body.error || error.response.error && error.response.error.message || text;
        error.message = message;
        error.status = status;
      }

      throw error;
    }
  }

  async call_(method, path, query, body, streamMode) {
    method = method.toLowerCase();
    let httpMethod = AllowedMethods[method];

    if (!httpMethod) {
      throw new Error('Invalid method: ' + method);
    }

    if (path[0] === '/') {
      path = path.substr(1);
    }

    let req = this.agent[httpMethod](this.endpoint + path);

    if (query) {
      req.query(query);
    }

    if (method === 'download') {
      req.responseType('blob');
    } else if (method === 'upload') {
      req.attach("file", body);
    } else if (body) {
      req.send(body);
    }

    return this._sendRequest_(req, streamMode);
  }

  async getOne_(resource, id, query) {
    return this.call_('get', encodeURIComponent(resource) + '/' + encodeURIComponent(id), query);
  }

  async getList_(resource, query) {
    return this.call_('get', encodeURIComponent(resource), query);
  }

  async create_(resource, data) {
    return this.call_('post', encodeURIComponent(resource), null, data);
  }

  async updateAny_(resource, where, data) {
    return this.call_('put', encodeURIComponent(resource), where, data);
  }

  async updateOne_(resource, id, data) {
    return this.call_('put', encodeURIComponent(resource) + '/' + encodeURIComponent(id), null, data);
  }

  async removeOne_(resource, id) {
    return this.call_('del', encodeURIComponent(resource) + '/' + encodeURIComponent(id));
  }

  async removeAny_(resource, where) {
    return this.call_('del', encodeURIComponent(resource), where);
  }

}

module.exports = {
  type: Feature.SERVICE,
  load_: async function (app, settings) {
    _.map(settings, (endpoint, name) => {
      let client = new RestClient(endpoint);
      app.registerService(`restClient.${name}`, client);
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9yZXN0Q2xpZW50LmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiRmVhdHVyZSIsInRyeVJlcXVpcmUiLCJBbGxvd2VkTWV0aG9kcyIsIlJlc3RDbGllbnQiLCJjb25zdHJ1Y3RvciIsImVuZHBvaW50Iiwib25TZW5kSGFuZGxlciIsImFnZW50IiwiZW5kc1dpdGgiLCJfc2VuZFJlcXVlc3RfIiwicmVxIiwic3RyZWFtTW9kZSIsInJlcyIsInR5cGUiLCJ0ZXh0IiwiYm9keSIsImVycm9yIiwib25FcnJvckhhbmRsZXIiLCJzdG9wUHJvY2VzcyIsInVuZGVmaW5lZCIsInJlc3BvbnNlIiwic3RhdHVzIiwibWVzc2FnZSIsImNhbGxfIiwibWV0aG9kIiwicGF0aCIsInF1ZXJ5IiwidG9Mb3dlckNhc2UiLCJodHRwTWV0aG9kIiwiRXJyb3IiLCJzdWJzdHIiLCJyZXNwb25zZVR5cGUiLCJhdHRhY2giLCJzZW5kIiwiZ2V0T25lXyIsInJlc291cmNlIiwiaWQiLCJlbmNvZGVVUklDb21wb25lbnQiLCJnZXRMaXN0XyIsImNyZWF0ZV8iLCJkYXRhIiwidXBkYXRlQW55XyIsIndoZXJlIiwidXBkYXRlT25lXyIsInJlbW92ZU9uZV8iLCJyZW1vdmVBbnlfIiwibW9kdWxlIiwiZXhwb3J0cyIsIlNFUlZJQ0UiLCJsb2FkXyIsImFwcCIsInNldHRpbmdzIiwibWFwIiwibmFtZSIsImNsaWVudCIsInJlZ2lzdGVyU2VydmljZSJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxpQkFBRCxDQUF2Qjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBO0FBQUYsSUFBaUJGLE9BQU8sQ0FBQyxrQkFBRCxDQUE5Qjs7QUFFQSxNQUFNRyxjQUFjLEdBQUc7QUFDbkIsU0FBTyxLQURZO0FBRW5CLFVBQVEsTUFG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QVcsS0FBWCxFQUFrQmMsa0JBQWtCLENBQUNGLFFBQUQsQ0FBbEIsR0FBK0IsR0FBL0IsR0FBcUNFLGtCQUFrQixDQUFDRCxFQUFELENBQXpFLEVBQStFLElBQS9FLEVBQXFGSSxJQUFyRixDQUFQO0FBQ0g7O0FBRUQsUUFBTUksVUFBTixDQUFpQlQsUUFBakIsRUFBMkJDLEVBQTNCLEVBQStCO0FBQzNCLFdBQU8sS0FBS2IsS0FBTCxDQUFXLEtBQVgsRUFBa0JjLGtCQUFrQixDQUFDRixRQUFELENBQWxCLEdBQStCLEdBQS9CLEdBQXFDRSxrQkFBa0IsQ0FBQ0QsRUFBRCxDQUF6RSxDQUFQO0FBQ0g7O0FBRUQsUUFBTVMsVUFBTixDQUFpQlYsUUFBakIsRUFBMkJPLEtBQTNCLEVBQWtDO0FBQzlCLFdBQU8sS0FBS25CLEtBQUwsQ0FBVyxLQUFYLEVBQWtCYyxrQkFBa0IsQ0FBQ0YsUUFBRCxDQUFwQyxFQUFnRE8sS0FBaEQsQ0FBUDtBQUNIOztBQTFGWTs7QUE2RmpCSSxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFNYmxDLEVBQUFBLElBQUksRUFBRWIsT0FBTyxDQUFDZ0QsT0FORDtBQWNiQyxFQUFBQSxLQUFLLEVBQUUsZ0JBQWdCQyxHQUFoQixFQUFxQkMsUUFBckIsRUFBK0I7QUFDbENyRCxJQUFBQSxDQUFDLENBQUNzRCxHQUFGLENBQU1ELFFBQU4sRUFBZ0IsQ0FBQzlDLFFBQUQsRUFBV2dELElBQVgsS0FBb0I7QUFDaEMsVUFBSUMsTUFBTSxHQUFHLElBQUluRCxVQUFKLENBQWVFLFFBQWYsQ0FBYjtBQUNBNkMsTUFBQUEsR0FBRyxDQUFDSyxlQUFKLENBQXFCLGNBQWFGLElBQUssRUFBdkMsRUFBMENDLE1BQTFDO0FBQ0gsS0FIRDtBQUlIO0FBbkJZLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgRmVhdHVyZSA9IHJlcXVpcmUoJy4uL2VudW0vRmVhdHVyZScpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCcuLi91dGlscy9IZWxwZXJzJyk7XG5cbmNvbnN0IEFsbG93ZWRNZXRob2RzID0ge1xuICAgICdnZXQnOiAnZ2V0JyxcbiAgICAncG9zdCc6ICdwb3N0JyxcbiAgICAncHV0JzogJ3B1dCcsXG4gICAgJ2RlbCc6ICdkZWwnLFxuICAgICdkZWxldGUnOiAnZGVsJyxcbiAgICAndXBsb2FkJzogJ3Bvc3QnLFxuICAgICdkb3dubG9hZCc6ICdnZXQnXG59O1xuXG5jbGFzcyBSZXN0Q2xpZW50IHtcbiAgICBjb25zdHJ1Y3RvcihlbmRwb2ludCwgb25TZW5kSGFuZGxlcikge1xuICAgICAgICB0aGlzLmFnZW50ID0gdHJ5UmVxdWlyZSgnc3VwZXJhZ2VudCcpO1xuICAgICAgICB0aGlzLmVuZHBvaW50ID0gZW5kcG9pbnQuZW5kc1dpdGgoJy8nKSA/IGVuZHBvaW50IDogZW5kcG9pbnQgKyAnLyc7XG4gICAgICAgIHRoaXMub25TZW5kSGFuZGxlciA9IG9uU2VuZEhhbmRsZXI7XG4gICAgfVxuXG4gICAgYXN5bmMgX3NlbmRSZXF1ZXN0XyhyZXEsIHN0cmVhbU1vZGUpIHtcbiAgICAgICAgaWYgKHRoaXMub25TZW5kSGFuZGxlcikge1xuICAgICAgICAgICAgdGhpcy5vblNlbmRIYW5kbGVyKHJlcSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoc3RyZWFtTW9kZSkgcmV0dXJuIHJlcTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgbGV0IHJlcyA9IGF3YWl0IHJlcTtcbiAgICAgICAgICAgIHJldHVybiByZXMudHlwZSA9PT0gJ3RleHQvcGxhaW4nID8gcmVzLnRleHQgOiAocmVzLmJvZHkgfHwgcmVzLnRleHQpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgaWYgKHRoaXMub25FcnJvckhhbmRsZXIpIHtcbiAgICAgICAgICAgICAgICBsZXQgc3RvcFByb2Nlc3MgPSBhd2FpdCB0aGlzLm9uRXJyb3JIYW5kbGVyKGVycm9yKTtcbiAgICAgICAgICAgICAgICBpZiAoc3RvcFByb2Nlc3MpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChlcnJvci5yZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIGxldCB7IHN0YXR1cywgYm9keSwgdGV4dCB9ID0gZXJyb3IucmVzcG9uc2U7XG5cbiAgICAgICAgICAgICAgICBsZXQgbWVzc2FnZSA9IChib2R5ICYmIGJvZHkuZXJyb3IpIHx8IChlcnJvci5yZXNwb25zZS5lcnJvciAmJiBlcnJvci5yZXNwb25zZS5lcnJvci5tZXNzYWdlKSB8fCB0ZXh0O1xuICAgICAgICAgICAgICAgIGVycm9yLm1lc3NhZ2UgPSBtZXNzYWdlOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBlcnJvci5zdGF0dXMgPSBzdGF0dXM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgY2FsbF8obWV0aG9kLCBwYXRoLCBxdWVyeSwgYm9keSwgc3RyZWFtTW9kZSkge1xuICAgICAgICBtZXRob2QgPSBtZXRob2QudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgbGV0IGh0dHBNZXRob2QgPSBBbGxvd2VkTWV0aG9kc1ttZXRob2RdO1xuICAgICAgICBpZiAoIWh0dHBNZXRob2QpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBtZXRob2Q6ICcgKyBtZXRob2QpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBhdGhbMF0gPT09ICcvJykge1xuICAgICAgICAgICAgcGF0aCA9IHBhdGguc3Vic3RyKDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHJlcSA9IHRoaXMuYWdlbnRbaHR0cE1ldGhvZF0odGhpcy5lbmRwb2ludCArIHBhdGgpO1xuICAgICAgICBpZiAocXVlcnkpIHtcbiAgICAgICAgICAgIHJlcS5xdWVyeShxdWVyeSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobWV0aG9kID09PSAnZG93bmxvYWQnKSB7XG4gICAgICAgICAgICByZXEucmVzcG9uc2VUeXBlKCdibG9iJyk7XG4gICAgICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAndXBsb2FkJykge1xuICAgICAgICAgICAgcmVxLmF0dGFjaChcImZpbGVcIiwgYm9keSk7XG4gICAgICAgIH0gZWxzZSBpZiAoYm9keSkge1xuICAgICAgICAgICAgcmVxLnNlbmQoYm9keSk7ICAgICAgICAgICAgXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5fc2VuZFJlcXVlc3RfKHJlcSwgc3RyZWFtTW9kZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0T25lXyhyZXNvdXJjZSwgaWQsIHF1ZXJ5KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNhbGxfKCdnZXQnLCBlbmNvZGVVUklDb21wb25lbnQocmVzb3VyY2UpICsgJy8nICsgZW5jb2RlVVJJQ29tcG9uZW50KGlkKSwgcXVlcnkpO1xuICAgIH1cblxuICAgIGFzeW5jIGdldExpc3RfKHJlc291cmNlLCBxdWVyeSkge1xuICAgICAgICByZXR1cm4gdGhpcy5jYWxsXygnZ2V0JywgZW5jb2RlVVJJQ29tcG9uZW50KHJlc291cmNlKSwgcXVlcnkpO1xuICAgIH1cblxuICAgIGFzeW5jIGNyZWF0ZV8ocmVzb3VyY2UsIGRhdGEpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FsbF8oJ3Bvc3QnLCBlbmNvZGVVUklDb21wb25lbnQocmVzb3VyY2UpLCBudWxsLCBkYXRhKTtcbiAgICB9XG5cbiAgICBhc3luYyB1cGRhdGVBbnlfKHJlc291cmNlLCB3aGVyZSwgZGF0YSkge1xuICAgICAgICByZXR1cm4gdGhpcy5jYWxsXygncHV0JywgZW5jb2RlVVJJQ29tcG9uZW50KHJlc291cmNlKSwgd2hlcmUsIGRhdGEpO1xuICAgIH1cblxuICAgIGFzeW5jIHVwZGF0ZU9uZV8ocmVzb3VyY2UsIGlkLCBkYXRhKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNhbGxfKCdwdXQnLCBlbmNvZGVVUklDb21wb25lbnQocmVzb3VyY2UpICsgJy8nICsgZW5jb2RlVVJJQ29tcG9uZW50KGlkKSwgbnVsbCwgZGF0YSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVtb3ZlT25lXyhyZXNvdXJjZSwgaWQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FsbF8oJ2RlbCcsIGVuY29kZVVSSUNvbXBvbmVudChyZXNvdXJjZSkgKyAnLycgKyBlbmNvZGVVUklDb21wb25lbnQoaWQpKTtcbiAgICB9XG5cbiAgICBhc3luYyByZW1vdmVBbnlfKHJlc291cmNlLCB3aGVyZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5jYWxsXygnZGVsJywgZW5jb2RlVVJJQ29tcG9uZW50KHJlc291cmNlKSwgd2hlcmUpO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IGluaXQgc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5TRVJWSUNFLFxuXG4gICAgLyoqXG4gICAgICogTG9hZCB0aGUgZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgY2xpIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IHNldHRpbmdzIC0gU2V0dGluZ3Mgb2YgcmVzdCBjbGllbnRzICAgIFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBsb2FkXzogYXN5bmMgZnVuY3Rpb24gKGFwcCwgc2V0dGluZ3MpIHtcbiAgICAgICAgXy5tYXAoc2V0dGluZ3MsIChlbmRwb2ludCwgbmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IG5ldyBSZXN0Q2xpZW50KGVuZHBvaW50KTtcbiAgICAgICAgICAgIGFwcC5yZWdpc3RlclNlcnZpY2UoYHJlc3RDbGllbnQuJHtuYW1lfWAsIGNsaWVudCk7XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxufTsiXX0=