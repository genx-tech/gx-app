"use strict";

require("source-map-support/register");

const {
  _
} = require("@genx/july");

const Feature = require("../enum/Feature");

const {
  ensureFeatureName
} = require("../utils/Helpers");

const AllowedMethods = {
  get: "get",
  post: "post",
  put: "put",
  del: "del",
  delete: "del",
  upload: "post",
  download: "get"
};

function resToPath(parts) {
  return parts ? Array.isArray(parts) ? parts.map(res => encodeURIComponent(res)).join("/") : parts : "";
}

function joinEndpoint(p1, p2) {
  if (p2) {
    if (p1) {
      p1.endsWith("/") || (p1 += "/");
      p2.startsWith("/") && (p2 = p2.substr(1));
    } else if (!p2.startsWith("/")) {
      p1 = "/";
    }

    return p1 + p2;
  }

  return p1;
}

class RestClient {
  constructor(app, endpoint) {
    this.agent = app.tryRequire("superagent");
    this.endpoint = endpoint;
  }

  initReq(httpMethod, url) {
    return this.agent[httpMethod](url);
  }

  async do(method, path, query, body, options) {
    method = method.toLowerCase();
    let httpMethod = AllowedMethods[method];

    if (!httpMethod) {
      throw new Error("Invalid method: " + method);
    }

    let url = path.startsWith("http:") || path.startsWith("https:") ? path : joinEndpoint(options && options.endpoint ? options.endpoint : this.endpoint, path);
    let req = this.initReq(httpMethod, url);

    if (this.onSend) {
      this.onSend(req);
    }

    if (query) {
      req.query(query);
    }

    if (method === "download") {
      req.send(body);
    } else if (method === "upload") {
      if (options && options.formData) {
        _.forOwn(options.formData, (v, k) => {
          req.field(k, v);
        });
      }

      req.attach(options && options.fileField ? options.fileField : "file", body);
    } else {
      req.send(body);
    }

    if (options && options.onProgress) {
      req.on("progress", options.onProgress);
    }

    try {
      const res = await req;
      const result = (!res.body || res.body === "") && res.text !== "" ? res.text : res.body;

      if (this.onSent) {
        await this.onSent(url, result);
      }

      return result;
    } catch (error) {
      if (error.response && error.response.error) {
        if (this.onError) {
          return this.onError(error.response.error);
        }

        throw error.response.error;
      }

      if (this.onError) {
        this.onError(error);
        return;
      }

      throw error;
    }
  }

  async get(resource, query, options) {
    return this.do("get", resToPath(resource), query, null, options);
  }

  async post(resource, data, query, options) {
    return this.do("post", resToPath(resource), query, data, options);
  }

  async put(resource, data, query, options) {
    return this.do("put", resToPath(resource), query, data, options);
  }

  async del(resource, query, options) {
    return this.do("del", resToPath(resource), query, null, options);
  }

  async upload(resource, file, query, options) {
    return this.do("upload", resToPath(resource), query, file, options);
  }

  async download(resource, query, options) {
    return this.do("download", resToPath(resource), query, null, options);
  }

}

module.exports = {
  type: Feature.SERVICE,
  groupable: true,
  RestClient,
  load_: async function (app, settings, name) {
    ensureFeatureName(name);
    let client = new RestClient(app, settings);
    app.registerService(name, client);
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9yZXN0Q2xpZW50LmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiRmVhdHVyZSIsImVuc3VyZUZlYXR1cmVOYW1lIiwiQWxsb3dlZE1ldGhvZHMiLCJnZXQiLCJwb3N0IiwicHV0IiwiZGVsIiwiZGVsZXRlIiwidXBsb2FkIiwiZG93bmxvYWQiLCJyZXNUb1BhdGgiLCJwYXJ0cyIsIkFycmF5IiwiaXNBcnJheSIsIm1hcCIsInJlcyIsImVuY29kZVVSSUNvbXBvbmVudCIsImpvaW4iLCJqb2luRW5kcG9pbnQiLCJwMSIsInAyIiwiZW5kc1dpdGgiLCJzdGFydHNXaXRoIiwic3Vic3RyIiwiUmVzdENsaWVudCIsImNvbnN0cnVjdG9yIiwiYXBwIiwiZW5kcG9pbnQiLCJhZ2VudCIsInRyeVJlcXVpcmUiLCJpbml0UmVxIiwiaHR0cE1ldGhvZCIsInVybCIsImRvIiwibWV0aG9kIiwicGF0aCIsInF1ZXJ5IiwiYm9keSIsIm9wdGlvbnMiLCJ0b0xvd2VyQ2FzZSIsIkVycm9yIiwicmVxIiwib25TZW5kIiwic2VuZCIsImZvcm1EYXRhIiwiZm9yT3duIiwidiIsImsiLCJmaWVsZCIsImF0dGFjaCIsImZpbGVGaWVsZCIsIm9uUHJvZ3Jlc3MiLCJvbiIsInJlc3VsdCIsInRleHQiLCJvblNlbnQiLCJlcnJvciIsInJlc3BvbnNlIiwib25FcnJvciIsInJlc291cmNlIiwiZGF0YSIsImZpbGUiLCJtb2R1bGUiLCJleHBvcnRzIiwidHlwZSIsIlNFUlZJQ0UiLCJncm91cGFibGUiLCJsb2FkXyIsInNldHRpbmdzIiwibmFtZSIsImNsaWVudCIsInJlZ2lzdGVyU2VydmljZSJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsWUFBRCxDQUFyQjs7QUFDQSxNQUFNQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxpQkFBRCxDQUF2Qjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBO0FB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WyJjb25zdCB7IF8gfSA9IHJlcXVpcmUoXCJAZ2VueC9qdWx5XCIpO1xuY29uc3QgRmVhdHVyZSA9IHJlcXVpcmUoXCIuLi9lbnVtL0ZlYXR1cmVcIik7XG5jb25zdCB7IGVuc3VyZUZlYXR1cmVOYW1lIH0gPSByZXF1aXJlKFwiLi4vdXRpbHMvSGVscGVyc1wiKTtcblxuLyoqXG4gKiBFbmFibGUgYSBuYW1lZCByZXN0IGNsaWVudFxuICogQG1vZHVsZSBGZWF0dXJlX1Jlc3RDbGllbnRcbiAqL1xuXG5jb25zdCBBbGxvd2VkTWV0aG9kcyA9IHtcbiAgICBnZXQ6IFwiZ2V0XCIsXG4gICAgcG9zdDogXCJwb3N0XCIsXG4gICAgcHV0OiBcInB1dFwiLFxuICAgIGRlbDogXCJkZWxcIixcbiAgICBkZWxldGU6IFwiZGVsXCIsXG4gICAgdXBsb2FkOiBcInBvc3RcIixcbiAgICBkb3dubG9hZDogXCJnZXRcIixcbn07XG5cbmZ1bmN0aW9uIHJlc1RvUGF0aChwYXJ0cykge1xuICAgIHJldHVybiBwYXJ0c1xuICAgICAgICA/IEFycmF5LmlzQXJyYXkocGFydHMpXG4gICAgICAgICAgICA/IHBhcnRzLm1hcCgocmVzKSA9PiBlbmNvZGVVUklDb21wb25lbnQocmVzKSkuam9pbihcIi9cIilcbiAgICAgICAgICAgIDogcGFydHNcbiAgICAgICAgOiBcIlwiO1xufVxuXG5mdW5jdGlvbiBqb2luRW5kcG9pbnQocDEsIHAyKSB7XG4gICAgaWYgKHAyKSB7XG4gICAgICAgIGlmIChwMSkge1xuICAgICAgICAgICAgcDEuZW5kc1dpdGgoXCIvXCIpIHx8IChwMSArPSBcIi9cIik7XG4gICAgICAgICAgICBwMi5zdGFydHNXaXRoKFwiL1wiKSAmJiAocDIgPSBwMi5zdWJzdHIoMSkpO1xuICAgICAgICB9IGVsc2UgaWYgKCFwMi5zdGFydHNXaXRoKFwiL1wiKSkge1xuICAgICAgICAgICAgcDEgPSBcIi9cIjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwMSArIHAyO1xuICAgIH1cblxuICAgIHJldHVybiBwMTtcbn1cblxuLyoqXG4gKiBSRVNUZnVsIGNsaWVudC5cbiAqIEBjbGFzc1xuICovXG5jbGFzcyBSZXN0Q2xpZW50IHtcbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0geyp9IGVuZHBvaW50IFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGFwcCwgZW5kcG9pbnQpIHtcbiAgICAgICAgdGhpcy5hZ2VudCA9IGFwcC50cnlSZXF1aXJlKFwic3VwZXJhZ2VudFwiKTtcbiAgICAgICAgdGhpcy5lbmRwb2ludCA9IGVuZHBvaW50OyAgICAgICAgXG4gICAgfVxuXG4gICAgaW5pdFJlcShodHRwTWV0aG9kLCB1cmwpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYWdlbnRbaHR0cE1ldGhvZF0odXJsKTtcbiAgICB9XG5cbiAgICBhc3luYyBkbyhtZXRob2QsIHBhdGgsIHF1ZXJ5LCBib2R5LCBvcHRpb25zKSB7XG4gICAgICAgIG1ldGhvZCA9IG1ldGhvZC50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBsZXQgaHR0cE1ldGhvZCA9IEFsbG93ZWRNZXRob2RzW21ldGhvZF07XG4gICAgICAgIGlmICghaHR0cE1ldGhvZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBtZXRob2Q6IFwiICsgbWV0aG9kKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB1cmwgPVxuICAgICAgICAgICAgKHBhdGguc3RhcnRzV2l0aChcImh0dHA6XCIpIHx8IHBhdGguc3RhcnRzV2l0aChcImh0dHBzOlwiKSlcbiAgICAgICAgICAgICAgICA/IHBhdGhcbiAgICAgICAgICAgICAgICA6IGpvaW5FbmRwb2ludCgob3B0aW9ucyAmJiBvcHRpb25zLmVuZHBvaW50ID8gb3B0aW9ucy5lbmRwb2ludCA6IHRoaXMuZW5kcG9pbnQpLCBwYXRoKTtcblxuICAgICAgICBsZXQgcmVxID0gdGhpcy5pbml0UmVxKGh0dHBNZXRob2QsIHVybCk7XG5cbiAgICAgICAgaWYgKHRoaXMub25TZW5kKSB7XG4gICAgICAgICAgICB0aGlzLm9uU2VuZChyZXEpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHF1ZXJ5KSB7XG4gICAgICAgICAgICByZXEucXVlcnkocXVlcnkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG1ldGhvZCA9PT0gXCJkb3dubG9hZFwiKSB7XG4gICAgICAgICAgICByZXEuc2VuZChib2R5KTtcbiAgICAgICAgfSBlbHNlIGlmIChtZXRob2QgPT09IFwidXBsb2FkXCIpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZm9ybURhdGEpIHtcbiAgICAgICAgICAgICAgICBfLmZvck93bihvcHRpb25zLmZvcm1EYXRhLCAodiwgaykgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXEuZmllbGQoaywgdik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXEuYXR0YWNoKG9wdGlvbnMgJiYgb3B0aW9ucy5maWxlRmllbGQgPyBvcHRpb25zLmZpbGVGaWVsZCA6IFwiZmlsZVwiLCBib2R5KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlcS5zZW5kKGJvZHkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5vblByb2dyZXNzKSB7XG4gICAgICAgICAgICByZXEub24oXCJwcm9ncmVzc1wiLCBvcHRpb25zLm9uUHJvZ3Jlc3MpO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlcTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9ICgoIXJlcy5ib2R5IHx8IHJlcy5ib2R5ID09PSBcIlwiKSAmJiByZXMudGV4dCAhPT0gXCJcIikgPyByZXMudGV4dCA6IHJlcy5ib2R5O1xuXG4gICAgICAgICAgICBpZiAodGhpcy5vblNlbnQpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLm9uU2VudCh1cmwsIHJlc3VsdCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBpZiAoZXJyb3IucmVzcG9uc2UgJiYgZXJyb3IucmVzcG9uc2UuZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5vbkVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9uRXJyb3IoZXJyb3IucmVzcG9uc2UuZXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRocm93IGVycm9yLnJlc3BvbnNlLmVycm9yO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodGhpcy5vbkVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0KHJlc291cmNlLCBxdWVyeSwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5kbyhcImdldFwiLCByZXNUb1BhdGgocmVzb3VyY2UpLCBxdWVyeSwgbnVsbCwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgYXN5bmMgcG9zdChyZXNvdXJjZSwgZGF0YSwgcXVlcnksIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG8oXCJwb3N0XCIsIHJlc1RvUGF0aChyZXNvdXJjZSksIHF1ZXJ5LCBkYXRhLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICBhc3luYyBwdXQocmVzb3VyY2UsIGRhdGEsIHF1ZXJ5LCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRvKFwicHV0XCIsIHJlc1RvUGF0aChyZXNvdXJjZSksIHF1ZXJ5LCBkYXRhLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICBhc3luYyBkZWwocmVzb3VyY2UsIHF1ZXJ5LCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRvKFwiZGVsXCIsIHJlc1RvUGF0aChyZXNvdXJjZSksIHF1ZXJ5LCBudWxsLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICBhc3luYyB1cGxvYWQocmVzb3VyY2UsIGZpbGUsIHF1ZXJ5LCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRvKFwidXBsb2FkXCIsIHJlc1RvUGF0aChyZXNvdXJjZSksIHF1ZXJ5LCBmaWxlLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICBhc3luYyBkb3dubG9hZChyZXNvdXJjZSwgcXVlcnksIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG8oXCJkb3dubG9hZFwiLCByZXNUb1BhdGgocmVzb3VyY2UpLCBxdWVyeSwgbnVsbCwgb3B0aW9ucyk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IGluaXQgc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5TRVJWSUNFLFxuXG4gICAgLyoqXG4gICAgICogVGhpcyBmZWF0dXJlIGNhbiBiZSBncm91cGVkIGJ5IHNlcnZpY2VHcm91cFxuICAgICAqIEBtZW1iZXIge2Jvb2xlYW59XG4gICAgICovXG4gICAgZ3JvdXBhYmxlOiB0cnVlLFxuXG4gICAgUmVzdENsaWVudCxcblxuICAgIC8qKlxuICAgICAqIExvYWQgdGhlIGZlYXR1cmVcbiAgICAgKiBAcGFyYW0ge0FwcH0gYXBwIC0gVGhlIGNsaSBhcHAgbW9kdWxlIG9iamVjdFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzZXR0aW5ncyAtIFNldHRpbmdzIG9mIHJlc3QgY2xpZW50c1xuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBsb2FkXzogYXN5bmMgZnVuY3Rpb24gKGFwcCwgc2V0dGluZ3MsIG5hbWUpIHtcbiAgICAgICAgZW5zdXJlRmVhdHVyZU5hbWUobmFtZSk7XG5cbiAgICAgICAgbGV0IGNsaWVudCA9IG5ldyBSZXN0Q2xpZW50KGFwcCwgc2V0dGluZ3MpO1xuXG4gICAgICAgIGFwcC5yZWdpc3RlclNlcnZpY2UobmFtZSwgY2xpZW50KTsgICAgICAgIFxuICAgIH0sXG59O1xuIl19