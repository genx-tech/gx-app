"use strict";

require("source-map-support/register");

const {
  _,
  dropLeftIfStartsWith
} = require('rk-utils');

const Feature = require('../enum/Feature');

const {
  tryRequire
} = require('../utils/Helpers');

const AllowedMethods = {
  'get': 'get',
  'post': 'post',
  'put': 'put',
  'del': 'del',
  'delete': 'del',
  'upload': 'post',
  'download': 'get'
};

function resToPath(parts) {
  return parts ? Array.isArray(parts) ? parts.map(res => encodeURIComponent(res)).join('/') : dropLeftIfStartsWith(parts, '/') : '';
}

class RestClient {
  constructor(endpoint, onSend, onError) {
    this.agent = tryRequire('superagent');
    this.endpoint = endpoint.endsWith('/') ? endpoint : endpoint + '/';
    this.onSend = onSend;
    this.onError = onError;
  }

  async do(method, path, query, body, options) {
    method = method.toLowerCase();
    let httpMethod = AllowedMethods[method];

    if (!httpMethod) {
      throw new Error('Invalid method: ' + method);
    }

    let req = this.agent[httpMethod](path.startsWith('http:') || path.startsWith('https:') ? path : (options && options.endpoint ? options.endpoint : this.endpoint) + path);

    if (this.onSend) {
      this.onSend(req);
    }

    if (query) {
      req.query(query);
    }

    if (method === 'download') {
      req.send(body);
    } else if (method === 'upload') {
      if (options && options.formData) {
        _.forOwn(options.formData, (v, k) => {
          req.field(k, v);
        });
      }

      req.attach("file", body);
    } else {
      req.send(body);
    }

    if (options && options.onProgress) {
      req.on('progress', options.onProgress);
    }

    try {
      let res = await req;

      if ((!res.body || res.body === '') && res.text !== '') {
        return res.text;
      }

      return res.body;
    } catch (error) {
      if (error.response && error.response.error) {
        if (this.onError) {
          return this.onError(error.response.error);
        }

        throw error.response.error;
      }

      if (this.onError) {
        this.onError(error);
        return;
      }

      throw error;
    }
  }

  async get(resource, query, options) {
    return this.do('get', resToPath(resource), query, null, options);
  }

  async post(resource, data, query, options) {
    return this.do('post', resToPath(resource), query, data, options);
  }

  async put(resource, data, query, options) {
    return this.do('put', resToPath(resource), query, data, options);
  }

  async del(resource, query, options) {
    return this.do('del', resToPath(resource), query, null, options);
  }

  async upload(resource, file, query, options) {
    return this.do('upload', resToPath(resource), query, file, options);
  }

}

module.exports = {
  type: Feature.SERVICE,
  load_: async function (app, settings) {
    _.map(settings, (endpoint, name) => {
      let client = new RestClient(endpoint);
      app.registerService(`restClient.${name}`, client);
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9yZXN0Q2xpZW50LmpzIl0sIm5hbWVzIjpbIl8iLCJkcm9wTGVmdElmU3RhcnRzV2l0aCIsInJlcXVpcmUiLCJGZWF0dXJlIiwidHJ5UmVxdWlyZSIsIkFsbG93ZWRNZXRob2RzIiwicmVzVG9QYXRoIiwicGFydHMiLCJBcnJheSIsImlzQXJyYXkiLCJtYXAiLCJyZXMiLCJlbmNvZGVVUklDb21wb25lbnQiLCJqb2luIiwiUmVzdENsaWVudCIsImNvbnN0cnVjdG9yIiwiZW5kcG9pbnQiLCJvblNlbmQiLCJvbkVycm9yIiwiYWdlbnQiLCJlbmRzV2l0aCIsImRvIiwibWV0aG9kIiwicGF0aCIsInF1ZXJ5IiwiYm9keSIsIm9wdGlvbnMiLCJ0b0xvd2VyQ2FzZSIsImh0dHBNZXRob2QiLCJFcnJvciIsInJlcSIsInN0YXJ0c1dpdGgiLCJzZW5kIiwiZm9ybURhdGEiLCJmb3JPd24iLCJ2IiwiayIsImZpZWxkIiwiYXR0YWNoIiwib25Qcm9ncmVzcyIsIm9uIiwidGV4dCIsImVycm9yIiwicmVzcG9uc2UiLCJnZXQiLCJyZXNvdXJjZSIsInBvc3QiLCJkYXRhIiwicHV0IiwiZGVsIiwidXBsb2FkIiwiZmlsZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJ0eXBlIiwiU0VSVklDRSIsImxvYWRfIiwiYXBwIiwic2V0dGluZ3MiLCJuYW1lIiwiY2xpZW50IiwicmVnaXN0ZXJTZXJ2aWNlIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsSUFBOEJDLE9BQU8sQ0FBQyxVQUFELENBQTNDOztBQUNBLE1BQU1DLE9BQU8sR0FBR0QsT0FBTyxDQUFDLGlCQUFELENBQXZCOztBQUNBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUFpQkYsT0FBTyxDQUFDLGtCQUFELENBQTlCOztBQU9BLE1BQU1HLGNBQWMsR0FBRztBQUNuQixTQUFPLEtBRFk7QUFFbkIsVUFBUSxNQUZXO0FBR25C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bHMnKTtcbmNvbnN0IEZlYXR1cmUgPSByZXF1aXJlKCcuLi9lbnVtL0ZlYXR1cmUnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvSGVscGVycycpO1xuXG4vKipcbiAqIEVuYWJsZSBhIG5hbWVkIHJlc3QgY2xpZW50XG4gKiBAbW9kdWxlIEZlYXR1cmVfUmVzdENsaWVudFxuICovXG5cbmNvbnN0IEFsbG93ZWRNZXRob2RzID0ge1xuICAgICdnZXQnOiAnZ2V0JyxcbiAgICAncG9zdCc6ICdwb3N0JyxcbiAgICAncHV0JzogJ3B1dCcsXG4gICAgJ2RlbCc6ICdkZWwnLFxuICAgICdkZWxldGUnOiAnZGVsJyxcbiAgICAndXBsb2FkJzogJ3Bvc3QnLFxuICAgICdkb3dubG9hZCc6ICdnZXQnXG59O1xuXG5mdW5jdGlvbiByZXNUb1BhdGgocGFydHMpIHtcbiAgICByZXR1cm4gcGFydHMgPyAoQXJyYXkuaXNBcnJheShwYXJ0cykgPyBwYXJ0cy5tYXAocmVzID0+IGVuY29kZVVSSUNvbXBvbmVudChyZXMpKS5qb2luKCcvJykgOiBkcm9wTGVmdElmU3RhcnRzV2l0aChwYXJ0cywgJy8nKSkgOiAnJztcbn1cblxuLyoqXG4gKiBSRVNUZnVsIGNsaWVudC5cbiAqIEBjbGFzc1xuICovXG5jbGFzcyBSZXN0Q2xpZW50IHtcbiAgICBjb25zdHJ1Y3RvcihlbmRwb2ludCwgb25TZW5kLCBvbkVycm9yKSB7XG4gICAgICAgIHRoaXMuYWdlbnQgPSB0cnlSZXF1aXJlKCdzdXBlcmFnZW50Jyk7XG4gICAgICAgIHRoaXMuZW5kcG9pbnQgPSBlbmRwb2ludC5lbmRzV2l0aCgnLycpID8gZW5kcG9pbnQgOiBlbmRwb2ludCArICcvJztcbiAgICAgICAgdGhpcy5vblNlbmQgPSBvblNlbmQ7XG4gICAgICAgIHRoaXMub25FcnJvciA9IG9uRXJyb3I7XG4gICAgfVxuXG4gICAgYXN5bmMgZG8obWV0aG9kLCBwYXRoLCBxdWVyeSwgYm9keSwgb3B0aW9ucykge1xuICAgICAgICBtZXRob2QgPSBtZXRob2QudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgbGV0IGh0dHBNZXRob2QgPSBBbGxvd2VkTWV0aG9kc1ttZXRob2RdO1xuICAgICAgICBpZiAoIWh0dHBNZXRob2QpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBtZXRob2Q6ICcgKyBtZXRob2QpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHJlcSA9IHRoaXMuYWdlbnRbaHR0cE1ldGhvZF0oKHBhdGguc3RhcnRzV2l0aCgnaHR0cDonKSB8fCBwYXRoLnN0YXJ0c1dpdGgoJ2h0dHBzOicpKSA/IHBhdGggOiAoKG9wdGlvbnMgJiYgb3B0aW9ucy5lbmRwb2ludCA/IG9wdGlvbnMuZW5kcG9pbnQgOiB0aGlzLmVuZHBvaW50KSArIHBhdGgpKTtcblxuICAgICAgICBpZiAodGhpcy5vblNlbmQpIHtcbiAgICAgICAgICAgIHRoaXMub25TZW5kKHJlcSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocXVlcnkpIHtcbiAgICAgICAgICAgIHJlcS5xdWVyeShxdWVyeSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobWV0aG9kID09PSAnZG93bmxvYWQnKSB7XG4gICAgICAgICAgICByZXEuc2VuZChib2R5KTtcbiAgICAgICAgfSBlbHNlIGlmIChtZXRob2QgPT09ICd1cGxvYWQnKSB7XG4gICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmZvcm1EYXRhKSB7XG4gICAgICAgICAgICAgICAgXy5mb3JPd24ob3B0aW9ucy5mb3JtRGF0YSwgKHYsIGspID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVxLmZpZWxkKGssIHYpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVxLmF0dGFjaChcImZpbGVcIiwgYm9keSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXEuc2VuZChib2R5KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMub25Qcm9ncmVzcykge1xuICAgICAgICAgICAgcmVxLm9uKCdwcm9ncmVzcycsIG9wdGlvbnMub25Qcm9ncmVzcyk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgbGV0IHJlcyA9IGF3YWl0IHJlcTtcblxuICAgICAgICAgICAgaWYgKCghcmVzLmJvZHkgfHwgcmVzLmJvZHkgPT09ICcnKSAmJiByZXMudGV4dCAhPT0gJycpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnRleHQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiByZXMuYm9keTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGlmIChlcnJvci5yZXNwb25zZSAmJiBlcnJvci5yZXNwb25zZS5lcnJvcikge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLm9uRXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMub25FcnJvcihlcnJvci5yZXNwb25zZS5lcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdGhyb3cgZXJyb3IucmVzcG9uc2UuZXJyb3I7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0aGlzLm9uRXJyb3IpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uRXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBnZXQocmVzb3VyY2UsIHF1ZXJ5LCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRvKCdnZXQnLFxuICAgICAgICAgICAgcmVzVG9QYXRoKHJlc291cmNlKSxcbiAgICAgICAgICAgIHF1ZXJ5LCBudWxsLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICBhc3luYyBwb3N0KHJlc291cmNlLCBkYXRhLCBxdWVyeSwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5kbygncG9zdCcsXG4gICAgICAgICAgICByZXNUb1BhdGgocmVzb3VyY2UpLFxuICAgICAgICAgICAgcXVlcnksIGRhdGEsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGFzeW5jIHB1dChyZXNvdXJjZSwgZGF0YSwgcXVlcnksIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG8oJ3B1dCcsXG4gICAgICAgICAgICByZXNUb1BhdGgocmVzb3VyY2UpLFxuICAgICAgICAgICAgcXVlcnksIGRhdGEsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGFzeW5jIGRlbChyZXNvdXJjZSwgcXVlcnksIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG8oJ2RlbCcsXG4gICAgICAgICAgICByZXNUb1BhdGgocmVzb3VyY2UpLFxuICAgICAgICAgICAgcXVlcnksIG51bGwsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGFzeW5jIHVwbG9hZChyZXNvdXJjZSwgZmlsZSwgcXVlcnksIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG8oJ3VwbG9hZCcsXG4gICAgICAgICAgICByZXNUb1BhdGgocmVzb3VyY2UpLFxuICAgICAgICAgICAgcXVlcnksIGZpbGUsIG9wdGlvbnMpO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IGluaXQgc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5TRVJWSUNFLFxuXG4gICAgLyoqXG4gICAgICogTG9hZCB0aGUgZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgY2xpIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IHNldHRpbmdzIC0gU2V0dGluZ3Mgb2YgcmVzdCBjbGllbnRzICAgIFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBsb2FkXzogYXN5bmMgZnVuY3Rpb24gKGFwcCwgc2V0dGluZ3MpIHtcbiAgICAgICAgXy5tYXAoc2V0dGluZ3MsIChlbmRwb2ludCwgbmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IG5ldyBSZXN0Q2xpZW50KGVuZHBvaW50KTtcbiAgICAgICAgICAgIGFwcC5yZWdpc3RlclNlcnZpY2UoYHJlc3RDbGllbnQuJHtuYW1lfWAsIGNsaWVudCk7XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxufTsiXX0=