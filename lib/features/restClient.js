"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const Feature = require('../enum/Feature');

const {
  tryRequire
} = require('../utils/Helpers');

const AllowedMethods = {
  'get': 'get',
  'post': 'post',
  'put': 'put',
  'del': 'del',
  'delete': 'del',
  'upload': 'post',
  'download': 'get'
};

class RestClient {
  constructor(endpoint, onSendHandler) {
    this.agent = tryRequire('superagent');
    this.endpoint = endpoint.endsWith('/') ? endpoint : endpoint + '/';
    this.onSendHandler = onSendHandler;
  }

  async _sendRequest_(req, streamMode) {
    if (this.onSendHandler) {
      this.onSendHandler(req);
    }

    if (streamMode) return req;

    try {
      let res = await req;
      return res.type === 'text/plain' ? res.text : res.body || res.text;
    } catch (error) {
      if (this.onErrorHandler) {
        let stopProcess = await this.onErrorHandler(error);

        if (stopProcess) {
          return undefined;
        }
      }

      if (error.response) {
        let {
          status,
          body,
          text
        } = error.response;
        let message = body && body.error || error.response.error && error.response.error.message || text;
        error.message = message;
        error.status = status;
      }

      throw error;
    }
  }

  async call_(method, path, query, body, streamMode) {
    method = method.toLowerCase();
    let httpMethod = AllowedMethods[method];

    if (!httpMethod) {
      throw new Error('Invalid method: ' + method);
    }

    if (path[0] === '/') {
      path = path.substr(1);
    }

    let req = this.agent[httpMethod](this.endpoint + path);

    if (query) {
      req.query(query);
    }

    if (method === 'download') {
      req.responseType('blob');
    } else if (method === 'upload') {
      req.attach("file", body);
    } else if (body) {
      req.send(body);
    }

    return this._sendRequest_(req, streamMode);
  }

  async getOne_(resource, id, query) {
    return this.call_('get', encodeURIComponent(resource) + '/' + encodeURIComponent(id), query);
  }

  async getList_(resource, query) {
    return this.call_('get', encodeURIComponent(resource), query);
  }

  async create_(resource, data) {
    return this.call_('post', encodeURIComponent(resource), null, data);
  }

  async updateOne_(resource, id, data) {
    return this.call_('put', encodeURIComponent(resource) + '/' + encodeURIComponent(id), null, data);
  }

  async updateAny_(resource, where, data) {
    return this.call_('put', encodeURIComponent(resource), where, data);
  }

  async removeOne_(resource, id) {
    return this.call_('del', encodeURIComponent(resource) + '/' + encodeURIComponent(id));
  }

  async removeAny_(resource, where) {
    return this.call_('del', encodeURIComponent(resource), where);
  }

}

module.exports = {
  type: Feature.SERVICE,
  load_: async function (app, settings) {
    _.map(settings, (endpoint, name) => {
      let client = new RestClient(endpoint);
      app.registerService(`restClient.${name}`, client);
    });
  },
  RestClient: RestClient
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9yZXN0Q2xpZW50LmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiRmVhdHVyZSIsInRyeVJlcXVpcmUiLCJBbGxvd2VkTWV0aG9kcyIsIlJlc3RDbGllbnQiLCJjb25zdHJ1Y3RvciIsImVuZHBvaW50Iiwib25TZW5kSGFuZGxlciIsImFnZW50IiwiZW5kc1dpdGgiLCJfc2VuZFJlcXVlc3RfIiwicmVxIiwic3RyZWFtTW9kZSIsInJlcyIsInR5cGUiLCJ0ZXh0IiwiYm9keSIsImVycm9yIiwib25FcnJvckhhbmRsZXIiLCJzdG9wUHJvY2VzcyIsInVuZGVmaW5lZCIsInJlc3BvbnNlIiwic3RhdHVzIiwibWVzc2FnZSIsImNhbGxfIiwibWV0aG9kIiwicGF0aCIsInF1ZXJ5IiwidG9Mb3dlckNhc2UiLCJodHRwTWV0aG9kIiwiRXJyb3IiLCJzdWJzdHIiLCJyZXNwb25zZVR5cGUiLCJhdHRhY2giLCJzZW5kIiwiZ2V0T25lXyIsInJlc291cmNlIiwiaWQiLCJlbmNvZGVVUklDb21wb25lbnQiLCJnZXRMaXN0XyIsImNyZWF0ZV8iLCJkYXRhIiwidXBkYXRlT25lXyIsInVwZGF0ZUFueV8iLCJ3aGVyZSIsInJlbW92ZU9uZV8iLCJyZW1vdmVBbnlfIiwibW9kdWxlIiwiZXhwb3J0cyIsIlNFUlZJQ0UiLCJsb2FkXyIsImFwcCIsInNldHRpbmdzIiwibWFwIiwibmFtZSIsImNsaWVudCIsInJlZ2lzdGVyU2VydmljZSJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUE7QUFBRixJQUFRQyxPQUFPLENBQUMsVUFBRCxDQUFyQjs7QUFDQSxNQUFNQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxpQkFBRCxDQUF2Qjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBO0FBQUYsSUFBaUJGLE9BQU8sQ0FBQyxrQkFBRCxDQUE5Qjs7QUFPQSxNQUFNRyxjQUFjLEdBQUc7QUFDbkIsU0FBTyxLQURZO0FBRW5CLFVBQVEsTUFG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QWtDSCxJQUFsQyxFQUF3QztBQUNwQyxXQUFPLEtBQUtqQixLQUFMLENBQVcsS0FBWCxFQUFrQmMsa0JBQWtCLENBQUNGLFFBQUQsQ0FBcEMsRUFBZ0RRLEtBQWhELEVBQXVESCxJQUF2RCxDQUFQO0FBQ0g7O0FBT0QsUUFBTUksVUFBTixDQUFpQlQsUUFBakIsRUFBMkJDLEVBQTNCLEVBQStCO0FBQzNCLFdBQU8sS0FBS2IsS0FBTCxDQUFXLEtBQVgsRUFBa0JjLGtCQUFrQixDQUFDRixRQUFELENBQWxCLEdBQStCLEdBQS9CLEdBQXFDRSxrQkFBa0IsQ0FBQ0QsRUFBRCxDQUF6RSxDQUFQO0FBQ0g7O0FBT0QsUUFBTVMsVUFBTixDQUFpQlYsUUFBakIsRUFBMkJRLEtBQTNCLEVBQWtDO0FBQzlCLFdBQU8sS0FBS3BCLEtBQUwsQ0FBVyxLQUFYLEVBQWtCYyxrQkFBa0IsQ0FBQ0YsUUFBRCxDQUFwQyxFQUFnRFEsS0FBaEQsQ0FBUDtBQUNIOztBQXpJWTs7QUE0SWpCRyxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFNYmxDLEVBQUFBLElBQUksRUFBRWIsT0FBTyxDQUFDZ0QsT0FORDtBQWNiQyxFQUFBQSxLQUFLLEVBQUUsZ0JBQWdCQyxHQUFoQixFQUFxQkMsUUFBckIsRUFBK0I7QUFDbENyRCxJQUFBQSxDQUFDLENBQUNzRCxHQUFGLENBQU1ELFFBQU4sRUFBZ0IsQ0FBQzlDLFFBQUQsRUFBV2dELElBQVgsS0FBb0I7QUFDaEMsVUFBSUMsTUFBTSxHQUFHLElBQUluRCxVQUFKLENBQWVFLFFBQWYsQ0FBYjtBQUNBNkMsTUFBQUEsR0FBRyxDQUFDSyxlQUFKLENBQXFCLGNBQWFGLElBQUssRUFBdkMsRUFBMENDLE1BQTFDO0FBQ0gsS0FIRDtBQUlILEdBbkJZO0FBcUJibkQsRUFBQUEsVUFBVSxFQUFFQTtBQXJCQyxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IEZlYXR1cmUgPSByZXF1aXJlKCcuLi9lbnVtL0ZlYXR1cmUnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvSGVscGVycycpO1xuXG4vKipcbiAqIEVuYWJsZSBhIG5hbWVkIHJlc3QgY2xpZW50XG4gKiBAbW9kdWxlIEZlYXR1cmVfUmVzdENsaWVudFxuICovXG5cbmNvbnN0IEFsbG93ZWRNZXRob2RzID0ge1xuICAgICdnZXQnOiAnZ2V0JyxcbiAgICAncG9zdCc6ICdwb3N0JyxcbiAgICAncHV0JzogJ3B1dCcsXG4gICAgJ2RlbCc6ICdkZWwnLFxuICAgICdkZWxldGUnOiAnZGVsJyxcbiAgICAndXBsb2FkJzogJ3Bvc3QnLFxuICAgICdkb3dubG9hZCc6ICdnZXQnXG59O1xuXG4vKipcbiAqIFJFU1RmdWwgY2xpZW50LlxuICogQGNsYXNzXG4gKi9cbmNsYXNzIFJlc3RDbGllbnQge1xuICAgIGNvbnN0cnVjdG9yKGVuZHBvaW50LCBvblNlbmRIYW5kbGVyKSB7XG4gICAgICAgIHRoaXMuYWdlbnQgPSB0cnlSZXF1aXJlKCdzdXBlcmFnZW50Jyk7XG4gICAgICAgIHRoaXMuZW5kcG9pbnQgPSBlbmRwb2ludC5lbmRzV2l0aCgnLycpID8gZW5kcG9pbnQgOiBlbmRwb2ludCArICcvJztcbiAgICAgICAgdGhpcy5vblNlbmRIYW5kbGVyID0gb25TZW5kSGFuZGxlcjtcbiAgICB9XG5cbiAgICBhc3luYyBfc2VuZFJlcXVlc3RfKHJlcSwgc3RyZWFtTW9kZSkge1xuICAgICAgICBpZiAodGhpcy5vblNlbmRIYW5kbGVyKSB7XG4gICAgICAgICAgICB0aGlzLm9uU2VuZEhhbmRsZXIocmVxKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzdHJlYW1Nb2RlKSByZXR1cm4gcmVxO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsZXQgcmVzID0gYXdhaXQgcmVxO1xuICAgICAgICAgICAgcmV0dXJuIHJlcy50eXBlID09PSAndGV4dC9wbGFpbicgPyByZXMudGV4dCA6IChyZXMuYm9keSB8fCByZXMudGV4dCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5vbkVycm9ySGFuZGxlcikge1xuICAgICAgICAgICAgICAgIGxldCBzdG9wUHJvY2VzcyA9IGF3YWl0IHRoaXMub25FcnJvckhhbmRsZXIoZXJyb3IpO1xuICAgICAgICAgICAgICAgIGlmIChzdG9wUHJvY2Vzcykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGVycm9yLnJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgbGV0IHsgc3RhdHVzLCBib2R5LCB0ZXh0IH0gPSBlcnJvci5yZXNwb25zZTtcblxuICAgICAgICAgICAgICAgIGxldCBtZXNzYWdlID0gKGJvZHkgJiYgYm9keS5lcnJvcikgfHwgKGVycm9yLnJlc3BvbnNlLmVycm9yICYmIGVycm9yLnJlc3BvbnNlLmVycm9yLm1lc3NhZ2UpIHx8IHRleHQ7XG4gICAgICAgICAgICAgICAgZXJyb3IubWVzc2FnZSA9IG1lc3NhZ2U7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGVycm9yLnN0YXR1cyA9IHN0YXR1cztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxsIGEgcmVzdGZ1bCBtZXRob2QuXG4gICAgICogQHBhcmFtIHsqfSBtZXRob2QgXG4gICAgICogQHBhcmFtIHsqfSBwYXRoIFxuICAgICAqIEBwYXJhbSB7Kn0gcXVlcnkgXG4gICAgICogQHBhcmFtIHsqfSBib2R5IFxuICAgICAqIEBwYXJhbSB7Kn0gc3RyZWFtTW9kZSBcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICAgKi9cbiAgICBhc3luYyBjYWxsXyhtZXRob2QsIHBhdGgsIHF1ZXJ5LCBib2R5LCBzdHJlYW1Nb2RlKSB7XG4gICAgICAgIG1ldGhvZCA9IG1ldGhvZC50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBsZXQgaHR0cE1ldGhvZCA9IEFsbG93ZWRNZXRob2RzW21ldGhvZF07XG4gICAgICAgIGlmICghaHR0cE1ldGhvZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIG1ldGhvZDogJyArIG1ldGhvZCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocGF0aFswXSA9PT0gJy8nKSB7XG4gICAgICAgICAgICBwYXRoID0gcGF0aC5zdWJzdHIoMSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcmVxID0gdGhpcy5hZ2VudFtodHRwTWV0aG9kXSh0aGlzLmVuZHBvaW50ICsgcGF0aCk7XG4gICAgICAgIGlmIChxdWVyeSkge1xuICAgICAgICAgICAgcmVxLnF1ZXJ5KHF1ZXJ5KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtZXRob2QgPT09ICdkb3dubG9hZCcpIHtcbiAgICAgICAgICAgIHJlcS5yZXNwb25zZVR5cGUoJ2Jsb2InKTtcbiAgICAgICAgfSBlbHNlIGlmIChtZXRob2QgPT09ICd1cGxvYWQnKSB7XG4gICAgICAgICAgICByZXEuYXR0YWNoKFwiZmlsZVwiLCBib2R5KTtcbiAgICAgICAgfSBlbHNlIGlmIChib2R5KSB7XG4gICAgICAgICAgICByZXEuc2VuZChib2R5KTsgICAgICAgICAgICBcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLl9zZW5kUmVxdWVzdF8ocmVxLCBzdHJlYW1Nb2RlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIGRldGFpbCBvZiBhIHNpbmdsZSBlbnRpdHkuXG4gICAgICogQHBhcmFtIHsqfSByZXNvdXJjZSBcbiAgICAgKiBAcGFyYW0geyp9IGlkIFxuICAgICAqIEBwYXJhbSB7Kn0gcXVlcnkgXG4gICAgICovXG4gICAgYXN5bmMgZ2V0T25lXyhyZXNvdXJjZSwgaWQsIHF1ZXJ5KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNhbGxfKCdnZXQnLCBlbmNvZGVVUklDb21wb25lbnQocmVzb3VyY2UpICsgJy8nICsgZW5jb2RlVVJJQ29tcG9uZW50KGlkKSwgcXVlcnkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBhIGxpc3Qgb2YgZW50aXRpZXMuXG4gICAgICogQHBhcmFtIHsqfSByZXNvdXJjZSBcbiAgICAgKiBAcGFyYW0geyp9IHF1ZXJ5IFxuICAgICAqL1xuICAgIGFzeW5jIGdldExpc3RfKHJlc291cmNlLCBxdWVyeSkge1xuICAgICAgICByZXR1cm4gdGhpcy5jYWxsXygnZ2V0JywgZW5jb2RlVVJJQ29tcG9uZW50KHJlc291cmNlKSwgcXVlcnkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIG5ldyBlbnRpdHkuXG4gICAgICogQHBhcmFtIHsqfSByZXNvdXJjZSBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICovXG4gICAgYXN5bmMgY3JlYXRlXyhyZXNvdXJjZSwgZGF0YSkge1xuICAgICAgICByZXR1cm4gdGhpcy5jYWxsXygncG9zdCcsIGVuY29kZVVSSUNvbXBvbmVudChyZXNvdXJjZSksIG51bGwsIGRhdGEpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBhIHNwZWNpZmllZCBlbnRpdHkuXG4gICAgICogQHBhcmFtIHsqfSByZXNvdXJjZSBcbiAgICAgKiBAcGFyYW0geyp9IGlkIFxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVPbmVfKHJlc291cmNlLCBpZCwgZGF0YSkge1xuICAgICAgICByZXR1cm4gdGhpcy5jYWxsXygncHV0JywgZW5jb2RlVVJJQ29tcG9uZW50KHJlc291cmNlKSArICcvJyArIGVuY29kZVVSSUNvbXBvbmVudChpZCksIG51bGwsIGRhdGEpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBzb21lIG9mIHRoZSBlbnRpdGllcy5cbiAgICAgKiBAcGFyYW0geyp9IHJlc291cmNlIFxuICAgICAqIEBwYXJhbSB7Kn0gd2hlcmUgXG4gICAgICogQHBhcmFtIHsqfSBkYXRhIFxuICAgICAqL1xuICAgIGFzeW5jIHVwZGF0ZUFueV8ocmVzb3VyY2UsIHdoZXJlLCBkYXRhKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNhbGxfKCdwdXQnLCBlbmNvZGVVUklDb21wb25lbnQocmVzb3VyY2UpLCB3aGVyZSwgZGF0YSk7XG4gICAgfSAgICBcblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhIHNwZWNpZmllZCBlbnRpdHkuXG4gICAgICogQHBhcmFtIHsqfSByZXNvdXJjZSBcbiAgICAgKiBAcGFyYW0geyp9IGlkIFxuICAgICAqL1xuICAgIGFzeW5jIHJlbW92ZU9uZV8ocmVzb3VyY2UsIGlkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNhbGxfKCdkZWwnLCBlbmNvZGVVUklDb21wb25lbnQocmVzb3VyY2UpICsgJy8nICsgZW5jb2RlVVJJQ29tcG9uZW50KGlkKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIHNvbWUgb2YgdGhlIGVudGl0aWVzLlxuICAgICAqIEBwYXJhbSB7Kn0gcmVzb3VyY2UgXG4gICAgICogQHBhcmFtIHsqfSB3aGVyZSBcbiAgICAgKi9cbiAgICBhc3luYyByZW1vdmVBbnlfKHJlc291cmNlLCB3aGVyZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5jYWxsXygnZGVsJywgZW5jb2RlVVJJQ29tcG9uZW50KHJlc291cmNlKSwgd2hlcmUpO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IGluaXQgc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5TRVJWSUNFLFxuXG4gICAgLyoqXG4gICAgICogTG9hZCB0aGUgZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgY2xpIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IHNldHRpbmdzIC0gU2V0dGluZ3Mgb2YgcmVzdCBjbGllbnRzICAgIFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBsb2FkXzogYXN5bmMgZnVuY3Rpb24gKGFwcCwgc2V0dGluZ3MpIHtcbiAgICAgICAgXy5tYXAoc2V0dGluZ3MsIChlbmRwb2ludCwgbmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IG5ldyBSZXN0Q2xpZW50KGVuZHBvaW50KTtcbiAgICAgICAgICAgIGFwcC5yZWdpc3RlclNlcnZpY2UoYHJlc3RDbGllbnQuJHtuYW1lfWAsIGNsaWVudCk7XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfSxcblxuICAgIFJlc3RDbGllbnQ6IFJlc3RDbGllbnRcbn07Il19