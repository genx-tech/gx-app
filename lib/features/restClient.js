"use strict";

require("source-map-support/register");

const {
  _,
  dropLeftIfStartsWith
} = require('rk-utils');

const Feature = require('../enum/Feature');

const {
  tryRequire
} = require('../utils/Helpers');

const AllowedMethods = {
  'get': 'get',
  'post': 'post',
  'put': 'put',
  'del': 'del',
  'delete': 'del',
  'upload': 'post',
  'download': 'get'
};

function resToPath(parts) {
  return parts ? Array.isArray(parts) ? parts.map(res => encodeURIComponent(res)).join('/') : dropLeftIfStartsWith(parts) : '';
}

class RestClient {
  constructor(endpoint, onSend, onError) {
    this.agent = tryRequire('superagent');
    this.endpoint = endpoint.endsWith('/') ? endpoint : endpoint + '/';
    this.onSend = onSend;
    this.onError = onError;
  }

  async do(method, path, query, body, options) {
    method = method.toLowerCase();
    let httpMethod = AllowedMethods[method];

    if (!httpMethod) {
      throw new Error('Invalid method: ' + method);
    }

    let req = this.agent[httpMethod](path.startsWith('http:') ? path : (options && options.endpoint ? options.endpoint : this.endpoint) + path);

    if (this.onSend) {
      this.onSend(req);
    }

    if (query) {
      req.query(query);
    }

    if (method === 'download') {
      req.send(body);
    } else if (method === 'upload') {
      if (options && options.formData) {
        _.forOwn(options.formData, (v, k) => {
          req.field(k, v);
        });
      }

      req.attach("file", body);
    } else {
      req.send(body);
    }

    if (options && options.onProgress) {
      req.on('progress', options.onProgress);
    }

    try {
      let res = await req;

      if ((!res.body || res.body === '') && res.text !== '') {
        return res.text;
      }

      return res.body;
    } catch (error) {
      if (this.onError) {
        this.onError(error);
        return;
      }

      if (error.response) {
        throw new Error(error.response.body ? error.response.body.error || error.response.body || error.response.text : error.response.text);
      }

      throw error;
    }
  }

  async get(resource, query, options) {
    return this.do('get', resToPath(resource), query, null, options);
  }

  async post(resource, data, query, options) {
    return this.do('post', resToPath(resource), query, data, options);
  }

  async put(resource, data, query, options) {
    return this.do('put', resToPath(resource), query, data, options);
  }

  async del(resource, query, options) {
    return this.do('del', resToPath(resource), query, null, options);
  }

  async upload(resource, file, query, options) {
    return this.do('upload', resToPath(resource), query, file, options);
  }

}

module.exports = {
  type: Feature.SERVICE,
  load_: async function (app, settings) {
    _.map(settings, (endpoint, name) => {
      let client = new RestClient(endpoint);
      app.registerService(`restClient.${name}`, client);
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9yZXN0Q2xpZW50LmpzIl0sIm5hbWVzIjpbIl8iLCJkcm9wTGVmdElmU3RhcnRzV2l0aCIsInJlcXVpcmUiLCJGZWF0dXJlIiwidHJ5UmVxdWlyZSIsIkFsbG93ZWRNZXRob2RzIiwicmVzVG9QYXRoIiwicGFydHMiLCJBcnJheSIsImlzQXJyYXkiLCJtYXAiLCJyZXMiLCJlbmNvZGVVUklDb21wb25lbnQiLCJqb2luIiwiUmVzdENsaWVudCIsImNvbnN0cnVjdG9yIiwiZW5kcG9pbnQiLCJvblNlbmQiLCJvbkVycm9yIiwiYWdlbnQiLCJlbmRzV2l0aCIsImRvIiwibWV0aG9kIiwicGF0aCIsInF1ZXJ5IiwiYm9keSIsIm9wdGlvbnMiLCJ0b0xvd2VyQ2FzZSIsImh0dHBNZXRob2QiLCJFcnJvciIsInJlcSIsInN0YXJ0c1dpdGgiLCJzZW5kIiwiZm9ybURhdGEiLCJmb3JPd24iLCJ2IiwiayIsImZpZWxkIiwiYXR0YWNoIiwib25Qcm9ncmVzcyIsIm9uIiwidGV4dCIsImVycm9yIiwicmVzcG9uc2UiLCJnZXQiLCJyZXNvdXJjZSIsInBvc3QiLCJkYXRhIiwicHV0IiwiZGVsIiwidXBsb2FkIiwiZmlsZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJ0eXBlIiwiU0VSVklDRSIsImxvYWRfIiwiYXBwIiwic2V0dGluZ3MiLCJuYW1lIiwiY2xpZW50IiwicmVnaXN0ZXJTZXJ2aWNlIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsSUFBOEJDLE9BQU8sQ0FBQyxVQUFELENBQTNDOztBQUNBLE1BQU1DLE9BQU8sR0FBR0QsT0FBTyxDQUFDLGlCQUFELENBQXZCOztBQUNBLE1BQU07QUFBRUUsRUFBQUE7QUFBRixJQUFpQkYsT0FBTyxDQUFDLGtCQUFELENBQTlCOztBQU9BLE1BQU1HLGNBQWMsR0FBRztBQUNuQixTQUFPLEtBRFk7QUFFbkIsVUFBUSxNQUZXO0FBR25C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QUFpQ0UsT0FBakMsRUFBMEM7QUFDdEMsV0FBTyxLQUFLTCxFQUFMLENBQVEsS0FBUixFQUNIZixTQUFTLENBQUN1QyxRQUFELENBRE4sRUFFSHJCLEtBRkcsRUFFSXVCLElBRkosRUFFVXJCLE9BRlYsQ0FBUDtBQUdIOztBQUVELFFBQU11QixHQUFOLENBQVVKLFFBQVYsRUFBb0JyQixLQUFwQixFQUEyQkUsT0FBM0IsRUFBb0M7QUFDaEMsV0FBTyxLQUFLTCxFQUFMLENBQVEsS0FBUixFQUNIZixTQUFTLENBQUN1QyxRQUFELENBRE4sRUFFSHJCLEtBRkcsRUFFSSxJQUZKLEVBRVVFLE9BRlYsQ0FBUDtBQUdIOztBQUVELFFBQU13QixNQUFOLENBQWFMLFFBQWIsRUFBdUJNLElBQXZCLEVBQTZCM0IsS0FBN0IsRUFBb0NFLE9BQXBDLEVBQTZDO0FBQ3pDLFdBQU8sS0FBS0wsRUFBTCxDQUFRLFFBQVIsRUFDSGYsU0FBUyxDQUFDdUMsUUFBRCxDQUROLEVBRUhyQixLQUZHLEVBRUkyQixJQUZKLEVBRVV6QixPQUZWLENBQVA7QUFHSDs7QUE1Rlk7O0FBK0ZqQjBCLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQU1iQyxFQUFBQSxJQUFJLEVBQUVuRCxPQUFPLENBQUNvRCxPQU5EO0FBY2JDLEVBQUFBLEtBQUssRUFBRSxnQkFBZ0JDLEdBQWhCLEVBQXFCQyxRQUFyQixFQUErQjtBQUNsQzFELElBQUFBLENBQUMsQ0FBQ1UsR0FBRixDQUFNZ0QsUUFBTixFQUFnQixDQUFDMUMsUUFBRCxFQUFXMkMsSUFBWCxLQUFvQjtBQUNoQyxVQUFJQyxNQUFNLEdBQUcsSUFBSTlDLFVBQUosQ0FBZUUsUUFBZixDQUFiO0FBQ0F5QyxNQUFBQSxHQUFHLENBQUNJLGVBQUosQ0FBcUIsY0FBYUYsSUFBSyxFQUF2QyxFQUEwQ0MsTUFBMUM7QUFDSCxLQUhEO0FBSUg7QUFuQlksQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IF8sIGRyb3BMZWZ0SWZTdGFydHNXaXRoIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgRmVhdHVyZSA9IHJlcXVpcmUoJy4uL2VudW0vRmVhdHVyZScpO1xuY29uc3QgeyB0cnlSZXF1aXJlIH0gPSByZXF1aXJlKCcuLi91dGlscy9IZWxwZXJzJyk7XG5cbi8qKlxuICogRW5hYmxlIGEgbmFtZWQgcmVzdCBjbGllbnRcbiAqIEBtb2R1bGUgRmVhdHVyZV9SZXN0Q2xpZW50XG4gKi9cblxuY29uc3QgQWxsb3dlZE1ldGhvZHMgPSB7XG4gICAgJ2dldCc6ICdnZXQnLFxuICAgICdwb3N0JzogJ3Bvc3QnLFxuICAgICdwdXQnOiAncHV0JyxcbiAgICAnZGVsJzogJ2RlbCcsXG4gICAgJ2RlbGV0ZSc6ICdkZWwnLFxuICAgICd1cGxvYWQnOiAncG9zdCcsXG4gICAgJ2Rvd25sb2FkJzogJ2dldCdcbn07XG5cbmZ1bmN0aW9uIHJlc1RvUGF0aChwYXJ0cykge1xuICAgIHJldHVybiBwYXJ0cyA/IChBcnJheS5pc0FycmF5KHBhcnRzKSA/IHBhcnRzLm1hcChyZXMgPT4gZW5jb2RlVVJJQ29tcG9uZW50KHJlcykpLmpvaW4oJy8nKSA6IGRyb3BMZWZ0SWZTdGFydHNXaXRoKHBhcnRzKSkgOiAnJztcbn1cblxuLyoqXG4gKiBSRVNUZnVsIGNsaWVudC5cbiAqIEBjbGFzc1xuICovXG5jbGFzcyBSZXN0Q2xpZW50IHtcbiAgICBjb25zdHJ1Y3RvcihlbmRwb2ludCwgb25TZW5kLCBvbkVycm9yKSB7XG4gICAgICAgIHRoaXMuYWdlbnQgPSB0cnlSZXF1aXJlKCdzdXBlcmFnZW50Jyk7XG4gICAgICAgIHRoaXMuZW5kcG9pbnQgPSBlbmRwb2ludC5lbmRzV2l0aCgnLycpID8gZW5kcG9pbnQgOiBlbmRwb2ludCArICcvJztcbiAgICAgICAgdGhpcy5vblNlbmQgPSBvblNlbmQ7XG4gICAgICAgIHRoaXMub25FcnJvciA9IG9uRXJyb3I7XG4gICAgfVxuXG4gICAgYXN5bmMgZG8obWV0aG9kLCBwYXRoLCBxdWVyeSwgYm9keSwgb3B0aW9ucykge1xuICAgICAgICBtZXRob2QgPSBtZXRob2QudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgbGV0IGh0dHBNZXRob2QgPSBBbGxvd2VkTWV0aG9kc1ttZXRob2RdO1xuICAgICAgICBpZiAoIWh0dHBNZXRob2QpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBtZXRob2Q6ICcgKyBtZXRob2QpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHJlcSA9IHRoaXMuYWdlbnRbaHR0cE1ldGhvZF0ocGF0aC5zdGFydHNXaXRoKCdodHRwOicpID8gcGF0aCA6ICgob3B0aW9ucyAmJiBvcHRpb25zLmVuZHBvaW50ID8gb3B0aW9ucy5lbmRwb2ludCA6IHRoaXMuZW5kcG9pbnQpICsgcGF0aCkpO1xuXG4gICAgICAgIGlmICh0aGlzLm9uU2VuZCkge1xuICAgICAgICAgICAgdGhpcy5vblNlbmQocmVxKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChxdWVyeSkge1xuICAgICAgICAgICAgcmVxLnF1ZXJ5KHF1ZXJ5KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtZXRob2QgPT09ICdkb3dubG9hZCcpIHtcbiAgICAgICAgICAgIHJlcS5zZW5kKGJvZHkpO1xuICAgICAgICB9IGVsc2UgaWYgKG1ldGhvZCA9PT0gJ3VwbG9hZCcpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZm9ybURhdGEpIHtcbiAgICAgICAgICAgICAgICBfLmZvck93bihvcHRpb25zLmZvcm1EYXRhLCAodiwgaykgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXEuZmllbGQoaywgdik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXEuYXR0YWNoKFwiZmlsZVwiLCBib2R5KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlcS5zZW5kKGJvZHkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5vblByb2dyZXNzKSB7XG4gICAgICAgICAgICByZXEub24oJ3Byb2dyZXNzJywgb3B0aW9ucy5vblByb2dyZXNzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsZXQgcmVzID0gYXdhaXQgcmVxO1xuXG4gICAgICAgICAgICBpZiAoKCFyZXMuYm9keSB8fCByZXMuYm9keSA9PT0gJycpICYmIHJlcy50ZXh0ICE9PSAnJykge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXMudGV4dDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHJlcy5ib2R5O1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgaWYgKHRoaXMub25FcnJvcikge1xuICAgICAgICAgICAgICAgIHRoaXMub25FcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoZXJyb3IucmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3IucmVzcG9uc2UuYm9keSA/IChlcnJvci5yZXNwb25zZS5ib2R5LmVycm9yIHx8IGVycm9yLnJlc3BvbnNlLmJvZHkgfHwgZXJyb3IucmVzcG9uc2UudGV4dCkgOiBlcnJvci5yZXNwb25zZS50ZXh0KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBnZXQocmVzb3VyY2UsIHF1ZXJ5LCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRvKCdnZXQnLFxuICAgICAgICAgICAgcmVzVG9QYXRoKHJlc291cmNlKSxcbiAgICAgICAgICAgIHF1ZXJ5LCBudWxsLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICBhc3luYyBwb3N0KHJlc291cmNlLCBkYXRhLCBxdWVyeSwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5kbygncG9zdCcsXG4gICAgICAgICAgICByZXNUb1BhdGgocmVzb3VyY2UpLFxuICAgICAgICAgICAgcXVlcnksIGRhdGEsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGFzeW5jIHB1dChyZXNvdXJjZSwgZGF0YSwgcXVlcnksIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG8oJ3B1dCcsXG4gICAgICAgICAgICByZXNUb1BhdGgocmVzb3VyY2UpLFxuICAgICAgICAgICAgcXVlcnksIGRhdGEsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGFzeW5jIGRlbChyZXNvdXJjZSwgcXVlcnksIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG8oJ2RlbCcsXG4gICAgICAgICAgICByZXNUb1BhdGgocmVzb3VyY2UpLFxuICAgICAgICAgICAgcXVlcnksIG51bGwsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGFzeW5jIHVwbG9hZChyZXNvdXJjZSwgZmlsZSwgcXVlcnksIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG8oJ3VwbG9hZCcsXG4gICAgICAgICAgICByZXNUb1BhdGgocmVzb3VyY2UpLFxuICAgICAgICAgICAgcXVlcnksIGZpbGUsIG9wdGlvbnMpO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IGluaXQgc3RhZ2VcbiAgICAgKiBAbWVtYmVyIHtzdHJpbmd9XG4gICAgICovXG4gICAgdHlwZTogRmVhdHVyZS5TRVJWSUNFLFxuXG4gICAgLyoqXG4gICAgICogTG9hZCB0aGUgZmVhdHVyZVxuICAgICAqIEBwYXJhbSB7QXBwfSBhcHAgLSBUaGUgY2xpIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IHNldHRpbmdzIC0gU2V0dGluZ3Mgb2YgcmVzdCBjbGllbnRzICAgIFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjwqPn1cbiAgICAgKi9cbiAgICBsb2FkXzogYXN5bmMgZnVuY3Rpb24gKGFwcCwgc2V0dGluZ3MpIHtcbiAgICAgICAgXy5tYXAoc2V0dGluZ3MsIChlbmRwb2ludCwgbmFtZSkgPT4ge1xuICAgICAgICAgICAgbGV0IGNsaWVudCA9IG5ldyBSZXN0Q2xpZW50KGVuZHBvaW50KTtcbiAgICAgICAgICAgIGFwcC5yZWdpc3RlclNlcnZpY2UoYHJlc3RDbGllbnQuJHtuYW1lfWAsIGNsaWVudCk7XG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxufTsiXX0=