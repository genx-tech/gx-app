{"version":3,"sources":["../../src/features/restClient.js"],"names":["_","require","Feature","ensureFeatureName","AllowedMethods","get","post","put","del","delete","upload","download","resToPath","parts","Array","isArray","map","res","encodeURIComponent","join","joinEndpoint","p1","p2","endsWith","startsWith","substr","RestClient","constructor","app","endpoint","agent","tryRequire","initReq","httpMethod","url","do","method","path","query","body","options","toLowerCase","Error","req","onSend","headers","forOwn","v","k","set","withCredentials","send","formData","field","attach","fileField","fileName","onProgress","on","result","type","text","onSent","error","response","onError","resource","data","file","module","exports","SERVICE","groupable","load_","settings","name","client","registerService"],"mappings":"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","sourcesContent":["const { _ } = require(\"@genx/july\");\nconst Feature = require(\"../enum/Feature\");\nconst { ensureFeatureName } = require(\"../utils/Helpers\");\n\n/**\n * Enable a named rest client\n * @module Feature_RestClient\n */\n\nconst AllowedMethods = {\n    get: \"get\",\n    post: \"post\",\n    put: \"put\",\n    del: \"del\",\n    delete: \"del\",\n    upload: \"post\",\n    download: \"get\",\n};\n\nfunction resToPath(parts) {\n    return parts\n        ? Array.isArray(parts)\n            ? parts.map((res) => encodeURIComponent(res)).join(\"/\")\n            : parts\n        : \"\";\n}\n\nfunction joinEndpoint(p1, p2) {\n    if (p2) {\n        if (p1) {\n            p1.endsWith(\"/\") || (p1 += \"/\");\n            p2.startsWith(\"/\") && (p2 = p2.substr(1));\n        } else if (!p2.startsWith(\"/\")) {\n            p1 = \"/\";\n        } else {\n            p1 = '';\n        }\n\n        return p1 + p2;\n    }\n\n    return p1;\n}\n\n/**\n * RESTful client.\n * @class\n */\nclass RestClient {\n    /**\n     * \n     * @param {*} endpoint \n     */\n    constructor(app, endpoint) {\n        this.agent = app.tryRequire(\"superagent\");\n        this.endpoint = endpoint;        \n    }\n\n    initReq(httpMethod, url) {\n        return this.agent[httpMethod](url);\n    }\n\n    async do(method, path, query, body, options) {\n        method = method.toLowerCase();\n        let httpMethod = options?.httpMethod ?? AllowedMethods[method];\n        if (!httpMethod) {\n            throw new Error(\"Invalid method: \" + method);\n        }\n\n        let url =\n            (path.startsWith(\"http:\") || path.startsWith(\"https:\"))\n                ? path\n                : joinEndpoint((options && options.endpoint ? options.endpoint : this.endpoint), path);\n\n        let req = this.initReq(httpMethod, url);\n\n        if (this.onSend) {\n            this.onSend(req);\n        }\n\n        if (options?.headers) {\n            _.forOwn(options.headers, (v, k) => {\n                req.set(k, v);\n            });\n        }\n\n        if (options?.withCredentials) {\n            req.withCredentials();\n        }\n\n        if (query) {\n            req.query(query);\n        }\n\n        if (method === \"download\") {\n            req.send(body);\n        } else if (method === \"upload\") {\n            if (options && options.formData) {\n                _.forOwn(options.formData, (v, k) => {\n                    req.field(k, v);\n                });\n            }\n            req.attach(options?.fileField ?? \"file\", body, options?.fileName);\n        } else {\n            req.send(body);\n        }\n\n        if (options && options.onProgress) {\n            req.on(\"progress\", options.onProgress);\n        }\n\n        try {\n            const res = await req;\n            const result = res.type.startsWith('text/') ? res.text : res.body;\n\n            if (this.onSent) {\n                await this.onSent(url, result);\n            }\n\n            return result;\n        } catch (error) {\n            if (error.response && error.response.error) {\n                if (this.onError) {\n                    return this.onError(error.response.error);\n                }\n\n                throw error.response.error;\n            }\n\n            if (this.onError) {\n                this.onError(error);\n                return;\n            }\n\n            throw error;\n        }\n    }\n\n    async get(resource, query, options) {\n        return this.do(\"get\", resToPath(resource), query, null, options);\n    }\n\n    async post(resource, data, query, options) {\n        return this.do(\"post\", resToPath(resource), query, data, options);\n    }\n\n    async put(resource, data, query, options) {\n        return this.do(\"put\", resToPath(resource), query, data, options);\n    }\n\n    async del(resource, query, options) {\n        return this.do(\"del\", resToPath(resource), query, null, options);\n    }\n\n    async upload(resource, file, query, options) {\n        return this.do(\"upload\", resToPath(resource), query, file, options);\n    }\n\n    async download(resource, query, options) {\n        return this.do(\"download\", resToPath(resource), query, null, options);\n    }\n}\n\nmodule.exports = {\n    /**\n     * This feature is loaded at init stage\n     * @member {string}\n     */\n    type: Feature.SERVICE,\n\n    /**\n     * This feature can be grouped by serviceGroup\n     * @member {boolean}\n     */\n    groupable: true,\n\n    RestClient,\n\n    /**\n     * Load the feature\n     * @param {App} app - The cli app module object\n     * @param {object} settings - Settings of rest clients\n     * @returns {Promise.<*>}\n     */\n    load_: async function (app, settings, name) {\n        ensureFeatureName(name);\n\n        let client = new RestClient(app, settings);\n\n        app.registerService(name, client);        \n    },\n};\n"],"file":"restClient.js"}