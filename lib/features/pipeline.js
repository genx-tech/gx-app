"use strict";

require("source-map-support/register");

const EventEmitter = require('events');

const path = require('path');

const {
  eachAsync_,
  _
} = require('rk-utils');

const {
  Types: {
    DATETIME
  },
  Generators
} = require('@genx/data');

const {
  dependsOn,
  requireConfig
} = require('../utils/Helpers');

const SEC_MINUTES = 60;
const SEC_PER_HOUR = SEC_MINUTES * 60;
const SEC_PER_DAY = SEC_PER_HOUR * 24;
const SEC_PER_MONTH = SEC_PER_DAY * 30;
const JOB_INFO = 'jobInfo';
const JOB_STATUS = 'jobStatus';
const JOB_SCHEDULE = 'jobSchedule';
const FEATURE_NAME = path.basename(__filename, '.js');

class Pipeline extends EventEmitter {
  constructor(store, queue, logger) {
    super();

    this.log = (level, message, ...rest) => {
      this.logger && this.logger.log(level, message, ...rest);
      return this;
    };

    this.logError = error => {
      return this.logger && this.logger.logError(error);
    };

    this.store = store;
    this.jobQueue = queue;
    this.logger = logger;
  }

  async initStore_() {
    await this.store.onCollection_(JOB_INFO, collection => collection.createIndexes([{
      key: {
        name: 1
      },
      unique: true
    }]));
    await this.store.onCollection_(JOB_SCHEDULE, collection => collection.createIndexes([{
      key: {
        job: 1,
        schedule: 1,
        batch: 1
      },
      unique: true
    }]));
    await this.store.onCollection_(JOB_STATUS, collection => collection.createIndexes([{
      key: {
        startedAt: 1
      },
      expireAfterSeconds: SEC_PER_MONTH
    }]));
    this.defineJobs_([{
      name: '_built_in_timer',
      pipeline: ['@_timed_task'],
      priority: 0,
      expiry: SEC_MINUTES * 5
    }]);
  }

  async startBuiltinWorkers_() {
    const builtinQueues = ['_timed_task'];
    await eachAsync_(builtinQueues, queueName => this.queue.workerConsume_(queueName, (channel, msg) => {
      let info = JSON.parse(msg.content.toString());
      worker(app, info).then(shouldAck => {
        if (shouldAck) {
          channel.ack(msg);
        } else {
          channel.nack(msg);
        }
      }).catch(error => {
        this.logError(error);

        if (error.needRetry) {
          channel.nack(msg);
        } else {
          channel.ack(msg);
        }
      });
    }));
  }

  async defineJobs_(jobsInfo) {
    jobsInfo = _.castArray(jobsInfo);
    let now = DATETIME.typeObject.local().toJSDate();
    await eachAsync_(jobsInfo, info => store.upsertOne_(JOB_INFO, { ...info,
      createdAt: now
    }, {
      name: info.name
    }));
  }

  async registerWorker_(task, worker) {}

  async startJobs_(jobs) {}

  async scheduleJobs(scheduleList) {
    scheduleList = _.castArray(scheduleList);
    let now = DATETIME.typeObject.local().toJSDate();
    await eachAsync_(scheduleList, scheduleRecord => store.insertOneIfNotExist_(JOB_SCHEDULE, { ...scheduleRecord,
      status: 'pending',
      createdAt: now
    }));
  }

  async start_(jobs) {
    let jobSet = new Set();
    jobs = jobs.map(job => {
      if (typeof job === 'string') {
        jobSet.add(job);
        return {
          name: job
        };
      } else if (Array.isArray(job)) {
        let [name, data] = job;
        jobSet.add(job);
        return {
          name,
          data
        };
      }

      return job;
    });
    let jobInfo = await this.store.findAll_(JOB_INFO, {
      name: jobName
    });

    try {
      if (jobInfo) {
        let step0 = 'jq_' + jobInfo.pipeline[0];
        let jobName = jobSchedule.job;
        let ref = Generators.shortid();
        let now = DATETIME.typeObject.local().toJSDate();
        let ret = await jobQueue.sendToWorkers_(step0, {
          ref,
          job: jobName,
          step: 0,
          data: { ...jobInfo.data,
            ...jobSchedule.data
          }
        });

        if (!ret) {
          throw new Error(`Failed to send the job [${jobName}] to the worker queue [${step0}].`);
        }

        let jobStatus = {
          _id: ref,
          name: jobName,
          status: 'started',
          startedAt: now,
          schedule: jobSchedule._id,
          runOnce: jobSchedule.runOnce,
          pipeline: jobInfo.pipeline,
          step: 0,
          state: [{
            status: 'started',
            startedAt: now
          }]
        };
        await store.insertOne_(JOB_STATUS, jobStatus);
      } else {
        throw new Error(`Job [${jobName}] not found.`);
      }
    } catch (error) {
      engine.logger.log('error', error.message, {
        name: error.name,
        stack: error.stack
      });

      if (jobSchedule.runOnce) {
        await store.deleteOne_(JOB_SCHEDULE, {
          _id: jobSchedule._id
        });
      } else {
        await store.updateOne_(JOB_SCHEDULE, {
          status: 'pending',
          doneAt: now
        }, {
          _id: jobSchedule._id
        });
      }

      throw error;
    }
  }

  async nextStep({
    store,
    jobQueue,
    logger
  }, {
    ref,
    nextQueueName,
    job,
    nextStep,
    data
  }) {
    let now = DATETIME.typeObject.local().toJSDate();
    let ret = await jobQueue.sendToWorkers_(nextQueueName, {
      ref,
      job,
      step: nextStep,
      data
    });

    if (ret) {
      await store.updateOne_(JOB_STATUS, {
        step: nextStep,
        $push: {
          state: {
            status: 'started',
            startedAt: now
          }
        }
      }, {
        _id: jobRef
      });
    } else {
      await store.updateOne_(JOB_STATUS, {
        step: nextStep,
        $push: {
          state: {
            status: 'failed',
            failedAt: now
          }
        }
      }, {
        _id: jobRef
      });
    }
  }

  async proceed({
    store,
    jobQueue,
    logger
  }, jobRef, state, nextStepData) {
    let jobStatus = await store.findOne_(JOB_STATUS, {
      _id: jobRef
    });

    if (!jobStatus) {
      logger.log('error', 'Job not found');
      return;
    }

    let currentStep = jobStatus.step;
    let now = DATETIME.typeObject.local().toJSDate();

    if (currentStep === jobStatus.pipeline.length - 1) {
      logger.log('info', `Job [${jobStatus.name}, ref=${jobRef}] done.`, state);
      await store.updateOne_(JOB_STATUS, {
        "state.$[step]": state,
        status: 'done',
        'doneAt': now
      }, {
        _id: jobRef
      }, {
        arrayFilters: [{
          step: currentStep
        }]
      });
      await store.updateOne_(JOB_SCHEDULE, {
        status: 'pending',
        doneAt: now
      }, {
        _id: jobStatus.schedule
      });
    } else {
      logger.log('info', `Job [${jobStatus.name}, ref=${jobRef}] step[${currentStep}] done.`, state);
      await store.updateOne_(JOB_STATUS, {
        "state.$[step]": state
      }, {
        _id: jobRef
      }, {
        arrayFilters: [{
          step: currentStep
        }]
      });
      currentStep++;
      let nextQueueName = 'jq_' + jobStatus.pipeline[currentStep];
      await nextStep(jobQueue, {
        ref: jobRef,
        nextQueueName,
        job: jobStatus.name,
        nextStep: currentStep,
        data: nextStepData
      });
    }
  }

  async error({
    store,
    logger
  }, jobRef, error) {
    logger.log('error', error.message, {
      name: error.name,
      stack: error.stack
    });
    let jobStatus = await store.findOne_(JOB_STATUS, {
      _id: jobRef
    });

    if (!jobStatus) {
      logger.log('error', 'Job not found');
      return;
    }

    let currentStep = jobStatus.step;
    let now = DATETIME.typeObject.local().toJSDate();
    await store.updateOne_(JOB_STATUS, {
      "state.$[step]": {
        status: 'error',
        'doneAt': now
      },
      error: {
        name: error.name,
        message: error.message,
        stack: error.stack
      },
      status: 'error',
      'doneAt': now
    }, {
      _id: jobRef
    }, {
      arrayFilters: [{
        step: currentStep
      }]
    });

    if (jobStatus.runOnce) {
      await store.deleteOne_(JOB_SCHEDULE, {
        _id: jobStatus.schedule
      });
    } else {
      await store.updateOne_(JOB_SCHEDULE, {
        status: 'pending',
        doneAt: now
      }, {
        _id: jobStatus.schedule
      });
    }
  }

}

module.exports = {
  type: Feature.PLUGIN,
  load_: (app, config) => {
    requireConfig(app, config, ['store', 'queue'], FEATURE_NAME);
    dependsOn(['dataSource'], app, FEATURE_NAME);
    let store = app.getService(config.store);
    let queue = app.getService(config.queue);
    let logger = config.logger && app.getService(config.logger);
    const pipeline = new Pipeline(store, queue, logger);
    app.registerService(FEATURE_NAME, pipeline);
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9waXBlbGluZS5qcyJdLCJuYW1lcyI6WyJFdmVudEVtaXR0ZXIiLCJyZXF1aXJlIiwicGF0aCIsImVhY2hBc3luY18iLCJfIiwiVHlwZXMiLCJEQVRFVElNRSIsIkdlbmVyYXRvcnMiLCJkZXBlbmRzT24iLCJyZXF1aXJlQ29uZmlnIiwiU0VDX01JTlVURVMiLCJTRUNfUEVSX0hPVVIiLCJTRUNfUEVSX0RBWSIsIlNFQ19QRVJfTU9OVEgiLCJKT0JfSU5GTyIsIkpPQl9TVEFUVVMiLCJKT0JfU0NIRURVTEUiLCJGRUFUVVJFX05BTUUiLCJiYXNlbmFtZSIsIl9fZmlsZW5hbWUiLCJQaXBlbGluZSIsImNvbnN0cnVjdG9yIiwic3RvcmUiLCJxdWV1ZSIsImxvZ2dlciIsImxvZyIsImxldmVsIiwibWVzc2FnZSIsInJlc3QiLCJsb2dFcnJvciIsImVycm9yIiwiam9iUXVldWUiLCJpbml0U3RvcmVfIiwib25Db2xsZWN0aW9uXyIsImNvbGxlY3Rpb24iLCJjcmVhdGVJbmRleGVzIiwia2V5IiwibmFtZSIsInVuaXF1ZSIsImpvYiIsInNjaGVkdWxlIiwiYmF0Y2giLCJzdGFydGVkQXQiLCJleHBpcmVBZnRlclNlY29uZHMiLCJkZWZpbmVKb2JzXyIsInBpcGVsaW5lIiwicHJpb3JpdHkiLCJleHBpcnkiLCJzdGFydEJ1aWx0aW5Xb3JrZXJzXyIsImJ1aWx0aW5RdWV1ZXMiLCJxdWV1ZU5hbWUiLCJ3b3JrZXJDb25zdW1lXyIsImNoYW5uZWwiLCJtc2ciLCJpbmZvIiwiSlNPTiIsInBhcnNlIiwiY29udGVudCIsInRvU3RyaW5nIiwid29ya2VyIiwiYXBwIiwidGhlbiIsInNob3VsZEFjayIsImFjayIsIm5hY2siLCJjYXRjaCIsIm5lZWRSZXRyeSIsImpvYnNJbmZvIiwiY2FzdEFycmF5Iiwibm93IiwidHlwZU9iamVjdCIsImxvY2FsIiwidG9KU0RhdGUiLCJ1cHNlcnRPbmVfIiwiY3JlYXRlZEF0IiwicmVnaXN0ZXJXb3JrZXJfIiwidGFzayIsInN0YXJ0Sm9ic18iLCJqb2JzIiwic2NoZWR1bGVKb2JzIiwic2NoZWR1bGVMaXN0Iiwic2NoZWR1bGVSZWNvcmQiLCJpbnNlcnRPbmVJZk5vdEV4aXN0XyIsInN0YXR1cyIsInN0YXJ0XyIsImpvYlNldCIsIlNldCIsIm1hcCIsImFkZCIsIkFycmF5IiwiaXNBcnJheSIsImRhdGEiLCJqb2JJbmZvIiwiZmluZEFsbF8iLCJqb2JOYW1lIiwic3RlcDAiLCJqb2JTY2hlZHVsZSIsInJlZiIsInNob3J0aWQiLCJyZXQiLCJzZW5kVG9Xb3JrZXJzXyIsInN0ZXAiLCJFcnJvciIsImpvYlN0YXR1cyIsIl9pZCIsInJ1bk9uY2UiLCJzdGF0ZSIsImluc2VydE9uZV8iLCJlbmdpbmUiLCJzdGFjayIsImRlbGV0ZU9uZV8iLCJ1cGRhdGVPbmVfIiwiZG9uZUF0IiwibmV4dFN0ZXAiLCJuZXh0UXVldWVOYW1lIiwiJHB1c2giLCJqb2JSZWYiLCJmYWlsZWRBdCIsInByb2NlZWQiLCJuZXh0U3RlcERhdGEiLCJmaW5kT25lXyIsImN1cnJlbnRTdGVwIiwibGVuZ3RoIiwiYXJyYXlGaWx0ZXJzIiwibW9kdWxlIiwiZXhwb3J0cyIsInR5cGUiLCJGZWF0dXJlIiwiUExVR0lOIiwibG9hZF8iLCJjb25maWciLCJnZXRTZXJ2aWNlIiwicmVnaXN0ZXJTZXJ2aWNlIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsWUFBWSxHQUFHQyxPQUFPLENBQUMsUUFBRCxDQUE1Qjs7QUFDQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRUUsRUFBQUEsVUFBRjtBQUFjQyxFQUFBQTtBQUFkLElBQW9CSCxPQUFPLENBQUMsVUFBRCxDQUFqQzs7QUFDQSxNQUFNO0FBQUVJLEVBQUFBLEtBQUssRUFBRTtBQUFFQyxJQUFBQTtBQUFGLEdBQVQ7QUFBdUJDLEVBQUFBO0FBQXZCLElBQXNDTixPQUFPLENBQUMsWUFBRCxDQUFuRDs7QUFDQSxNQUFNO0FBQUVPLEVB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QUNBLFFBQUlDLE1BQU0sR0FBRzBHLE1BQU0sQ0FBQzFHLE1BQVAsSUFBaUJvQyxHQUFHLENBQUN1RSxVQUFKLENBQWVELE1BQU0sQ0FBQzFHLE1BQXRCLENBQTlCO0FBRUEsVUFBTXFCLFFBQVEsR0FBRyxJQUFJekIsUUFBSixDQUFhRSxLQUFiLEVBQW9CQyxLQUFwQixFQUEyQkMsTUFBM0IsQ0FBakI7QUFDQW9DLElBQUFBLEdBQUcsQ0FBQ3dFLGVBQUosQ0FBb0JuSCxZQUFwQixFQUFrQzRCLFFBQWxDO0FBQ0g7QUExQlksQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB7IGVhY2hBc3luY18sIF8gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IFR5cGVzOiB7IERBVEVUSU1FIH0sIEdlbmVyYXRvcnMgfSA9IHJlcXVpcmUoJ0BnZW54L2RhdGEnKTtcbmNvbnN0IHsgZGVwZW5kc09uLCByZXF1aXJlQ29uZmlnIH0gPSByZXF1aXJlKCcuLi91dGlscy9IZWxwZXJzJyk7XG5cbi8qKlxuICogRW5hYmxlIHBpcGVsaW5lIGVuZ2luZVxuICogQG1vZHVsZSBGZWF0dXJlX1BpcGVsaW5lXG4gKi9cblxuY29uc3QgU0VDX01JTlVURVMgPSA2MDtcbmNvbnN0IFNFQ19QRVJfSE9VUiA9IFNFQ19NSU5VVEVTKjYwO1xuY29uc3QgU0VDX1BFUl9EQVkgPSBTRUNfUEVSX0hPVVIqMjQ7XG5jb25zdCBTRUNfUEVSX01PTlRIID0gU0VDX1BFUl9EQVkqMzA7XG5cbmNvbnN0IEpPQl9JTkZPID0gJ2pvYkluZm8nO1xuY29uc3QgSk9CX1NUQVRVUyA9ICdqb2JTdGF0dXMnO1xuY29uc3QgSk9CX1NDSEVEVUxFID0gJ2pvYlNjaGVkdWxlJztcblxuY29uc3QgRkVBVFVSRV9OQU1FID0gcGF0aC5iYXNlbmFtZShfX2ZpbGVuYW1lLCAnLmpzJyk7XG5cbmNsYXNzIFBpcGVsaW5lIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBjb25zdHJ1Y3RvcihzdG9yZSwgcXVldWUsIGxvZ2dlcikge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMuc3RvcmUgPSBzdG9yZTtcbiAgICAgICAgdGhpcy5qb2JRdWV1ZSA9IHF1ZXVlO1xuICAgICAgICB0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcbiAgICB9XG5cbiAgICBsb2cgPSAobGV2ZWwsIG1lc3NhZ2UsIC4uLnJlc3QpID0+IHtcbiAgICAgICAgdGhpcy5sb2dnZXIgJiYgdGhpcy5sb2dnZXIubG9nKGxldmVsLCBtZXNzYWdlLCAuLi5yZXN0KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgbG9nRXJyb3IgPSAoZXJyb3IpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9nZ2VyICYmIHRoaXMubG9nZ2VyLmxvZ0Vycm9yKGVycm9yKTtcbiAgICB9XG5cbiAgICBhc3luYyBpbml0U3RvcmVfKCkge1xuICAgICAgICAvL2NyZWF0ZSBKT0JfSU5GTyBpbmRleFxuICAgICAgICBhd2FpdCB0aGlzLnN0b3JlLm9uQ29sbGVjdGlvbl8oSk9CX0lORk8sIGNvbGxlY3Rpb24gPT4gY29sbGVjdGlvbi5jcmVhdGVJbmRleGVzKFtcbiAgICAgICAgICAgIHsga2V5OiB7IG5hbWU6IDEgfSwgdW5pcXVlOiB0cnVlIH1cbiAgICAgICAgXSkpO1xuICAgIFxuICAgICAgICAvL2NyZWF0ZSBKT0JfU0NIRURVTEUgaW5kZXhcbiAgICAgICAgYXdhaXQgdGhpcy5zdG9yZS5vbkNvbGxlY3Rpb25fKEpPQl9TQ0hFRFVMRSwgY29sbGVjdGlvbiA9PiBjb2xsZWN0aW9uLmNyZWF0ZUluZGV4ZXMoW1xuICAgICAgICAgICAgeyBrZXk6IHsgam9iOiAxLCBzY2hlZHVsZTogMSwgYmF0Y2g6IDEgfSwgdW5pcXVlOiB0cnVlIH1cbiAgICAgICAgXSkpO1xuICAgIFxuICAgICAgICAvL2NyZWF0ZSBKT0JfU1RBVFVTIGluZGV4XG4gICAgICAgIGF3YWl0IHRoaXMuc3RvcmUub25Db2xsZWN0aW9uXyhKT0JfU1RBVFVTLCBjb2xsZWN0aW9uID0+IGNvbGxlY3Rpb24uY3JlYXRlSW5kZXhlcyhbXG4gICAgICAgICAgICB7IGtleTogeyBzdGFydGVkQXQ6IDEgfSwgZXhwaXJlQWZ0ZXJTZWNvbmRzOiBTRUNfUEVSX01PTlRIIH1cbiAgICAgICAgXSkpO1xuXG4gICAgICAgIHRoaXMuZGVmaW5lSm9ic18oW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG5hbWU6ICdfYnVpbHRfaW5fdGltZXInLFxuICAgICAgICAgICAgICAgIHBpcGVsaW5lOiBbICdAX3RpbWVkX3Rhc2snIF0sXG4gICAgICAgICAgICAgICAgcHJpb3JpdHk6IDAsIFxuICAgICAgICAgICAgICAgIGV4cGlyeTogU0VDX01JTlVURVMqNVxuICAgICAgICAgICAgfVxuICAgICAgICBdKTtcbiAgICB9XG5cbiAgICBhc3luYyBzdGFydEJ1aWx0aW5Xb3JrZXJzXygpIHtcbiAgICAgICAgY29uc3QgYnVpbHRpblF1ZXVlcyA9IFsgJ190aW1lZF90YXNrJyBdO1xuXG4gICAgICAgIGF3YWl0IGVhY2hBc3luY18oYnVpbHRpblF1ZXVlcywgcXVldWVOYW1lID0+IHRoaXMucXVldWUud29ya2VyQ29uc3VtZV8ocXVldWVOYW1lLCAoY2hhbm5lbCwgbXNnKSA9PiB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgaW5mbyA9IEpTT04ucGFyc2UobXNnLmNvbnRlbnQudG9TdHJpbmcoKSk7XG5cbiAgICAgICAgICAgIHdvcmtlcihhcHAsIGluZm8pLnRoZW4oKHNob3VsZEFjaykgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChzaG91bGRBY2spIHsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBjaGFubmVsLmFjayhtc2cpOyAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY2hhbm5lbC5uYWNrKG1zZyk7ICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KS5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dFcnJvcihlcnJvcik7XG5cbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IubmVlZFJldHJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIGNoYW5uZWwubmFjayhtc2cpOyAgXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY2hhbm5lbC5hY2sobXNnKTtcbiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSkpO1xuXG4gICAgfVxuICAgIFxuICAgIGFzeW5jIGRlZmluZUpvYnNfKGpvYnNJbmZvKSB7XG4gICAgICAgIGpvYnNJbmZvID0gXy5jYXN0QXJyYXkoam9ic0luZm8pO1xuICAgIFxuICAgICAgICBsZXQgbm93ID0gREFURVRJTUUudHlwZU9iamVjdC5sb2NhbCgpLnRvSlNEYXRlKCk7XG4gICAgICAgIFxuICAgICAgICBhd2FpdCBlYWNoQXN5bmNfKGpvYnNJbmZvLCBpbmZvID0+IHN0b3JlLnVwc2VydE9uZV8oSk9CX0lORk8sIHsgXG4gICAgICAgICAgICAuLi5pbmZvLCAgICAgICAgICAgIFxuICAgICAgICAgICAgY3JlYXRlZEF0OiBub3cgXG4gICAgICAgIH0sIHsgbmFtZTogaW5mby5uYW1lIH0pKTtcbiAgICB9XG5cbiAgICBhc3luYyByZWdpc3Rlcldvcmtlcl8odGFzaywgd29ya2VyKSB7XG5cbiAgICB9XG5cbiAgICBhc3luYyBzdGFydEpvYnNfKGpvYnMpIHtcblxuICAgIH1cbiAgICBcbiAgICBhc3luYyBzY2hlZHVsZUpvYnMoc2NoZWR1bGVMaXN0KSB7XG4gICAgICAgIHNjaGVkdWxlTGlzdCA9IF8uY2FzdEFycmF5KHNjaGVkdWxlTGlzdCk7XG4gICAgXG4gICAgICAgIGxldCBub3cgPSBEQVRFVElNRS50eXBlT2JqZWN0LmxvY2FsKCkudG9KU0RhdGUoKTtcblxuXG4gICAgXG4gICAgICAgIGF3YWl0IGVhY2hBc3luY18oc2NoZWR1bGVMaXN0LCBzY2hlZHVsZVJlY29yZCA9PiBzdG9yZS5pbnNlcnRPbmVJZk5vdEV4aXN0XyhKT0JfU0NIRURVTEUsIHsgLi4uc2NoZWR1bGVSZWNvcmQsIHN0YXR1czogJ3BlbmRpbmcnLCBjcmVhdGVkQXQ6IG5vdyB9KSk7XG4gICAgfVxuICAgIFxuICAgIC8qXG4gICAgYXN5bmMgc3RhcnRKb2JzQnlTY2hlZHVsZV8oZmlsdGVycykge1xuICAgICAgICBsZXQgbm93ID0gREFURVRJTUUudHlwZU9iamVjdC5sb2NhbCgpLnRvSlNEYXRlKCk7XG4gICAgXG4gICAgICAgIGxldCBqb2JzVG9SdW4gPSBhd2FpdCB0aGlzLnN0b3JlLnVwZGF0ZU1hbnlBbmRSZXR1cm5fKFxuICAgICAgICAgICAgSk9CX1NDSEVEVUxFLCBcbiAgICAgICAgICAgIHsgc3RhdHVzOiAncnVubmluZycsIHJ1bm5pbmdBdDogbm93IH0sIFxuICAgICAgICAgICAgeyAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAuLi5maWx0ZXJzLFxuICAgICAgICAgICAgICAgIHN0YXR1czogJ3BlbmRpbmcnLCBcbiAgICAgICAgICAgICAgICAkb3I6IFsgXG4gICAgICAgICAgICAgICAgICAgIHsgZG9uZUF0OiB7ICRleGlzdHM6IGZhbHNlIH0gfSxcbiAgICAgICAgICAgICAgICAgICAgeyBtaW5JbnRlcnZhbDogeyAkZXhpc3RzOiBmYWxzZSB9IH0sXG4gICAgICAgICAgICAgICAgICAgIHsgJGV4cHI6IHsgJGx0OiBbIHsgJGFkZDogWyckZG9uZUF0JywgJyRtaW5JbnRlcnZhbCcgXSB9LCBub3cgXSAgfSB9IC8vIG9yIGV4cGlyZWRcbiAgICAgICAgICAgICAgICBdIFxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIFxuICAgICAgICBpZiAoam9ic1RvUnVuICYmIGpvYnNUb1J1bi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBhd2FpdCBlYWNoQXN5bmNfKGpvYnNUb1J1biwgYXN5bmMgam9iU2NoZWR1bGUgPT4gYXN5bmMgdGhpcy5zdGFydChlbmdpbmUsIGpvYlNjaGVkdWxlKSk7XG4gICAgICAgIH1cbiAgICBcbiAgICAgICAgcmV0dXJuIGpvYnNUb1J1bjtcbiAgICB9Ki9cbiAgICBcbiAgICAvKipcbiAgICAgKiBTdGFydCBpbW1lZGlhdGUgam9iIG9yIHNjaGVkdWxlXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtzY2hlZHVsZV0gXG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRfKGpvYnMpIHtcbiAgICAgICAgbGV0IGpvYlNldCA9IG5ldyBTZXQoKTtcblxuICAgICAgICBqb2JzID0gam9icy5tYXAoam9iID0+IHtcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygam9iID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIGpvYlNldC5hZGQoam9iKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IGpvYlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShqb2IpKSB7XG4gICAgICAgICAgICAgICAgbGV0IFtuYW1lLCBkYXRhXSA9IGpvYjsgXG4gICAgICAgICAgICAgICAgam9iU2V0LmFkZChqb2IpO1xuICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgICAgICAgICAgZGF0YVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBqb2I7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxldCBqb2JJbmZvID0gYXdhaXQgdGhpcy5zdG9yZS5maW5kQWxsXyhKT0JfSU5GTywgeyBuYW1lOiBqb2JOYW1lIH0pO1xuXG5cbiAgICAgICAgdHJ5IHtcbiAgICBcbiAgICAgICAgICAgIC8vdG9kbyBvcmRlciBieSBwcmlvcml0eVxuICAgICAgICAgICBcbiAgICBcbiAgICAgICAgICAgIGlmIChqb2JJbmZvKSB7XG4gICAgICAgICAgICAgICAgbGV0IHN0ZXAwID0gJ2pxXycgKyBqb2JJbmZvLnBpcGVsaW5lWzBdO1xuICAgICAgICAgICAgICAgIGxldCBqb2JOYW1lID0gam9iU2NoZWR1bGUuam9iO1xuICAgICAgICAgICAgICAgIGxldCByZWYgPSBHZW5lcmF0b3JzLnNob3J0aWQoKTtcbiAgICBcbiAgICAgICAgICAgICAgICBsZXQgbm93ID0gREFURVRJTUUudHlwZU9iamVjdC5sb2NhbCgpLnRvSlNEYXRlKCk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IGpvYlF1ZXVlLnNlbmRUb1dvcmtlcnNfKHN0ZXAwLCB7IHJlZiwgam9iOiBqb2JOYW1lLCBzdGVwOiAwLCBkYXRhOiB7IC4uLmpvYkluZm8uZGF0YSwgLi4uam9iU2NoZWR1bGUuZGF0YSB9IH0pO1xuICAgICAgICAgICAgICAgIGlmICghcmV0KSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIHNlbmQgdGhlIGpvYiBbJHtqb2JOYW1lfV0gdG8gdGhlIHdvcmtlciBxdWV1ZSBbJHtzdGVwMH1dLmApO1xuICAgICAgICAgICAgICAgIH1cbiAgICBcbiAgICAgICAgICAgICAgICBsZXQgam9iU3RhdHVzID0geyBcbiAgICAgICAgICAgICAgICAgICAgX2lkOiByZWYsIFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBqb2JOYW1lLCBcbiAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiAnc3RhcnRlZCcsIFxuICAgICAgICAgICAgICAgICAgICBzdGFydGVkQXQ6IG5vdywgXG4gICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlOiBqb2JTY2hlZHVsZS5faWQsIFxuICAgICAgICAgICAgICAgICAgICBydW5PbmNlOiBqb2JTY2hlZHVsZS5ydW5PbmNlLFxuICAgICAgICAgICAgICAgICAgICBwaXBlbGluZTogam9iSW5mby5waXBlbGluZSxcbiAgICAgICAgICAgICAgICAgICAgc3RlcDogMCxcbiAgICAgICAgICAgICAgICAgICAgc3RhdGU6IFt7IHN0YXR1czogJ3N0YXJ0ZWQnLCBzdGFydGVkQXQ6IG5vdyB9XSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9O1xuICAgIFxuICAgICAgICAgICAgICAgIGF3YWl0IHN0b3JlLmluc2VydE9uZV8oSk9CX1NUQVRVUywgam9iU3RhdHVzKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAvL2FkZCB0aW1lciBmb3IgZXhwaXJlIGNoZWNrXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSm9iIFske2pvYk5hbWV9XSBub3QgZm91bmQuYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBlbmdpbmUubG9nZ2VyLmxvZygnZXJyb3InLCBlcnJvci5tZXNzYWdlLCB7IG5hbWU6IGVycm9yLm5hbWUsIHN0YWNrOiBlcnJvci5zdGFjayB9KTtcbiAgICBcbiAgICAgICAgICAgIGlmIChqb2JTY2hlZHVsZS5ydW5PbmNlKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgc3RvcmUuZGVsZXRlT25lXyhKT0JfU0NIRURVTEUsIHsgX2lkOiBqb2JTY2hlZHVsZS5faWQgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGF3YWl0IHN0b3JlLnVwZGF0ZU9uZV8oSk9CX1NDSEVEVUxFLCB7IHN0YXR1czogJ3BlbmRpbmcnLCBkb25lQXQ6IG5vdyB9LCB7IF9pZDogam9iU2NoZWR1bGUuX2lkIH0pO1xuICAgICAgICAgICAgfVxuICAgIFxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgYXN5bmMgbmV4dFN0ZXAoeyBzdG9yZSwgam9iUXVldWUsIGxvZ2dlciB9LCB7IHJlZiwgbmV4dFF1ZXVlTmFtZSwgam9iLCBuZXh0U3RlcCwgZGF0YSB9KSB7XG4gICAgICAgIGxldCBub3cgPSBEQVRFVElNRS50eXBlT2JqZWN0LmxvY2FsKCkudG9KU0RhdGUoKTtcbiAgICAgICAgbGV0IHJldCA9IGF3YWl0IGpvYlF1ZXVlLnNlbmRUb1dvcmtlcnNfKG5leHRRdWV1ZU5hbWUsIHsgcmVmLCBqb2IsIHN0ZXA6IG5leHRTdGVwLCBkYXRhIH0pO1xuICAgICAgICBpZiAocmV0KSB7ICAgICAgICBcbiAgICAgICAgICAgIGF3YWl0IHN0b3JlLnVwZGF0ZU9uZV8oSk9CX1NUQVRVUywgeyBzdGVwOiBuZXh0U3RlcCwgJHB1c2g6IHsgc3RhdGU6IHsgc3RhdHVzOiAnc3RhcnRlZCcsIHN0YXJ0ZWRBdDogbm93IH0gfSB9LCB7IF9pZDogam9iUmVmIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYXdhaXQgc3RvcmUudXBkYXRlT25lXyhKT0JfU1RBVFVTLCB7IHN0ZXA6IG5leHRTdGVwLCAkcHVzaDogeyBzdGF0ZTogeyBzdGF0dXM6ICdmYWlsZWQnLCBmYWlsZWRBdDogbm93IH0gfSB9LCB7IF9pZDogam9iUmVmIH0pOyAvLyBmYWlsZWQgZm9yIGZhaWwgdG8gc3RhcnQsIGVycm9yIGZvciBmYWlsdXJlIGR1cmluZyBzdGFnZVxuICAgICAgICB9XG4gICAgfVxuICAgIFxuICAgIGFzeW5jIHByb2NlZWQoeyBzdG9yZSwgam9iUXVldWUsIGxvZ2dlciB9LCBqb2JSZWYsIHN0YXRlLCBuZXh0U3RlcERhdGEpIHtcbiAgICAgICAgbGV0IGpvYlN0YXR1cyA9IGF3YWl0IHN0b3JlLmZpbmRPbmVfKEpPQl9TVEFUVVMsIHsgX2lkOiBqb2JSZWYgfSk7XG4gICAgXG4gICAgICAgIGlmICgham9iU3RhdHVzKSB7XG4gICAgICAgICAgICBsb2dnZXIubG9nKCdlcnJvcicsICdKb2Igbm90IGZvdW5kJyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgICAgXG4gICAgICAgIGxldCBjdXJyZW50U3RlcCA9IGpvYlN0YXR1cy5zdGVwO1xuICAgICAgICBsZXQgbm93ID0gREFURVRJTUUudHlwZU9iamVjdC5sb2NhbCgpLnRvSlNEYXRlKCk7ICAgICAgXG4gICAgXG4gICAgICAgIGlmIChjdXJyZW50U3RlcCA9PT0gam9iU3RhdHVzLnBpcGVsaW5lLmxlbmd0aC0xKSB7XG4gICAgICAgICAgICBsb2dnZXIubG9nKCdpbmZvJywgYEpvYiBbJHtqb2JTdGF0dXMubmFtZX0sIHJlZj0ke2pvYlJlZn1dIGRvbmUuYCwgc3RhdGUpO1xuICAgIFxuICAgICAgICAgICAgYXdhaXQgc3RvcmUudXBkYXRlT25lXyhKT0JfU1RBVFVTLCB7IFwic3RhdGUuJFtzdGVwXVwiOiBzdGF0ZSwgc3RhdHVzOiAnZG9uZScsICdkb25lQXQnOiBub3cgfSwgeyBfaWQ6IGpvYlJlZiB9LCB7IGFycmF5RmlsdGVyczogWyB7IHN0ZXA6IGN1cnJlbnRTdGVwIH0gXSB9KTsgXG4gICAgICAgICAgICBhd2FpdCBzdG9yZS51cGRhdGVPbmVfKEpPQl9TQ0hFRFVMRSwgeyBzdGF0dXM6ICdwZW5kaW5nJywgZG9uZUF0OiBub3cgfSwgeyBfaWQ6IGpvYlN0YXR1cy5zY2hlZHVsZSB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZ2dlci5sb2coJ2luZm8nLCBgSm9iIFske2pvYlN0YXR1cy5uYW1lfSwgcmVmPSR7am9iUmVmfV0gc3RlcFske2N1cnJlbnRTdGVwfV0gZG9uZS5gLCBzdGF0ZSk7XG4gICAgXG4gICAgICAgICAgICBhd2FpdCBzdG9yZS51cGRhdGVPbmVfKEpPQl9TVEFUVVMsIHsgXCJzdGF0ZS4kW3N0ZXBdXCI6IHN0YXRlIH0sIHsgX2lkOiBqb2JSZWYgfSwgeyBhcnJheUZpbHRlcnM6IFsgeyBzdGVwOiBjdXJyZW50U3RlcCB9IF0gfSk7IFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBjdXJyZW50U3RlcCsrO1xuICAgICAgICAgICAgbGV0IG5leHRRdWV1ZU5hbWUgPSAnanFfJyArIGpvYlN0YXR1cy5waXBlbGluZVtjdXJyZW50U3RlcF07IFxuICAgICAgICAgICAgYXdhaXQgbmV4dFN0ZXAoam9iUXVldWUsIHsgcmVmOiBqb2JSZWYsIG5leHRRdWV1ZU5hbWUsIGpvYjogam9iU3RhdHVzLm5hbWUsIG5leHRTdGVwOiBjdXJyZW50U3RlcCwgZGF0YTogbmV4dFN0ZXBEYXRhIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIFxuICAgIGFzeW5jIGVycm9yKHsgc3RvcmUsIGxvZ2dlciB9LCBqb2JSZWYsIGVycm9yKSB7XG4gICAgICAgIGxvZ2dlci5sb2coJ2Vycm9yJywgZXJyb3IubWVzc2FnZSwgeyBuYW1lOiBlcnJvci5uYW1lLCBzdGFjazogZXJyb3Iuc3RhY2sgfSk7XG4gICAgXG4gICAgICAgIGxldCBqb2JTdGF0dXMgPSBhd2FpdCBzdG9yZS5maW5kT25lXyhKT0JfU1RBVFVTLCB7IF9pZDogam9iUmVmIH0pO1xuICAgIFxuICAgICAgICBpZiAoIWpvYlN0YXR1cykge1xuICAgICAgICAgICAgbG9nZ2VyLmxvZygnZXJyb3InLCAnSm9iIG5vdCBmb3VuZCcpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgICAgIFxuICAgICAgICBsZXQgY3VycmVudFN0ZXAgPSBqb2JTdGF0dXMuc3RlcDtcbiAgICAgICAgbGV0IG5vdyA9IERBVEVUSU1FLnR5cGVPYmplY3QubG9jYWwoKS50b0pTRGF0ZSgpOyAgICBcbiAgICAgICAgXG4gICAgICAgIGF3YWl0IHN0b3JlLnVwZGF0ZU9uZV8oSk9CX1NUQVRVUywgeyBcInN0YXRlLiRbc3RlcF1cIjogeyBzdGF0dXM6ICdlcnJvcicsICdkb25lQXQnOiBub3cgfSwgZXJyb3I6IHsgbmFtZTogZXJyb3IubmFtZSwgbWVzc2FnZTogZXJyb3IubWVzc2FnZSwgc3RhY2s6IGVycm9yLnN0YWNrIH0sIHN0YXR1czogJ2Vycm9yJywgJ2RvbmVBdCc6IG5vdyB9LCB7IF9pZDogam9iUmVmIH0sIHsgYXJyYXlGaWx0ZXJzOiBbIHsgc3RlcDogY3VycmVudFN0ZXAgfSBdIH0pOyBcbiAgICBcbiAgICAgICAgaWYgKGpvYlN0YXR1cy5ydW5PbmNlKSB7XG4gICAgICAgICAgICBhd2FpdCBzdG9yZS5kZWxldGVPbmVfKEpPQl9TQ0hFRFVMRSwgeyBfaWQ6IGpvYlN0YXR1cy5zY2hlZHVsZSB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGF3YWl0IHN0b3JlLnVwZGF0ZU9uZV8oSk9CX1NDSEVEVUxFLCB7IHN0YXR1czogJ3BlbmRpbmcnLCBkb25lQXQ6IG5vdyB9LCB7IF9pZDogam9iU3RhdHVzLnNjaGVkdWxlIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIFxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgICAvKipcbiAgICAgKiBUaGlzIGZlYXR1cmUgaXMgbG9hZGVkIGF0IHBsdWdpbiBzdGFnZVxuICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgKi9cbiAgICB0eXBlOiBGZWF0dXJlLlBMVUdJTixcblxuICAgIC8qKlxuICAgICAqIExvYWQgdGhlIGZlYXR1cmVcbiAgICAgKiBAcGFyYW0ge0FwcH0gYXBwIC0gVGhlIGFwcCBtb2R1bGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZyAtIFBpcGVsaW5lIGVuZ2luZSBjb25maWdcbiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gY29uZmlnLnN0b3JlIC0gRGF0YSBzdG9yZSBzZXJ2aWNlXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGNvbmZpZy5xdWV1ZSAtIEpvYiBxdWV1ZSBzZXJ2aWNlXG4gICAgICogQHByb3BlcnR5IHtzdHJpbmd9IFtjb25maWcubG9nZ2VyXSAtIExvZ2dlciBzZXJ2aWNlXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPCo+fVxuICAgICAqL1xuICAgIGxvYWRfOiAoYXBwLCBjb25maWcpID0+IHtcbiAgICAgICAgcmVxdWlyZUNvbmZpZyhhcHAsIGNvbmZpZywgWyAnc3RvcmUnLCAncXVldWUnIF0sIEZFQVRVUkVfTkFNRSk7XG4gICAgICAgIGRlcGVuZHNPbihbICdkYXRhU291cmNlJyBdLCBhcHAsIEZFQVRVUkVfTkFNRSk7XG5cbiAgICAgICAgbGV0IHN0b3JlID0gYXBwLmdldFNlcnZpY2UoY29uZmlnLnN0b3JlKTtcbiAgICAgICAgbGV0IHF1ZXVlID0gYXBwLmdldFNlcnZpY2UoY29uZmlnLnF1ZXVlKTtcbiAgICAgICAgbGV0IGxvZ2dlciA9IGNvbmZpZy5sb2dnZXIgJiYgYXBwLmdldFNlcnZpY2UoY29uZmlnLmxvZ2dlcik7XG5cbiAgICAgICAgY29uc3QgcGlwZWxpbmUgPSBuZXcgUGlwZWxpbmUoc3RvcmUsIHF1ZXVlLCBsb2dnZXIpO1xuICAgICAgICBhcHAucmVnaXN0ZXJTZXJ2aWNlKEZFQVRVUkVfTkFNRSwgcGlwZWxpbmUpO1xuICAgIH1cbn07Il19