{"version":3,"file":"useDb.js","names":["require","path","naming","InvalidConfiguration","InvalidArgument","ApplicationError","Feature","Literal","module","exports","type","INIT","load_","app","dbRefs","DbCache","db","schemaName","originApp","schemaInfo","requestedSchema","fromLib","dataSource","refSchemaName","lib","server","getLib","connector","getService","i18n","__","modelPath","options","toAbsolutePath","backendPath","join","MODELS_PATH","Db","pascalCase","model","modelName","s","m","split"],"sources":["../../src/features/useDb.js"],"sourcesContent":["\"use strict\";\n\n/**\n * Enable db references\n * @module Feature_UseDb\n */\n\nconst path = require('path');\nconst { naming } = require('@genx/july');\nconst { InvalidConfiguration, InvalidArgument, ApplicationError } = require('@genx/error');\nconst Feature = require('../enum/Feature');\nconst Literal = require('../enum/Literal');\n\nmodule.exports = {\n    /**\n     * This feature is loaded at init stage\n     * @member {string}\n     */\n    type: Feature.INIT,\n\n    /**\n     * Load the feature\n     * @param {App} app - The app module object\n     * @param {object} dbRefs - db reference settings     \n     * @returns {Promise.<*>}\n     */\n    load_: async (app, dbRefs) => {\n        const DbCache = {};\n        \n        app.db = (schemaName, originApp) => {\n            if (!schemaName) {\n                throw new InvalidArgument('Schema name is required.')\n            }\n\n            if (!originApp && DbCache[schemaName]) return DbCache[schemaName];\n\n            let schemaInfo = dbRefs[schemaName];\n            if (!schemaInfo) {\n                throw new InvalidConfiguration(`Data source config for schema \"${schemaName}\" not found.`, app, { 'useDb': dbRefs, requestedSchema: schemaName });\n            }\n\n            if (!schemaInfo.fromLib && !schemaInfo.dataSource) {                \n                throw new InvalidConfiguration('Missing \"fromLib\" or \"dataSource\".', app, { 'useDb': dbRefs, requestedSchema: schemaName });\n            }\n\n            let db;\n\n            if (schemaInfo.fromLib) {\n                if (originApp) {\n                    throw new ApplicationError('Invalid usage of app.db()')\n                }\n\n                let refSchemaName = schemaInfo.schemaName || schemaName;\n                let lib = (app.server || app).getLib(schemaInfo.fromLib);\n\n                if (!lib.db) {\n                    throw new InvalidConfiguration(`\"useDb\" feature is not enabled in lib module \"${schemaInfo.fromLib}\".`, app);\n                }\n\n                db = lib.db(refSchemaName, app);\n            } else {\n                let connector = app.getService(schemaInfo.dataSource);\n                if (!connector) {\n                    throw new InvalidConfiguration(`Data source [${schemaInfo.dataSource}] not found.`, app, `useDb.${schemaName}.dataSource`);\n                }\n\n                let i18n = app.getService('i18n') || app.__;\n                let modelPath;\n\n                if (app.options.modelPath) {\n                    modelPath = app.toAbsolutePath(app.options.modelPath); \n                } else if (app.backendPath) {\n                    modelPath = path.join(app.backendPath, Literal.MODELS_PATH);\n                } else {\n                    modelPath = app.toAbsolutePath(Literal.MODELS_PATH); \n                }\n\n                const Db = require(path.join(modelPath, naming.pascalCase(schemaName)));\n                db = new Db(app, connector, i18n);\n                if (originApp) {\n                    db.app = originApp;\n                }\n            }           \n\n            if (!originApp) {\n                DbCache[schemaName] = db;            \n            }\n\n            return db;\n        };       \n        \n        app.model = (schemaName, modelName) => {\n            if (!modelName) {\n                let [ s, m ] = schemaName.split('.');\n                schemaName = s;\n                modelName = m;                \n            }\n            \n            return app.db(schemaName).model(modelName);\n        };\n    }\n};"],"mappings":"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"}