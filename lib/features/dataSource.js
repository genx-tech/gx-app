"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const {
  tryRequire
} = require('../utils/Helpers');

const Feature = require('../enum/Feature');

const {
  InvalidConfiguration
} = require('../utils/Errors');

module.exports = {
  type: Feature.SERVICE,
  load_: async (app, dataSources) => {
    const {
      Connector
    } = tryRequire('@gx/erml');

    _.forOwn(dataSources, (dataSource, dbms) => {
      _.forOwn(dataSource, (config, connectorName) => {
        let serviceName = dbms + '.' + connectorName;

        if (!config.connection) {
          throw new InvalidConfiguration(`Missing connection config for data source "${serviceName}".`, app, `dataSource.${dbms}.${connectorName}`);
        }

        let {
          connection: connectionString,
          ...other
        } = config;
        let connectorService = Connector.createConnector(dbms, connectionString, {
          logger: app.logger || app.server.logger,
          ...other
        });
        app.registerService(serviceName, connectorService);
        app.on('stopping', elegantStoppers => {
          elegantStoppers.push(connectorService.end_());
        });
      });
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mZWF0dXJlcy9kYXRhU291cmNlLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsIkZlYXR1cmUiLCJJbnZhbGlkQ29uZmlndXJhdGlvbiIsIm1vZHVsZSIsImV4cG9ydHMiLCJ0eXBlIiwiU0VSVklDRSIsImxvYWRfIiwiYXBwIiwiZGF0YVNvdXJjZXMiLCJDb25uZWN0b3IiLCJmb3JPd24iLCJkYXRhU291cmNlIiwiZGJtcyIsImNvbmZpZyIsImNvbm5lY3Rvck5hbWUiLCJzZXJ2aWNlTmFtZSIsImNvbm5lY3Rpb24iLCJjb25uZWN0aW9uU3RyaW5nIiwib3RoZXIiLCJjb25uZWN0b3JTZXJ2aWNlIiwiY3JlYXRlQ29ubmVjdG9yIiwibG9nZ2VyIiwic2VydmVyIiwicmVnaXN0ZXJTZXJ2aWNlIiwib24iLCJlbGVnYW50U3RvcHBlcnMiLCJwdXNoIiwiZW5kXyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFPQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBUUMsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQWlCRCxPQUFPLENBQUMsa0JBQUQsQ0FBOUI7O0FBQ0EsTUFBTUUsT0FBTyxHQUFHRixPQUFPLENBQUMsaUJBQUQsQ0FBdkI7O0FBQ0EsTUFBTTtBQUFFRyxFQUFBQTtBQUFGLElBQTJCSCxPQUFPLENBQUMsaUJBQUQsQ0FBeEM7O0FBRUFJLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQUtiQyxFQUFBQSxJQUFJLEVBQUVKLE9BQU8sQ0FBQ0ssT0FMRDtBQWFiQyxFQUFBQSxLQUFLLEVBQUUsT0FBT0MsR0FBUCxFQUFZQyxXQUFaLEtBQTRCO0FBQy9CLFVBQU07QUFBRUMsTUFBQUE7QUFBRixRQUFnQlYsVUFBVSxDQUFDLFVBQUQsQ0FBaEM7O0FBRUFGLElBQUFBLENBQUMsQ0FBQ2EsTUFBRixDQUFTRixXQUFULEVBQXNCLENBQUNHLFVBQUQsRUFBYUMsSUFBYixLQUFzQjtBQUN4Q2YsTUFBQUEsQ0FBQyxDQUFDYSxNQUFGLENBQVNDLFVBQVQsRUFBcUIsQ0FBQ0UsTUFBRCxFQUFTQyxhQUFULEtBQTJCO0FBQzVDLFlBQUlDLFdBQVcsR0FBR0gsSUFBSSxHQUFHLEdBQVAsR0FBYUUsYUFBL0I7O0FBRUEsWUFBSSxDQUFDRCxNQUFNLENBQUNHLFVBQVosRUFBd0I7QUFDcEIsZ0JBQU0sSUFBSWYsb0JBQUosQ0FDRCw4Q0FBNkNjLFdBQVksSUFEeEQsRUFFRlIsR0FGRSxFQUdELGNBQWFLLElBQUssSUFBR0UsYUFBYyxFQUhsQyxDQUFOO0FBS0g7O0FBRUQsWUFBSTtBQUFFRSxVQUFBQSxVQUFVLEVBQUVDLGdCQUFkO0FBQWdDLGFBQUdDO0FBQW5DLFlBQTZDTCxNQUFqRDtBQUVBLFlBQUlNLGdCQUFnQixHQUFHVixTQUFTLENBQUNXLGVBQVYsQ0FBMEJSLElBQTFCLEVBQWdDSyxnQkFBaEMsRUFBa0Q7QUFBRUksVUFBQUEsTUFBTSxFQUFFZCxHQUFHLENBQUNjLE1BQUosSUFBY2QsR0FBRyxDQUFDZSxNQUFKLENBQVdELE1BQW5DO0FBQTJDLGFBQUdIO0FBQTlDLFNBQWxELENBQXZCO0FBQ0FYLFFBQUFBLEdBQUcsQ0FBQ2dCLGVBQUosQ0FBb0JSLFdBQXBCLEVBQWlDSSxnQkFBakM7QUFFQVosUUFBQUEsR0FBRyxDQUFDaUIsRUFBSixDQUFPLFVBQVAsRUFBb0JDLGVBQUQsSUFBcUI7QUFDcENBLFVBQUFBLGVBQWUsQ0FBQ0MsSUFBaEIsQ0FBcUJQLGdCQUFnQixDQUFDUSxJQUFqQixFQUFyQjtBQUNILFNBRkQ7QUFHSCxPQW5CRDtBQW9CSCxLQXJCRDtBQXNCSDtBQXRDWSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG4vKipcbiAqIEVuYWJsZSBkYXRhIHNvdXJjZSBmZWF0dXJlXG4gKiBAbW9kdWxlIEZlYXR1cmVfRGF0YVNvdXJjZVxuICovXG5cbmNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcbmNvbnN0IHsgdHJ5UmVxdWlyZSB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvSGVscGVycycpO1xuY29uc3QgRmVhdHVyZSA9IHJlcXVpcmUoJy4uL2VudW0vRmVhdHVyZScpO1xuY29uc3QgeyBJbnZhbGlkQ29uZmlndXJhdGlvbiB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvRXJyb3JzJyk7XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICAgIC8qKlxuICAgICAqIFRoaXMgZmVhdHVyZSBpcyBsb2FkZWQgYXQgc2VydmljZSBzdGFnZVxuICAgICAqIEBtZW1iZXIge3N0cmluZ31cbiAgICAgKi9cbiAgICB0eXBlOiBGZWF0dXJlLlNFUlZJQ0UsXG5cbiAgICAvKipcbiAgICAgKiBMb2FkIHRoZSBmZWF0dXJlXG4gICAgICogQHBhcmFtIHtTZXJ2aWNlQ29udGFpbmVyfSBhcHAgLSBUaGUgYXBwIG1vZHVsZSBvYmplY3RcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YVNvdXJjZXMgLSBEYXRhc291cmNlIHNldHRpbmdzXG4gICAgICogQHJldHVybnMge1Byb21pc2UuPCo+fVxuICAgICAqL1xuICAgIGxvYWRfOiBhc3luYyAoYXBwLCBkYXRhU291cmNlcykgPT4ge1xuICAgICAgICBjb25zdCB7IENvbm5lY3RvciB9ID0gdHJ5UmVxdWlyZSgnQGd4L2VybWwnKTtcblxuICAgICAgICBfLmZvck93bihkYXRhU291cmNlcywgKGRhdGFTb3VyY2UsIGRibXMpID0+IHtcbiAgICAgICAgICAgIF8uZm9yT3duKGRhdGFTb3VyY2UsIChjb25maWcsIGNvbm5lY3Rvck5hbWUpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgc2VydmljZU5hbWUgPSBkYm1zICsgJy4nICsgY29ubmVjdG9yTmFtZTtcblxuICAgICAgICAgICAgICAgIGlmICghY29uZmlnLmNvbm5lY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgYE1pc3NpbmcgY29ubmVjdGlvbiBjb25maWcgZm9yIGRhdGEgc291cmNlIFwiJHtzZXJ2aWNlTmFtZX1cIi5gLFxuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLFxuICAgICAgICAgICAgICAgICAgICAgICAgYGRhdGFTb3VyY2UuJHtkYm1zfS4ke2Nvbm5lY3Rvck5hbWV9YFxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBsZXQgeyBjb25uZWN0aW9uOiBjb25uZWN0aW9uU3RyaW5nLCAuLi5vdGhlciB9ID0gY29uZmlnOyAgXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IGNvbm5lY3RvclNlcnZpY2UgPSBDb25uZWN0b3IuY3JlYXRlQ29ubmVjdG9yKGRibXMsIGNvbm5lY3Rpb25TdHJpbmcsIHsgbG9nZ2VyOiBhcHAubG9nZ2VyIHx8IGFwcC5zZXJ2ZXIubG9nZ2VyLCAuLi5vdGhlciB9KTtcbiAgICAgICAgICAgICAgICBhcHAucmVnaXN0ZXJTZXJ2aWNlKHNlcnZpY2VOYW1lLCBjb25uZWN0b3JTZXJ2aWNlKTtcblxuICAgICAgICAgICAgICAgIGFwcC5vbignc3RvcHBpbmcnLCAoZWxlZ2FudFN0b3BwZXJzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGVsZWdhbnRTdG9wcGVycy5wdXNoKGNvbm5lY3RvclNlcnZpY2UuZW5kXygpKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pOyAgICAgICAgICAgIFxuICAgICAgICB9KTsgICAgICAgIFxuICAgIH1cbn07Il19