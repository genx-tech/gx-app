{"version":3,"file":"soapClient.js","names":["_","waitUntil_","require","Feature","ensureFeatureName","SoapClient","constructor","app","config","soap","tryRequire","createClientAsync","wsdlUrl","then","client","_client","catch","error","logError","_waitForClientReady_","createClientTimeout","maxRound","listMethods_","desc","describe","methods","mapValues","svc","ms","Object","keys","call_","method","args","result","rawResponse","soapHeader","rawRequest","module","exports","type","SERVICE","groupable","load_","settings","name","registerService"],"sources":["../../src/features/soapClient.js"],"sourcesContent":["const { _, waitUntil_ } = require('@genx/july');\nconst Feature = require('../enum/Feature');\nconst { ensureFeatureName } = require(\"../utils/Helpers\");\n\n/**\n * Enable a named soap client\n * @module Feature_SoapClient\n */\n\nclass SoapClient {\n    constructor(app, config) {\n        this.app = app;\n        this.config = config;\n\n        const soap = app.tryRequire('soap');\n\n        soap.createClientAsync(config.wsdlUrl).then(client => {\n            this._client = client;\n        }).catch(error => {\n            this.app.logError(error);\n        });        \n    }    \n\n    async _waitForClientReady_() {\n        if (this._client) return this._client;\n\n        let createClientTimeout = this.config.createClientTimeout || 10000; // 10s\n        let maxRound = createClientTimeout / 100;\n\n        return waitUntil_(() => this._client, 100, maxRound);\n    }\n\n    async listMethods_() {\n        let client = await this._waitForClientReady_();\n\n        let desc = client.describe();\n\n        let methods = _.mapValues(desc, svc => _.mapValues(svc, ms => Object.keys(ms)));         \n        \n        return methods;\n    }\n\n    async call_(method, args) {\n        let client = await this._waitForClientReady_();\n\n        let [result, rawResponse, soapHeader, rawRequest] = await client[method + 'Async'](args);\n\n        return result;\n    }\n}\n\nmodule.exports = {\n\n    /**\n     * This feature is loaded at init stage\n     * @member {string}\n     */\n    type: Feature.SERVICE,\n\n    /**\n     * This feature can be grouped by serviceGroup\n     * @member {boolean}\n     */\n    groupable: true,\n\n    /**\n     * Load the feature\n     * @param {App} app - The cli app module object\n     * @param {object} settings - Settings of soal client   \n     * @returns {Promise.<*>}\n     */\n    load_: async function (app, settings, name) {\n        ensureFeatureName(name);\n\n        let client = new SoapClient(app, settings);\n\n        app.registerService(name, client);\n    }\n};"],"mappings":"oDAAA,KAAM,CAAEA,CAAC,CAAEC,UAAW,CAAC,CAAGC,OAAO,CAAC,YAAY,CAAC,CAC/C,KAAM,CAAAC,OAAO,CAAGD,OAAO,CAAC,iBAAiB,CAAC,CAC1C,KAAM,CAAEE,iBAAkB,CAAC,CAAGF,OAAO,CAAC,kBAAkB,CAAC,CAOzD,KAAM,CAAAG,UAAW,CACbC,WAAWA,CAACC,GAAG,CAAEC,MAAM,CAAE,CACrB,IAAI,CAACD,GAAG,CAAGA,GAAG,CACd,IAAI,CAACC,MAAM,CAAGA,MAAM,CAEpB,KAAM,CAAAC,IAAI,CAAGF,GAAG,CAACG,UAAU,CAAC,MAAM,CAAC,CAEnCD,IAAI,CAACE,iBAAiB,CAACH,MAAM,CAACI,OAAO,CAAC,CAACC,IAAI,CAACC,MAAM,EAAI,CAClD,IAAI,CAACC,OAAO,CAAGD,MACnB,CAAC,CAAC,CAACE,KAAK,CAACC,KAAK,EAAI,CACd,IAAI,CAACV,GAAG,CAACW,QAAQ,CAACD,KAAK,CAC3B,CAAC,CACL,CAEA,KAAM,CAAAE,oBAAoBA,CAAA,CAAG,CACzB,GAAI,IAAI,CAACJ,OAAO,CAAE,MAAO,KAAI,CAACA,OAAO,CAErC,GAAI,CAAAK,mBAAmB,CAAG,IAAI,CAACZ,MAAM,CAACY,mBAAmB,EAAI,KAAK,CAClE,GAAI,CAAAC,QAAQ,CAAGD,mBAAmB,CAAG,GAAG,CAExC,MAAO,CAAAnB,UAAU,CAAC,IAAM,IAAI,CAACc,OAAO,CAAE,GAAG,CAAEM,QAAQ,CACvD,CAEA,KAAM,CAAAC,YAAYA,CAAA,CAAG,CACjB,GAAI,CAAAR,MAAM,CAAG,KAAM,KAAI,CAACK,oBAAoB,EAAE,CAE9C,GAAI,CAAAI,IAAI,CAAGT,MAAM,CAACU,QAAQ,EAAE,CAE5B,GAAI,CAAAC,OAAO,CAAGzB,CAAC,CAAC0B,SAAS,CAACH,IAAI,CAAEI,GAAG,EAAI3B,CAAC,CAAC0B,SAAS,CAACC,GAAG,CAAEC,EAAE,EAAIC,MAAM,CAACC,IAAI,CAACF,EAAE,CAAC,CAAC,CAAC,CAE/E,MAAO,CAAAH,OACX,CAEA,KAAM,CAAAM,KAAKA,CAACC,MAAM,CAAEC,IAAI,CAAE,CACtB,GAAI,CAAAnB,MAAM,CAAG,KAAM,KAAI,CAACK,oBAAoB,EAAE,CAE9C,GAAI,CAACe,MAAM,CAAEC,WAAW,CAAEC,UAAU,CAAEC,UAAU,CAAC,CAAG,KAAM,CAAAvB,MAAM,CAACkB,MAAM,CAAG,OAAO,CAAC,CAACC,IAAI,CAAC,CAExF,MAAO,CAAAC,MACX,CACJ,CAEAI,MAAM,CAACC,OAAO,CAAG,CAMbC,IAAI,CAAErC,OAAO,CAACsC,OAAO,CAMrBC,SAAS,CAAE,IAAI,CAQfC,KAAK,CAAE,cAAAA,CAAgBpC,GAAG,CAAEqC,QAAQ,CAAEC,IAAI,CAAE,CACxCzC,iBAAiB,CAACyC,IAAI,CAAC,CAEvB,GAAI,CAAA/B,MAAM,CAAG,GAAI,CAAAT,UAAU,CAACE,GAAG,CAAEqC,QAAQ,CAAC,CAE1CrC,GAAG,CAACuC,eAAe,CAACD,IAAI,CAAE/B,MAAM,CACpC,CACJ,CAAC"}