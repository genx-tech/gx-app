{"version":3,"file":"httpClient.js","names":["_","url","urlUtil","require","Feature","ensureFeatureName","AllowedMethods","get","post","put","del","delete","upload","download","resToPath","parts","Array","isArray","map","res","encodeURIComponent","join","HttpClient","constructor","agent","endpointOrOptions","options","endpoint","initReq","httpMethod","do","method","path","query","body","toLowerCase","_options","Error","startsWith","req","onSend","timeout","headers","forOwn","v","k","set","withCredentials","send","formData","field","attach","fileField","fileName","onProgress","on","result","type","text","_onSent","onSent","error","_onError","onError","response","_responseError","JSON","parse","resource","data","file","module","exports","SERVICE","groupable","load_","app","settings","name","tryRequire","client","registerService"],"sources":["../../src/features/httpClient.js"],"sourcesContent":["const { _, url: urlUtil } = require(\"@genx/july\");\nconst Feature = require(\"../enum/Feature\");\nconst { ensureFeatureName } = require(\"../utils/Helpers\");\n\n/**\n * Enable a http client as service\n * @module Feature_HttpClient\n */\n\nconst AllowedMethods = {\n    get: \"get\",\n    post: \"post\",\n    put: \"put\",\n    del: \"del\",\n    delete: \"del\",\n    upload: \"post\",\n    download: \"get\",\n};\n\nfunction resToPath(parts) {\n    return parts ? (Array.isArray(parts) ? parts.map((res) => encodeURIComponent(res)).join(\"/\") : parts) : \"\";\n}\n\n/**\n * HTTP client.\n * @class\n */\nclass HttpClient {\n    /**\n     *\n     * @param {*} endpoint\n     */\n    constructor(agent, endpointOrOptions) {\n        this.agent = agent;\n        this.options = typeof endpointOrOptions === \"string\" ? { endpoint: endpointOrOptions } : endpointOrOptions;\n    }\n\n    /**\n     * Initialize a request instance\n     * @param {string} httpMethod \n     * @param {string} url \n     * @returns {Request} \n     */\n    initReq(httpMethod, url) {\n        return this.agent[httpMethod](url);\n    }\n\n    /**\n     *\n     * @param {string} method\n     * @param {string} path\n     * @param {object} query\n     * @param {object} body\n     * @param {object} options - Request options\n     * @property {string} [options.httpMethod] - Specified the http method to override the method argument\n     * @property {string} [options.endpoint] - Specified the base endpoint for this request only\n     * @property {function} [options.onSend] - Specified the onSend hook for this request only\n     * @property {integer} [options.timeout] - Specified the timeout setting for this request only\n     * @property {object} [options.headers] - Specified the headers for this request only\n     * @property {boolean} [options.withCredentials] - Specified the withCredentials header for CORS\n     * @property {object} [options.formData] - Specified the form fields \n     * @property {object} [options.fileField='file'] - Specified the file field name\n     * @property {object} [options.fileName] - Specified the file name to override the file to upload\n     * @property {function} [options.onProgress] - Specified the on progress callback\n     * @returns {*}\n     */\n    async do(method, path, query, body, options) {\n        method = method.toLowerCase();\n        const _options = { ...this.options, ...options };\n\n        let httpMethod = _options.httpMethod ?? AllowedMethods[method];\n        if (!httpMethod) {\n            throw new Error(\"Invalid method: \" + method);\n        }\n\n        let url = path.startsWith(\"http:\") || path.startsWith(\"https:\") ? path : urlUtil.join(_options.endpoint, path);\n\n        let req = this.initReq(httpMethod, url);\n\n        if (this.onSend) {\n            this.onSend(req);\n        }\n\n        if (_options.onSend) {\n            _options.onSend(req);\n        }\n\n        if (_options.timeout) {\n            req.timeout(_options.timeout);\n        }\n\n        if (_options.headers) {\n            _.forOwn(_options.headers, (v, k) => {\n                req.set(k, v);\n            });\n        }\n\n        if (_options.withCredentials) {\n            req.withCredentials();\n        }\n\n        if (query) {\n            req.query(query);\n        }        \n\n        if (method === \"download\") {\n            if (httpMethod !== 'get') {\n                req.send(body);\n            }\n        } else if (method === \"upload\") {\n            if (_options.formData) {\n                _.forOwn(_options.formData, (v, k) => {\n                    req.field(k, v);\n                });\n            }\n            req.attach(_options.fileField ?? \"file\", body, _options.fileName);\n        } else if (httpMethod !== 'get') {\n            req.send(body ?? _options.body);\n        }\n\n        if (_options.onProgress) {\n            req.on(\"progress\", _options.onProgress);\n        }\n\n        try {\n            const res = await req;\n            const result = res.type.startsWith(\"text/\") ? res.text : res.body;\n\n            const _onSent = _options.onSent ?? this.onSent;\n\n            if (_onSent != null) {\n                await _onSent(url, result, res);\n            }\n\n            return result;\n        } catch (error) {\n            const _onError = _options.onError ?? this.onError;\n\n            if (error.response && error.response.error) {\n                const _responseError = error.response.error;\n\n                if (error.response.type === \"application/json\") {\n                    _responseError.body = JSON.parse(error.response.text);\n                }\n\n                if (_onError != null) {\n                    return _onError(_responseError, error);\n                }\n\n                throw _responseError;\n            }\n\n            if (_onError != null) {\n                return _onError(error);\n            }\n\n            throw error;\n        }\n    }\n\n    async get(resource, query, options) {\n        return this.do(\"get\", resToPath(resource), query, null, options);\n    }\n\n    async post(resource, data, query, options) {\n        return this.do(\"post\", resToPath(resource), query, data, options);\n    }\n\n    async put(resource, data, query, options) {\n        return this.do(\"put\", resToPath(resource), query, data, options);\n    }\n\n    async del(resource, query, options) {\n        return this.do(\"del\", resToPath(resource), query, null, options);\n    }\n\n    async upload(resource, file, query, options) {\n        return this.do(\"upload\", resToPath(resource), query, file, options);\n    }\n\n    async download(resource, query, options) {\n        return this.do(\"download\", resToPath(resource), query, null, options);\n    }\n}\n\nmodule.exports = {\n    /**\n     * This feature is loaded at init stage\n     * @member {string}\n     */\n    type: Feature.SERVICE,\n\n    /**\n     * This feature can be grouped by serviceGroup\n     * @member {boolean}\n     */\n    groupable: true,\n\n    HttpClient,\n\n    /**\n     * Load the feature\n     * @param {App} app - The cli app module object\n     * @param {object} settings - Settings of rest clients\n     * @returns {Promise.<*>}\n     */\n    load_: async function (app, settings, name) {\n        ensureFeatureName(name);\n\n        const agent = app.tryRequire(\"superagent\").agent();\n\n        let client = new HttpClient(agent, settings);\n\n        app.registerService(name, client);\n    },\n};\n"],"mappings":"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"}