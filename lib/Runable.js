"use strict";

require("source-map-support/register");

const {
  _,
  sleep_,
  eachAsync_
} = require('@genx/july');

const winston = require('winston');

const winstonFlight = require('winstonflight');

const Logger = require('winston/lib/winston/logger');

const Runable = T => {
  var _temp;

  return _temp = class extends T {
    constructor(name, options) {
      super(name, {
        logger: {
          "useMetaKey": "metadata",
          "level": "info",
          "transports": [{
            "type": "console",
            "options": {
              "format": winston.format.combine(winston.format.colorize(), winston.format.simple())
            }
          }],
          ...(options && options.logger)
        },
        exitOnUncaught: true,
        ..._.omit(options, ['logger'])
      });

      this._getOnUncaughtException = exitOnError => err => {
        if (exitOnError) {
          let waitForLogging = setTimeout(() => {
            process.exit(1);
          }, 1000);
          this.log('error', err, () => {
            clearTimeout(waitForLogging);
            process.exit(1);
          });
        } else {
          this.logError(err);
        }
      };

      this._onWarning = warning => {
        this.log('warn', warning.message);
      };

      this._onExit = code => {
        if (this.started) {
          this.stop_().catch(this.logError);
        }
      };
    }

    async start_() {
      this._initialize();

      process.on('exit', this._onExit);
      return super.start_();
    }

    async stop_() {
      if (this.started) {
        if (this.libModules) {
          await eachAsync_(this.libModules, lib => lib.stop_());
          delete this.libModules;
        }
      }

      process.removeListener('exit', this._onExit);
      await super.stop_();
      await sleep_(0);

      this._uninitialize();
    }

    getLib(libName) {
      if (!this.libModules) {
        throw new Error('"libModules" feature is required to access lib among modules.');
      }

      let libModule = this.libModules[libName];

      if (!libModule) {
        throw new Error(`Lib module [${libName}] not found.`);
      }

      return libModule;
    }

    requireFromLib(libName, relativePath) {
      let libModule = this.getLib(libName);
      return libModule.require(relativePath);
    }

    registerLib(lib) {
      if (!this.libModules) {
        this.libModules = {};
      }

      this.libModules[lib.name] = lib;
    }

    _initialize() {
      this._pwd = process.cwd();

      if (this.workingPath !== this._pwd) {
        process.chdir(this.workingPath);
      }

      this._injectLogger();

      this._injectErrorHandlers();
    }

    _uninitialize() {
      const detach = true;

      this._injectErrorHandlers(detach);

      this._injectLogger(detach);

      process.chdir(this._pwd);
      delete this._pwd;
    }

    _injectLogger(detach) {
      if (detach) {
        this.log('verbose', 'Logger is detaching ...');

        if (!this._externalLogger) {
          this.logger.close();
        }

        delete this._externalLogger;
        delete this.logger;
        return;
      }

      if (this.options.logger instanceof Logger) {
        this.logger = this.options.logger;
        this._externalLogger = true;
      } else {
        const loggerOpt = _.cloneDeep(this.options.logger);

        if (loggerOpt.transports) {
          loggerOpt.transports = winstonFlight(winston, loggerOpt.transports);
        }

        this.logger = winston.createLogger(loggerOpt);
      }

      this.log('verbose', 'Logger injected.');
    }

    _injectErrorHandlers(detach) {
      if (detach) {
        process.removeListener('warning', this._onWarning);

        if (this._onUncaughtException) {
          process.removeListener('uncaughtException', this._onUncaughtException);
          delete this._onUncaughtException;
        }

        this.log('verbose', 'Process-wide error handlers detached.');
        return;
      }

      if (!this.options.ignoreUncaught) {
        this._onUncaughtException = this._getOnUncaughtException(this.options.exitOnUncaught);
        process.on('uncaughtException', this._onUncaughtException);
      }

      process.on('warning', this._onWarning);
      this.log('verbose', 'Process-wide error handlers injected.');
    }

  }, _temp;
};

module.exports = Runable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9SdW5hYmxlLmpzIl0sIm5hbWVzIjpbIl8iLCJzbGVlcF8iLCJlYWNoQXN5bmNfIiwicmVxdWlyZSIsIndpbnN0b24iLCJ3aW5zdG9uRmxpZ2h0IiwiTG9nZ2VyIiwiUnVuYWJsZSIsIlQiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJvcHRpb25zIiwibG9nZ2VyIiwiZm9ybWF0IiwiY29tYmluZSIsImNvbG9yaXplIiwic2ltcGxlIiwiZXhpdE9uVW5jYXVnaHQiLCJvbWl0IiwiX2dldE9uVW5jYXVnaHRFeGNlcHRpb24iLCJleGl0T25FcnJvciIsImVyciIsIndhaXRGb3JMb2dnaW5nIiwic2V0VGltZW91dCIsInByb2Nlc3MiLCJleGl0IiwibG9nIiwiY2xlYXJUaW1lb3V0IiwibG9nRXJyb3IiLCJfb25XYXJuaW5nIiwid2FybmluZyIsIm1lc3NhZ2UiLCJfb25FeGl0IiwiY29kZSIsInN0YXJ0ZWQiLCJzdG9wXyIsImNhdGNoIiwic3RhcnRfIiwiX2luaXRpYWxpemUiLCJvbiIsImxpYk1vZHVsZXMiLCJsaWIiLCJyZW1vdmVMaXN0ZW5lciIsIl91bmluaXRpYWxpemUiLCJnZXRMaWIiLCJsaWJOYW1lIiwiRXJyb3IiLCJsaWJNb2R1bGUiLCJyZXF1aXJlRnJvbUxpYiIsInJlbGF0aXZlUGF0aCIsInJlZ2lzdGVyTGliIiwiX3B3ZCIsImN3ZCIsIndvcmtpbmdQYXRoIiwiY2hkaXIiLCJfaW5qZWN0TG9nZ2VyIiwiX2luamVjdEVycm9ySGFuZGxlcnMiLCJkZXRhY2giLCJfZXh0ZXJuYWxMb2dnZXIiLCJjbG9zZSIsImxvZ2dlck9wdCIsImNsb25lRGVlcCIsInRyYW5zcG9ydHMiLCJjcmVhdGVMb2dnZXIiLCJfb25VbmNhdWdodEV4Y2VwdGlvbiIsImlnbm9yZVVuY2F1Z2h0IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7QUFFQSxNQUFNO0FBQUVBLEVBQUFBLENBQUY7QUFBS0MsRUFBQUEsTUFBTDtBQUFhQyxF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TyxLQUFLQSxvQkFBWjtBQUNIOztBQUNELGFBQUt0QyxHQUFMLENBQVMsU0FBVCxFQUFvQix1Q0FBcEI7QUFDQTtBQUNIOztBQUVELFVBQUksQ0FBQyxLQUFLZixPQUFMLENBQWFzRCxjQUFsQixFQUFrQztBQUM5QixhQUFLRCxvQkFBTCxHQUE0QixLQUFLN0MsdUJBQUwsQ0FBNkIsS0FBS1IsT0FBTCxDQUFhTSxjQUExQyxDQUE1QjtBQUNBTyxRQUFBQSxPQUFPLENBQUNlLEVBQVIsQ0FBVyxtQkFBWCxFQUFnQyxLQUFLeUIsb0JBQXJDO0FBQ0g7O0FBRUR4QyxNQUFBQSxPQUFPLENBQUNlLEVBQVIsQ0FBVyxTQUFYLEVBQXNCLEtBQUtWLFVBQTNCO0FBQ0EsV0FBS0gsR0FBTCxDQUFTLFNBQVQsRUFBb0IsdUNBQXBCO0FBQ0g7O0FBbk1nQyxHQUFwQjtBQUFBLENBQWpCOztBQXNNQXdDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjVELE9BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IHsgXywgc2xlZXBfLCBlYWNoQXN5bmNfIH0gPSByZXF1aXJlKCdAZ2VueC9qdWx5Jyk7XG5cbmNvbnN0IHdpbnN0b24gPSByZXF1aXJlKCd3aW5zdG9uJyk7XG5jb25zdCB3aW5zdG9uRmxpZ2h0ID0gcmVxdWlyZSgnd2luc3RvbmZsaWdodCcpO1xuY29uc3QgTG9nZ2VyID0gcmVxdWlyZSgnd2luc3Rvbi9saWIvd2luc3Rvbi9sb2dnZXInKTtcblxuLyoqXG4gKiBSdW5hYmxlIGFwcCBtaXhpbi4gXG4gKiBAcGFyYW0ge29iamVjdH0gVCAtIEJhc2UgY2xhc3MuICAgICBcbiAqIEByZXR1cm5zIHtSdW5hYmxlfSBBIHJ1bmFibGUgYXBwIGNsYXNzLlxuICogQGNvbnN0cnVjdHMgUnVuYWJsZShUKVxuICovXG5jb25zdCBSdW5hYmxlID0gVCA9PiBjbGFzcyBleHRlbmRzIFQge1xuICAgIF9nZXRPblVuY2F1Z2h0RXhjZXB0aW9uID0gZXhpdE9uRXJyb3IgPT4gZXJyID0+IHtcbiAgICAgICAgaWYgKGV4aXRPbkVycm9yKSB7XG4gICAgICAgICAgICAvL3dhaXQgMSBzZWNvbmQgZm9yIGZsdXNoaW5nIHRoZSBsYXN0IGxvZ1xuICAgICAgICAgICAgbGV0IHdhaXRGb3JMb2dnaW5nID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICAgICAgfSwgMTAwMCk7XG5cbiAgICAgICAgICAgIHRoaXMubG9nKCdlcnJvcicsIGVyciwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh3YWl0Rm9yTG9nZ2luZyk7XG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmxvZ0Vycm9yKGVycik7XG4gICAgICAgIH1cbiAgICB9OyAgICAgICAgXG5cbiAgICBfb25XYXJuaW5nID0gd2FybmluZyA9PiB7XG4gICAgICAgIHRoaXMubG9nKCd3YXJuJywgd2FybmluZy5tZXNzYWdlKTsgICBcbiAgICB9O1xuXG4gICAgX29uRXhpdCA9IGNvZGUgPT4ge1xuICAgICAgICBpZiAodGhpcy5zdGFydGVkKSB7XG4gICAgICAgICAgICB0aGlzLnN0b3BfKCkuY2F0Y2godGhpcy5sb2dFcnJvcik7XG4gICAgICAgIH0gICAgICAgICAgIFxuICAgIH07XG5cbiAgICAvKiogICAgICAgICAgICAgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGFwcGxpY2F0aW9uLiAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIEFwcGxpY2F0aW9uIG9wdGlvbnMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbb3B0aW9ucy5sb2dnZXJdIC0gTG9nZ2VyIG9wdGlvbnMgICAgXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLmlnbm9yZVVuY2F1Z2h0PWZhbHNlXSAtIFdoZXRoZXIgdG8gc2tpcCB0aGUgaGFuZGxpbmcgb2YgdW5jYXVnaHQgZXhjZXB0aW9uXG4gICAgICogQHByb3BlcnR5IHtvYmplY3R9IFtvcHRpb25zLmV4aXRPblVuY2F1Z2h0PXRydWVdIC0gV2hldGhlciB0byBleGl0IHByb2Nlc3Mgb24gdW5jYXVnaHQgZXhjZXB0aW9uIHRocm93blxuICAgICAqIEBjb25zdHJ1Y3RzIFJ1bmFibGVcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihuYW1lLCBvcHRpb25zKSB7XG4gICAgICAgIHN1cGVyKG5hbWUsIHtcbiAgICAgICAgICAgIGxvZ2dlcjoge1xuICAgICAgICAgICAgICAgIFwidXNlTWV0YUtleVwiOiBcIm1ldGFkYXRhXCIsXG4gICAgICAgICAgICAgICAgXCJsZXZlbFwiOiBcImluZm9cIixcbiAgICAgICAgICAgICAgICBcInRyYW5zcG9ydHNcIjogW1xuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBcInR5cGVcIjogXCJjb25zb2xlXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBcIm9wdGlvbnNcIjogeyAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImZvcm1hdFwiOiB3aW5zdG9uLmZvcm1hdC5jb21iaW5lKHdpbnN0b24uZm9ybWF0LmNvbG9yaXplKCksIHdpbnN0b24uZm9ybWF0LnNpbXBsZSgpKVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICAuLi4ob3B0aW9ucyAmJiBvcHRpb25zLmxvZ2dlcilcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBleGl0T25VbmNhdWdodDogdHJ1ZSxcbiAgICAgICAgICAgIC4uLl8ub21pdChvcHRpb25zLCBbJ2xvZ2dlciddKVxuICAgICAgICB9KTsgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IHRoZSBhcHAgICAgIFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgICAqIEBtZW1iZXJvZiBSdW5hYmxlXG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRfKCkgeyAgICAgICAgXG4gICAgICAgIHRoaXMuX2luaXRpYWxpemUoKTtcblxuICAgICAgICBwcm9jZXNzLm9uKCdleGl0JywgdGhpcy5fb25FeGl0KTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBzdXBlci5zdGFydF8oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdG9wIHRoZSBhcHBcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICAgKiBAbWVtYmVyb2YgUnVuYWJsZVxuICAgICAqL1xuICAgIGFzeW5jIHN0b3BfKCkge1xuICAgICAgICBpZiAodGhpcy5zdGFydGVkKSB7ICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAodGhpcy5saWJNb2R1bGVzKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgZWFjaEFzeW5jXyh0aGlzLmxpYk1vZHVsZXMsIGxpYiA9PiBsaWIuc3RvcF8oKSk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubGliTW9kdWxlcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHByb2Nlc3MucmVtb3ZlTGlzdGVuZXIoJ2V4aXQnLCB0aGlzLl9vbkV4aXQpO1xuXG4gICAgICAgIGF3YWl0IHN1cGVyLnN0b3BfKCk7XG5cbiAgICAgICAgYXdhaXQgc2xlZXBfKDApO1xuXG4gICAgICAgIHRoaXMuX3VuaW5pdGlhbGl6ZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgbGliIG1vZHVsZVxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBsaWJOYW1lIFxuICAgICAqL1xuICAgIGdldExpYihsaWJOYW1lKSB7XG4gICAgICAgIGlmICghdGhpcy5saWJNb2R1bGVzKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wibGliTW9kdWxlc1wiIGZlYXR1cmUgaXMgcmVxdWlyZWQgdG8gYWNjZXNzIGxpYiBhbW9uZyBtb2R1bGVzLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGxpYk1vZHVsZSA9IHRoaXMubGliTW9kdWxlc1tsaWJOYW1lXTtcbiAgICAgICAgXG4gICAgICAgIGlmICghbGliTW9kdWxlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYExpYiBtb2R1bGUgWyR7bGliTmFtZX1dIG5vdCBmb3VuZC5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBsaWJNb2R1bGU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVxdWlyZSBhIG1vZHVsZSBmcm9tIHRoZSBzb3VyY2UgcGF0aCBvZiBhIGxpYnJhcnkgbW9kdWxlXG4gICAgICogQHBhcmFtIHsqfSByZWxhdGl2ZVBhdGggXG4gICAgICovXG4gICAgcmVxdWlyZUZyb21MaWIobGliTmFtZSwgcmVsYXRpdmVQYXRoKSB7XG4gICAgICAgIGxldCBsaWJNb2R1bGUgPSB0aGlzLmdldExpYihsaWJOYW1lKTtcbiAgICAgICAgcmV0dXJuIGxpYk1vZHVsZS5yZXF1aXJlKHJlbGF0aXZlUGF0aCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVnaXN0ZXIgYSBsb2FkZWQgbGliIG1vZHVsZVxuICAgICAqIEBwYXJhbSB7TGliTW9kdWxlfSBsaWIgXG4gICAgICovXG4gICAgcmVnaXN0ZXJMaWIobGliKSB7XG4gICAgICAgIGlmICghdGhpcy5saWJNb2R1bGVzKSB7XG4gICAgICAgICAgICB0aGlzLmxpYk1vZHVsZXMgPSB7fTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubGliTW9kdWxlc1tsaWIubmFtZV0gPSBsaWI7XG4gICAgfVxuXG4gICAgX2luaXRpYWxpemUoKSB7XG4gICAgICAgIHRoaXMuX3B3ZCA9IHByb2Nlc3MuY3dkKCk7XG4gICAgICAgIGlmICh0aGlzLndvcmtpbmdQYXRoICE9PSB0aGlzLl9wd2QpIHsgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBwcm9jZXNzLmNoZGlyKHRoaXMud29ya2luZ1BhdGgpO1xuICAgICAgICB9ICAgICAgXG5cbiAgICAgICAgdGhpcy5faW5qZWN0TG9nZ2VyKCk7XG4gICAgICAgIHRoaXMuX2luamVjdEVycm9ySGFuZGxlcnMoKTsgXG4gICAgfVxuXG4gICAgX3VuaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgY29uc3QgZGV0YWNoID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5faW5qZWN0RXJyb3JIYW5kbGVycyhkZXRhY2gpOyAgICAgICBcbiAgICAgICAgdGhpcy5faW5qZWN0TG9nZ2VyKGRldGFjaCk7ICAgICAgICAgXG5cbiAgICAgICAgcHJvY2Vzcy5jaGRpcih0aGlzLl9wd2QpO1xuICAgICAgICBkZWxldGUgdGhpcy5fcHdkO1xuICAgIH1cblxuICAgIF9pbmplY3RMb2dnZXIoZGV0YWNoKSB7XG4gICAgICAgIGlmIChkZXRhY2gpIHtcbiAgICAgICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ0xvZ2dlciBpcyBkZXRhY2hpbmcgLi4uJyk7XG5cbiAgICAgICAgICAgIGlmICghdGhpcy5fZXh0ZXJuYWxMb2dnZXIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5jbG9zZSgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBkZWxldGUgdGhpcy5fZXh0ZXJuYWxMb2dnZXI7XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5sb2dnZXI7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ2dlciBpbnN0YW5jZW9mIExvZ2dlcikge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIgPSB0aGlzLm9wdGlvbnMubG9nZ2VyO1xuICAgICAgICAgICAgdGhpcy5fZXh0ZXJuYWxMb2dnZXIgPSB0cnVlO1xuICAgICAgICB9IGVsc2UgeyAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBsb2dnZXJPcHQgPSBfLmNsb25lRGVlcCh0aGlzLm9wdGlvbnMubG9nZ2VyKVxuXG4gICAgICAgICAgICBpZiAobG9nZ2VyT3B0LnRyYW5zcG9ydHMpIHsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbG9nZ2VyT3B0LnRyYW5zcG9ydHMgPSB3aW5zdG9uRmxpZ2h0KHdpbnN0b24sIGxvZ2dlck9wdC50cmFuc3BvcnRzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5sb2dnZXIgPSB3aW5zdG9uLmNyZWF0ZUxvZ2dlcihsb2dnZXJPcHQpOyAgIFxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdMb2dnZXIgaW5qZWN0ZWQuJyk7ICAgICAgICAgICAgXG4gICAgfVxuXG4gICAgX2luamVjdEVycm9ySGFuZGxlcnMoZGV0YWNoKSB7XG4gICAgICAgIGlmIChkZXRhY2gpIHsgICAgICAgICAgICBcbiAgICAgICAgICAgIHByb2Nlc3MucmVtb3ZlTGlzdGVuZXIoJ3dhcm5pbmcnLCB0aGlzLl9vbldhcm5pbmcpO1xuICAgICAgICAgICAgaWYgKHRoaXMuX29uVW5jYXVnaHRFeGNlcHRpb24pIHtcbiAgICAgICAgICAgICAgICBwcm9jZXNzLnJlbW92ZUxpc3RlbmVyKCd1bmNhdWdodEV4Y2VwdGlvbicsIHRoaXMuX29uVW5jYXVnaHRFeGNlcHRpb24pO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9vblVuY2F1Z2h0RXhjZXB0aW9uO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnUHJvY2Vzcy13aWRlIGVycm9yIGhhbmRsZXJzIGRldGFjaGVkLicpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuaWdub3JlVW5jYXVnaHQpIHtcbiAgICAgICAgICAgIHRoaXMuX29uVW5jYXVnaHRFeGNlcHRpb24gPSB0aGlzLl9nZXRPblVuY2F1Z2h0RXhjZXB0aW9uKHRoaXMub3B0aW9ucy5leGl0T25VbmNhdWdodCk7XG4gICAgICAgICAgICBwcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIHRoaXMuX29uVW5jYXVnaHRFeGNlcHRpb24pOyAgICAgXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHByb2Nlc3Mub24oJ3dhcm5pbmcnLCB0aGlzLl9vbldhcm5pbmcpO1xuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdQcm9jZXNzLXdpZGUgZXJyb3IgaGFuZGxlcnMgaW5qZWN0ZWQuJyk7ICAgICAgICAgICAgXG4gICAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBSdW5hYmxlOyJdfQ==