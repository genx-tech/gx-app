"use strict";

require("source-map-support/register");

const Util = require('rk-utils');

const {
  _,
  sleep_
} = Util;

const winston = require('winston');

const winstonFlight = require('winstonflight');

const Logger = require('winston/lib/winston/logger');

const Runable = T => {
  var _temp;

  return _temp = class extends T {
    constructor(name, options) {
      super(name, {
        logger: {
          "useMetaKey": "metadata",
          "level": "info",
          "transports": [{
            "type": "console",
            "options": {
              "format": winston.format.combine(winston.format.colorize(), winston.format.simple())
            }
          }],
          ...(options && options.logger)
        },
        ..._.omit(options, ['logger'])
      });

      this._onUncaughtException = err => {
        let waitForLogging = setTimeout(() => {
          process.exit(1);
        }, 1000);
        this.log('error', err, () => {
          clearTimeout(waitForLogging);
          process.exit(1);
        });
      };

      this._onWarning = warning => {
        this.log('warn', warning.message);
      };

      this._onExit = code => {
        if (this.started) {
          this.stop_().catch(this.logError);
        }
      };
    }

    async start_() {
      this._initialize();

      process.on('exit', this._onExit);
      return super.start_();
    }

    async stop_() {
      process.removeListener('exit', this._onExit);
      await super.stop_();
      await sleep_(0);

      this._uninitialize();
    }

    getLib(libName) {
      if (!this.libModules) {
        throw new Error('"libModules" feature is required to access lib among modules.');
      }

      let libModule = this.libModules[libName];

      if (!libModule) {
        throw new Error(`Lib module [${libName}] not found.`);
      }

      return libModule;
    }

    requireFromLib(libName, relativePath) {
      let libModule = this.getLib(libName);
      return libModule.require(relativePath);
    }

    registerLib(lib) {
      if (!this.libModules) {
        this.libModules = {};
      }

      this.libModules[lib.name] = lib;
    }

    _initialize() {
      this._pwd = process.cwd();

      if (this.workingPath !== this._pwd) {
        process.chdir(this.workingPath);
      }

      this._injectLogger();

      this._injectErrorHandlers();
    }

    _uninitialize() {
      const detach = true;

      this._injectErrorHandlers(detach);

      this._injectLogger(detach);

      process.chdir(this._pwd);
      delete this._pwd;
    }

    _injectLogger(detach) {
      if (detach) {
        this.log('verbose', 'Logger is detaching ...');

        if (!this._externalLogger) {
          this.logger.close();
        }

        delete this._externalLogger;
        delete this.logger;
        return;
      }

      let loggerOpt = this.options.logger;

      if (loggerOpt instanceof Logger) {
        this.logger = loggerOpt;
        this._externalLogger = true;
      } else {
        if (loggerOpt.transports) {
          loggerOpt.transports = winstonFlight(winston, loggerOpt.transports);
        }

        this.logger = winston.createLogger(loggerOpt);
      }

      this.log('verbose', 'Logger injected.');
    }

    _injectErrorHandlers(detach) {
      if (detach) {
        process.removeListener('warning', this._onWarning);
        process.removeListener('uncaughtException', this._onUncaughtException);
        this.log('verbose', 'Process-wide error handlers detached.');
        return;
      }

      process.on('uncaughtException', this._onUncaughtException);
      process.on('warning', this._onWarning);
      this.log('verbose', 'Process-wide error handlers injected.');
    }

  }, _temp;
};

module.exports = Runable;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9SdW5hYmxlLmpzIl0sIm5hbWVzIjpbIlV0aWwiLCJyZXF1aXJlIiwiXyIsInNsZWVwXyIsIndpbnN0b24iLCJ3aW5zdG9uRmxpZ2h0IiwiTG9nZ2VyIiwiUnVuYWJsZSIsIlQiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJvcHRpb25zIiwibG9nZ2VyIiwiZm9ybWF0IiwiY29tYmluZSIsImNvbG9yaXplIiwic2ltcGxlIiwib21pdCIsIl9vblVuY2F1Z2h0RXhjZXB0aW9uIiwiZXJyIiwid2FpdEZvckxvZ2dpbmciLCJzZXRUaW1lb3V0IiwicHJvY2VzcyIsImV4aXQiLCJsb2ciLCJjbGVhclRpbWVvdXQiLCJfb25XYXJuaW5nIiwid2FybmluZyIsIm1lc3NhZ2UiLCJfb25FeGl0IiwiY29kZSIsInN0YXJ0ZWQiLCJzdG9wXyIsImNhdGNoIiwibG9nRXJyb3IiLCJzdGFydF8iLCJfaW5pdGlhbGl6ZSIsIm9uIiwicmVtb3ZlTGlzdGVuZXIiLCJfdW5pbml0aWFsaXplIiwiZ2V0TGliIiwibGliTmFtZSIsImxpYk1vZHVsZXMiLCJFcnJvciIsImxpYk1vZHVsZSIsInJlcXVpcmVGcm9tTGliIiwicmVsYXRpdmVQYXRoIiwicmVnaXN0ZXJMaWIiLCJsaWIiLCJfcHdkIiwiY3dkIiwid29ya2luZ1BhdGgiLCJjaGRpciIsIl9pbmplY3RMb2dnZXIiLCJfaW5qZWN0RXJyb3JIYW5kbGVycyIsImRldGFjaCIsIl9leHRlcm5hbExvZ2dlciIsImNsb3NlIiwibG9nZ2VyT3B0IiwidHJhbnNwb3J0cyIsImNyZWF0ZUxvZ2dlciIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBRUEsTUFBTUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUFwQjs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxJQUFnQkgsSUFBdEI7O0FBRUEsTUFBTUksT0FBTyxHQUFHSCxPQUFPLENBQUMsU0FBRCxDQUF2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QUF1QixJQUF2QjtBQUNILE9BSEQsTUFHTztBQUNILFlBQUlFLFNBQVMsQ0FBQ0MsVUFBZCxFQUEwQjtBQUN0QkQsVUFBQUEsU0FBUyxDQUFDQyxVQUFWLEdBQXVCdEQsYUFBYSxDQUFDRCxPQUFELEVBQVVzRCxTQUFTLENBQUNDLFVBQXBCLENBQXBDO0FBQ0g7O0FBRUQsYUFBSy9DLE1BQUwsR0FBY1IsT0FBTyxDQUFDd0QsWUFBUixDQUFxQkYsU0FBckIsQ0FBZDtBQUNIOztBQUVELFdBQUtsQyxHQUFMLENBQVMsU0FBVCxFQUFvQixrQkFBcEI7QUFDSDs7QUFFRDhCLElBQUFBLG9CQUFvQixDQUFDQyxNQUFELEVBQVM7QUFDekIsVUFBSUEsTUFBSixFQUFZO0FBQ1JqQyxRQUFBQSxPQUFPLENBQUNnQixjQUFSLENBQXVCLFNBQXZCLEVBQWtDLEtBQUtaLFVBQXZDO0FBQ0FKLFFBQUFBLE9BQU8sQ0FBQ2dCLGNBQVIsQ0FBdUIsbUJBQXZCLEVBQTRDLEtBQUtwQixvQkFBakQ7QUFDQSxhQUFLTSxHQUFMLENBQVMsU0FBVCxFQUFvQix1Q0FBcEI7QUFDQTtBQUNIOztBQUVERixNQUFBQSxPQUFPLENBQUNlLEVBQVIsQ0FBVyxtQkFBWCxFQUFnQyxLQUFLbkIsb0JBQXJDO0FBQ0FJLE1BQUFBLE9BQU8sQ0FBQ2UsRUFBUixDQUFXLFNBQVgsRUFBc0IsS0FBS1gsVUFBM0I7QUFDQSxXQUFLRixHQUFMLENBQVMsU0FBVCxFQUFvQix1Q0FBcEI7QUFDSDs7QUE3S2dDLEdBQXBCO0FBQUEsQ0FBakI7O0FBZ0xBcUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCdkQsT0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuY29uc3QgVXRpbCA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5jb25zdCB7IF8sIHNsZWVwXyB9ID0gVXRpbDtcblxuY29uc3Qgd2luc3RvbiA9IHJlcXVpcmUoJ3dpbnN0b24nKTtcbmNvbnN0IHdpbnN0b25GbGlnaHQgPSByZXF1aXJlKCd3aW5zdG9uZmxpZ2h0Jyk7XG5jb25zdCBMb2dnZXIgPSByZXF1aXJlKCd3aW5zdG9uL2xpYi93aW5zdG9uL2xvZ2dlcicpO1xuXG4vKipcbiAqIFJ1bmFibGUgYXBwIG1peGluLiBcbiAqIEBwYXJhbSB7b2JqZWN0fSBUIC0gQmFzZSBjbGFzcy4gICAgIFxuICogQHJldHVybnMge1J1bmFibGV9IEEgcnVuYWJsZSBhcHAgY2xhc3MuXG4gKiBAY29uc3RydWN0cyBSdW5hYmxlKFQpXG4gKi9cbmNvbnN0IFJ1bmFibGUgPSBUID0+IGNsYXNzIGV4dGVuZHMgVCB7XG4gICAgX29uVW5jYXVnaHRFeGNlcHRpb24gPSBlcnIgPT4ge1xuICAgICAgICBsZXQgd2FpdEZvckxvZ2dpbmcgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfSwgMTAwMCk7XG5cbiAgICAgICAgdGhpcy5sb2coJ2Vycm9yJywgZXJyLCAoKSA9PiB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQod2FpdEZvckxvZ2dpbmcpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9KTtcbiAgICB9OyAgICAgICAgXG5cbiAgICBfb25XYXJuaW5nID0gd2FybmluZyA9PiB7XG4gICAgICAgIHRoaXMubG9nKCd3YXJuJywgd2FybmluZy5tZXNzYWdlKTsgICBcbiAgICB9O1xuXG4gICAgX29uRXhpdCA9IGNvZGUgPT4ge1xuICAgICAgICBpZiAodGhpcy5zdGFydGVkKSB7XG4gICAgICAgICAgICB0aGlzLnN0b3BfKCkuY2F0Y2godGhpcy5sb2dFcnJvcik7XG4gICAgICAgIH0gICAgICAgICAgIFxuICAgIH07XG5cbiAgICAvKiogICAgICAgICAgICAgICAgIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGFwcGxpY2F0aW9uLiAgICAgXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIEFwcGxpY2F0aW9uIG9wdGlvbnMgICAgIFxuICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBbb3B0aW9ucy5sb2dnZXJdIC0gTG9nZ2VyIG9wdGlvbnMgICAgXG4gICAgICogQGNvbnN0cnVjdHMgUnVuYWJsZVxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG5hbWUsIG9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIobmFtZSwge1xuICAgICAgICAgICAgbG9nZ2VyOiB7XG4gICAgICAgICAgICAgICAgXCJ1c2VNZXRhS2V5XCI6IFwibWV0YWRhdGFcIixcbiAgICAgICAgICAgICAgICBcImxldmVsXCI6IFwiaW5mb1wiLFxuICAgICAgICAgICAgICAgIFwidHJhbnNwb3J0c1wiOiBbXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwidHlwZVwiOiBcImNvbnNvbGVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwib3B0aW9uc1wiOiB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiZm9ybWF0XCI6IHdpbnN0b24uZm9ybWF0LmNvbWJpbmUod2luc3Rvbi5mb3JtYXQuY29sb3JpemUoKSwgd2luc3Rvbi5mb3JtYXQuc2ltcGxlKCkpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIC4uLihvcHRpb25zICYmIG9wdGlvbnMubG9nZ2VyKVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIC4uLl8ub21pdChvcHRpb25zLCBbJ2xvZ2dlciddKVxuICAgICAgICB9KTsgICAgICAgIFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0IHRoZSBhcHAgICAgIFxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgICAqIEBtZW1iZXJvZiBSdW5hYmxlXG4gICAgICovXG4gICAgYXN5bmMgc3RhcnRfKCkgeyAgICAgICAgXG4gICAgICAgIHRoaXMuX2luaXRpYWxpemUoKTtcblxuICAgICAgICBwcm9jZXNzLm9uKCdleGl0JywgdGhpcy5fb25FeGl0KTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBzdXBlci5zdGFydF8oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdG9wIHRoZSBhcHBcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICAgKiBAbWVtYmVyb2YgUnVuYWJsZVxuICAgICAqL1xuICAgIGFzeW5jIHN0b3BfKCkge1xuICAgICAgICBwcm9jZXNzLnJlbW92ZUxpc3RlbmVyKCdleGl0JywgdGhpcy5fb25FeGl0KTtcblxuICAgICAgICBhd2FpdCBzdXBlci5zdG9wXygpO1xuXG4gICAgICAgIGF3YWl0IHNsZWVwXygwKTtcblxuICAgICAgICB0aGlzLl91bmluaXRpYWxpemUoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgdGhlIGxpYiBtb2R1bGVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbGliTmFtZSBcbiAgICAgKi9cbiAgICBnZXRMaWIobGliTmFtZSkge1xuICAgICAgICBpZiAoIXRoaXMubGliTW9kdWxlcykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcImxpYk1vZHVsZXNcIiBmZWF0dXJlIGlzIHJlcXVpcmVkIHRvIGFjY2VzcyBsaWIgYW1vbmcgbW9kdWxlcy4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBsaWJNb2R1bGUgPSB0aGlzLmxpYk1vZHVsZXNbbGliTmFtZV07XG4gICAgICAgIFxuICAgICAgICBpZiAoIWxpYk1vZHVsZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBMaWIgbW9kdWxlIFske2xpYk5hbWV9XSBub3QgZm91bmQuYCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbGliTW9kdWxlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcXVpcmUgYSBtb2R1bGUgZnJvbSB0aGUgc291cmNlIHBhdGggb2YgYSBsaWJyYXJ5IG1vZHVsZVxuICAgICAqIEBwYXJhbSB7Kn0gcmVsYXRpdmVQYXRoIFxuICAgICAqL1xuICAgIHJlcXVpcmVGcm9tTGliKGxpYk5hbWUsIHJlbGF0aXZlUGF0aCkge1xuICAgICAgICBsZXQgbGliTW9kdWxlID0gdGhpcy5nZXRMaWIobGliTmFtZSk7XG4gICAgICAgIHJldHVybiBsaWJNb2R1bGUucmVxdWlyZShyZWxhdGl2ZVBhdGgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlZ2lzdGVyIGEgbG9hZGVkIGxpYiBtb2R1bGVcbiAgICAgKiBAcGFyYW0ge0xpYk1vZHVsZX0gbGliIFxuICAgICAqL1xuICAgIHJlZ2lzdGVyTGliKGxpYikge1xuICAgICAgICBpZiAoIXRoaXMubGliTW9kdWxlcykge1xuICAgICAgICAgICAgdGhpcy5saWJNb2R1bGVzID0ge307XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmxpYk1vZHVsZXNbbGliLm5hbWVdID0gbGliO1xuICAgIH1cblxuICAgIF9pbml0aWFsaXplKCkge1xuICAgICAgICB0aGlzLl9wd2QgPSBwcm9jZXNzLmN3ZCgpO1xuICAgICAgICBpZiAodGhpcy53b3JraW5nUGF0aCAhPT0gdGhpcy5fcHdkKSB7ICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgcHJvY2Vzcy5jaGRpcih0aGlzLndvcmtpbmdQYXRoKTtcbiAgICAgICAgfSAgICAgIFxuXG4gICAgICAgIHRoaXMuX2luamVjdExvZ2dlcigpO1xuICAgICAgICB0aGlzLl9pbmplY3RFcnJvckhhbmRsZXJzKCk7IFxuICAgIH1cblxuICAgIF91bmluaXRpYWxpemUoKSB7XG4gICAgICAgIGNvbnN0IGRldGFjaCA9IHRydWU7XG4gICAgICAgIHRoaXMuX2luamVjdEVycm9ySGFuZGxlcnMoZGV0YWNoKTsgICAgICAgXG4gICAgICAgIHRoaXMuX2luamVjdExvZ2dlcihkZXRhY2gpOyAgICAgICAgIFxuXG4gICAgICAgIHByb2Nlc3MuY2hkaXIodGhpcy5fcHdkKTtcbiAgICAgICAgZGVsZXRlIHRoaXMuX3B3ZDtcbiAgICB9XG5cbiAgICBfaW5qZWN0TG9nZ2VyKGRldGFjaCkge1xuICAgICAgICBpZiAoZGV0YWNoKSB7XG4gICAgICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdMb2dnZXIgaXMgZGV0YWNoaW5nIC4uLicpO1xuXG4gICAgICAgICAgICBpZiAoIXRoaXMuX2V4dGVybmFsTG9nZ2VyKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIuY2xvc2UoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2V4dGVybmFsTG9nZ2VyO1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMubG9nZ2VyO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGxvZ2dlck9wdCA9IHRoaXMub3B0aW9ucy5sb2dnZXI7XG5cbiAgICAgICAgaWYgKGxvZ2dlck9wdCBpbnN0YW5jZW9mIExvZ2dlcikge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIgPSBsb2dnZXJPcHQ7XG4gICAgICAgICAgICB0aGlzLl9leHRlcm5hbExvZ2dlciA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAobG9nZ2VyT3B0LnRyYW5zcG9ydHMpIHtcbiAgICAgICAgICAgICAgICBsb2dnZXJPcHQudHJhbnNwb3J0cyA9IHdpbnN0b25GbGlnaHQod2luc3RvbiwgbG9nZ2VyT3B0LnRyYW5zcG9ydHMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmxvZ2dlciA9IHdpbnN0b24uY3JlYXRlTG9nZ2VyKGxvZ2dlck9wdCk7ICAgXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHRoaXMubG9nKCd2ZXJib3NlJywgJ0xvZ2dlciBpbmplY3RlZC4nKTsgICAgICAgICAgICBcbiAgICB9XG5cbiAgICBfaW5qZWN0RXJyb3JIYW5kbGVycyhkZXRhY2gpIHtcbiAgICAgICAgaWYgKGRldGFjaCkgeyAgICAgICAgICAgIFxuICAgICAgICAgICAgcHJvY2Vzcy5yZW1vdmVMaXN0ZW5lcignd2FybmluZycsIHRoaXMuX29uV2FybmluZyk7XG4gICAgICAgICAgICBwcm9jZXNzLnJlbW92ZUxpc3RlbmVyKCd1bmNhdWdodEV4Y2VwdGlvbicsIHRoaXMuX29uVW5jYXVnaHRFeGNlcHRpb24pO1xuICAgICAgICAgICAgdGhpcy5sb2coJ3ZlcmJvc2UnLCAnUHJvY2Vzcy13aWRlIGVycm9yIGhhbmRsZXJzIGRldGFjaGVkLicpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgcHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCB0aGlzLl9vblVuY2F1Z2h0RXhjZXB0aW9uKTsgXG4gICAgICAgIHByb2Nlc3Mub24oJ3dhcm5pbmcnLCB0aGlzLl9vbldhcm5pbmcpO1xuICAgICAgICB0aGlzLmxvZygndmVyYm9zZScsICdQcm9jZXNzLXdpZGUgZXJyb3IgaGFuZGxlcnMgaW5qZWN0ZWQuJyk7ICAgICAgICAgICAgXG4gICAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBSdW5hYmxlOyJdfQ==